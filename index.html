<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 OB PICK & PACK HTP (Bennett)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom Styles based on the PyQt Stylesheet */
        body {
            font-family: "Segoe UI", "Malgun Gothic", sans-serif;
            background-color: #1E2336;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1E2336;
        }
        ::-webkit-scrollbar-thumb {
            background: #404760;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #505770;
        }
        
        /* Specific element styling */
        .btn {
            background-color: #303750; color: #E0E3E8; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.9rem; font-weight: 600; min-height: 36px; transition: background-color 0.2s;
        }
        .btn:hover { background-color: #404760; }
        .btn:disabled { background-color: #202535; color: #606575; cursor: not-allowed; }
        .btn-checkable:not(.checked) { background-color: #303750; }
        .btn-checkable.checked { background-color: #17C3B2; color: #FFFFFF; font-weight: 700; }
        .btn-checkable.checked:hover { background-color: #14A89A; }
        
        .input-field { background-color: #101420; border: 1px solid #303750; padding: 4px 10px; border-radius: 4px; color: #D0D5DD; font-size: 0.9rem; min-height: 36px; }
        .input-field:focus { border: 1px solid #17C3B2; background-color: #181D2C; outline: none; }

        .table-container {
            max-height: calc(100vh - 280px); /* Adjust based on other elements' heights */
            overflow: auto;
        }
        
        th { background-color: #282D40; color: #E0E3E8; padding: 8px 10px; border-bottom: 1px solid #404760; font-weight: 600; text-align: center; }
        td { padding: 7px 10px; border-bottom: 1px solid #303750; text-align: center; white-space: nowrap; }
        tr:nth-child(even) td { background-color: #22283E; }
        tr:hover td { background-color: #108A80; }

        .sidebar { background-color: #141827; border-left: 1px solid #303750; transition: width 0.35s ease-in-out; }
        .sidebar-hidden { width: 0; }
        .sidebar-visible { width: 280px; }
        .sidebar-content { min-width: 280px; }

        .group-box { border: 1px solid #303750; border-radius: 4px; margin-top: 8px; padding: 12px 8px 8px 8px; position: relative; }
        .group-box-title { position: absolute; top: -0.6em; left: 8px; background: #141827; padding: 0 4px; color: #E0E3E8; font-size: 0.9rem; font-weight: bold; }

        /* Ticker Animation */
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .ticker-wrap {
            position: relative;
            width: 100%;
            overflow: hidden;
            height: 20px;
        }
        .ticker-move {
            position: absolute;
            white-space: nowrap;
            will-change: transform;
            animation: ticker 20s linear infinite;
        }
        #tickerLabel { color: #FFD700; font-weight: bold; }
    </style>
</head>

<body class="text-[#D0D5DD]">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, setLogLevel
        };
    </script>

    <div class="flex h-screen overflow-hidden">
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
                <!-- Header -->
                <header class="text-center">
                    <h1 id="titleLabel" class="text-4xl font-bold text-white transition-colors duration-1000">🚀 GWJ2 OB PICK & PACK HTP CHECK</h1>
                    <p class="text-sm text-[#707890]">Developed By Bennett</p>
                </header>

                <!-- Top Controls -->
                <div class="flex items-center space-x-4">
                    <label for="file-upload" class="btn cursor-pointer">📁 엑셀 첨부</label>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsx">
                    
                    <div class="flex-grow flex justify-center">
                        <div class="relative w-full max-w-md">
                            <input id="searchInput" type="text" placeholder="🔍 이름(원바코드) 검색" class="input-field w-full pr-8">
                            <button id="clearSearchButton" class="absolute right-2 top-1/2 -translate-y-1/2 text-xl text-gray-400 hover:text-white">✕</button>
                        </div>
                    </div>
                    
                    <button id="htpCheckButton" class="btn btn-checkable">� 저조자 ON/OFF</button>
                    <button id="captureButton" class="btn">📷 캡처</button>
                    <button id="exportButton" class="btn">📊 엑셀로 내보내기</button>
                    <button id="toggleSidebarButton" class="btn">⚙️</button>
                </div>

                <!-- Table -->
                <div id="tableContainer" class="table-container border border-[#303750] rounded-lg">
                    <table id="mainTable" class="w-full">
                        <thead class="sticky top-0 z-10">
                            <!-- Headers will be generated by JS -->
                        </thead>
                        <tbody>
                            <!-- Rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>
            </main>

            <!-- Status Bar -->
            <footer class="bg-[#141827] border-t border-[#303750] p-2 flex items-center justify-between text-sm">
                <div class="flex items-center space-x-2">
                    <div id="progressContainer" class="hidden items-center space-x-2">
                        <div class="w-32 h-2 bg-[#1E2336] rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-[#17C3B2] rounded-full" style="width: 0%;"></div>
                        </div>
                        <span id="progressLabel"></span>
                    </div>
                     <span id="userIdLabel" class="text-xs text-gray-500"></span>
                </div>
                <div id="tickerContainer" class="flex-1 ticker-wrap mx-4">
                    <div id="tickerLabel" class="ticker-move"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="lowHtpStatusLabel" class="font-bold text-[#FF6060]"></span>
                    <span id="filterStatsLabel">필터: -</span>
                    <span id="workerStatsLabel">표시 그룹: - | 작업자 수: - | 총 작업량: - | 평균 HTP: -</span>
                </div>
            </footer>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar sidebar-visible overflow-y-auto">
            <div class="sidebar-content p-4 space-y-4">
                <h2 class="text-xl font-bold text-white pb-2 border-b border-[#404760]">⚙️ 필터 및 설정</h2>
                
                <!-- Process Filter -->
                <div class="group-box">
                    <span class="group-box-title">✅ 데이터 로딩 필터: 프로세스</span>
                    <div class="flex space-x-2">
                        <button id="pickFilterButton" data-process="PICK" class="process-filter-btn btn btn-checkable flex-1">🟦 PICK</button>
                        <button id="packFilterButton" data-process="PACK" class="process-filter-btn btn btn-checkable flex-1">🟨 PACK</button>
                    </div>
                </div>

                <!-- Floor Filter -->
                <div id="floorFilterGroup" class="group-box">
                    <span class="group-box-title">📶 화면 표시 필터: 층 (집품)</span>
                    <div id="floorCheckboxes" class="space-y-1"></div>
                    <div class="flex space-x-2 mt-2">
                        <button id="selectAllFloors" class="btn text-xs flex-1">모든 층 선택</button>
                        <button id="deselectAllFloors" class="btn text-xs flex-1">모든 층 해제</button>
                    </div>
                </div>

                <!-- Pack Type Filter -->
                <div class="group-box">
                    <span class="group-box-title">📦 화면 표시 필터: 팩 종류 (포장)</span>
                    <div id="packTypeCheckboxes" class="space-y-1"></div>
                    <div class="flex space-x-2 mt-2">
                        <button id="selectAllPackTypes" class="btn text-xs flex-1">모두 선택</button>
                        <button id="deselectAllPackTypes" class="btn text-xs flex-1">모두 해제</button>
                    </div>
                </div>

                <!-- Target HTP Settings -->
                <div class="group-box">
                    <span class="group-box-title">🎯 Target HTP 설정</span>
                    <div id="targetHtpInputs" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Main Application Logic -->
    <script type="module">
        // --- Firebase Initialization ---
        const {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, setLogLevel
        } = window.firebase;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-htp-check-app';
        let db, auth, userId;

        // --- Constants from Python Script ---
        const APP_VERSION = "3.0.1-web";
        document.title += ` v${APP_VERSION}`;
        document.getElementById('titleLabel').textContent += ` (v${APP_VERSION})`;
        
        const COLUMNS_TO_DISPLAY = ['Process Type', 'Employee', 'Floor', 'Unit Qty', 'Location', 'Process Path Name', 'Pack Type', 'M/H', 'HTP', 'Process(Task)'];
        const COLUMN_NAME_MAP = { 'Process Type': '집품/포장', 'Employee': '이름(원바코드)', 'Floor': '층', 'Unit Qty': '작업량', 'Location': '로케이션 및 작업대', 'Process Path Name': 'PP', 'Pack Type': '팩 종류', 'M/H': 'M/H', 'HTP': 'HTP', 'Process(Task)': '원본 Task' };
        const NUMERIC_SORT_COLUMNS = ['Unit Qty', 'M/H', 'HTP'];
        const COLUMNS_TO_LOAD = ['Employee', 'Unit Qty', 'Location', 'Floor', 'Process Path Name', 'HTP Start', 'HTP End', 'Process(Task)', 'Contract Type'];
        const PACK_TYPE_MAP = new Map([["메뉴얼팩", "179_1.3F_MA_S_OG_"], ["메뉴얼팩 멀티", "179_1.3F_MA_M_OG_"], ["ACE LINE", "179-1.2F-MA-ACE-OG-"], ["오토백 1.2", "179_1.3F_AB_R1.2_OG_"], ["오토백 2.5", "179_1.3F_AB_R2.5_OG_"], ["오토백 4.0", "179_1.3F_AB_R4.0_OG_"], ["오토백 RTPB", "179_1.3F_AB_T1_OG_"], ["오토백 멀티", "179_1.3F_AB_M_OG_"], ["CFC 메뉴얼팩", "190_6.2F_MA_S_OG_"], ["CFC 메뉴얼팩 멀티", "190_6.2F_MA_M_OG_"], ["CFC 오토백 2.5", "190_6.2F_AB_R2.5_OG_"], ["CFC 오토백 4.0", "190_6.2F_AB_R4.0_OG_"], ["CFC 오토백 RTPB", "190_6.2G_AB_T1_OG_"]]);
        const DEFAULT_PACK_TYPE = "기타";
        const FLOOR_DISPLAY_NAMES = ['6-1층', '6-2층', '6-3층', '7-1층', '7-2층', '7-3층', '8층'];
        const FLOOR_DATA_TO_DISPLAY_MAP = { '6.1F': '6-1층', '6.2F': '6-2층', '6.3F': '6-3층', '7.1F': '7-1층', '7.2F': '7-2층', '7.3F': '7-3층', '8.1F': '8층' };
        const FLOOR_DISPLAY_TO_DATA_MAP = Object.fromEntries(Object.entries(FLOOR_DATA_TO_DISPLAY_MAP).map(([k, v]) => [v, k]));
        const EMPLOYEES_TO_EXCLUDE = ['AGV_Agent'];
        const ALLOWED_PROCESSES = ['PACK(PACKING)', 'PICK(PICKING)'];
        const TARGET_HTP_DEFAULTS = { "Manual SINGULATION": [100, ['ManualPack', '179_1.3F_MA_S_OG_'], ['PACK(PACKING)']], "Manual MULTI": [120, ['7F_Multi_AGV', '179_1.3F_MA_M_OG_'], ['PACK(PACKING)']], "ACE LINE": [150, ['ACE', '179-1.2F-MA-ACE-OG-'], ['PACK(PACKING)']], "Autobagger 1.2": [380, ['Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'], ['PACK(PACKING)']], "Autobagger 2.5": [350, ['Autobag2.5', '179_1.3F_AB_R2.5_OG_'], ['PACK(PACKING)']], "Autobagger 4.0": [280, ['Autobag4.0', '179_1.3F_AB_R4.0_OG_'], ['PACK(PACKING)']], "Autobagger RTPB": [150, ['Autobag_RTPB1', '179_1.3F_AB_T1_OG_'], ['PACK(PACKING)']], "Auto MULTI": [250, ['AGV_Multi_Autobag4.0', '179_1.3F_AB_M_OG_'], ['PACK(PACKING)']], "CFC Manual S": [100, ['190_6.2F_MA_S_OG_'], ['PACK(PACKING)']], "CFC Manual M": [120, ['190_6.2F_MA_M_OG_'], ['PACK(PACKING)']], "CFC Autobag 2.5": [350, ['190_6.2F_AB_R2.5_OG_'], ['PACK(PACKING)']], "CFC Autobag 4.0": [280, ['190_6.2F_AB_R4.0_OG_'], ['PACK(PACKING)']], "CFC Autobag RTPB": [150, ['190_6.2G_AB_T1_OG_'], ['PACK(PACKING)']], "PICK": [90, [], ['PICK(PICKING)']] };
        const MANAGERS_LIST = ['98659377', '31629728', '26485305', '94354606', '66476877', '21284456', '24856615', '87406548', '57101574', '39104550', '23761528', '29801698', '27407697', '30997520', '26152514', '42103385', '47548283', '92816677', '55540763', '39678603', '29787775', '88463987', '65712250', '37005613', '88031159', '24304330', '58548628', '58728654', '27507426', '92733138', '41310393', '21220693', '38876677', '53909931', '77358628', '95383395', '86473941', '28996527', '36148186', '96358817', '64118293', '50908038', '30049374', '68100618', '29229926', '66536830', '25657753', '47848283', '46802436', '93246435', '83689729', '92718820', '87935445', '97224272', '39359504'];
        const MANAGER_ICON = "👑";
        const LOW_HTP_ICON = "🚨";

        // --- Global State ---
        let currentData = [];
        let processFilter = null; // 'PICK', 'PACK', or null for all
        let htpTargets = {};
        let currentSort = { column: -1, order: 'asc' };

        // --- DOM Elements ---
        const fileUploadInput = document.getElementById('file-upload');
        const mainTable = document.getElementById('mainTable');
        const tableBody = mainTable.querySelector('tbody');
        const tableHead = mainTable.querySelector('thead');
        const searchInput = document.getElementById('searchInput');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const htpCheckButton = document.getElementById('htpCheckButton');
        const captureButton = document.getElementById('captureButton');
        const exportButton = document.getElementById('exportButton');
        const pickFilterButton = document.getElementById('pickFilterButton');
        const packFilterButton = document.getElementById('packFilterButton');
        const toggleSidebarButton = document.getElementById('toggleSidebarButton');
        const sidebar = document.getElementById('sidebar');
        const packTypeCheckboxesContainer = document.getElementById('packTypeCheckboxes');
        const floorCheckboxesContainer = document.getElementById('floorCheckboxes');
        const floorFilterGroup = document.getElementById('floorFilterGroup');
        const targetHtpInputsContainer = document.getElementById('targetHtpInputs');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const workerStatsLabel = document.getElementById('workerStatsLabel');
        const filterStatsLabel = document.getElementById('filterStatsLabel');
        const lowHtpStatusLabel = document.getElementById('lowHtpStatusLabel');
        const tickerLabel = document.getElementById('tickerLabel');
        const tickerMove = document.querySelector('.ticker-move');
        const userIdLabel = document.getElementById('userIdLabel');

        // --- Firestore Document References ---
        let dataDocRef, htpConfigDocRef;

        // --- Helper Functions ---
        const showProgress = (message, value = null) => {
            progressContainer.classList.remove('hidden');
            progressContainer.classList.add('flex');
            progressLabel.textContent = message;
            if (value !== null) {
                progressBar.style.width = `${value}%`;
            } else {
                // Indeterminate
                progressBar.classList.add('animate-pulse');
            }
        };

        const hideProgress = () => {
            progressContainer.classList.add('hidden');
            progressLabel.textContent = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('animate-pulse');
        };

        const showAlert = (message, type = 'info') => {
            // A more robust implementation would use a modal. For simplicity, we'll use console and a status bar message.
            console.log(`${type.toUpperCase()}: ${message}`);
            workerStatsLabel.textContent = message;
            setTimeout(() => updateStatusBar(), 5000);
        };
        
        // --- Data Processing Logic (Ported from Python) ---
        
        // This function converts Excel serial date numbers to JS Date objects
        function excelSerialDateToJSDate(serial) {
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);

            const fractional_day = serial - Math.floor(serial) + 0.0000001;

            let total_seconds = Math.floor(86400 * fractional_day);

            const seconds = total_seconds % 60;
            total_seconds -= seconds;

            const hours = Math.floor(total_seconds / (60 * 60));
            const minutes = Math.floor(total_seconds / 60) % 60;

            return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
        }

        const getPackType = (location, processTask, processPathName) => {
            if (typeof location !== 'string') return DEFAULT_PACK_TYPE;
            if (processTask === 'PACK(PACKING)' &&
                location.startsWith('Pack at Rebin (Test') &&
                processPathName === '0. AGV_Multi_Autobag4.0 + 일반존 통합') {
                return "오토백 멀티";
            }
            for (const [name, prefix] of PACK_TYPE_MAP.entries()) {
                if (location.startsWith(prefix)) {
                    return name;
                }
            }
            return DEFAULT_PACK_TYPE;
        };
        
        const processExcelData = (data) => {
            // 1. Initial filtering and type conversion
            let df = data.filter(row => row.Employee && !EMPLOYEES_TO_EXCLUDE.includes(row.Employee));
            
            df = df.map(row => {
                let htpStart, htpEnd;
                try {
                    htpStart = typeof row['HTP Start'] === 'number' ? excelSerialDateToJSDate(row['HTP Start']) : new Date(row['HTP Start']);
                    if(isNaN(htpStart.getTime())) htpStart = null;
                } catch(e) { htpStart = null; }
                
                try {
                    htpEnd = typeof row['HTP End'] === 'number' ? excelSerialDateToJSDate(row['HTP End']) : new Date(row['HTP End']);
                    if(isNaN(htpEnd.getTime())) htpEnd = null;
                } catch(e) { htpEnd = null; }

                return {
                    ...row,
                    'Unit Qty': Number(row['Unit Qty']) || 0,
                    'HTP Start': htpStart,
                    'HTP End': htpEnd,
                    'Floor': String(row.Floor || '').trim(),
                    'Contract Type': String(row['Contract Type'] || '').trim().toUpperCase(),
                    'Employee': String(row.Employee || ''),
                    'Location': String(row.Location || ''),
                    'Process(Task)': String(row['Process(Task)'] || ''),
                    'Process Path Name': String(row['Process Path Name'] || ''),
                };
            }).filter(row => row['HTP Start'] && row['HTP End'] && row.Employee);

            // 2. Remap REBIN to PACK for new Autobag Multi
            df.forEach(row => {
                const isAutobagMultiRebin = (
                    row['Process(Task)'] === 'REBIN(REBIN)' &&
                    row.Location.startsWith('Pack at Rebin (Test') &&
                    row['Process Path Name'] === '0. AGV_Multi_Autobag4.0 + 일반존 통합'
                );
                if (isAutobagMultiRebin) {
                    row['Process(Task)'] = 'PACK(PACKING)';
                }
            });

            // 3. Determine Pack Type
            df.forEach(row => {
                row['Pack Type'] = getPackType(row.Location, row['Process(Task)'], row['Process Path Name']);
            });

            // 4. Filter by selected process (PICK/PACK)
            let filteredDf = df.filter(row => ALLOWED_PROCESSES.includes(row['Process(Task)']));
            if(processFilter) {
                const targetProcess = processFilter === 'PICK' ? 'PICK(PICKING)' : 'PACK(PACKING)';
                filteredDf = filteredDf.filter(row => row['Process(Task)'] === targetProcess);
            }

            // 5. Calculate M/H
            filteredDf.forEach(row => {
                const durationSeconds = (row['HTP End'].getTime() - row['HTP Start'].getTime()) / 1000;
                row['M/H'] = Math.max(0, durationSeconds) / 3600.0;
            });

            // 6. Separate and aggregate PICK and PACK data
            const dfPick = filteredDf.filter(row => row['Process(Task)'] === 'PICK(PICKING)');
            const dfPack = filteredDf.filter(row => row['Process(Task)'] === 'PACK(PACKING)');
            
            const aggregatedData = [];

            // Grouping function
            const groupBy = (array, keys) => {
                const groups = new Map();
                array.forEach(item => {
                    const key = keys.map(k => item[k]).join('||');
                    if (!groups.has(key)) {
                        groups.set(key, []);
                    }
                    groups.get(key).push(item);
                });
                return groups;
            };
            
            // Aggregate PICK
            if (dfPick.length > 0) {
                const pickGroups = groupBy(dfPick, ['Employee', 'Floor']);
                pickGroups.forEach(group => {
                    const first = group[0];
                    const last = group[group.length - 1];
                    const totalQty = group.reduce((sum, row) => sum + row['Unit Qty'], 0);
                    const totalMH = group.reduce((sum, row) => sum + row['M/H'], 0);
                    aggregatedData.push({
                        'Employee': first.Employee,
                        'Floor': first.Floor,
                        'Unit Qty': totalQty,
                        'M/H': totalMH,
                        'Location': last.Location,
                        'Process Path Name': last['Process Path Name'],
                        'Process(Task)': first['Process(Task)'],
                        'Contract Type': first['Contract Type'],
                        'Pack Type': '집품'
                    });
                });
            }

            // Aggregate PACK
            if (dfPack.length > 0) {
                const packGroups = groupBy(dfPack, ['Employee', 'Pack Type']);
                packGroups.forEach(group => {
                    const first = group[0];
                    const last = group[group.length - 1];
                    const totalQty = group.reduce((sum, row) => sum + row['Unit Qty'], 0);
                    const totalMH = group.reduce((sum, row) => sum + row['M/H'], 0);
                    aggregatedData.push({
                        'Employee': first.Employee,
                        'Pack Type': first['Pack Type'],
                         'Unit Qty': totalQty,
                        'M/H': totalMH,
                        'Location': last.Location,
                        'Process Path Name': last['Process Path Name'],
                        'Process(Task)': first['Process(Task)'],
                        'Contract Type': first['Contract Type'],
                        'Floor': last.Floor
                    });
                });
            }
            
            // 7. Final calculations and filtering
            let finalData = aggregatedData.map(row => {
                const htp = row['M/H'] > 0 ? row['Unit Qty'] / row['M/H'] : 0;
                return { ...row, HTP: htp };
            }).filter(row => row['Unit Qty'] > 0);

            return finalData;
        };

        const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showProgress(`'${file.name}' 로드 중...`, 0);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Check for required columns
                    const header = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                    const missingCols = COLUMNS_TO_LOAD.filter(col => col !== 'Contract Type' && !header.includes(col));
                    if (missingCols.length > 0) {
                        throw new Error(`필수 컬럼 누락: ${missingCols.join(', ')}`);
                    }

                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    showProgress('데이터 처리 중...', 50);
                    
                    const processedData = processExcelData(jsonData);
                    
                    showProgress('서버에 업로드 중...', 90);
                    await setDoc(dataDocRef, { 
                        data: processedData, 
                        fileName: file.name, 
                        uploadedBy: userId,
                        timestamp: new Date()
                    });
                    
                    showAlert('✅ 데이터 로드 및 공유 완료.', 'info');
                } catch (error) {
                    console.error("File processing error:", error);
                    showAlert(`오류: ${error.message}`, 'error');
                } finally {
                    hideProgress();
                    // Clear the input value to allow re-uploading the same file
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };


        // --- UI Rendering and Interaction ---
        
        const renderTable = (data) => {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                updateStatusBar();
                return;
            }
            
            // Sort data if needed
            if (currentSort.column !== -1) {
                const sortKey = COLUMNS_TO_DISPLAY[currentSort.column];
                const isNumeric = NUMERIC_SORT_COLUMNS.includes(sortKey);

                data.sort((a, b) => {
                    let valA = a[sortKey];
                    let valB = b[sortKey];

                    if (isNumeric) {
                        valA = Number(valA) || 0;
                        valB = Number(valB) || 0;
                        return currentSort.order === 'asc' ? valA - valB : valB - valA;
                    } else {
                        valA = String(valA || '').toLowerCase();
                        valB = String(valB || '').toLowerCase();
                        return currentSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                });
            }

            const fragment = document.createDocumentFragment();
            data.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.dataset.employee = rowData.Employee;
                tr.dataset.packType = rowData['Pack Type'];
                tr.dataset.floor = rowData.Floor;
                tr.dataset.htp = rowData.HTP;
                tr.dataset.processPath = rowData['Process Path Name'];
                tr.dataset.processTask = rowData['Process(Task)'];
                tr.dataset.contractType = rowData['Contract Type'];
                
                COLUMNS_TO_DISPLAY.forEach(colKey => {
                    const td = document.createElement('td');
                    let cellValue = rowData[colKey];
                    
                    if (colKey === 'Process Type') {
                        cellValue = rowData['Process(Task)'] === 'PICK(PICKING)' ? 'PICK(집품)' : 'PACK(포장)';
                    } else if (typeof cellValue === 'number') {
                        if (colKey === 'M/H') cellValue = cellValue.toFixed(4);
                        else if (colKey === 'HTP') cellValue = cellValue.toFixed(2);
                        else cellValue = Math.round(cellValue).toLocaleString();
                    }
                    
                    td.textContent = cellValue ?? '';
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });
            tableBody.appendChild(fragment);
            applyDisplayFilters();
        };

        const applyConditionalFormatting = () => {
            const rows = tableBody.querySelectorAll('tr');
            const htpColIdx = COLUMNS_TO_DISPLAY.indexOf('HTP');
            const empColIdx = COLUMNS_TO_DISPLAY.indexOf('Employee');
            const procTypeColIdx = COLUMNS_TO_DISPLAY.indexOf('Process Type');

            rows.forEach(tr => {
                if (tr.style.display === 'none') return;
                
                // Reset styles
                tr.querySelectorAll('td').forEach(td => {
                    td.style.color = '';
                    td.style.backgroundColor = '';
                    td.style.fontWeight = '';
                });

                // Employee styling (Manager, Contract)
                const empCell = tr.cells[empColIdx];
                if (empCell) {
                    const empNameFull = tr.dataset.employee;
                    const match = empNameFull.match(/^(.*?)\s*\((.*?)\)$/);
                    const empId = match ? match[2].trim() : empNameFull.trim();
                    
                    if (MANAGERS_LIST.includes(empId)) {
                        empCell.textContent = `${MANAGER_ICON}${empNameFull}`;
                        empCell.style.color = '#faffa1'; // Gold
                        empCell.style.fontWeight = 'bold';
                    } else if (tr.dataset.contractType === 'PERM') {
                        empCell.style.backgroundColor = '#B3E0FF';
                        empCell.style.color = '#005A9C'; // Darker blue for contrast
                    }
                }
                
                // Process Type styling
                const procTypeCell = tr.cells[procTypeColIdx];
                if (procTypeCell) {
                    if (procTypeCell.textContent === 'PICK(집품)') {
                        procTypeCell.style.color = '#ADD8E6'; // Light Blue
                    } else if (procTypeCell.textContent === 'PACK(포장)') {
                        procTypeCell.style.color = '#DAA520'; // Goldenrod
                    }
                }

                // HTP styling
                const htpCell = tr.cells[htpColIdx];
                if (htpCell) {
                    const htp = parseFloat(tr.dataset.htp);
                    const targetHtp = getTargetHtp(tr.dataset.processPath, tr.dataset.processTask);
                    
                    htpCell.textContent = htp.toFixed(2);
                    if (targetHtp > 0 && htp < targetHtp) {
                        htpCell.textContent = `${LOW_HTP_ICON} ${htp.toFixed(2)}`;
                        htpCell.style.color = '#FF0000'; // Red
                        htpCell.style.fontWeight = 'bold';
                    }
                }
            });
        };

        const getTargetHtp = (processPathName, processTask) => {
            if (processTask === 'PICK(PICKING)') {
                return htpTargets['PICK'] || 0;
            }
            if (processTask === 'PACK(PACKING)') {
                for (const [name, config] of Object.entries(TARGET_HTP_DEFAULTS)) {
                    if (name === "PICK") continue;
                    const keywords = config[1];
                    const requiredTask = config[2][0];
                    if (requiredTask === processTask) {
                        if (keywords.some(kw => processPathName.includes(kw))) {
                            return htpTargets[name] || 0;
                        }
                    }
                }
                return htpTargets['Manual SINGULATION'] || 0;
            }
            return 0;
        };
        
        const applyDisplayFilters = () => {
            const searchText = searchInput.value.trim().toLowerCase();
            const lowHtpChecked = htpCheckButton.classList.contains('checked');
            const selectedPackTypes = new Set([...packTypeCheckboxesContainer.querySelectorAll('input:checked')].map(cb => cb.dataset.name));
            const selectedFloors = new Set([...floorCheckboxesContainer.querySelectorAll('input:checked')].map(cb => cb.dataset.name));
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(tr => {
                let showRow = true;

                // Search filter
                if (searchText) {
                    const empName = tr.dataset.employee.toLowerCase();
                    if (!empName.includes(searchText)) {
                        showRow = false;
                    }
                }

                // Low HTP filter
                if (showRow && lowHtpChecked) {
                    const htp = parseFloat(tr.dataset.htp);
                    const targetHtp = getTargetHtp(tr.dataset.processPath, tr.dataset.processTask);
                    if (!(targetHtp > 0 && htp < targetHtp)) {
                        showRow = false;
                    }
                }

                // Pack Type filter
                if (showRow && selectedPackTypes.size > 0) {
                    const packType = tr.dataset.packType;
                    if (!selectedPackTypes.has(packType)) {
                        showRow = false;
                    }
                }

                // Floor filter
                if (showRow && selectedFloors.size > 0) {
                    const floorData = tr.dataset.floor;
                    const floorDisplay = FLOOR_DATA_TO_DISPLAY_MAP[floorData] || floorData;
                    if (tr.dataset.processTask === 'PICK(PICKING)' && !selectedFloors.has(floorDisplay)) {
                        showRow = false;
                    }
                }

                tr.style.display = showRow ? '' : 'none';
            });
            
            applyConditionalFormatting();
            updateStatusBar();
        };

        const updateStatusBar = () => {
            const visibleRows = [...tableBody.querySelectorAll('tr')].filter(tr => tr.style.display !== 'none');
            const visibleRowCount = visibleRows.length;
            
            const visibleWorkers = new Set(visibleRows.map(tr => tr.dataset.employee));
            const totalQty = visibleRows.reduce((sum, tr) => {
                const qtyCellIdx = COLUMNS_TO_DISPLAY.indexOf('Unit Qty');
                const qtyText = tr.cells[qtyCellIdx]?.textContent.replace(/,/g, '') || '0';
                return sum + (parseInt(qtyText, 10) || 0);
            }, 0);
            
            const totalHtp = visibleRows.reduce((sum, tr) => sum + (parseFloat(tr.dataset.htp) || 0), 0);
            const avgHtp = visibleRowCount > 0 ? totalHtp / visibleRowCount : 0;

            workerStatsLabel.textContent = `표시 그룹: ${visibleRowCount} | 작업자 수: ${visibleWorkers.size} | 총 작업량: ${totalQty.toLocaleString()} | 평균 HTP: ${avgHtp.toFixed(2)}`;
            
            let filterInfo = [];
            if (processFilter) filterInfo.push(processFilter); else filterInfo.push("전체 Process");
            filterStatsLabel.textContent = `필터: ${filterInfo.join(', ')}`;
            
            lowHtpStatusLabel.textContent = htpCheckButton.classList.contains('checked') ? "🚨 저조자 ON" : "";
            updateTicker(visibleRows);
        };

        const updateTicker = (visibleRows) => {
            if (visibleRows.length === 0) {
                tickerMove.style.animation = 'none';
                tickerLabel.textContent = '';
                return;
            }

            const htpData = visibleRows.map(tr => ({
                name: `${tr.dataset.employee.split('(')[0].trim()} (${tr.dataset.processTask === 'PICK(PICKING)' ? (FLOOR_DATA_TO_DISPLAY_MAP[tr.dataset.floor] || tr.dataset.floor) : tr.dataset.packType})`,
                htp: parseFloat(tr.dataset.htp) || 0
            })).filter(d => d.htp > 0);

            if (htpData.length === 0) {
                tickerMove.style.animation = 'none';
                tickerLabel.textContent = '';
                return;
            }

            htpData.sort((a, b) => b.htp - a.htp);
            const top3 = htpData.slice(0, 3);
            const low3 = htpData.slice().sort((a, b) => a.htp - b.htp).slice(0, 3);

            const topStr = "🏆Top3: " + (top3.length > 0 ? top3.map(d => `${d.name} (${d.htp.toFixed(1)})`).join(', ') : "-");
            const lowStr = "🚨Low3: " + (low3.length > 0 ? low3.map(d => `${d.name} (${d.htp.toFixed(1)})`).join(', ') : "-");
            
            const text = `${topStr}      ${lowStr}`;
            tickerLabel.textContent = text;
            
            const textWidth = tickerLabel.offsetWidth;
            const containerWidth = tickerLabel.parentElement.offsetWidth;
            
            if (textWidth > containerWidth) {
                const duration = (textWidth + containerWidth) / 50; // Adjust speed
                tickerMove.style.animation = `ticker ${duration}s linear infinite`;
            } else {
                tickerMove.style.animation = 'none';
            }
        };

        const setupUI = () => {
            // Table Headers
            tableHead.innerHTML = '';
            const tr = document.createElement('tr');
            COLUMNS_TO_DISPLAY.forEach((colKey, index) => {
                const th = document.createElement('th');
                th.textContent = COLUMN_NAME_MAP[colKey] || colKey;
                th.dataset.columnIndex = index;
                if (colKey === 'Process(Task)') {
                    th.classList.add('hidden');
                }
                if (NUMERIC_SORT_COLUMNS.includes(colKey) || ['Employee', 'Pack Type', 'Floor'].includes(colKey)) {
                    th.classList.add('cursor-pointer');
                    th.innerHTML += ' <span class="sort-indicator"></span>';
                }
                tr.appendChild(th);
            });
            tableHead.appendChild(tr);

            // Pack Type Checkboxes
            const packTypes = [...Object.keys(Object.fromEntries(PACK_TYPE_MAP)), DEFAULT_PACK_TYPE];
            packTypeCheckboxesContainer.innerHTML = packTypes.map(name => `
                <label class="flex items-center space-x-2 text-sm">
                    <input type="checkbox" data-name="${name}" class="pack-type-cb form-checkbox bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500">
                    <span>${name}</span>
                </label>
            `).join('');

            // Floor Checkboxes
            floorCheckboxesContainer.innerHTML = FLOOR_DISPLAY_NAMES.map(name => `
                <label class="flex items-center space-x-2 text-sm">
                    <input type="checkbox" data-name="${name}" class="floor-cb form-checkbox bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500">
                    <span>${name}</span>
                </label>
            `).join('');

            // HTP Target Inputs
            targetHtpInputsContainer.innerHTML = Object.entries(TARGET_HTP_DEFAULTS).map(([name, config]) => `
                <div class="flex items-center justify-between">
                    <label for="htp-${name}">${name}:</label>
                    <input type="number" id="htp-${name}" data-name="${name}" value="${config[0]}" class="htp-input input-field w-20 text-right">
                </div>
            `).join('');
            
            updateFloorFilterGroupEnabledState();
        };

        const updateFloorFilterGroupEnabledState = () => {
            const isPickRelevant = (processFilter === 'PICK' || processFilter === null);
            floorFilterGroup.style.opacity = isPickRelevant ? '1' : '0.5';
            floorFilterGroup.style.pointerEvents = isPickRelevant ? 'auto' : 'none';
        };

        const resetDisplayFilters = () => {
            searchInput.value = '';
            htpCheckButton.classList.remove('checked');
            packTypeCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false);
            floorCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false);
            applyDisplayFilters();
        };

        // --- Event Listeners ---
        fileUploadInput.addEventListener('change', handleFileUpload);

        document.querySelectorAll('.process-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const selectedProcess = btn.dataset.process;
                if (btn.classList.contains('checked')) {
                    // Deselecting
                    btn.classList.remove('checked');
                    processFilter = null;
                } else {
                    // Selecting
                    document.querySelectorAll('.process-filter-btn').forEach(b => b.classList.remove('checked'));
                    btn.classList.add('checked');
                    processFilter = selectedProcess;
                }
                updateFloorFilterGroupEnabledState();
                // If a file has been uploaded, re-process and update
                if (fileUploadInput.files[0]) {
                    handleFileUpload({ target: { files: [fileUploadInput.files[0]] } });
                }
            });
        });
        
        searchInput.addEventListener('input', applyDisplayFilters);
        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            applyDisplayFilters();
        });
        
        htpCheckButton.addEventListener('click', () => {
            htpCheckButton.classList.toggle('checked');
            if (htpCheckButton.classList.contains('checked') && searchInput.value) {
                searchInput.value = '';
            }
            applyDisplayFilters();
        });

        toggleSidebarButton.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-visible');
            sidebar.classList.toggle('sidebar-hidden');
        });

        packTypeCheckboxesContainer.addEventListener('change', applyDisplayFilters);
        document.getElementById('selectAllPackTypes').addEventListener('click', () => {
            packTypeCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = true);
            applyDisplayFilters();
        });
        document.getElementById('deselectAllPackTypes').addEventListener('click', () => {
            packTypeCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false);
            applyDisplayFilters();
        });

        floorCheckboxesContainer.addEventListener('change', applyDisplayFilters);
        document.getElementById('selectAllFloors').addEventListener('click', () => {
            floorCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = true);
            applyDisplayFilters();
        });
        document.getElementById('deselectAllFloors').addEventListener('click', () => {
            floorCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false);
            applyDisplayFilters();
        });

        targetHtpInputsContainer.addEventListener('change', async (e) => {
            if (e.target.classList.contains('htp-input')) {
                const name = e.target.dataset.name;
                const value = parseFloat(e.target.value);
                if (!isNaN(value)) {
                    htpTargets[name] = value;
                    // Persist to Firestore
                    await updateDoc(htpConfigDocRef, { targets: htpTargets });
                    // No need to call applyDisplayFilters here, it's called by onSnapshot
                }
            }
        });

        captureButton.addEventListener('click', () => {
            const tableContainer = document.getElementById('tableContainer');
            showProgress('캡처 중...');
            html2canvas(tableContainer).then(canvas => {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                        .then(() => showAlert('✅ 클립보드에 복사됨.', 'info'))
                        .catch(err => showAlert(`캡처 오류: ${err.message}`, 'error'));
                });
            }).finally(hideProgress);
        });

        exportButton.addEventListener('click', () => {
            const visibleRows = [...tableBody.querySelectorAll('tr')].filter(tr => tr.style.display !== 'none');
            if (visibleRows.length === 0) {
                showAlert('내보낼 데이터가 없습니다.', 'warning');
                return;
            }

            const dataToExport = visibleRows.map(tr => {
                const rowData = {};
                COLUMNS_TO_DISPLAY.forEach((colKey, index) => {
                    if (colKey !== 'Process(Task)') {
                        rowData[COLUMN_NAME_MAP[colKey]] = tr.cells[index].textContent;
                    }
                });
                return rowData;
            });
            
            const pickData = dataToExport.filter(row => row['집품/포장'] === 'PICK(집품)');
            const packData = dataToExport.filter(row => row['집품/포장'] === 'PACK(포장)');

            const wb = XLSX.utils.book_new();
            if (pickData.length > 0) {
                const wsPick = XLSX.utils.json_to_sheet(pickData);
                XLSX.utils.book_append_sheet(wb, wsPick, 'PICK(집품)');
            }
            if (packData.length > 0) {
                const wsPack = XLSX.utils.json_to_sheet(packData);
                XLSX.utils.book_append_sheet(wb, wsPack, 'PACK(포장)');
            }
            
            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `Bennett_HTP_${today}.xlsx`);
        });
        
        tableHead.addEventListener('click', (e) => {
            const th = e.target.closest('th');
            if (!th || !th.classList.contains('cursor-pointer')) return;
            
            const colIndex = parseInt(th.dataset.columnIndex, 10);
            
            if (currentSort.column === colIndex) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = colIndex;
                currentSort.order = 'asc';
            }
            
            // Update sort indicators
            tableHead.querySelectorAll('.sort-indicator').forEach(span => span.textContent = '');
            const indicator = th.querySelector('.sort-indicator');
            if (indicator) {
                indicator.textContent = currentSort.order === 'asc' ? ' ▲' : ' ▼';
            }

            renderTable(currentData);
        });

        // --- Firebase Auth and Initialization ---
        const initializeAppAndAuth = async () => {
            if (!firebaseConfig) {
                showAlert("Firebase configuration is missing. Real-time features are disabled.", "error");
                document.body.innerHTML = '<div class="p-8 text-center text-red-400">Firebase 설정이 누락되었습니다. 앱을 실행할 수 없습니다.</div>';
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                dataDocRef = doc(db, `artifacts/${appId}/public/data/shared_data`);
                htpConfigDocRef = doc(db, `artifacts/${appId}/public/data/htp_config`);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdLabel.textContent = `UserID: ${userId}`;
                        console.log("User is signed in with UID:", userId);
                        
                        // Attach listeners now that we are authenticated
                        attachFirestoreListeners();

                    } else {
                        console.log("User is not signed in. Attempting to sign in...");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showAlert(`Firebase 초기화 오류: ${error.message}`, "error");
            }
        };

        const attachFirestoreListeners = () => {
            // Listener for HTP targets
            onSnapshot(htpConfigDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    htpTargets = docSnap.data().targets || {};
                } else {
                    // First time, set defaults
                    htpTargets = Object.fromEntries(Object.entries(TARGET_HTP_DEFAULTS).map(([k, v]) => [k, v[0]]));
                    setDoc(htpConfigDocRef, { targets: htpTargets });
                }
                // Update UI with fetched/default targets
                Object.entries(htpTargets).forEach(([name, value]) => {
                    const input = document.getElementById(`htp-${name}`);
                    if (input) input.value = value;
                });
                // Re-apply filters and formatting as targets might have changed
                applyDisplayFilters();
            }, (error) => {
                console.error("HTP Config listener error:", error);
                showAlert("HTP 설정 동기화 오류.", "error");
            });

            // Listener for main data
            onSnapshot(dataDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const docData = docSnap.data();
                    currentData = docData.data || [];
                    const fileName = docData.fileName || "데이터";
                    const uploadTime = docData.timestamp?.toDate().toLocaleString() || "";
                    showAlert(`'${fileName}' 데이터 로드됨 (${uploadTime})`, 'info');
                    resetDisplayFilters();
                    renderTable(currentData);
                } else {
                    console.log("No shared data found. Waiting for upload.");
                    tableBody.innerHTML = '<tr><td colspan="10" class="p-8 text-gray-400">엑셀 파일을 첨부하여 데이터를 공유하세요.</td></tr>';
                }
            }, (error) => {
                console.error("Shared Data listener error:", error);
                showAlert("데이터 동기화 오류.", "error");
            });
        };

        // --- App Start ---
        setupUI();
        initializeAppAndAuth();

    </script>
</body>

</html>