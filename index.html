<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 PICK & PACK HTP TOOL_Bennett (v3.2)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="PICK & PACK HTP TOOL_Bennett">
    <meta property="og:description" content="엑셀 파일을 업로드하여 실시간으로 HTP 데이터를 공유하고 분석하세요.">
    <meta property="og:image" content="https://github.com/qogmlwo000/gwj2pickpackhtp/blob/main/Bennett.png?raw=true">
    <meta property="og:url" content="https://qogmlwo000.github.io/gwj2pickpackhtp/">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- External CSS (Optimized) -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        :root {
            --transition-speed: 0s;
        }
        
        /* Light Mode Colors */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* 필요한 요소만 transition 적용 */
        body,
        #sidebar,
        #main-content,
        .card,
        button,
        input,
        .filter-btn,
        .view-tab,
        .kpi-card,
        label {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }

        /* Forms - 체크박스 스타일 */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.1rem;
            height: 1.1rem;
            border: 2px solid #94a3b8;
            border-radius: 4px;
            background-color: #f1f5f9;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .form-checkbox {
            background-color: #0f172a;
            border: 2px solid #60a5fa;
        }
        
        .form-checkbox:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        .form-checkbox:checked {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: var(--accent-primary);
        }
        
        .form-checkbox:checked::after {
            content: '✔';
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        body { 
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            scrollbar-width: thin;
        }

        /* Badge System Styles */
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .employee-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: help;
            position: relative;
        }
        
        .employee-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .employee-badge.legendary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            color: white;
            animation: shimmer 2s infinite;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
        
        .employee-badge.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }
        
        .employee-badge.silver {
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
            color: #1f2937;
        }
        
        .employee-badge.bronze {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            color: white;
        }
        
        .employee-badge.normal {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        .employee-badge.warning {
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            color: white;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .badge-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            margin-bottom: 5px;
            z-index: 1000;
        }
        
        .employee-badge:hover .badge-tooltip {
            opacity: 1;
        }
        
        .badge-icon {
            font-size: 14px;
            line-height: 1;
        }

        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 5px; border: 2px solid var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; background-color: var(--bg-primary); }
        
        #sidebar {
            width: 300px;
            transition: margin-left var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            position: fixed; top: 0; left: 0; height: 100%; z-index: 40;
            transform: translateX(-100%);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        #sidebar.open { transform: translateX(0); }
        #main-content { transition: margin-left var(--transition-speed) ease-in-out; width: 100%; background-color: var(--bg-primary); }

        @media (min-width: 1024px) {
            #sidebar { position: static; transform: translateX(0); }
            #main-content { flex: 1; min-width: 0; }
            .app-container.sidebar-collapsed #sidebar { margin-left: -300px; }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative; width: 60px; height: 30px;
            background: var(--bg-tertiary); border-radius: 30px;
            cursor: pointer; display: flex; align-items: center; padding: 3px;
            border: 2px solid var(--border-color);
        }
        .theme-toggle-slider {
            width: 22px; height: 22px;
            background: var(--accent-primary); border-radius: 50%;
            transition: transform var(--transition-speed) ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-md);
        }
        [data-theme="dark"] .theme-toggle-slider { transform: translateX(30px); }

        /* Status & Loader */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px currentColor; }
        .status-connected { background-color: var(--success); animation: pulse-success 2s infinite; }
        .status-disconnected { background-color: var(--error); }
        .status-loading { background-color: var(--warning); animation: pulse-warning 1.5s infinite; }
        @keyframes pulse-success { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons & Filters */
        .filter-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: var(--bg-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .filter-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; }

        button { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }
        .bg-blue-600 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border-color: #3b82f6 !important; }
        .bg-blue-600:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important; }

        /* Cards & Views */
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .view-tab { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 2px solid var(--border-color); transition: all 0.2s ease; font-weight: 600; }
        .view-tab:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .view-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* Title & Ticker */
        /* 🎯 Enhanced Ticker Design */
        #ticker-container { 
            overflow: hidden; 
            position: relative; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px; 
            border: 2px solid transparent;
            background-clip: padding-box;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        [data-theme="light"] #ticker-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        #ticker-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #3b82f6);
            border-radius: 12px;
            z-index: -1;
            background-size: 200% 100%;
            animation: border-flow 6s linear infinite;
        }

        @keyframes border-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        #ticker-text-wrapper {
            display: flex;
            align-items: center;
            gap: 24px;
            overflow: hidden;
        }
        
        #ticker-text { 
            display: flex;
            align-items: center;
            gap: 24px;
            animation: ticker-scroll 60s linear infinite;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .ticker-section {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .ticker-section.top {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .ticker-section.low {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* PICK/PACK 전용 스타일 */
        .ticker-section.pick {
            border-left: 3px solid #60a5fa;
        }
        
        .ticker-section.pack {
            border-left: 3px solid #fbbf24;
        }
        
        .ticker-section.pick .ticker-label::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.6);
        }
        
        .ticker-section.pack .ticker-label::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #fbbf24;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        }
        
        [data-theme="light"] .ticker-section.top {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
        }
        
        [data-theme="light"] .ticker-section.low {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        }
        
        .ticker-label {
            font-weight: 800;
            font-size: 13px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .ticker-section.top .ticker-label {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticker-section.low .ticker-label {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        [data-theme="light"] .ticker-item {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .ticker-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .ticker-name {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        [data-theme="light"] .ticker-name {
            color: #1e293b;
        }
        
        .ticker-htp {
            font-weight: 700;
            font-size: 14px;
        }
        
        .ticker-section.top .ticker-htp {
            color: #10b981;
        }
        
        .ticker-section.low .ticker-htp {
            color: #ef4444;
        }
        
        .ticker-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
        }
        
        .ticker-rank.rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.6);
        }
        
        .ticker-rank.rank-2 {
            background: linear-gradient(135deg, #e5e7eb, #9ca3af);
            color: #1f2937;
        }
        
        .ticker-rank.rank-3 {
            background: linear-gradient(135deg, #fb923c, #f97316);
            color: white;
        }
        
        @keyframes ticker-scroll { 
            0% { transform: translateX(100%); } 
            100% { transform: translateX(-100%); } 
        }
        
        #ticker-text:hover {
            animation-play-state: paused;
        }

        /* Table */
        .table-container { flex-grow: 1; overflow: auto; -webkit-overflow-scrolling: touch; background-color: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        #data-table { background-color: var(--bg-secondary); }
        #data-table thead { background: var(--bg-tertiary); }
        #data-table th { color: var(--text-primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--border-color); white-space: nowrap; padding: 16px; }
        #data-table td { border-right: 1px solid var(--border-color); white-space: nowrap; padding: 12px 16px; color: var(--text-secondary); }
        #data-table th:last-child, #data-table td:last-child { border-right: none; }
        #data-table tbody tr { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        #data-table tbody tr:hover { background-color: var(--bg-hover); box-shadow: var(--shadow-sm); }
        .sortable { cursor: pointer; position: relative; user-select: none; }
        .sort-indicator { display: inline-block; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
        .sortable:hover .sort-indicator { opacity: 0.8; }
        .sort-indicator.asc, .sort-indicator.desc { opacity: 1; color: var(--accent-primary); font-weight: bold; }
        .hidden-col { display: none; }
		
		/* 🆕 Enhanced Hidden Employee Styles */
        #data-table tbody tr.hidden-employee { 
            opacity: 0.2; 
            background: repeating-linear-gradient(
                45deg,
                var(--bg-secondary),
                var(--bg-secondary) 10px,
                var(--bg-tertiary) 10px,
                var(--bg-tertiary) 20px
            );
            filter: grayscale(0.8);
        }
        #data-table tbody tr.hidden-employee:hover {
            opacity: 0.4;
        }

        /* Forms */
        input[type="text"], input[type="number"], input[type="date"] { background-color: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary); transition: all 0.2s ease; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: var(--bg-secondary); }
        input[type="text"]::placeholder { color: var(--text-tertiary); }

        /* Dashboard */
        .kpi-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-left: 4px solid var(--accent-primary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .kpi-card h4 { color: var(--text-tertiary); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card p { color: var(--text-primary); font-size: 2rem; font-weight: 800; margin-top: 0.5rem; }

        /* Modals */
        #chart-modal-backdrop, #history-modal-backdrop, #employee-detail-modal-backdrop, #ranking-modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        #chart-modal-content, #history-modal-content, #employee-detail-modal-content, #ranking-modal-content { max-height: 85vh; background-color: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); overflow-y: auto; }
        #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		
		/* Text Colors */
        .text-gray-200, .text-white { color: var(--text-primary) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .text-gray-400, .text-gray-500 { color: var(--text-tertiary) !important; }
        .text-blue-400 { color: #60a5fa !important; }
        .text-yellow-400 { color: #fbbf24 !important; }
        .text-red-400 { color: #f87171 !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-purple-400 { color: #c084fc !important; }
        .text-yellow-300 { color: #fcd34d !important; }
        .text-yellow-600 { color: #ca8a04 !important; }
        .text-emerald-400 { color: #34d399 !important; }
        .text-emerald-600 { color: #059669 !important; }
        .text-gray-700 { color: #374151 !important; }
        .text-lime-400 { color: #a3e635 !important; }
        
        [data-theme="light"] .text-lime-400 {
            color: #16a34a !important;
            font-weight: 600;
        }
        
        [data-theme="light"] .text-yellow-300 {
            color: #d97706 !important;
        }
        
        [data-theme="light"] .text-yellow-600 {
            color: #ca8a04 !important;
        }
        
        [data-theme="light"] .text-emerald-400 {
            color: #10b981 !important;
        }
        
        [data-theme="light"] .text-emerald-600 {
            color: #059669 !important;
        }
        
        [data-theme="light"] .text-gray-700 {
            color: #374151 !important;
        }
        
        [data-theme="light"] .text-purple-400 {
            color: #9333ea !important;
        }

        /* Utility */
        .bg-gray-800, .bg-gray-700 { background-color: var(--bg-secondary) !important; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        label { color: var(--text-secondary); transition: color 0.2s ease; }
        label:hover { color: var(--text-primary); }
        .rounded-lg { border-radius: 12px !important; }
        .rounded-md { border-radius: 8px !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { animation: fadeIn 0.3s ease-out; }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
            animation: badge-pulse 2s infinite;
        }
        .badge-gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .badge-silver { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); color: #374151; }
        .badge-bronze { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: #7c2d12; }
        .badge-streak { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .badge-record { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        @keyframes badge-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
		
		/* 🆕 Warning/Danger Badge Styles */
        .badge-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: #78350f; 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .badge-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .badge-info { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
        }
        
        /* 🏅 Enhanced Badge System Styles */
        .badge-legendary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            color: white;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            animation: shimmer-badge 2s infinite;
            font-weight: 800;
            border: 2px solid #fbbf24;
        }
        
        .badge-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.6);
            font-weight: 700;
        }
        
        .badge-silver {
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
            color: #1f2937;
            box-shadow: 0 0 8px rgba(156, 163, 175, 0.4);
            font-weight: 700;
        }
        
        .badge-bronze {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            color: white;
            box-shadow: 0 0 8px rgba(251, 146, 60, 0.5);
            font-weight: 700;
        }
        
        .badge-normal {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            font-weight: 600;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            font-weight: 700;
        }
        
        @keyframes shimmer-badge {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            }
            50% { 
                opacity: 0.9; 
                box-shadow: 0 0 30px rgba(251, 191, 36, 1);
            }
        }
		
		/* 🆕 Row Action Menu (Hover) */
        .row-action-menu {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            border: 2px solid var(--border-color);
        }
        tr:hover .row-action-menu {
            opacity: 1;
        }
        .action-menu-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 12px;
            font-size: 1.3rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-menu-btn:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }

        /* History View Styles */
        .period-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .period-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.875rem; cursor: pointer; }
        .period-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; }
        
        .history-chart-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 20px; }
        
        .date-range-picker { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .date-range-picker input { padding: 8px 12px; border-radius: 8px; font-size: 0.875rem; }

        /* 🆕 Calendar View Styles */
        .calendar-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); cursor: pointer; }
        .calendar-nav-btn:hover { background-color: var(--bg-hover); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-header { text-align: center; font-weight: 700; color: var(--text-secondary); padding: 12px; font-size: 0.875rem; }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
            position: relative;
        }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .calendar-day.inactive { opacity: 0.3; cursor: default; }
        .calendar-day.inactive:hover { transform: none; box-shadow: none; }
        .calendar-day.today { border-color: var(--accent-primary); border-width: 3px; }
        .calendar-day-number { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .calendar-day-htp { font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
        .calendar-day.excellent { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); }
        .calendar-day.good { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%); }
        .calendar-day.average { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%); }
        .calendar-day.poor { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); }
        .calendar-day.no-data { background-color: var(--bg-tertiary); }
        .calendar-legend { display: flex; gap: 16px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .calendar-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; }
        .calendar-legend-color { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--border-color); }

        /* 🆕 Ranking/Leaderboard Styles */
        .ranking-card { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 16px; }
        .ranking-podium { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; align-items: end; }
        .podium-item { text-align: center; padding: 20px; border-radius: 12px; transition: all 0.3s ease; cursor: pointer; }
        .podium-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .podium-first { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); order: 2; padding-top: 40px; }
        .podium-second { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); order: 1; }
        .podium-third { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); order: 3; }
        .podium-rank { font-size: 3rem; margin-bottom: 8px; }
        .podium-name { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 4px; }
        .podium-score { font-weight: 600; font-size: 1.5rem; color: var(--text-primary); }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: var(--bg-tertiary); border-radius: 8px; border: 2px solid var(--border-color); transition: all 0.2s ease; cursor: pointer; }
        .ranking-item:hover { background-color: var(--bg-hover); transform: translateX(4px); }
        .ranking-item.highlight-user { border-color: var(--accent-primary); background-color: rgba(59, 130, 246, 0.1); }
        .ranking-position { font-weight: 700; font-size: 1.2rem; color: var(--text-secondary); min-width: 40px; }
        .ranking-employee { font-weight: 600; flex-grow: 1; color: var(--text-primary); }
        .ranking-htp { font-weight: 700; font-size: 1.1rem; color: var(--success); }
        .ranking-change { font-size: 0.875rem; font-weight: 600; margin-left: 8px; }
        .ranking-change.up { color: var(--success); }
        .ranking-change.down { color: var(--error); }
        .ranking-change.same { color: var(--text-tertiary); }
        .ranking-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .ranking-tab { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; text-align: center; cursor: pointer; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s ease; }
        .ranking-tab:hover { background-color: var(--bg-hover); }
        .ranking-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); }

        /* 🆕 Employee Detail Modal Styles */
        .employee-detail-header { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0; margin: -24px -24px 24px -24px; }
        .employee-detail-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .employee-stat-card { background-color: var(--bg-tertiary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); }
        .employee-stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; font-weight: 600; }
        .employee-stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); margin-top: 4px; }
        .employee-chart-container { background-color: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .trend-indicator { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; }
        .trend-indicator.positive { background-color: rgba(16, 185, 129, 0.2); color: var(--success); }
        .trend-indicator.negative { background-color: rgba(239, 68, 68, 0.2); color: var(--error); }
        .trend-indicator.neutral { background-color: var(--bg-tertiary); color: var(--text-tertiary); }

        /* 🆕 Hidden Employee Styles */
        .hidden-employee-indicator { 
            position: absolute; 
            right: 8px; 
            top: 50%; 
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            color: var(--error);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
            animation: pulse-hidden 2s infinite;
        }
        
        @keyframes pulse-hidden {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .hide-employee-btn {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hide-employee-btn:hover {
            background-color: var(--error);
            color: white;
        }
        .show-employee-btn {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .show-employee-btn:hover {
            background-color: var(--success);
            color: white;
        }
        .hidden-employees-panel {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-top: 0;
            max-height: 0;
            opacity: 0;
            transform: translateY(-6px);
            overflow: hidden;
            padding: 0 16px;
            pointer-events: none;
            transition: max-height 0.32s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.2s ease,
                        transform 0.24s ease,
                        margin-top 0.24s ease,
                        padding 0.24s ease;
            will-change: max-height, opacity, transform;
        }
        .hidden-employees-panel.is-open {
            max-height: 460px;
            opacity: 1;
            transform: translateY(0);
            margin-top: 12px;
            padding: 14px 16px;
            pointer-events: auto;
            overflow-y: auto;
            overscroll-behavior: contain;
        }
        #manage-hidden-btn .hidden-panel-chevron {
            font-size: 0.8rem;
            transition: transform 0.24s ease;
        }
        #manage-hidden-btn.active .hidden-panel-chevron {
            transform: rotate(180deg);
        }
        .hidden-employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .show-employee-btn-small {
            background: rgba(16, 185, 129, 0.14);
            border: 1px solid rgba(16, 185, 129, 0.5);
            color: var(--success);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 700;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .show-employee-btn-small:hover {
            background: var(--success);
            color: #fff;
        }
		
		/* 🆕 Enhanced Header Styles */
        .header-gradient {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.2) 0%, 
				rgba(139, 92, 246, 0.2) 50%, 
				rgba(236, 72, 153, 0.2) 100%
            );
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899) 1;
            position: relative;
            overflow: hidden;
        }
        
        .header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            will-change: transform;
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header-toggle-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .header-toggle-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: rotate(90deg);
            color: white;
        }
        
        .logo-icon {
            font-size: 3rem;
            will-change: transform;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header-title {
            font-size: 1.75rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            line-height: 1.2;
            margin: 0;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient-shift 8s ease infinite;
            animation-play-state: paused;
        }
        .gradient-text:hover { animation-play-state: running; }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-pulse {
            color: #10b981;
            animation: pulse-dot 1.5s ease-in-out infinite;
            font-size: 1.2rem;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .status-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        
        .status-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 700;
        }
		
		/* 🆕 Employee Analysis Card Styles */
        .employee-analysis-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .employee-analysis-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .employee-name-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .employee-stat-item {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .employee-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }
        .employee-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        /* === Employee Dashboard Modal === */
        .edm-modal {
            padding: 0 !important;
            overflow: hidden;
        }
        .edm-header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            padding: 24px 28px 20px;
            color: #fff;
        }
        .edm-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .edm-name {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        .edm-process-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            margin-left: 10px;
            vertical-align: middle;
        }
        .edm-badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }
        .edm-badge-chip {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.25);
            transition: transform 0.15s;
            cursor: help;
        }
        .edm-badge-chip:hover { transform: scale(1.08); }
        .edm-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: #fff;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .edm-close:hover { background: rgba(255,255,255,0.3); }
        .edm-body {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 0;
            padding: 24px 28px 28px;
        }
        @media (max-width: 640px) {
            .edm-body { grid-template-columns: 1fr; }
            .edm-left { border-right: none !important; border-bottom: 1px solid var(--border-color); padding-bottom: 20px !important; margin-bottom: 20px; padding-right: 0 !important; }
        }
        .edm-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-right: 28px;
            border-right: 1px solid var(--border-color);
        }
        .edm-ring-wrap {
            position: relative;
            width: 140px;
            height: 140px;
        }
        .edm-ring {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(
                var(--ring-color, #3b82f6) calc(var(--pct, 0) * 1%),
                var(--bg-tertiary) 0
            );
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.6s ease;
        }
        .edm-ring-inner {
            width: 108px;
            height: 108px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .edm-ring-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.05em;
        }
        .edm-ring-value {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1;
            margin: 4px 0 2px;
        }
        .edm-ring-sub {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }
        .edm-specialty {
            margin-top: 16px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }
        .edm-specialty strong {
            color: var(--text-primary);
            font-weight: 700;
        }
        .edm-right {
            padding-left: 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        @media (max-width: 640px) {
            .edm-right { padding-left: 0; }
            #chart-modal-content .edm-left { border-right: none !important; border-bottom: 1px solid var(--border-color); padding-bottom: 20px !important; padding-right: 0 !important; }
            #chart-modal-content [style*="grid-template-columns:200px"] { grid-template-columns: 1fr !important; }
        }
        .edm-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .edm-stat {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .edm-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .edm-stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }
        .edm-stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            line-height: 1;
        }
        .edm-stat-value.green { color: #4ade80; }
        .edm-stat-value.blue { color: #60a5fa; }
        .edm-stat-value.purple { color: #a78bfa; }
        .edm-stat-value.orange { color: #fb923c; }
        .edm-stat-value.red { color: #f87171; }
        [data-theme="light"] .edm-stat-value.green { color: #16a34a; }
        [data-theme="light"] .edm-stat-value.blue { color: #2563eb; }
        [data-theme="light"] .edm-stat-value.purple { color: #7c3aed; }
        [data-theme="light"] .edm-stat-value.orange { color: #ea580c; }
        [data-theme="light"] .edm-stat-value.red { color: #dc2626; }
        .edm-progress-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        .edm-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .edm-progress-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .edm-progress-pct {
            font-size: 0.875rem;
            font-weight: 800;
        }
        .edm-progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-primary);
            overflow: hidden;
        }
        .edm-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        @keyframes edmFadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Badge in header - keep original colors but tweak for header context */
        .edm-badge-in-header {
            margin-left: 0 !important;
            border-radius: 20px !important;
            padding: 3px 10px !important;
            font-size: 0.7rem !important;
            cursor: help;
            transition: transform 0.15s, box-shadow 0.2s !important;
        }
        .edm-badge-in-header:hover {
            transform: scale(1.12) !important;
        }
        /* Modal backdrop animated gradient */
        .edm-backdrop-fx {
            background:
                radial-gradient(ellipse at 20% 50%, rgba(59,130,246,0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139,92,246,0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(236,72,153,0.08) 0%, transparent 50%);
            animation: edm-bg-shift 8s ease-in-out infinite alternate;
        }
        [data-theme="light"] .edm-backdrop-fx {
            background:
                radial-gradient(ellipse at 20% 50%, rgba(59,130,246,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139,92,246,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(236,72,153,0.04) 0%, transparent 50%);
        }
        @keyframes edm-bg-shift {
            0% { background-position: 0% 0%, 100% 0%, 50% 100%; }
            100% { background-position: 100% 100%, 0% 100%, 50% 0%; }
        }
        /* Floating dots on backdrop */
        .edm-backdrop-dots {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .edm-dot {
            position: absolute;
            border-radius: 50%;
            opacity: 0;
            animation: edm-float linear infinite;
        }
        @keyframes edm-float {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100vh) scale(1); }
        }
        /* Toolbar action buttons */
        .toolbar-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .toolbar-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toolbar-action-btn:active {
            transform: translateY(0);
        }
        .toolbar-action-btn.btn-capture {
            border-color: rgba(59,130,246,0.4);
        }
        .toolbar-action-btn.btn-capture:hover {
            background: rgba(59,130,246,0.15);
            border-color: rgba(59,130,246,0.6);
            color: #60a5fa;
        }
        .toolbar-action-btn.btn-excel {
            border-color: rgba(34,197,94,0.4);
        }
        .toolbar-action-btn.btn-excel:hover {
            background: rgba(34,197,94,0.15);
            border-color: rgba(34,197,94,0.6);
            color: #4ade80;
        }
        [data-theme="light"] .toolbar-action-btn.btn-capture:hover {
            background: rgba(59,130,246,0.1);
            color: #2563eb;
        }
        [data-theme="light"] .toolbar-action-btn.btn-excel:hover {
            background: rgba(34,197,94,0.1);
            color: #16a34a;
        }

        .best-performance-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .best-performance-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .best-performance-detail {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .performance-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .performance-badge.pick {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        .performance-badge.pack {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        /* 🆕 Loading Progress Bar */
        #loading-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            z-index: 9999;
            display: none;
        }
        #loading-progress-bar.active {
            display: block;
        }
        #loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            width: 0%;
            transition: width 0.3s ease;
        }
        #loading-status-text {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            display: none;
        }
        #loading-status-text.active {
            display: block;
        }

        /* 🎨 라이트 모드 사이드바 스타일 */
        [data-theme="light"] #sidebar {
            background: linear-gradient(to bottom, #f0f9ff, #e0f2fe) !important;
            border-right: 2px solid #3b82f6 !important;
        }

        [data-theme="light"] #sidebar h2 {
            background: linear-gradient(to right, #2563eb, #7c3aed) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            color: transparent !important;
        }

        /* 숨긴 작업자 - 라이트 모드 */
        [data-theme="light"] #sidebar > div:nth-child(2) {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb) !important;
            border: 1px solid #d1d5db !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(2) h3 {
            color: #1f2937 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(2) button {
            background: linear-gradient(to right, #6b7280, #4b5563) !important;
        }

        [data-theme="light"] #hidden-count-badge {
            background: linear-gradient(to right, #ef4444, #ec4899) !important;
        }

        /* 시간대별 필터 - 라이트 모드 (파랑) */
        [data-theme="light"] #sidebar > div:nth-child(3) {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
            border: 1px solid #60a5fa !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(3) h3 {
            color: #1e3a8a !important;
        }

        [data-theme="light"] #select-day-shift {
            background: linear-gradient(to right, #fbbf24, #f59e0b) !important;
        }

        [data-theme="light"] #select-swing-shift {
            background: linear-gradient(to right, #8b5cf6, #7c3aed) !important;
        }

        [data-theme="light"] #all-hours-checkbox {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        [data-theme="light"] .hour-filter-btn {
            background-color: #e5e7eb !important;
            border-color: #9ca3af !important;
            color: #4b5563 !important;
        }

        [data-theme="light"] .hour-filter-btn.bg-blue-500 {
            background-color: #3b82f6 !important;
            border-color: #2563eb !important;
            color: white !important;
        }

        /* 층별 필터 - 라이트 모드 (초록) */
        [data-theme="light"] #sidebar > div:nth-child(4) {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
            border: 1px solid #34d399 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(4) h3 {
            color: #065f46 !important;
        }

        /* 팩 종류 필터 - 라이트 모드 (주황) */
        [data-theme="light"] #sidebar > div:nth-child(5) {
            background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
            border: 1px solid #fb923c !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(5) h3 {
            color: #7c2d12 !important;
        }

        /* Target HTP - 라이트 모드 (보라) */
        [data-theme="light"] #sidebar > div:nth-child(6) {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe) !important;
            border: 1px solid #a855f7 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(6) h3 {
            color: #581c87 !important;
        }

        /* 체크박스 라벨 - 라이트 모드 */
        [data-theme="light"] #sidebar label {
            background-color: rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="light"] #sidebar label:hover {
            background-color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="light"] #sidebar label span {
            color: #1f2937 !important;
        }

        /* 버튼 - 라이트 모드 */
        [data-theme="light"] #select-all-hours,
        [data-theme="light"] #select-all-floors,
        [data-theme="light"] #select-all-packtypes {
            background: linear-gradient(to right, #10b981, #059669) !important;
        }

        [data-theme="light"] #deselect-all-hours,
        [data-theme="light"] #deselect-all-floors,
        [data-theme="light"] #deselect-all-packtypes {
            background: linear-gradient(to right, #ef4444, #dc2626) !important;
        }

        /* 체크박스 - 라이트 모드 */
        [data-theme="light"] .form-checkbox {
            border-color: #9ca3af !important;
            background-color: white !important;
        }

        [data-theme="light"] .form-checkbox:checked {
            background-color: #3b82f6 !important;
            border-color: #2563eb !important;
        }

        /* 🎯 뱃지 툴팁 스타일 */
        .cursor-help {
            cursor: help;
        }

        /* 툴팁이 잘 보이도록 추가 스타일 */
        [title] {
            position: relative;
        }
		
		/* 🆕 History Top Performers Enhanced Styles */
        .top-performer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .top-performer-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .top-performer-item:hover::before {
            left: 100%;
        }

        .top-performer-item:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        /* 🥇 1위 스타일 */
        .top-performer-item.rank-1 {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border-color: #fbbf24;
            animation: pulse-gold 2s infinite;
        }

        .top-performer-item.rank-1 .performer-name {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .top-performer-item.rank-1 .performer-htp {
            color: #fbbf24;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
            animation: glow-gold 1.5s infinite alternate;
        }

        .top-performer-item.rank-1 .medal-icon {
            font-size: 2rem;
            animation: rotate-medal 3s infinite;
        }

        @keyframes pulse-gold {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            }
            50% { 
                box-shadow: 0 0 40px rgba(251, 191, 36, 0.8);
            }
        }

        @keyframes glow-gold {
            from { text-shadow: 0 0 10px rgba(251, 191, 36, 0.6); }
            to { text-shadow: 0 0 20px rgba(251, 191, 36, 1); }
        }

        @keyframes rotate-medal {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-15deg) scale(1.1); }
            75% { transform: rotate(15deg) scale(1.1); }
        }

        /* 🥈 2위 스타일 */
        .top-performer-item.rank-2 {
            background: linear-gradient(135deg, rgba(229, 231, 235, 0.2) 0%, rgba(156, 163, 175, 0.2) 100%);
            border-color: #9ca3af;
            animation: pulse-silver 2s infinite;
        }

        .top-performer-item.rank-2 .performer-name {
            background: linear-gradient(135deg, #f3f4f6, #9ca3af, #6b7280);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .top-performer-item.rank-2 .performer-htp {
            color: #d1d5db;
            font-weight: 700;
            animation: glow-silver 1.5s infinite alternate;
        }

        .top-performer-item.rank-2 .medal-icon {
            font-size: 1.8rem;
            animation: bounce-medal 2s infinite;
        }

        @keyframes pulse-silver {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(156, 163, 175, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(156, 163, 175, 0.6);
            }
        }

        @keyframes glow-silver {
            from { text-shadow: 0 0 8px rgba(209, 213, 219, 0.5); }
            to { text-shadow: 0 0 16px rgba(209, 213, 219, 0.9); }
        }

        @keyframes bounce-medal {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* 🥉 3위 스타일 */
        .top-performer-item.rank-3 {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%);
            border-color: #fb923c;
            animation: pulse-bronze 2s infinite;
        }

        .top-performer-item.rank-3 .performer-name {
            background: linear-gradient(135deg, #fb923c, #f97316, #ea580c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .top-performer-item.rank-3 .performer-htp {
            color: #fb923c;
            font-weight: 700;
            animation: glow-bronze 1.5s infinite alternate;
        }

        .top-performer-item.rank-3 .medal-icon {
            font-size: 1.6rem;
            animation: swing-medal 2s infinite;
        }

        @keyframes pulse-bronze {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(251, 146, 60, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(251, 146, 60, 0.6);
            }
        }

        @keyframes glow-bronze {
            from { text-shadow: 0 0 8px rgba(251, 146, 60, 0.5); }
            to { text-shadow: 0 0 16px rgba(251, 146, 60, 0.9); }
        }

        @keyframes swing-medal {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* 4-10위 스타일 */
        .top-performer-item.rank-other {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-color: var(--border-color);
        }

        .top-performer-item.rank-other:hover {
            border-color: var(--accent-primary);
        }

        .top-performer-item.rank-other .performer-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .top-performer-item.rank-other .performer-htp {
            color: var(--success);
            font-weight: 600;
        }

        .top-performer-item.rank-other .rank-number {
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* 공통 요소 */
        .performer-name {
            font-size: 1rem;
            flex-grow: 1;
            margin-left: 12px;
        }

        .performer-htp {
            font-size: 1.1rem;
            min-width: 80px;
            text-align: right;
        }

        .medal-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
        }

        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            font-size: 1.1rem;
        }

        /* 라이트 모드 조정 */
        [data-theme="light"] .top-performer-item.rank-1 .performer-name {
            background: linear-gradient(135deg, #d97706, #b45309, #92400e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .top-performer-item.rank-2 .performer-name {
            background: linear-gradient(135deg, #4b5563, #374151, #1f2937);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .top-performer-item.rank-3 .performer-name {
            background: linear-gradient(135deg, #c2410c, #9a3412, #7c2d12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
    <style id="ux-refresh-overrides">
        :root {
            --font-ui: 'Pretendard', 'Noto Sans KR', sans-serif;
            --accent-primary: #0f766e;
            --accent-secondary: #2563eb;
            --bg-primary: #f4f7fb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #edf2f7;
            --bg-hover: #e2eaf4;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-tertiary: #64748b;
            --border-color: #dce6f3;
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.05);
            --shadow-md: 0 12px 28px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 24px 52px rgba(15, 23, 42, 0.12);
        }

        [data-theme="dark"] {
            --bg-primary: #090f1c;
            --bg-secondary: #121a2d;
            --bg-tertiary: #1d2940;
            --bg-hover: #263654;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #31425f;
            --shadow-sm: 0 2px 8px rgba(2, 6, 23, 0.35);
            --shadow-md: 0 12px 28px rgba(2, 6, 23, 0.42);
            --shadow-lg: 0 24px 52px rgba(2, 6, 23, 0.48);
        }

        html,
        body,
        button,
        input,
        select,
        textarea,
        label,
        table,
        th,
        td {
            font-family: var(--font-ui) !important;
            letter-spacing: -0.01em;
        }

        body {
            background:
                radial-gradient(1200px 460px at -10% -20%, rgba(37, 99, 235, 0.12) 0%, rgba(37, 99, 235, 0) 70%),
                radial-gradient(900px 380px at 110% -8%, rgba(13, 148, 136, 0.14) 0%, rgba(13, 148, 136, 0) 72%),
                var(--bg-primary);
        }

        .header-gradient {
            border-bottom: 1px solid rgba(15, 118, 110, 0.24);
            background:
                linear-gradient(132deg, rgba(13, 148, 136, 0.2), rgba(30, 64, 175, 0.15)),
                linear-gradient(180deg, rgba(15, 23, 42, 0.08), rgba(15, 23, 42, 0));
            backdrop-filter: blur(8px);
        }

        .status-card {
            border-color: rgba(15, 118, 110, 0.32);
            background: linear-gradient(145deg, rgba(15, 118, 110, 0.16), rgba(37, 99, 235, 0.1));
        }

        .control-panel-card {
            background: color-mix(in srgb, var(--bg-secondary) 88%, transparent);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(6px);
        }

        .control-panel-card input[type="text"] {
            border-radius: 10px;
        }

        .toolbar-action-btn {
            border-color: rgba(37, 99, 235, 0.22);
            background: linear-gradient(145deg, color-mix(in srgb, var(--bg-secondary) 92%, transparent), var(--bg-tertiary));
            color: var(--text-primary);
        }

        .toolbar-action-btn.btn-capture:hover,
        .toolbar-action-btn.btn-excel:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        }

        .toolbar-action-btn.btn-preset-save {
            border-color: rgba(13, 148, 136, 0.36);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.2), rgba(15, 118, 110, 0.08));
            color: #0f766e;
        }

        .toolbar-action-btn.btn-preset-save:hover {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.28), rgba(15, 118, 110, 0.16));
        }

        .toolbar-action-btn.btn-preset-load {
            border-color: rgba(37, 99, 235, 0.36);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(30, 64, 175, 0.08));
            color: #1d4ed8;
        }

        .toolbar-action-btn.btn-preset-load:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.28), rgba(30, 64, 175, 0.16));
        }

        [data-theme="dark"] .toolbar-action-btn.btn-preset-save {
            color: #5eead4;
        }

        [data-theme="dark"] .toolbar-action-btn.btn-preset-load {
            color: #93c5fd;
        }

        .target-htp-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .target-htp-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 4px 4px;
        }

        .target-htp-toolbar-title {
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: rgba(226, 232, 240, 0.85);
        }

        .target-htp-reset-all {
            border: 1px solid rgba(148, 163, 184, 0.32);
            background: rgba(15, 23, 42, 0.22);
            color: rgba(226, 232, 240, 0.9);
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            line-height: 1;
            padding: 7px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .target-htp-reset-all:hover {
            border-color: rgba(96, 165, 250, 0.55);
            background: rgba(37, 99, 235, 0.22);
        }

        .target-htp-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .target-htp-item {
            border: 1px solid rgba(148, 163, 184, 0.26);
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.3), rgba(15, 23, 42, 0.12));
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .target-htp-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .target-htp-name {
            font-size: 0.77rem;
            font-weight: 700;
            color: #f1f5f9;
            line-height: 1.35;
        }

        .target-htp-default {
            font-size: 0.68rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 999px;
            color: #93c5fd;
            background: rgba(59, 130, 246, 0.2);
            white-space: nowrap;
        }

        .target-htp-controls {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 6px;
            align-items: center;
        }

        .target-htp-step,
        .target-htp-reset {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.34);
            background: rgba(15, 23, 42, 0.35);
            color: #e2e8f0;
            font-size: 0.95rem;
            font-weight: 800;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .target-htp-step:hover,
        .target-htp-reset:hover {
            border-color: rgba(96, 165, 250, 0.62);
            background: rgba(37, 99, 235, 0.28);
        }

        .target-htp-input-wrap {
            position: relative;
        }

        .target-htp-input {
            width: 100%;
            height: 30px;
            border-radius: 9px;
            border: 1px solid rgba(148, 163, 184, 0.38);
            background: rgba(15, 23, 42, 0.45);
            color: #f8fafc;
            font-weight: 800;
            font-size: 0.82rem;
            text-align: right;
            padding: 0 38px 0 10px;
            font-variant-numeric: tabular-nums;
        }

        .target-htp-input:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.7);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .target-htp-unit {
            position: absolute;
            right: 9px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.63rem;
            color: rgba(203, 213, 225, 0.86);
            font-weight: 700;
        }

        .target-htp-range {
            width: 100%;
            height: 5px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.35), rgba(139, 92, 246, 0.45));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .target-htp-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #93c5fd;
            border: 2px solid #0f172a;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.28);
            cursor: pointer;
        }

        .target-htp-range::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #93c5fd;
            border: 2px solid #0f172a;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.28);
            cursor: pointer;
        }

        .target-htp-foot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            font-size: 0.66rem;
            color: rgba(203, 213, 225, 0.85);
            font-weight: 600;
        }

        .target-htp-value-chip {
            font-size: 0.73rem;
            font-weight: 800;
            color: #e0f2fe;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(14, 165, 233, 0.2);
            min-width: 62px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        [data-theme="light"] .target-htp-toolbar-title {
            color: var(--text-secondary);
        }

        [data-theme="light"] .target-htp-reset-all {
            background: rgba(15, 23, 42, 0.05);
            color: #334155;
            border-color: rgba(100, 116, 139, 0.35);
        }

        [data-theme="light"] .target-htp-item {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.9));
            border-color: rgba(148, 163, 184, 0.32);
        }

        [data-theme="light"] .target-htp-name {
            color: #0f172a;
        }

        [data-theme="light"] .target-htp-default {
            color: #1d4ed8;
            background: rgba(37, 99, 235, 0.12);
        }

        [data-theme="light"] .target-htp-step,
        [data-theme="light"] .target-htp-reset {
            background: rgba(241, 245, 249, 0.9);
            border-color: rgba(148, 163, 184, 0.5);
            color: #334155;
        }

        [data-theme="light"] .target-htp-step:hover,
        [data-theme="light"] .target-htp-reset:hover {
            background: rgba(219, 234, 254, 0.85);
            border-color: rgba(59, 130, 246, 0.52);
            color: #1d4ed8;
        }

        [data-theme="light"] .target-htp-input {
            background: rgba(255, 255, 255, 0.95);
            color: #0f172a;
            border-color: rgba(148, 163, 184, 0.58);
        }

        [data-theme="light"] .target-htp-unit,
        [data-theme="light"] .target-htp-foot {
            color: #64748b;
        }

        [data-theme="light"] .target-htp-value-chip {
            color: #0c4a6e;
            background: rgba(14, 165, 233, 0.16);
        }

        .view-tab {
            border-radius: 10px;
            border-color: color-mix(in srgb, var(--border-color) 88%, transparent);
        }

        .view-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            box-shadow: 0 10px 20px rgba(15, 118, 110, 0.24);
        }

        .table-container,
        .dash-command-bar,
        .dash-kpi-card,
        .hist-section-card,
        .rank-list-card {
            border-color: color-mix(in srgb, var(--border-color) 88%, transparent);
            box-shadow: var(--shadow-sm);
        }

        /* Dashboard Repair: light/dark readability + card structure */
        #dashboard-view {
            background:
                radial-gradient(circle at 7% 0%, rgba(37, 99, 235, 0.09), transparent 35%),
                radial-gradient(circle at 94% 6%, rgba(13, 148, 136, 0.1), transparent 40%),
                var(--bg-primary);
        }

        #dashboard-view > *:not(:first-child) {
            position: relative;
            z-index: 1;
        }

        .dash-command-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 18px 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: color-mix(in srgb, var(--bg-secondary) 94%, transparent);
            box-shadow: var(--shadow-sm);
        }

        .dash-command-eyebrow {
            margin: 0;
            font-size: 0.74rem;
            font-weight: 700;
            letter-spacing: 0.11em;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        .dash-command-title {
            margin: 4px 0 0;
            font-size: clamp(1.05rem, 2.3vw, 1.4rem);
            font-weight: 800;
            color: var(--text-primary);
            background: none;
            -webkit-text-fill-color: currentColor;
        }

        [data-theme="dark"] .dash-command-title {
            background: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dash-live-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(16, 185, 129, 0.35);
            background: rgba(16, 185, 129, 0.12);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .dash-live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.15);
        }

        .dash-kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 4px;
        }

        .dash-kpi-card {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: center;
            min-height: 128px;
            padding: 16px 18px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: color-mix(in srgb, var(--bg-secondary) 96%, transparent);
            overflow: hidden;
            transform: translateY(0);
        }

        .dash-kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .dash-kpi-card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent);
            opacity: 0.9;
        }

        .dash-kpi-content {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dash-kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            background: color-mix(in srgb, var(--accent) 14%, transparent);
            color: var(--accent);
            box-shadow: none;
            animation: none;
        }

        .dash-kpi-label {
            font-size: 0.74rem;
            font-weight: 700;
            color: var(--text-tertiary);
            letter-spacing: 0.07em;
            text-transform: uppercase;
            line-height: 1.35;
        }

        .dash-kpi-value {
            font-size: clamp(1.05rem, 2vw, 1.8rem);
            font-weight: 800;
            color: var(--text-primary);
            text-shadow: none;
            font-variant-numeric: tabular-nums;
        }

        .dash-kpi-blue { --accent: #2563eb; }
        .dash-kpi-green { --accent: #0f9f75; }
        .dash-kpi-purple { --accent: #7c3aed; }
        .dash-kpi-red { --accent: #dc2626; }
        .dash-kpi-amber { --accent: #d97706; }
        .dash-kpi-cyan { --accent: #0891b2; }

        .dash-insight-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 4px;
        }

        .dash-insight-card {
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: color-mix(in srgb, var(--bg-secondary) 95%, transparent);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
            min-height: 90px;
        }

        .dash-insight-title {
            margin: 0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.09em;
            font-weight: 800;
            color: var(--text-tertiary);
            line-height: 1.3;
        }

        .dash-insight-value {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.02rem;
            font-weight: 700;
            line-height: 1.42;
            font-variant-numeric: tabular-nums;
            word-break: keep-all;
        }

        .dash-process-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            padding: 10px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: color-mix(in srgb, var(--bg-secondary) 95%, transparent);
        }

        .dash-process-item {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 14px;
            background: var(--bg-tertiary);
        }

        .dash-process-item.pick {
            background: linear-gradient(145deg, color-mix(in srgb, #2563eb 16%, var(--bg-tertiary)), var(--bg-tertiary));
        }

        .dash-process-item.pack {
            background: linear-gradient(145deg, color-mix(in srgb, #d97706 16%, var(--bg-tertiary)), var(--bg-tertiary));
        }

        .dash-process-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }

        .dash-process-divider span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 800;
            box-shadow: none;
        }

        .dash-process-stat-value {
            color: var(--text-primary);
        }

        .dash-chart-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            align-items: start;
        }

        .dash-chart-card {
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: color-mix(in srgb, var(--bg-secondary) 96%, transparent);
            padding: 14px;
            box-shadow: var(--shadow-sm);
        }

        .dash-chart-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .dash-chart-title {
            color: var(--text-primary);
        }

        .dash-chart-subtitle {
            color: var(--text-tertiary);
            font-size: 0.78rem;
            font-weight: 600;
        }

        .dash-process-insight-board,
        .dash-floor-insight-board {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            padding: 10px;
        }

        .dash-process-balance-track {
            margin-top: 8px;
            height: 8px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.24);
            display: flex;
        }

        #dashboard-view .dash-chart-card-wide {
            grid-column: 1 / -1;
        }

        #dashboard-view .dash-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        #dashboard-view .dash-chart-header-v2 {
            margin-bottom: 10px;
        }

        #dashboard-view .dash-chart-card-header-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #dashboard-view .dash-chart-title-group {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        #dashboard-view .dash-chart-icon-badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(37, 99, 235, 0.13);
            color: #1d4ed8;
            flex-shrink: 0;
            font-size: 1rem;
        }

        [data-theme="dark"] #dashboard-view .dash-chart-icon-badge {
            background: rgba(96, 165, 250, 0.16);
            color: #bfdbfe;
        }

        #dashboard-view .dash-chart-title {
            margin: 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 800;
            line-height: 1.35;
        }

        #dashboard-view .dash-chart-subtitle {
            display: block;
            color: var(--text-tertiary);
            font-size: 0.78rem;
            font-weight: 600;
            line-height: 1.35;
        }

        #dashboard-view .dash-chart-footer {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(132px, 1fr));
            gap: 8px;
        }

        #dashboard-view .dash-chart-card--process .dash-chart-footer {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        #dashboard-view .dash-chart-stat {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-tertiary);
            padding: 8px 10px;
            min-height: 58px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        #dashboard-view .dash-chart-card--process .dash-chart-stat {
            min-height: 66px;
            padding: 10px 12px;
        }

        #dashboard-view .dash-chart-stat-label {
            font-size: 0.68rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            font-weight: 700;
            line-height: 1.3;
        }

        #dashboard-view .dash-chart-stat-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1.35;
        }

        #dashboard-view .dash-chart-stat-value.pick {
            color: #2563eb;
        }

        #dashboard-view .dash-chart-stat-value.pack {
            color: #d97706;
        }

        #dashboard-view .dash-chart-card--process .dash-chart-stat-value {
            font-size: 1.06rem;
            line-height: 1.3;
        }

        #dashboard-view .dash-process-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        #dashboard-view .dash-process-tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 56px;
            height: 26px;
            padding: 0 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 800;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            box-shadow: none;
        }

        #dashboard-view .dash-process-tag.pick {
            color: #1d4ed8;
            background: rgba(37, 99, 235, 0.16);
            border: 1px solid rgba(37, 99, 235, 0.25);
        }

        #dashboard-view .dash-process-tag.pack {
            color: #b45309;
            background: rgba(217, 119, 6, 0.16);
            border: 1px solid rgba(217, 119, 6, 0.25);
        }

        [data-theme="dark"] #dashboard-view .dash-process-tag.pick {
            color: #93c5fd;
        }

        [data-theme="dark"] #dashboard-view .dash-process-tag.pack {
            color: #fcd34d;
        }

        #dashboard-view .dash-process-label {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        #dashboard-view .dash-process-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        #dashboard-view .dash-process-stat {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.45);
            padding: 8px 9px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        [data-theme="dark"] #dashboard-view .dash-process-stat {
            background: rgba(15, 23, 42, 0.3);
        }

        #dashboard-view .dash-process-stat-label {
            font-size: 0.66rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            font-weight: 700;
            line-height: 1.3;
        }

        #dashboard-view .dash-process-stat-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.3;
            font-variant-numeric: tabular-nums;
        }

        #dashboard-view .dash-meter-row {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #dashboard-view .dash-meter-label {
            font-size: 0.76rem;
            font-weight: 700;
            color: var(--text-secondary);
            line-height: 1.35;
        }

        #dashboard-view .dash-meter-track {
            height: 7px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.24);
        }

        #dashboard-view .dash-meter-fill {
            height: 100%;
            border-radius: inherit;
            transition: width 0.24s ease;
        }

        #dashboard-view .dash-meter-fill.pick {
            background: linear-gradient(90deg, #2563eb, #60a5fa);
        }

        #dashboard-view .dash-meter-fill.pack {
            background: linear-gradient(90deg, #d97706, #fbbf24);
        }

        #dashboard-view .dash-process-chip-row,
        #dashboard-view .dash-floor-chip-row,
        #dashboard-view .dash-pack-chip-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        #dashboard-view .dash-chart-card--process .dash-process-chip-row {
            margin-bottom: 10px;
        }

        #dashboard-view .dash-process-chip,
        #dashboard-view .dash-floor-chip,
        #dashboard-view .dash-pack-chip {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-tertiary);
            padding: 8px 10px;
        }

        #dashboard-view .dash-chart-card--process .dash-process-chip {
            padding: 10px 11px;
        }

        #dashboard-view .dash-process-chip-label,
        #dashboard-view .dash-floor-chip-label,
        #dashboard-view .dash-pack-chip-label {
            display: block;
            font-size: 0.63rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            font-weight: 700;
            line-height: 1.3;
        }

        #dashboard-view .dash-process-chip-value,
        #dashboard-view .dash-floor-chip-value,
        #dashboard-view .dash-pack-chip-value {
            display: block;
            margin-top: 4px;
            font-size: 0.86rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.35;
            font-variant-numeric: tabular-nums;
        }

        #dashboard-view .dash-floor-insight-board,
        #dashboard-view .dash-pack-insight-hero,
        #dashboard-view .dash-pack-row,
        #dashboard-view .dash-process-insight-board {
            box-shadow: none;
        }

        #dashboard-view .dash-chart-card--process .dash-process-insight-board {
            margin-top: 12px;
            padding: 12px;
        }

        #dashboard-view .dash-floor-mini-list,
        #dashboard-view .dash-pack-insight-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #dashboard-view .dash-chart-card--floor .dash-floor-mini-list {
            max-height: 186px;
            overflow-y: auto;
            padding-right: 4px;
        }

        #dashboard-view .dash-chart-card--packmix .dash-pack-insight-list {
            max-height: 186px;
            overflow-y: auto;
            padding-right: 4px;
        }

        #dashboard-view .dash-floor-rank-item {
            display: grid;
            grid-template-columns: 28px 1fr auto;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            padding: 7px 10px;
        }

        #dashboard-view .dash-chart-card--floor .dash-floor-rank-item {
            min-height: 38px;
        }

        #dashboard-view .dash-floor-rank-item.best {
            border-color: rgba(124, 58, 237, 0.38);
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.13), rgba(124, 58, 237, 0.03));
        }

        #dashboard-view .dash-floor-rank-pos {
            font-size: 0.72rem;
            font-weight: 800;
            color: var(--text-tertiary);
        }

        #dashboard-view .dash-floor-rank-name {
            font-size: 0.83rem;
            font-weight: 700;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #dashboard-view .dash-floor-rank-val {
            font-size: 0.82rem;
            font-weight: 800;
            color: #7c3aed;
            font-variant-numeric: tabular-nums;
        }

        #dashboard-view .dash-floor-empty,
        #dashboard-view .dash-pack-empty,
        #dashboard-view .dash-top-empty {
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            padding: 10px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-align: center;
        }

        #dashboard-view .dash-pack-insight-hero {
            border: 1px solid rgba(13, 148, 136, 0.3);
            border-radius: 10px;
            background: linear-gradient(145deg, rgba(13, 148, 136, 0.1), rgba(13, 148, 136, 0.03));
            padding: 10px;
            margin-bottom: 8px;
        }

        #dashboard-view .dash-pack-hero-label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--text-tertiary);
            font-weight: 700;
        }

        #dashboard-view .dash-pack-hero-value {
            display: block;
            margin-top: 4px;
            font-size: 1.05rem;
            font-weight: 800;
            color: #0f766e;
            font-variant-numeric: tabular-nums;
        }

        [data-theme="dark"] #dashboard-view .dash-pack-hero-value {
            color: #5eead4;
        }

        #dashboard-view .dash-pack-hero-state {
            display: block;
            margin-top: 3px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            line-height: 1.35;
        }

        #dashboard-view .dash-pack-row {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            padding: 8px 10px;
        }

        #dashboard-view .dash-chart-card--packmix .dash-pack-row {
            min-height: 52px;
        }

        #dashboard-view .dash-pack-row.top {
            border-color: rgba(13, 148, 136, 0.4);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.12), rgba(13, 148, 136, 0.03));
        }

        #dashboard-view .dash-pack-row-head {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: center;
        }

        #dashboard-view .dash-pack-row-name {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #dashboard-view .dash-pack-row-meta {
            font-size: 0.73rem;
            font-weight: 700;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        #dashboard-view .dash-pack-row-track {
            margin-top: 6px;
            height: 6px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.24);
        }

        #dashboard-view .dash-pack-row-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #0d9488, #2dd4bf);
            transition: width 0.24s ease;
        }

        #dashboard-view .dash-top-section {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        #dashboard-view .dash-top-header {
            border-radius: 10px 10px 0 0;
            padding: 8px 10px;
            font-size: 0.72rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        #dashboard-view .dash-top-header.pick {
            color: #2563eb;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(37, 99, 235, 0.05));
            border-bottom: 2px solid rgba(37, 99, 235, 0.32);
        }

        #dashboard-view .dash-top-header.pack {
            color: #b45309;
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.16), rgba(217, 119, 6, 0.05));
            border-bottom: 2px solid rgba(217, 119, 6, 0.32);
        }

        #dashboard-view .dash-top-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #dashboard-view .dash-chart-card-wide .dash-top-list {
            max-height: 234px;
            overflow-y: auto;
            padding-right: 4px;
        }

        #dashboard-view .dash-top-item {
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            padding: 10px 12px;
        }

        #dashboard-view .dash-top-item.top3 {
            background: linear-gradient(135deg, var(--bg-tertiary), rgba(37, 99, 235, 0.08));
        }

        #dashboard-view .dash-top-medal,
        #dashboard-view .dash-top-rank {
            min-width: 22px;
            text-align: center;
            font-weight: 700;
        }

        #dashboard-view .dash-top-rank {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }

        #dashboard-view .dash-top-name {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.84rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        #dashboard-view .dash-top-htp {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--success);
            font-variant-numeric: tabular-nums;
        }

        #dashboard-view,
        #history-view,
        #calendar-view,
        #ranking-view {
            content-visibility: auto;
            contain-intrinsic-size: 900px;
        }

        button:focus-visible,
        input:focus-visible,
        .view-tab:focus-visible {
            outline: 2px solid color-mix(in srgb, var(--accent-primary) 80%, white);
            outline-offset: 2px;
        }

        body.motion-paused * {
            animation-play-state: paused !important;
        }

        @media (max-width: 1023px) {
            .control-panel-card {
                border-radius: 12px;
            }

            .dash-kpi-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .dash-insight-grid {
                grid-template-columns: 1fr;
            }

            .dash-chart-grid {
                grid-template-columns: 1fr;
            }

            .dash-process-summary {
                grid-template-columns: 1fr;
            }

            .dash-process-divider {
                padding: 4px 0;
            }

            #dashboard-view .dash-process-stats {
                grid-template-columns: 1fr;
            }

            #dashboard-view .dash-process-chip-row,
            #dashboard-view .dash-floor-chip-row,
            #dashboard-view .dash-pack-chip-row {
                grid-template-columns: 1fr;
            }

            #dashboard-view .dash-chart-footer {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            #dashboard-view .dash-chart-card--process .dash-chart-footer {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            #dashboard-view .dash-chart-footer {
                grid-template-columns: 1fr;
            }

            .target-htp-controls {
                grid-template-columns: auto 1fr auto;
            }

            .target-htp-reset {
                width: 100%;
                height: 28px;
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .toolbar-action-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }

            #stats-display {
                font-size: 0.8rem;
                line-height: 1.45;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

<!-- 🆕 Loading Progress Bar -->
<div id="loading-progress-bar">
    <div id="loading-progress-fill"></div>
</div>
<div id="loading-status-text"></div>

<div id="app-container" class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gradient-to-b from-gray-800 to-gray-900 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto border-r-2 border-purple-500">
        <div class="flex items-center justify-between pb-3 border-b-2 border-purple-500">
            <h2 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">⚙️ 필터 및 설정</h2>
            <!-- Theme Toggle -->
            <div class="theme-toggle" id="theme-toggle">
                <div class="theme-toggle-slider">
                    <span id="theme-icon">🌙</span>
                </div>
            </div>
        </div>
        
        <!-- 🆕 Hidden Employees Management -->
        <div class="bg-gradient-to-br from-gray-700 to-gray-800 p-4 rounded-xl shadow-lg border border-gray-600">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="text-2xl">👻</span>
                    <span>숨긴 작업자</span>
                </h3>
                <span id="hidden-count-badge" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">0</span>
            </div>
            <button id="manage-hidden-btn" class="w-full py-2.5 px-4 text-sm font-bold rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 text-white shadow-md transition-all duration-200 flex items-center justify-between" aria-expanded="false">
                <span>관리하기</span>
                <span class="hidden-panel-chevron" aria-hidden="true">▾</span>
            </button>
            <div id="hidden-employees-list" class="hidden-employees-panel" aria-hidden="true">
                <p class="text-sm text-gray-400 mb-2">숨긴 작업자가 없습니다.</p>
            </div>
        </div>

        <!-- Time Filters -->
        <div class="bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl shadow-lg border border-blue-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">⏰</span>
                <span>시간대별 필터</span>
            </h3>
            
            <!-- DAY/SWING 빠른 선택 -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button id="select-day-shift" class="shift-quick-btn group relative overflow-hidden py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white shadow-lg transform hover:scale-105">
                    <div class="relative z-10">
                        <div class="text-xl mb-1">☀️</div>
                        <div class="font-extrabold">DAY</div>
                        <div class="text-xs opacity-90">09-18시</div>
                    </div>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                </button>
                <button id="select-swing-shift" class="shift-quick-btn group relative overflow-hidden py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg transform hover:scale-105">
                    <div class="relative z-10">
                        <div class="text-xl mb-1">🌙</div>
                        <div class="font-extrabold">SWING</div>
                        <div class="text-xs opacity-90">19-08시</div>
                    </div>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                </button>
            </div>
            
            <div class="space-y-2">
                <label class="flex items-center gap-3 text-sm cursor-pointer bg-gray-800 bg-opacity-50 px-3 py-2 rounded-lg hover:bg-opacity-70 transition-all">
                    <input type="checkbox" id="all-hours-checkbox" class="form-checkbox w-5 h-5 rounded border-2 border-purple-400 text-purple-500 focus:ring-2 focus:ring-purple-400" checked>
                    <span class="font-bold text-white">전체 시간</span>
                </label>
                <div id="hour-filters" class="grid grid-cols-4 gap-1.5 pt-2"></div>
                <div class="flex gap-2 pt-3 border-t border-blue-400">
                    <button id="select-all-hours" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                        ✓ 모두
                    </button>
                    <button id="deselect-all-hours" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                        ✗ 해제
                    </button>
                </div>
            </div>
        </div>

        <!-- Floor Filters -->
        <div class="bg-gradient-to-br from-green-900 to-teal-900 p-4 rounded-xl shadow-lg border border-green-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">📶</span>
                <span>층별 필터 (집품)</span>
            </h3>
            <div id="floor-filters" class="space-y-1"></div>
            <div class="flex gap-2 pt-3 mt-2 border-t border-green-400">
                <button id="select-all-floors" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ✓ 모두
                </button>
                <button id="deselect-all-floors" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ✗ 해제
                </button>
            </div>
        </div>

        <!-- Pack Type Filters -->
        <div class="bg-gradient-to-br from-orange-900 to-red-900 p-4 rounded-xl shadow-lg border border-orange-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">📦</span>
                <span>팩 종류 필터 (포장)</span>
            </h3>
            <div id="pack-type-filters" class="space-y-1"></div>
             <div class="flex gap-2 pt-3 mt-2 border-t border-orange-400">
                <button id="select-all-packtypes" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ✓ 모두
                </button>
                <button id="deselect-all-packtypes" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ✗ 해제
                </button>
            </div>
        </div>
        
        <!-- Target HTP Settings -->
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 p-4 rounded-xl shadow-lg border border-purple-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">🎯</span>
                <span>Target HTP 설정</span>
            </h3>
            <div id="target-htp-settings" class="space-y-1 text-sm"></div>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
	
	<!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col">
        <div class="header-gradient shadow-lg p-6 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-desktop" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="header-content">
                        <div class="flex items-center gap-3">
                            <div class="logo-icon">🚀</div>
                            <div>
                                <h1 class="header-title">
                                    <span class="gradient-text">GWJ2 OB PICK & PACK</span>
                                    <span class="version-badge">v3.2</span>
                                </h1>
                                <p class="header-subtitle">
                                    <span class="status-pulse">●</span>
                                    한 명이 엑셀을 올리면 모두에게 실시간으로 반영됩니다
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="status-indicator" class="status-card">
                    <div class="status-dot status-disconnected"></div>
                    <div>
                        <div class="status-label">연결 상태</div>
                        <div class="status-value">확인 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4 flex flex-col flex-shrink-0">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="control-panel-card bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <button id="filter-all" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md active">전체</button>
                    <button id="filter-pick" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">🟦 PICK</button>
                    <button id="filter-pack" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">🟨 PACK</button>
                </div>
                <div class="control-panel-card bg-gray-800 p-3 rounded-lg flex items-center">
                    <input type="text" id="search-input" placeholder="🔍 이름(쿠코드) 검색..." class="w-full rounded-md py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="control-panel-card bg-gray-800 p-3 rounded-lg flex items-center gap-2 flex-wrap">
                    <label class="flex items-center cursor-pointer flex-shrink-0 toolbar-action-btn" style="padding:5px 12px;border-color:rgba(239,68,68,0.35);gap:8px;">
                        <input type="checkbox" id="low-htp-toggle" class="sr-only peer">
                        <div class="relative w-9 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500" style="flex-shrink:0;"></div>
                        <span class="text-xs font-semibold" style="white-space:nowrap;">저조자만</span>
                    </label>
                    <button id="capture-btn" class="toolbar-action-btn btn-capture"><span style="font-size:1rem;">📷</span> 캡처</button>
                    <button id="export-btn" class="toolbar-action-btn btn-excel"><span style="font-size:1rem;">📊</span> 엑셀</button>
                    <button id="save-filter-preset-btn" class="toolbar-action-btn btn-preset-save" title="현재 필터 상태 저장">
                        <span style="font-size:1rem;">💾</span> 저장
                    </button>
                    <button id="load-filter-preset-btn" class="toolbar-action-btn btn-preset-load" title="저장한 필터 상태 복원">
                        <span style="font-size:1rem;">↺</span> 복원
                    </button>
                </div>
            </div>
            
            <!-- Ticker -->
            <div id="ticker-container">
                <div id="ticker-text-wrapper">
                    <div id="ticker-text">
                        <span class="ticker-loading" style="color: var(--text-secondary); font-size: 14px;">
                            📊 엑셀 파일을 업로드하면 PICK/PACK TOP3/LOW3가 표시됩니다
                        </span>
                    </div>
                </div>
            </div>

            <!-- Stats & Upload -->
            <div class="control-panel-card bg-gray-800 p-3 rounded-lg flex flex-col md:flex-row justify-between items-center text-sm">
                 <div id="stats-display" class="text-gray-300 mb-2 md:mb-0 text-center md:text-left">
                    표시 그룹: <span class="font-bold text-white">-</span> | 
                    작업자 수: <span class="font-bold text-white">-</span> | 
                    총 작업량: <span class="font-bold text-white">-</span> | 
                    평균 HTP: <span class="font-bold text-white">-</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p>마지막 업데이트: <span id="last-updated" class="font-semibold text-gray-200">데이터 없음</span></p>
                        <p>업로더: <span id="last-uploader" class="font-semibold text-gray-200">데이터 없음</span></p>
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                    <label for="file-upload" class="cursor-pointer py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">엑셀 업로드</label>
                </div>
            </div>
        </div>

        <!-- View Switcher (5개 메뉴) -->
        <div class="px-4 pt-2">
            <div class="bg-gray-800 p-1 rounded-lg flex space-x-1 overflow-x-auto">
                <button id="table-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md active whitespace-nowrap">📋 데이터</button>
                <button id="dashboard-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">📊 대시보드</button>
                <button id="history-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">📈 히스토리</button>
                <button id="calendar-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">📅 캘린더</button>
                <button id="ranking-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">🏆 랭킹</button>
            </div>
        </div>
		
		<!-- Table View -->
        <div id="table-view" class="flex flex-col flex-grow min-h-0">
            <div id="loader-container" class="flex-1 flex justify-center items-center hidden"><div class="loader"></div></div>
            <div class="table-container px-4 pb-4">
                <table id="data-table" class="min-w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processType">집품/포장<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="employee">이름(쿠코드)<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="unitQty">작업량<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="location">로케이션 및 작업대<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processPathName">PP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="packType">팩 종류<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="mh">M/H<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="htp">HTP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 text-center">보기</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-gray-800">
                        <tr id="placeholder-row"><td colspan="9" class="text-center py-10 text-gray-500">엑셀 파일을 업로드하여 데이터를 확인하세요.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Card View (hidden on desktop) -->
            <div class="mobile-card-view hidden">
                <div id="mobile-cards-container">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-5 overflow-y-auto relative">
            <!-- 🆕 Visual Wow Factors: Background Blobs -->
            <div class="absolute inset-0 overflow-hidden pointer-events-none" style="z-index: 0;">
                <div class="absolute" style="top: -10%; left: -10%; width: 40%; height: 40%; background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%); filter: blur(60px); animation: float 10s infinite alternate;"></div>
                <div class="absolute" style="bottom: -5%; right: -5%; width: 35%; height: 35%; background: radial-gradient(circle, rgba(139, 92, 246, 0.12) 0%, transparent 70%); filter: blur(50px); animation: float 8s infinite alternate-reverse;"></div>
                <div class="absolute" style="top: 40%; right: 10%; width: 25%; height: 25%; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%); filter: blur(40px); animation: float 12s infinite alternate;"></div>
            </div>

            <div class="dash-command-bar relative" style="z-index: 1;">
                <div>
                    <p class="dash-command-eyebrow">Realtime Operations</p>
                    <h2 class="dash-command-title">PICK & PACK 운영 대시보드</h2>
                </div>
                <div class="dash-live-chip">
                    <span class="dash-live-dot"></span>
                    <span>필터 기준 실시간 반영</span>
                </div>
            </div>

            <div class="dash-kpi-grid">
                <div class="dash-kpi-card dash-kpi-blue">
                    <div class="dash-kpi-icon">👥</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">총 작업자 수</span>
                        <span id="kpi-total-workers" class="dash-kpi-value">0</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#3b82f6;"></div>
                </div>
                <div class="dash-kpi-card dash-kpi-green">
                    <div class="dash-kpi-icon">📦</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">총 작업량 (Unit)</span>
                        <span id="kpi-total-qty" class="dash-kpi-value">0</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#10b981;"></div>
                </div>
                <div class="dash-kpi-card dash-kpi-purple">
                    <div class="dash-kpi-icon">📊</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">전체 평균 HTP</span>
                        <span id="kpi-avg-htp" class="dash-kpi-value">0.0</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#8b5cf6;"></div>
                </div>
                <div class="dash-kpi-card dash-kpi-red">
                    <div class="dash-kpi-icon">🚨</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">저조자 수</span>
                        <span id="kpi-low-performers" class="dash-kpi-value">0</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#ef4444;"></div>
                </div>
                <div class="dash-kpi-card dash-kpi-amber">
                    <div class="dash-kpi-icon">🎯</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">목표 달성률</span>
                        <span id="kpi-target-achievement" class="dash-kpi-value">0%</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#f59e0b;"></div>
                </div>
                <div class="dash-kpi-card dash-kpi-cyan">
                    <div class="dash-kpi-icon">⏰</div>
                    <div class="dash-kpi-content">
                        <span class="dash-kpi-label">피크 시간대</span>
                        <span id="kpi-best-hour" class="dash-kpi-value">-</span>
                    </div>
                    <div class="dash-kpi-bar" style="--kpi-color:#06b6d4;"></div>
                </div>
            </div>

            <div class="dash-insight-grid">
                <div class="dash-insight-card">
                    <div class="dash-insight-title">운영 스냅샷</div>
                    <div id="dash-insight-status" class="dash-insight-value">데이터 대기 중</div>
                </div>
                <div class="dash-insight-card">
                    <div class="dash-insight-title">공정 밸런스</div>
                    <div id="dash-insight-balance" class="dash-insight-value">PICK 0% · PACK 0%</div>
                </div>
                <div class="dash-insight-card">
                    <div class="dash-insight-title">집중 관리 포인트</div>
                    <div id="dash-insight-alert" class="dash-insight-value">분석 대기 중</div>
                </div>
            </div>

            <div class="dash-process-summary">
                <div class="dash-process-item pick">
                    <div class="dash-process-header">
                        <span class="dash-process-tag pick">PICK</span>
                        <span class="dash-process-label">집품</span>
                    </div>
                    <div class="dash-process-stats">
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">작업량</span>
                            <span id="dash-pick-qty" class="dash-process-stat-value">0</span>
                        </div>
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">평균 HTP</span>
                            <span id="dash-pick-htp" class="dash-process-stat-value">0.0</span>
                        </div>
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">작업자</span>
                            <span id="dash-pick-workers" class="dash-process-stat-value">0</span>
                        </div>
                    </div>
                    <div class="dash-meter-row">
                        <span class="dash-meter-label">작업 점유율 <strong id="dash-pick-share">0%</strong></span>
                        <div class="dash-meter-track"><div id="dash-pick-share-fill" class="dash-meter-fill pick" style="width:0%"></div></div>
                    </div>
                </div>
                <div class="dash-process-divider"><span>VS</span></div>
                <div class="dash-process-item pack">
                    <div class="dash-process-header">
                        <span class="dash-process-tag pack">PACK</span>
                        <span class="dash-process-label">포장</span>
                    </div>
                    <div class="dash-process-stats">
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">작업량</span>
                            <span id="dash-pack-qty" class="dash-process-stat-value">0</span>
                        </div>
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">평균 HTP</span>
                            <span id="dash-pack-htp" class="dash-process-stat-value">0.0</span>
                        </div>
                        <div class="dash-process-stat">
                            <span class="dash-process-stat-label">작업자</span>
                            <span id="dash-pack-workers" class="dash-process-stat-value">0</span>
                        </div>
                    </div>
                    <div class="dash-meter-row">
                        <span class="dash-meter-label">작업 점유율 <strong id="dash-pack-share">0%</strong></span>
                        <div class="dash-meter-track"><div id="dash-pack-share-fill" class="dash-meter-fill pack" style="width:0%"></div></div>
                    </div>
                </div>
            </div>

            <div class="dash-chart-grid">
                <div class="dash-chart-card dash-chart-card-wide">
                    <div class="dash-chart-header">
                        <h3 class="dash-chart-title">📈 시간대별 HTP 트렌드</h3>
                        <span class="dash-chart-subtitle">시간별 작업 효율 변화</span>
                    </div>
                    <div class="relative h-64 md:h-72"><canvas id="hourly-htp-chart"></canvas></div>
                </div>

                <div class="dash-chart-card dash-chart-card--process">
                    <div class="dash-chart-header-v2">
                        <div class="dash-chart-card-header-row">
                            <div class="dash-chart-icon-badge">🔄</div>
                            <div class="dash-chart-title-group">
                                <h3 class="dash-chart-title">프로세스별 비교</h3>
                                <span class="dash-chart-subtitle">PICK vs PACK 작업량 비율</span>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-56 md:h-64 dash-process-chart-wrap"><canvas id="process-comparison-chart"></canvas></div>
                    <div class="dash-chart-footer">
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">PICK 작업량</span>
                            <span id="stat-process-pick-qty" class="dash-chart-stat-value pick">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">PACK 작업량</span>
                            <span id="stat-process-pack-qty" class="dash-chart-stat-value pack">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">PICK Avg HTP</span>
                            <span id="stat-process-pick-htp" class="dash-chart-stat-value pick">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">PACK Avg HTP</span>
                            <span id="stat-process-pack-htp" class="dash-chart-stat-value pack">-</span>
                        </div>
                    </div>
                    <div class="dash-process-insight-board">
                        <div class="dash-process-chip-row">
                            <div class="dash-process-chip">
                                <span class="dash-process-chip-label">우세 공정</span>
                                <span id="proc-chip-dominant" class="dash-process-chip-value">-</span>
                            </div>
                            <div class="dash-process-chip">
                                <span class="dash-process-chip-label">점유율 격차</span>
                                <span id="proc-chip-share-gap" class="dash-process-chip-value">-</span>
                            </div>
                            <div class="dash-process-chip">
                                <span class="dash-process-chip-label">HTP 격차</span>
                                <span id="proc-chip-htp-gap" class="dash-process-chip-value">-</span>
                            </div>
                        </div>
                        <div class="dash-process-balance-track" role="img" aria-label="PICK PACK 점유율">
                            <div id="proc-balance-pick" class="dash-process-balance-fill pick" style="width:0%"></div>
                            <div id="proc-balance-pack" class="dash-process-balance-fill pack" style="width:0%"></div>
                        </div>
                        <div class="dash-process-balance-labels">
                            <span id="proc-balance-pick-label">PICK 0.0%</span>
                            <span id="proc-balance-pack-label">PACK 0.0%</span>
                        </div>
                        <p id="proc-insight-action" class="dash-process-action">데이터 분석 대기</p>
                    </div>
                </div>

                <div class="dash-chart-card dash-chart-card--floor">
                    <div class="dash-chart-header-v2">
                        <div class="dash-chart-card-header-row">
                            <div class="dash-chart-icon-badge">🏢</div>
                            <div class="dash-chart-title-group">
                                <h3 class="dash-chart-title">층별 평균 HTP</h3>
                                <span class="dash-chart-subtitle">집품 층별 효율</span>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-64 md:h-72"><canvas id="floor-htp-chart"></canvas></div>
                    <div class="dash-chart-footer">
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">층 수</span>
                            <span id="stat-floor-count" class="dash-chart-stat-value">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">최고 HTP 층</span>
                            <span id="stat-floor-best" class="dash-chart-stat-value">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">최저 HTP 층</span>
                            <span id="stat-floor-worst" class="dash-chart-stat-value">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">최고 HTP 값</span>
                            <span id="stat-floor-best-val" class="dash-chart-stat-value">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">층간 편차</span>
                            <span id="stat-floor-gap" class="dash-chart-stat-value">-</span>
                        </div>
                    </div>
                    <div class="dash-floor-insight-board">
                        <div class="dash-floor-chip-row">
                            <div class="dash-floor-chip">
                                <span class="dash-floor-chip-label">TOP</span>
                                <span id="floor-chip-top" class="dash-floor-chip-value">-</span>
                            </div>
                            <div class="dash-floor-chip">
                                <span class="dash-floor-chip-label">LOW</span>
                                <span id="floor-chip-low" class="dash-floor-chip-value">-</span>
                            </div>
                            <div class="dash-floor-chip">
                                <span class="dash-floor-chip-label">안정도</span>
                                <span id="floor-chip-stability" class="dash-floor-chip-value">-</span>
                            </div>
                        </div>
                        <div id="floor-insight-ranking" class="dash-floor-mini-list">
                            <div class="dash-floor-empty">PICK 데이터 없음</div>
                        </div>
                    </div>
                </div>

                <div class="dash-chart-card dash-chart-card--pack">
                    <div class="dash-chart-header-v2">
                        <div class="dash-chart-card-header-row">
                            <div class="dash-chart-icon-badge">📋</div>
                            <div class="dash-chart-title-group">
                                <h3 class="dash-chart-title">팩 종류별 작업량</h3>
                                <span class="dash-chart-subtitle">포장 유형 분포</span>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-56 md:h-64"><canvas id="pack-type-chart"></canvas></div>
                    <div class="dash-chart-footer">
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">총 팩 작업량</span>
                            <span id="stat-pack-total-qty" class="dash-chart-stat-value">-</span>
                        </div>
                        <div class="dash-chart-stat">
                            <span class="dash-chart-stat-label">팩 종류 수</span>
                            <span id="stat-pack-type-count" class="dash-chart-stat-value">-</span>
                        </div>
                    </div>
                </div>

                <div class="dash-chart-card dash-chart-card--packmix">
                    <div class="dash-chart-header-v2">
                        <div class="dash-chart-card-header-row">
                            <div class="dash-chart-icon-badge">🎯</div>
                            <div class="dash-chart-title-group">
                                <h3 class="dash-chart-title">팩 구성 인사이트</h3>
                                <span class="dash-chart-subtitle">상위 유형 집중도와 균형도</span>
                            </div>
                        </div>
                    </div>
                    <div class="dash-pack-insight-hero">
                        <span class="dash-pack-hero-label">구성 균형 점수</span>
                        <span id="pack-balance-score" class="dash-pack-hero-value">-</span>
                        <span id="pack-balance-state" class="dash-pack-hero-state">데이터 분석 대기</span>
                    </div>
                    <div class="dash-pack-chip-row">
                        <div class="dash-pack-chip">
                            <span class="dash-pack-chip-label">1위 팩</span>
                            <span id="pack-chip-top-type" class="dash-pack-chip-value">-</span>
                        </div>
                        <div class="dash-pack-chip">
                            <span class="dash-pack-chip-label">1위 비중</span>
                            <span id="pack-chip-top-share" class="dash-pack-chip-value">-</span>
                        </div>
                        <div class="dash-pack-chip">
                            <span class="dash-pack-chip-label">TOP3 비중</span>
                            <span id="pack-chip-top3-share" class="dash-pack-chip-value">-</span>
                        </div>
                    </div>
                    <div id="pack-insight-list" class="dash-pack-insight-list">
                        <div class="dash-pack-empty">PACK 데이터 없음</div>
                    </div>
                </div>

                <div class="dash-chart-card dash-chart-card-wide">
                    <div class="dash-chart-header">
                        <h3 class="dash-chart-title">🏆 Top 5 작업자</h3>
                        <span class="dash-chart-subtitle">공정별 우수 성과자</span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="dash-top-section">
                            <div class="dash-top-header pick">PICK TOP 5</div>
                            <ul id="top-pick-performers-list" class="dash-top-list"></ul>
                        </div>
                        <div class="dash-top-section">
                            <div class="dash-top-header pack">PACK TOP 5</div>
                            <ul id="top-pack-performers-list" class="dash-top-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View - Redesigned -->
        <div id="history-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-5 overflow-y-auto">
            <!-- Period Selector - Enhanced -->
            <div class="hist-period-card">
                <div class="hist-period-header">
                    <h3 class="hist-section-title">📅 분석 기간</h3>
                    <div class="hist-period-badges">
                        <button id="period-week" class="hist-period-btn active" data-period="week">
                            <span class="hist-period-icon">7</span>
                            <span>최근 7일</span>
                        </button>
                        <button id="period-month" class="hist-period-btn" data-period="month">
                            <span class="hist-period-icon">30</span>
                            <span>최근 30일</span>
                        </button>
                        <button id="period-all" class="hist-period-btn" data-period="all">
                            <span class="hist-period-icon">∞</span>
                            <span>전체</span>
                        </button>
                        <button id="period-custom" class="hist-period-btn" data-period="custom">
                            <span class="hist-period-icon">📆</span>
                            <span>사용자 지정</span>
                        </button>
                    </div>
                </div>
                <div id="custom-date-range" class="hist-date-range hidden">
                    <input type="date" id="start-date" class="hist-date-input">
                    <span class="hist-date-separator">~</span>
                    <input type="date" id="end-date" class="hist-date-input">
                    <button id="apply-custom-range" class="hist-date-apply">적용</button>
                </div>
            </div>

            <!-- History KPI Cards - Enhanced -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="hist-kpi-card">
                    <div class="hist-kpi-icon-wrap blue">📅</div>
                    <div class="hist-kpi-info">
                        <span class="hist-kpi-label">총 작업 일수</span>
                        <span id="history-kpi-days" class="hist-kpi-value">0</span>
                        <span class="hist-kpi-unit">일</span>
                    </div>
                </div>
                <div class="hist-kpi-card">
                    <div class="hist-kpi-icon-wrap green">📦</div>
                    <div class="hist-kpi-info">
                        <span class="hist-kpi-label">누적 작업량</span>
                        <span id="history-kpi-total-qty" class="hist-kpi-value">0</span>
                        <span class="hist-kpi-unit">Unit</span>
                    </div>
                </div>
                <div class="hist-kpi-card">
                    <div class="hist-kpi-icon-wrap orange">📊</div>
                    <div class="hist-kpi-info">
                        <span class="hist-kpi-label">평균 HTP</span>
                        <span id="history-kpi-avg-htp" class="hist-kpi-value">0.0</span>
                    </div>
                </div>
                <div class="hist-kpi-card">
                    <div class="hist-kpi-icon-wrap purple">🏅</div>
                    <div class="hist-kpi-info">
                        <span class="hist-kpi-label">최고 HTP</span>
                        <span id="history-kpi-max-htp" class="hist-kpi-value highlight">0.0</span>
                    </div>
                </div>
            </div>

            <!-- Employee Search & Analysis Section - Enhanced -->
            <div class="hist-section-card">
                <div class="hist-section-header">
                    <h3 class="hist-section-title">👤 사원별 상세 분석</h3>
                    <div class="hist-search-bar">
                        <div class="hist-search-input-wrap">
                            <span class="hist-search-icon">🔍</span>
                            <input
                                type="text"
                                id="history-employee-search"
                                placeholder="이름 또는 쿠코드 검색..."
                                class="hist-search-input"
                            >
                        </div>
                        <button id="history-show-all-btn" class="hist-show-all-btn">
                            전체 보기
                        </button>
                    </div>
                </div>

                <!-- Employee Analysis Results -->
                <div id="history-employee-results" class="hist-employee-grid">
                    <div class="hist-empty-state">
                        <div class="hist-empty-icon">🔍</div>
                        <p>사원을 검색하거나 "전체 보기"를 클릭하세요</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="history-pagination" class="hidden hist-pagination">
                    <button id="history-prev-page" class="hist-page-btn" disabled>
                        ◀ 이전
                    </button>
                    <span id="history-page-info" class="hist-page-info">1 / 1</span>
                    <button id="history-next-page" class="hist-page-btn">
                        다음 ▶
                    </button>
                </div>
            </div>

            <!-- Top Performers History - Enhanced -->
            <div class="hist-section-card">
                <h3 class="hist-section-title" style="margin-bottom: 16px;">🏆 기간별 Top 10 작업자</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="hist-top-column">
                        <div class="hist-top-column-header pick">
                            <span class="hist-top-tag">PICK</span>
                            <span>집품 TOP 10</span>
                        </div>
                        <div id="history-top-pick-list" class="hist-top-list"></div>
                    </div>
                    <div class="hist-top-column">
                        <div class="hist-top-column-header pack">
                            <span class="hist-top-tag">PACK</span>
                            <span>포장 TOP 10</span>
                        </div>
                        <div id="history-top-pack-list" class="hist-top-list"></div>
                    </div>
                </div>
            </div>

            <!-- Export Buttons - Enhanced -->
            <div class="hist-export-bar">
                <button id="export-history-excel" class="hist-export-btn excel">
                    <span>📊</span> 엑셀 다운로드
                </button>
                <button id="export-history-pdf" class="hist-export-btn pdf">
                    <span>📄</span> PDF 리포트
                </button>
            </div>
        </div>
		
		<!-- 🆕 Calendar View -->
        <div id="calendar-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="calendar-prev-month" class="calendar-nav-btn">◀ 이전</button>
                    <h2 id="calendar-month-title" class="text-2xl font-bold text-white">2025년 1월</h2>
                    <button id="calendar-next-month" class="calendar-nav-btn">다음 ▶</button>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- 요일 헤더 -->
                    <div class="calendar-day-header">일</div>
                    <div class="calendar-day-header">월</div>
                    <div class="calendar-day-header">화</div>
                    <div class="calendar-day-header">수</div>
                    <div class="calendar-day-header">목</div>
                    <div class="calendar-day-header">금</div>
                    <div class="calendar-day-header">토</div>
                    <!-- 날짜들이 동적으로 추가됨 -->
                </div>

                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color excellent"></div>
                        <span>우수 (목표 120% 이상)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color good"></div>
                        <span>양호 (목표 100-120%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color average"></div>
                        <span>보통 (목표 80-100%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color poor"></div>
                        <span>저조 (목표 80% 미만)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color no-data"></div>
                        <span>데이터 없음</span>
                    </div>
                </div>
            </div>
        </div>
		
		<!-- Ranking View - Redesigned -->
        <div id="ranking-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-5 overflow-y-auto">
            <!-- Ranking Controls -->
            <div class="rank-controls-card">
                <div class="rank-controls-row">
                    <div class="rank-period-tabs">
                        <button id="ranking-daily" class="rank-period-tab active">
                            <span class="rank-tab-icon">📅</span>
                            <span>일간</span>
                        </button>
                        <button id="ranking-weekly" class="rank-period-tab">
                            <span class="rank-tab-icon">📊</span>
                            <span>주간</span>
                        </button>
                        <button id="ranking-monthly" class="rank-period-tab">
                            <span class="rank-tab-icon">📈</span>
                            <span>월간</span>
                        </button>
                        <button id="ranking-all-time" class="rank-period-tab">
                            <span class="rank-tab-icon">🏆</span>
                            <span>전체</span>
                        </button>
                    </div>
                    <div class="rank-type-toggle">
                        <button id="ranking-pick-type" class="rank-type-btn active pick">PICK</button>
                        <button id="ranking-pack-type" class="rank-type-btn pack">PACK</button>
                    </div>
                </div>
            </div>

            <!-- Top 3 Podium - Enhanced -->
            <div class="rank-podium-card">
                <h3 class="rank-podium-title">🏆 TOP 3</h3>
                <div class="rank-podium" id="ranking-podium">
                    <div class="rank-podium-item silver">
                        <div class="rank-podium-medal">🥈</div>
                        <div class="rank-podium-pos">2nd</div>
                        <div class="rank-podium-name" id="podium-2-name">-</div>
                        <div class="rank-podium-score" id="podium-2-score">0</div>
                        <div class="rank-podium-label">HTP</div>
                        <div class="rank-podium-pillar silver"></div>
                    </div>
                    <div class="rank-podium-item gold">
                        <div class="rank-podium-crown">👑</div>
                        <div class="rank-podium-medal">🥇</div>
                        <div class="rank-podium-pos">1st</div>
                        <div class="rank-podium-name" id="podium-1-name">-</div>
                        <div class="rank-podium-score" id="podium-1-score">0</div>
                        <div class="rank-podium-label">HTP</div>
                        <div class="rank-podium-pillar gold"></div>
                    </div>
                    <div class="rank-podium-item bronze">
                        <div class="rank-podium-medal">🥉</div>
                        <div class="rank-podium-pos">3rd</div>
                        <div class="rank-podium-name" id="podium-3-name">-</div>
                        <div class="rank-podium-score" id="podium-3-score">0</div>
                        <div class="rank-podium-label">HTP</div>
                        <div class="rank-podium-pillar bronze"></div>
                    </div>
                </div>
            </div>

            <!-- Ranking Statistics - Enhanced -->
            <div class="grid grid-cols-3 gap-4">
                <div class="rank-stat-card">
                    <div class="rank-stat-icon blue">📊</div>
                    <div class="rank-stat-info">
                        <span class="rank-stat-label">평균 HTP</span>
                        <span id="ranking-avg-htp" class="rank-stat-value">0.0</span>
                    </div>
                </div>
                <div class="rank-stat-card">
                    <div class="rank-stat-icon green">⚡</div>
                    <div class="rank-stat-info">
                        <span class="rank-stat-label">최고 HTP</span>
                        <span id="ranking-max-htp" class="rank-stat-value green">0.0</span>
                    </div>
                </div>
                <div class="rank-stat-card">
                    <div class="rank-stat-icon yellow">📐</div>
                    <div class="rank-stat-info">
                        <span class="rank-stat-label">중간값 HTP</span>
                        <span id="ranking-median-htp" class="rank-stat-value yellow">0.0</span>
                    </div>
                </div>
            </div>

            <!-- Full Ranking List - Enhanced -->
            <div class="rank-list-card">
                <div class="rank-list-header">
                    <h3 class="rank-list-title">📋 전체 순위</h3>
                    <div class="rank-list-count">
                        총 <span id="ranking-total-count" class="rank-count-num">0</span>명
                    </div>
                </div>
                <div class="ranking-list" id="ranking-list">
                    <div class="rank-empty-state">데이터를 불러오는 중...</div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chart Modal (Individual Trend) -->
<div id="chart-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="chart-modal-content" class="rounded-2xl shadow-2xl w-full max-w-4xl relative flex flex-col overflow-y-auto" style="max-height:90vh;background:var(--bg-secondary);">
        <h3 id="chart-modal-title" class="text-xl font-bold text-white mb-4 p-6 pb-0">개인 HTP 추이</h3>
        <div class="flex-grow min-h-0 p-6 pt-0"><canvas id="individual-htp-chart"></canvas></div>
        <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>

<!-- 🆕 Employee Detail Modal (개인별 히스토리 상세 분석) -->
<div id="employee-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="employee-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl p-6 relative">
        <!-- Header -->
        <div class="employee-detail-header">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="employee-detail-name" class="text-3xl font-bold mb-2">작업자 이름</h2>
                    <p id="employee-detail-subtitle" class="text-lg opacity-90">PICK (집품)</p>
                </div>
                <button id="employee-detail-close" class="text-white hover:text-gray-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="employee-detail-stats">
            <div class="employee-stat-card">
                <div class="employee-stat-label">총 근무일수</div>
                <div class="employee-stat-value" id="employee-detail-total-days">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">평균 HTP</div>
                <div class="employee-stat-value" id="employee-detail-avg-htp">0.0</div>
                <div id="employee-detail-avg-trend" class="trend-indicator positive mt-2">
                    <span>↑</span>
                    <span>+0%</span>
                </div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">최고 HTP</div>
                <div class="employee-stat-value text-green-400" id="employee-detail-max-htp">0.0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">총 작업량</div>
                <div class="employee-stat-value" id="employee-detail-total-qty">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">목표 달성률</div>
                <div class="employee-stat-value" id="employee-detail-target-rate">0%</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">현재 순위</div>
                <div class="employee-stat-value" id="employee-detail-rank">-</div>
            </div>
        </div>

        <!-- 뱃지 섹션 -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">🏅 획득 뱃지</h4>
            <div id="employee-detail-badges" class="flex flex-wrap gap-2">
                <span class="text-gray-400">획득한 뱃지가 없습니다</span>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">📈 일별 HTP 추이</h4>
                <div class="relative h-64"><canvas id="employee-detail-daily-chart"></canvas></div>
            </div>
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">📊 일별 작업량</h4>
                <div class="relative h-64"><canvas id="employee-detail-qty-chart"></canvas></div>
            </div>
        </div>

        <!-- 주간/월간 비교 -->
        <div class="employee-chart-container mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">📅 주간 평균 비교</h4>
            <div class="relative h-64"><canvas id="employee-detail-weekly-chart"></canvas></div>
        </div>

        <!-- 최근 기록 테이블 -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">📋 최근 10일 기록</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-600">
                        <tr>
                            <th class="px-4 py-2 text-left text-white">날짜</th>
                            <th class="px-4 py-2 text-left text-white">작업량</th>
                            <th class="px-4 py-2 text-left text-white">M/H</th>
                            <th class="px-4 py-2 text-left text-white">HTP</th>
                            <th class="px-4 py-2 text-left text-white">순위</th>
                        </tr>
                    </thead>
                    <tbody id="employee-detail-recent-table" class="bg-gray-800">
                        <!-- Data will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 🆕 Calendar Day Detail Modal -->
<div id="calendar-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="calendar-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl p-6 relative max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="calendar-detail-title" class="text-2xl font-bold text-white">2025-01-17 상세 정보</h3>
            <button id="calendar-detail-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Day Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">평균 HTP</div>
                <div id="calendar-detail-avg-htp" class="text-2xl font-bold text-white">0.0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">총 작업량</div>
                <div id="calendar-detail-total-qty" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">작업자 수</div>
                <div id="calendar-detail-worker-count" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">목표 달성률</div>
                <div id="calendar-detail-target-rate" class="text-2xl font-bold text-white">0%</div>
            </div>
        </div>

        <!-- Top Performers of the Day -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">🏆 당일 Top 5</h4>
            <div id="calendar-detail-top-list" class="space-y-2">
                <!-- List will be populated dynamically -->
            </div>
        </div>

        <!-- Process Distribution Chart -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">📊 프로세스별 분포</h4>
            <div class="relative h-64"><canvas id="calendar-detail-chart"></canvas></div>
        </div>
    </div>
</div>

<!-- 🆕 Hidden Employees Management Modal -->
<div id="hidden-employees-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-white">👻 숨긴 작업자 관리</h3>
            <button id="hidden-employees-modal-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="mb-4">
            <p class="text-gray-400 text-sm">숨긴 작업자는 데이터 보기 탭에서 반투명하게 표시되며, 통계에서 제외되지 않습니다.</p>
        </div>

        <div id="hidden-employees-modal-list" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Hidden employees list will be populated -->
            <div class="text-center py-10 text-gray-500">숨긴 작업자가 없습니다.</div>
        </div>
    </div>
</div>

</body>
</html>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, Bytes, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 🆕 Loading Progress Functions ---
    function showLoadingProgress(text = '로딩 중...') {
        const progressBar = document.getElementById('loading-progress-bar');
        const statusText = document.getElementById('loading-status-text');
        progressBar.classList.add('active');
        statusText.classList.add('active');
        statusText.textContent = text;
    }

    function updateLoadingProgress(percent, text) {
        const progressFill = document.getElementById('loading-progress-fill');
        const statusText = document.getElementById('loading-status-text');
        progressFill.style.width = `${percent}%`;
        if (text) statusText.textContent = text;
    }

    function hideLoadingProgress() {
        const progressBar = document.getElementById('loading-progress-bar');
        const statusText = document.getElementById('loading-status-text');
        setTimeout(() => {
            progressBar.classList.remove('active');
            statusText.classList.remove('active');
        }, 300);
    }

    // --- Theme Management ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
        // Re-render charts with new theme colors
        if (typeof applyFiltersAndRender === 'function') applyFiltersAndRender();
    }

    function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
            themeIcon.textContent = theme === 'dark' ? '🌙' : '☀️';
        }
    }

    // Initialize theme immediately
    initTheme();

    // --- UI Elements ---
    const ui = {
        appContainer: document.getElementById('app-container'),
        fileUpload: document.getElementById('file-upload'),
        tableBody: document.getElementById('data-table-body'),
        tableHeader: document.querySelector('#data-table thead'),
        placeholderRow: document.getElementById('placeholder-row'),
        loaderContainer: document.getElementById('loader-container'),
        statusIndicator: document.getElementById('status-indicator'),
        lastUpdatedEl: document.getElementById('last-updated'),
        lastUploaderEl: document.getElementById('last-uploader'),
        sidebar: document.getElementById('sidebar'),
        sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
        sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        floorFilters: document.getElementById('floor-filters'),
        packTypeFilters: document.getElementById('pack-type-filters'),
        hourFilters: document.getElementById('hour-filters'),
        searchInput: document.getElementById('search-input'),
        lowHtpToggle: document.getElementById('low-htp-toggle'),
        statsDisplay: document.getElementById('stats-display'),
        captureBtn: document.getElementById('capture-btn'),
        exportBtn: document.getElementById('export-btn'),
        saveFilterPresetBtn: document.getElementById('save-filter-preset-btn'),
        loadFilterPresetBtn: document.getElementById('load-filter-preset-btn'),
        targetHtpSettings: document.getElementById('target-htp-settings'),
        tickerText: document.getElementById('ticker-text'),
        tableViewBtn: document.getElementById('table-view-btn'),
        dashboardViewBtn: document.getElementById('dashboard-view-btn'),
        historyViewBtn: document.getElementById('history-view-btn'),
        calendarViewBtn: document.getElementById('calendar-view-btn'),
        rankingViewBtn: document.getElementById('ranking-view-btn'),
        tableView: document.getElementById('table-view'),
        dashboardView: document.getElementById('dashboard-view'),
        historyView: document.getElementById('history-view'),
        calendarView: document.getElementById('calendar-view'),
        rankingView: document.getElementById('ranking-view'),
        chartModalBackdrop: document.getElementById('chart-modal-backdrop'),
        chartModalTitle: document.getElementById('chart-modal-title'),
        chartModalClose: document.getElementById('chart-modal-close'),
        kpi: {
            totalWorkers: document.getElementById('kpi-total-workers'),
            totalQty: document.getElementById('kpi-total-qty'),
            avgHtp: document.getElementById('kpi-avg-htp'),
            lowPerformers: document.getElementById('kpi-low-performers'),
        },
        topPickPerformersList: document.getElementById('top-pick-performers-list'),
        topPackPerformersList: document.getElementById('top-pack-performers-list'),
        periodWeekBtn: document.getElementById('period-week'),
        periodMonthBtn: document.getElementById('period-month'),
        periodAllBtn: document.getElementById('period-all'),
        periodCustomBtn: document.getElementById('period-custom'),
        customDateRange: document.getElementById('custom-date-range'),
        startDate: document.getElementById('start-date'),
        endDate: document.getElementById('end-date'),
        applyCustomRange: document.getElementById('apply-custom-range'),
        historyKpi: {
            days: document.getElementById('history-kpi-days'),
            totalQty: document.getElementById('history-kpi-total-qty'),
            avgHtp: document.getElementById('history-kpi-avg-htp'),
            maxHtp: document.getElementById('history-kpi-max-htp'),
        },
        historyTopPickList: document.getElementById('history-top-pick-list'),
        historyTopPackList: document.getElementById('history-top-pack-list'),
        exportHistoryExcel: document.getElementById('export-history-excel'),
        exportHistoryPdf: document.getElementById('export-history-pdf'),
        calendarPrevMonth: document.getElementById('calendar-prev-month'),
        calendarNextMonth: document.getElementById('calendar-next-month'),
        calendarMonthTitle: document.getElementById('calendar-month-title'),
        calendarGrid: document.getElementById('calendar-grid'),
        calendarDetailModalBackdrop: document.getElementById('calendar-detail-modal-backdrop'),
        calendarDetailClose: document.getElementById('calendar-detail-close'),
        rankingDaily: document.getElementById('ranking-daily'),
        rankingWeekly: document.getElementById('ranking-weekly'),
        rankingMonthly: document.getElementById('ranking-monthly'),
        rankingAllTime: document.getElementById('ranking-all-time'),
        rankingPickType: document.getElementById('ranking-pick-type'),
        rankingPackType: document.getElementById('ranking-pack-type'),
        rankingPodium: document.getElementById('ranking-podium'),
        rankingList: document.getElementById('ranking-list'),
        rankingTotalCount: document.getElementById('ranking-total-count'),
        rankingAvgHtp: document.getElementById('ranking-avg-htp'),
        rankingMaxHtp: document.getElementById('ranking-max-htp'),
        rankingMedianHtp: document.getElementById('ranking-median-htp'),
        employeeDetailModalBackdrop: document.getElementById('employee-detail-modal-backdrop'),
        employeeDetailClose: document.getElementById('employee-detail-close'),
        manageHiddenBtn: document.getElementById('manage-hidden-btn'),
        hiddenCountBadge: document.getElementById('hidden-count-badge'),
        hiddenEmployeesList: document.getElementById('hidden-employees-list'),
        hiddenEmployeesModalBackdrop: document.getElementById('hidden-employees-modal-backdrop'),
        hiddenEmployeesModalClose: document.getElementById('hidden-employees-modal-close'),
    };

    // --- Global State ---
    let globalRawData = []; 
    let historyData = {}; // { 'YYYY-MM-DD': rawDataArray }
    let hiddenEmployees = new Set();
    let state = {
        filters: {
            process: 'all', search: '', lowHtp: false,
            hours: new Set(), floors: new Set(), packTypes: new Set()
        },
        sort: { key: 'htp', direction: 'asc' },
        charts: { 
            floorHtp: null, packType: null, individualHtp: null, 
            processComparison: null, hourlyHtp: null,
            historyDailyTrend: null, historyDailyQty: null,
            employeeDailyChart: null, employeeQtyChart: null, employeeWeeklyChart: null,
            calendarDetailChart: null
        },
        historyPeriod: 'week',
        historyDateRange: { start: null, end: null },
        calendarCurrentMonth: new Date(),
        rankingPeriod: 'daily',
        rankingProcessType: 'pick',
        dashboardCache: { filteredData: [], rawData: [] },
        dashboardDirty: true,
        dashboardRafId: null,
        dataRevision: 0,
        cache: {
            rawByHours: new Map(),
            aggregatedByHours: new Map(),
        },
        lastDisplayData: [],
        tableRenderToken: 0,
        tableChunkRaf: null,
        lastTickerSignature: '',
        lastLocationHiddenFlag: null,
        lastDashboardAnimationAt: 0,
    };
    const requestIdle = typeof window.requestIdleCallback === 'function'
        ? (cb, options) => window.requestIdleCallback(cb, options)
        : (cb) => setTimeout(() => cb({ didTimeout: false, timeRemaining: () => 0 }), 16);
    const cancelIdle = typeof window.cancelIdleCallback === 'function'
        ? (id) => window.cancelIdleCallback(id)
        : (id) => clearTimeout(id);
    let pendingFilterIdleHandle = null;
    let filterRenderToken = 0;

    function runWhenIdle(callback, timeout = 120) {
        return requestIdle(callback, { timeout });
    }

    function clearDataCaches() {
        state.cache.rawByHours.clear();
        state.cache.aggregatedByHours.clear();
    }

    function bumpDataRevision() {
        state.dataRevision += 1;
        clearDataCaches();
        state.lastDisplayData = [];
        state.lastTickerSignature = '';
        state.lastLocationHiddenFlag = null;
    }

    function setGlobalRawData(nextData) {
        globalRawData = Array.isArray(nextData) ? nextData : [];
        bumpDataRevision();
    }

    function getHourFilterSignature(hoursSet) {
        if (!hoursSet || hoursSet.size === 0) return 'all';
        return Array.from(hoursSet).sort((a, b) => a - b).join(',');
    }

    function getTimeFilteredRawData() {
        const hourSig = getHourFilterSignature(state.filters.hours);
        const cacheKey = `${state.dataRevision}|${hourSig}`;
        if (state.cache.rawByHours.has(cacheKey)) {
            return state.cache.rawByHours.get(cacheKey);
        }
        const filtered = hourSig === 'all'
            ? globalRawData
            : globalRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
        state.cache.rawByHours.set(cacheKey, filtered);
        return filtered;
    }

    function getAggregatedDataForCurrentHours(timeFilteredRawData) {
        const hourSig = getHourFilterSignature(state.filters.hours);
        const cacheKey = `${state.dataRevision}|${hourSig}`;
        if (state.cache.aggregatedByHours.has(cacheKey)) {
            return state.cache.aggregatedByHours.get(cacheKey);
        }
        const aggregated = aggregateData(timeFilteredRawData);
        state.cache.aggregatedByHours.set(cacheKey, aggregated);
        return aggregated;
    }
    let targetHtpValues = {};
    let employeeBadges = {};
    let previousRankings = {};

    // --- Constants ---
    const PACK_TYPE_MAP = {
		"메뉴얼팩": ["179_1.3F_MA_S_OG_"],
		"메뉴얼팩 멀티": ["179_1.3F_MA_M_OG_", "MA_M_"],
		"ACE LINE": ["179-1.2F-MA-ACE-OG-"],
		"오토백 1.2": ["AB_R1.2_"],
		"오토백 2.5": ["AB_2.5_"],
		"오토백 4.0": ["AB_4.0_"],
		"오토백 RTPB": ["AB_T1_OG_"],
		"오토백 멀티": ["Pack at Rebin", "AB_M_"],
		"HV": ["179-7.1F-MA-HVHR-OG_"],
		"GIFT": ["179_1.3F_MA_GW_SUB_"],
		"CFC 메뉴얼팩": ["190_6.2F_MA_S_OG_"],
		"CFC 메뉴얼팩 멀티": ["190_6.2F_MA_M_OG_"],
		"CFC 오토백 2.5": ["190_6.2F_AB_R2.5_OG_"],
		"CFC 오토백 4.0": ["190_6.2F_AB_R4.0_OG_"],
		"CFC 오토백 RTPB": ["190_6.2G_AB_T1_OG_"]
	};
    const DEFAULT_PACK_TYPE = "기타";
    const MANAGERS_LIST = ['R5370913', 'E4992491', 'Z7386388', 'Z5406388', 'B3706369', 'S4461023', 'V6568216', 'X4033164', 'X7694762', 'A1943868', 'D5012685', 'N2086791', 'W9345496', 'T5941917', 'K9270657', 'P1637348', 'H6239751', 'X9075186', 'H4633331', 'G4094768', 'R9635160', 'R2637601', 'T9383022', 'V4296863', 'G9236102', 'U7306474', 'P9738071', 'L5291847', 'D9063832', 'R8788212', 'S1827358', 'M9279634', 'H3088014', 'V8173681', 'J7268590', 'G2791563', 'N2607464', 'Y5651563', 'H3614867', 'Q2813675', 'U2554263', 'T9060243', 'G2345755', 'A3511520', 'T3138750', 'A1481426', 'C1457759', 'Y9273085'];
    
    const TARGET_HTP_DEFAULTS = {
        "Manual SINGULATION": { value: 100, keywords: ['ManualPack', '179_1.3F_MA_S_OG_'] },
        "Manual MULTI": { value: 120, keywords: ['7F_Multi_AGV', '179_1.3F_MA_M_OG_', 'MA_M_'] },
        "ACE LINE": { value: 150, keywords: ['ACE', '179-1.2F-MA-ACE-OG-'] },
        "Autobagger 1.2": { value: 380, keywords: ['Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'] },
        "Autobagger 2.5": { value: 350, keywords: ['Autobag2.5', '179_1.3F_AB_R2.5_OG_'] },
        "Autobagger 4.0": { value: 280, keywords: ['Autobag4.0', '179_1.3F_AB_R4.0_OG_'] },
        "Autobagger RTPB": { value: 150, keywords: ['Autobag_RTPB1', '179_1.3F_AB_T1_OG_'] },
        "Auto MULTI": { value: 250, keywords: ['AGV_Multi_Autobag4.0', 'Pack at Rebin', 'AB_M_'] },
        "HV": { value: 100, keywords: ['179-7.1F-MA-HVHR-OG_'] },
        "GIFT": { value: 100, keywords: ['179_1.3F_MA_GW_SUB_'] },
        "PICK": { value: 90, keywords: [] }
    };
    for(const key in TARGET_HTP_DEFAULTS) {
        targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
    }

    // --- LocalStorage Management for Hidden Employees ---
    function loadHiddenEmployees() {
        const saved = localStorage.getItem('hiddenEmployees');
        if (saved) {
            hiddenEmployees = new Set(JSON.parse(saved));
        }
        updateHiddenCountBadge();
    }

    function saveHiddenEmployees() {
        localStorage.setItem('hiddenEmployees', JSON.stringify([...hiddenEmployees]));
        updateHiddenCountBadge();
    }

    function updateHiddenCountBadge() {
        ui.hiddenCountBadge.textContent = hiddenEmployees.size;
        if (hiddenEmployees.size > 0) {
            ui.hiddenCountBadge.classList.remove('bg-gray-500');
            ui.hiddenCountBadge.classList.add('bg-red-500');
        } else {
            ui.hiddenCountBadge.classList.remove('bg-red-500');
            ui.hiddenCountBadge.classList.add('bg-gray-500');
        }
    }

    function toggleHiddenEmployee(employeeName) {
        if (hiddenEmployees.has(employeeName)) {
            hiddenEmployees.delete(employeeName);
        } else {
            hiddenEmployees.add(employeeName);
        }
        saveHiddenEmployees();
        if (ui.hiddenEmployeesList.classList.contains('is-open')) {
            renderHiddenEmployeesList();
        }
        if (Array.isArray(state.lastDisplayData) && state.lastDisplayData.length >= 0) {
            renderTable(state.lastDisplayData);
            updateColumnVisibility(state.lastDisplayData);
            updateSortIndicators();
        } else {
            applyFiltersAndRender();
        }
    }

    function showHiddenEmployeesModal() {
        const modalList = document.getElementById('hidden-employees-modal-list');
        modalList.innerHTML = '';

        if (hiddenEmployees.size === 0) {
            modalList.innerHTML = '<div class="text-center py-10 text-gray-500">숨긴 작업자가 없습니다.</div>';
        } else {
            hiddenEmployees.forEach(employeeName => {
                const item = document.createElement('div');
                item.className = 'hidden-employee-item';
                item.innerHTML = `
                    <span class="font-semibold text-white">${employeeName}</span>
                    <button class="show-employee-btn" data-employee="${employeeName}">복구</button>
                `;
                modalList.appendChild(item);
            });

            modalList.querySelectorAll('.show-employee-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const employeeName = e.target.dataset.employee;
                    toggleHiddenEmployee(employeeName);
                    showHiddenEmployeesModal();
                });
            });
        }

        ui.hiddenEmployeesModalBackdrop.classList.remove('hidden');
        ui.hiddenEmployeesModalBackdrop.classList.add('flex');
    }

    // --- Firebase Setup ---
    const firebaseConfig = {
        apiKey: "AIzaSyBrPfjJWPPd8HzI1jCRoHFqwcuPuJ9u10E",
        authDomain: "gwj2-pickpack-htptool.firebaseapp.com",
        projectId: "gwj2-pickpack-htptool",
        storageBucket: "gwj2-pickpack-htptool.appspot.com",
        messagingSenderId: "913661158847",
        appId: "1:913661158847:web:ebaf60d2afbeadda452d0a",
        measurementId: "G-77DRPC5F58"
    };
    let db, auth, userId, dataDocRef, historyCollectionRef;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        dataDocRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpData', 'latestCompressed');
        historyCollectionRef = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpHistory');
    } catch(e) {
        console.error("Firebase 초기화 오류:", e);
        updateStatus('disconnected', 'Firebase 초기화에 실패했습니다.');
    }
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            updateStatus('connected', '실시간 서버에 연결되었습니다.');
            ui.fileUpload.disabled = false;
            setupRealtimeListener();
            // ⚡ LAZY LOAD: 히스토리는 히스토리 탭 클릭 시에만 로드
            // loadHistoryData(); // 제거
            loadHiddenEmployees();
        } else {
            try { await signInAnonymously(auth); } catch (error) {
                console.error("익명 로그인 오류:", error);
                updateStatus('disconnected', '서버에 연결할 수 없습니다.');
            }
        }
    });

    function setupRealtimeListener() {
        onSnapshot(dataDocRef, (docSnap) => {
            showLoader();
            if (docSnap.exists()) {
                const dataPayload = docSnap.data();
                try {
                    const compressedBytes = dataPayload.compressedData;
                    if (!compressedBytes) throw new Error("압축된 데이터가 없습니다.");
                    
                    // ⚡ OPTIMIZED: idle slot에서 비동기 처리
                    runWhenIdle(() => {
                        try {
                            const compressedUint8Array = compressedBytes.toUint8Array();
                            const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                            const parsedData = JSON.parse(decompressedString);
                            setGlobalRawData(parsedData.map(item => ({
                                ...item,
                                htpStart: new Date(item.htpStart),
                                htpEnd: new Date(item.htpEnd),
                            })));
                            ui.lastUploaderEl.textContent = dataPayload.uploaderId.substring(0, 8) + '...';
                            ui.lastUpdatedEl.textContent = new Date(dataPayload.timestamp).toLocaleString('ko-KR');
                            
                            // 🆕 필터 초기화를 비동기로
                            requestAnimationFrame(() => {
                                initializeFiltersFromData(globalRawData);
                                requestAnimationFrame(() => {
                                    applyFiltersAndRender();
                                    hideLoader();
                                });
                            });
                        } catch (error) {
                            console.error("데이터 처리 오류:", error);
                            showModal("데이터를 처리하는 데 실패했습니다.");
                            setGlobalRawData([]);
                            applyFiltersAndRender();
                            hideLoader();
                        }
                    });
                } catch (error) {
                    console.error("데이터 압축 해제 또는 파싱 오류:", error);
                    showModal("서버로부터 받은 데이터를 처리하는 데 실패했습니다.");
                    setGlobalRawData([]);
                    applyFiltersAndRender();
                    hideLoader();
                }
            } else {
                setGlobalRawData([]);
                initializeFiltersFromData([]);
                applyFiltersAndRender();
                hideLoader();
            }
        }, (error) => {
            console.error("실시간 데이터 수신 오류:", error);
            updateStatus('disconnected', '데이터 수신 중 오류 발생');
            hideLoader();
        });
    }

    // ⚡ OPTIMIZED: History Data Management
    let isLoadingHistory = false;
    let isHistoryLoaded = false; // 히스토리 로드 완료 플래그
    let badgesCalculated = false;

    async function loadHistoryData(days = 90) {
        if (isLoadingHistory) return;
        isLoadingHistory = true;
        
        showLoadingProgress('히스토리 데이터 로딩 중...');
        updateLoadingProgress(10, '히스토리 데이터 조회 중...');
        
        try {
            const daysAgo = new Date();
            daysAgo.setDate(daysAgo.getDate() - days);
            
            const q = query(
                historyCollectionRef,
                where('date', '>=', daysAgo.toISOString().split('T')[0]),
                orderBy('date', 'desc')
            );
            
            updateLoadingProgress(20, 'Firebase에서 데이터 가져오는 중...');
            const querySnapshot = await getDocs(q);
            const allDocs = [];
            querySnapshot.forEach((doc) => {
                allDocs.push(doc.data());
            });
            
            console.log(`📦 총 ${allDocs.length}일의 데이터를 로드합니다...`);
            updateLoadingProgress(40, `${allDocs.length}일 데이터 처리 중...`);
            
            // 🆕 청크 단위로 처리 (10일씩)
            historyData = {};
            const CHUNK_SIZE = 10;
            
            for (let i = 0; i < allDocs.length; i += CHUNK_SIZE) {
                const chunk = allDocs.slice(i, i + CHUNK_SIZE);
                const progress = 40 + ((i / allDocs.length) * 50);
                updateLoadingProgress(progress, `${i + chunk.length}/${allDocs.length} 일 처리 중...`);
                
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        chunk.forEach(data => {
                            try {
                                const compressedBytes = data.compressedData;
                                if (!compressedBytes) return;
                                const compressedUint8Array = compressedBytes.toUint8Array();
                                const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                                const parsedData = JSON.parse(decompressedString);
                                historyData[data.date] = parsedData.map(item => ({
                                    ...item,
                                    htpStart: new Date(item.htpStart),
                                    htpEnd: new Date(item.htpEnd),
                                }));
                            } catch (error) {
                                console.error(`히스토리 데이터 파싱 오류 (${data.date}):`, error);
                            }
                        });
                        resolve();
                    });
                });
            }
            
            updateLoadingProgress(95, '히스토리 로딩 완료!');
            console.log(`✨ ${Object.keys(historyData).length}일의 히스토리 데이터 로드 완료`);
            
            // 🆕 뱃지 자동 계산
            badgesCalculated = false;
            console.log('🏅 히스토리 로드 완료 - 뱃지 자동 계산 시작');
            ensureBadgesCalculated();
            
        } catch (error) {
            console.error("히스토리 데이터 로드 오류:", error);
            showModal('히스토리 데이터를 불러오는 데 실패했습니다.');
        } finally {
            isLoadingHistory = false;
            updateLoadingProgress(100, '완료!');
            isHistoryLoaded = true; // ⚡ 로드 완료 플래그
            setTimeout(() => hideLoadingProgress(), 500);
        }
    }

    // 🆕 뱃지 계산 (지연 실행)
    function ensureBadgesCalculated() {
        // 히스토리 데이터 또는 일반 데이터가 있으면 뱃지 계산
        const hasData = Object.keys(historyData).length > 0 || globalRawData.length > 0;
        
        if (!badgesCalculated && hasData) {
            console.log('🏅 뱃지 계산 시작...');
            calculateEmployeeBadges();
            badgesCalculated = true;
            console.log('✅ 뱃지 계산 완료 (사원 분석 모달에서 표시)');
        }
    }
	
	// --- 🏅 강화된 뱃지 시스템 (20+ 종류) ---
function calculateEmployeeBadges() {
    console.log('🏅 뱃지 계산 시작...');
    
    employeeBadges = {};
    
    // 🆕 히스토리 데이터 구조: historyData[date] = [items]
    let dataSource = 'none';
    let allEmployees = new Set();
    let employeeDataMap = {}; // 사원별 데이터: {employee: [{date, htp, qty, processType}]}
    
    if (Object.keys(historyData).length > 0) {
        // 히스토리 데이터 사용 (날짜별 → 사원별로 재구성)
        dataSource = 'history';
        const sortedDates = Object.keys(historyData).sort();
        const recentDates = sortedDates.slice(-30);
        
        recentDates.forEach(date => {
            const dayData = historyData[date]; // 해당 날짜의 모든 데이터
            if (!Array.isArray(dayData)) return;
            
            // 날짜별 사원별 집계 (같은 날짜의 여러 작업을 합침)
            const dailyEmployeeStats = {};
            
            dayData.forEach(item => {
                if (!item || !item.employee) return;
                
                const empName = item.employee;
                allEmployees.add(empName);
                
                if (!dailyEmployeeStats[empName]) {
                    dailyEmployeeStats[empName] = {
                        totalQty: 0,
                        totalSeconds: 0,
                        processTypes: new Set()
                    };
                }
                
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds > 0) {
                    dailyEmployeeStats[empName].totalQty += item.unitQty || 0;
                    dailyEmployeeStats[empName].totalSeconds += durationSeconds;
                    dailyEmployeeStats[empName].processTypes.add(item.processTask || item.processType || '');
                }
            });
            
            // 각 사원의 일일 집계를 employeeDataMap에 저장
            Object.keys(dailyEmployeeStats).forEach(empName => {
                if (!employeeDataMap[empName]) {
                    employeeDataMap[empName] = [];
                }
                
                const stats = dailyEmployeeStats[empName];
                const dailyHtp = stats.totalSeconds > 0 
                    ? (stats.totalQty / (stats.totalSeconds / 3600)) 
                    : 0;
                
                // 주요 프로세스 타입 결정
                const processType = Array.from(stats.processTypes).join(',');
                
                employeeDataMap[empName].push({
                    date: date,
                    htp: parseFloat(dailyHtp.toFixed(1)),
                    qty: stats.totalQty,
                    processType: processType
                });
            });
        });
    } else if (globalRawData && globalRawData.length > 0) {
        // 일반 데이터 사용 (오늘) - aggregateData 사용
        dataSource = 'today';
        const today = new Date().toISOString().split('T')[0];
        
        // globalRawData는 이미 집계된 데이터 (aggregateData 결과)
        globalRawData.forEach(item => {
            if (item.employee) {
                allEmployees.add(item.employee);
                if (!employeeDataMap[item.employee]) {
                    employeeDataMap[item.employee] = [];
                }
                
                // item.htp는 이미 계산된 평균 HTP
                employeeDataMap[item.employee].push({
                    date: today,
                    htp: parseFloat(item.htp) || 0,
                    qty: parseInt(item.unitQty) || 0,
                    processType: item.processType || ''
                });
            }
        });
    }
    
    console.log(`📊 데이터 소스: ${dataSource}, ${allEmployees.size}명의 사원 뱃지 계산 중...`);
    
    if (allEmployees.size === 0) {
        console.log('⚠️ 뱃지 계산 대상 없음');
        return;
    }
    
    allEmployees.forEach(employeeName => {
        const badges = [];
        const records = {
            maxHtp: 0,
            maxHtpDate: null,
            totalDays: 0,
            totalQty: 0,
            avgHtp: 0,
            pickDays: 0,
            packDays: 0,
            consecutiveDays: 0,
            maxConsecutiveDays: 0,
            topRankCount: 0,
            lowHtpCount: 0,
            perfectDays: 0, // HTP >= 목표 달성 일수
            specialtyProcess: null, // PICK 또는 PACK 전문가
        };
        
        const htpHistory = [];
        let currentStreak = 0;
        let lastDate = null;
        
        // 사원별 데이터 가져오기
        const employeeRecords = employeeDataMap[employeeName] || [];
        
        // 날짜별로 그룹화
        const dateGroups = {};
        employeeRecords.forEach(record => {
            if (!dateGroups[record.date]) {
                dateGroups[record.date] = [];
            }
            dateGroups[record.date].push(record);
        });
        
        // 날짜 정렬
        const employeeDates = Object.keys(dateGroups).sort();
        
        // 날짜별 데이터 처리
        employeeDates.forEach(date => {
            const dayRecords = dateGroups[date];
            
            // 근무일수 증가
            records.totalDays++;
            
            // 연속 근무일 계산
            if (lastDate) {
                const lastDateObj = new Date(lastDate);
                const currentDateObj = new Date(date);
                const dayDiff = Math.floor((currentDateObj - lastDateObj) / (1000 * 60 * 60 * 24));
                if (dayDiff === 1) {
                    currentStreak++;
                } else {
                    currentStreak = 1;
                }
            } else {
                currentStreak = 1;
            }
            
            if (currentStreak > records.maxConsecutiveDays) {
                records.maxConsecutiveDays = currentStreak;
            }
            lastDate = date;
            
            // 하루 집계 변수
            let dayMaxHtp = 0;
            let dayTotalQty = 0;
            let dayPerfect = true;
            let dayHasWork = dayRecords.length > 0;
            
            dayRecords.forEach(record => {
                const htp = parseFloat(record.htp) || 0;
                const qty = parseInt(record.qty) || 0;
                const processType = record.processType || '';
                const targetHtp = processType.includes('PICK') ? 90 : 180;
                
                htpHistory.push(htp);
                dayTotalQty += qty;
                
                if (htp > dayMaxHtp) dayMaxHtp = htp;
                if (htp > records.maxHtp) {
                    records.maxHtp = htp;
                    records.maxHtpDate = date;
                }
                
                if (htp < targetHtp) {
                    dayPerfect = false;
                    records.lowHtpCount++;
                }
                
                // 공정별 집계
                if (processType.includes('PICK')) records.pickDays++;
                if (processType.includes('PACK')) records.packDays++;
            });
            
            // 하루 집계 완료
            if (dayHasWork) {
                records.totalQty += dayTotalQty;
                if (dayPerfect && dayMaxHtp > 0) {
                    records.perfectDays++;
                }
            }
        });
        
        // 평균 HTP 계산
        if (htpHistory.length > 0) {
            records.avgHtp = htpHistory.reduce((a, b) => a + b, 0) / htpHistory.length;
        }
        
        // 디버깅: 사원별 records 출력 (처음 3명만)
        if (Object.keys(employeeBadges).length < 3) {
            console.log(`  ${employeeName}:`, {
                maxHtp: records.maxHtp,
                totalDays: records.totalDays,
                avgHtp: records.avgHtp.toFixed(1),
                perfectDays: records.perfectDays,
                maxStreak: records.maxConsecutiveDays
            });
        }
        
        // 전문 공정 판단
        if (records.pickDays > records.packDays * 2) records.specialtyProcess = 'PICK';
        else if (records.packDays > records.pickDays * 2) records.specialtyProcess = 'PACK';
        
        // ========================================
        // 🏆 뱃지 부여 시스템 (카테고리별)
        // ========================================
        
        // === 1. HTP 기록 뱃지 (Performance Badges) ===
        if (records.maxHtp >= 600) {
            badges.push({ type: 'record', name: '💎 전설', desc: 'HTP 600+', level: 'legendary', icon: '💎' });
        } else if (records.maxHtp >= 500) {
            badges.push({ type: 'record', name: '🏆 마스터', desc: 'HTP 500+', level: 'gold', icon: '🏆' });
        } else if (records.maxHtp >= 400) {
            badges.push({ type: 'record', name: '⭐ 엘리트', desc: 'HTP 400+', level: 'silver', icon: '⭐' });
        } else if (records.maxHtp >= 300) {
            badges.push({ type: 'record', name: '🌟 고수', desc: 'HTP 300+', level: 'bronze', icon: '🌟' });
        } else if (records.maxHtp >= 200) {
            badges.push({ type: 'record', name: '✨ 숙련자', desc: 'HTP 200+', level: 'normal', icon: '✨' });
        }
        
        // === 2. 평균 HTP 뱃지 (Consistency Badges) ===
        if (records.avgHtp >= 400) {
            badges.push({ type: 'consistency', name: '🎯 완벽주의자', desc: '평균 HTP 400+', level: 'gold', icon: '🎯' });
        } else if (records.avgHtp >= 300) {
            badges.push({ type: 'consistency', name: '📊 안정적', desc: '평균 HTP 300+', level: 'silver', icon: '📊' });
        } else if (records.avgHtp >= 200) {
            badges.push({ type: 'consistency', name: '📈 꾸준함', desc: '평균 HTP 200+', level: 'bronze', icon: '📈' });
        }
        
        // === 3. 근태 뱃지 (Attendance Badges) ===
        if (records.totalDays >= 30) {
            badges.push({ type: 'attendance', name: '📅 개근왕', desc: '30일 근무', level: 'gold', icon: '📅' });
        } else if (records.totalDays >= 20) {
            badges.push({ type: 'attendance', name: '📆 성실함', desc: '20일 근무', level: 'silver', icon: '📆' });
        } else if (records.totalDays >= 10) {
            badges.push({ type: 'attendance', name: '🗓️ 꾸준함', desc: '10일 근무', level: 'bronze', icon: '🗓️' });
        }
        
        // === 4. 연속 근무 뱃지 (Streak Badges) ===
        if (records.maxConsecutiveDays >= 15) {
            badges.push({ type: 'streak', name: '🔥 불타는 열정', desc: '15일 연속', level: 'gold', icon: '🔥' });
        } else if (records.maxConsecutiveDays >= 10) {
            badges.push({ type: 'streak', name: '⚡ 끈기왕', desc: '10일 연속', level: 'silver', icon: '⚡' });
        } else if (records.maxConsecutiveDays >= 5) {
            badges.push({ type: 'streak', name: '💪 집중력', desc: '5일 연속', level: 'bronze', icon: '💪' });
        }
        
        // === 5. 작업량 뱃지 (Volume Badges) ===
        if (records.totalQty >= 50000) {
            badges.push({ type: 'volume', name: '🎁 물량왕', desc: '총 50,000+', level: 'gold', icon: '🎁' });
        } else if (records.totalQty >= 30000) {
            badges.push({ type: 'volume', name: '📦 다작러', desc: '총 30,000+', level: 'silver', icon: '📦' });
        } else if (records.totalQty >= 10000) {
            badges.push({ type: 'volume', name: '📦 열심히', desc: '총 10,000+', level: 'bronze', icon: '📦' });
        }
        
        // === 6. 완벽한 날 뱃지 (Perfect Day Badges) ===
        const perfectRatio = records.totalDays > 0 ? (records.perfectDays / records.totalDays) : 0;
        if (perfectRatio >= 0.9 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: '💯 퍼펙트', desc: '목표 달성 90%+', level: 'gold', icon: '💯' });
        } else if (perfectRatio >= 0.7 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: '✅ 우수함', desc: '목표 달성 70%+', level: 'silver', icon: '✅' });
        } else if (perfectRatio >= 0.5 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: '👍 양호함', desc: '목표 달성 50%+', level: 'bronze', icon: '👍' });
        }
        
        // === 7. 전문가 뱃지 (Specialist Badges) ===
        if (records.specialtyProcess === 'PICK' && records.pickDays >= 15) {
            badges.push({ type: 'specialist', name: '🎯 PICK 전문가', desc: 'PICK 집중', level: 'gold', icon: '🎯' });
        } else if (records.specialtyProcess === 'PACK' && records.packDays >= 15) {
            badges.push({ type: 'specialist', name: '📦 PACK 전문가', desc: 'PACK 집중', level: 'gold', icon: '📦' });
        }
        
        // === 8. 특별 뱃지 (Special Badges) ===
        // 초보자 뱃지
        if (records.totalDays <= 3) {
            badges.push({ type: 'special', name: '🌱 신입', desc: '첫 3일', level: 'normal', icon: '🌱' });
        }
        
        // 올라운더 뱃지 (PICK & PACK 균형)
        if (records.pickDays >= 10 && records.packDays >= 10) {
            const ratio = Math.min(records.pickDays, records.packDays) / Math.max(records.pickDays, records.packDays);
            if (ratio >= 0.7) {
                badges.push({ type: 'special', name: '🎭 올라운더', desc: 'PICK & PACK 균형', level: 'gold', icon: '🎭' });
            }
        }
        
        // 성장 뱃지 (최근 성적 향상)
        if (htpHistory.length >= 10) {
            const firstHalf = htpHistory.slice(0, htpHistory.length / 2);
            const secondHalf = htpHistory.slice(htpHistory.length / 2);
            const avgFirst = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const avgSecond = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            const improvement = ((avgSecond - avgFirst) / avgFirst) * 100;
            
            if (improvement >= 30) {
                badges.push({ type: 'special', name: '🚀 급성장', desc: '성적 30%+ 향상', level: 'gold', icon: '🚀' });
            } else if (improvement >= 15) {
                badges.push({ type: 'special', name: '📈 성장세', desc: '성적 15%+ 향상', level: 'silver', icon: '📈' });
            }
        }
        
        // 최고 기록 보유자 (전체 1등 HTP)
        // 이건 나중에 전체 비교해서 부여
        
        // === 9. 재미 뱃지 (Fun Badges) ===
        // 아침형 인간 / 올빼미 (시간대 분석은 복잡하므로 생략)
        
        // 행운의 숫자 (HTP에 7이 들어가는 경우)
        if (records.maxHtp.toString().includes('7')) {
            badges.push({ type: 'fun', name: '🍀 행운의 7', desc: 'HTP에 7 포함', level: 'normal', icon: '🍀' });
        }
        
        // === 10. 부정적 뱃지 (Improvement Needed) ===
        // 너무 부정적이므로 주석 처리
        /*
        if (records.lowHtpCount > records.totalDays * 0.5) {
            badges.push({ type: 'warning', name: '⚠️ 개선 필요', desc: '저효율 많음', level: 'warning', icon: '⚠️' });
        }
        */
        
        employeeBadges[employeeName] = { badges, records };
    });
    
    // === 전체 순위 기반 뱃지 부여 ===
    // 최고 HTP 보유자 찾기
    let maxHtpOverall = 0;
    let maxHtpEmployee = null;
    Object.keys(employeeBadges).forEach(emp => {
        const empBadges = employeeBadges[emp];
        if (empBadges.records.maxHtp > maxHtpOverall) {
            maxHtpOverall = empBadges.records.maxHtp;
            maxHtpEmployee = emp;
        }
    });
    
    if (maxHtpEmployee && employeeBadges[maxHtpEmployee]) {
        employeeBadges[maxHtpEmployee].badges.unshift({ 
            type: 'champion', 
            name: '👑 챔피언', 
            desc: `최고 HTP ${maxHtpOverall.toFixed(0)}`, 
            level: 'legendary', 
            icon: '👑' 
        });
    }
    
    console.log(`✅ 뱃지 계산 완료! (총 ${Object.keys(employeeBadges).length}명)`);
}

    const FILTER_PRESET_STORAGE_KEY = 'gwj2-filter-preset-v1';

    function syncHourFilterButtonState() {
        const allHoursCheckbox = document.getElementById('all-hours-checkbox');
        const hasSelectedHour = state.filters.hours.size > 0;
        if (allHoursCheckbox) {
            allHoursCheckbox.checked = !hasSelectedHour;
        }

        document.querySelectorAll('.hour-filter-btn').forEach(btn => {
            const hour = parseInt(btn.dataset.hour, 10);
            const isActive = state.filters.hours.has(hour);
            btn.classList.toggle('bg-blue-500', isActive);
            btn.classList.toggle('border-blue-400', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('shadow-lg', isActive);
            btn.classList.toggle('scale-110', isActive);
            btn.classList.toggle('bg-gray-700', !isActive);
            btn.classList.toggle('border-gray-600', !isActive);
            btn.classList.toggle('text-gray-300', !isActive);
        });
    }

    function syncCheckboxFilterState(container, selectedValues) {
        if (!container || !selectedValues) return;
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = selectedValues.has(cb.value);
        });
    }

    function syncFilterUiFromState() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const isActive = btn.id === `filter-${state.filters.process}`;
            btn.classList.toggle('active', isActive);
        });

        if (ui.searchInput) {
            ui.searchInput.value = state.filters.search || '';
        }

        if (ui.lowHtpToggle) {
            ui.lowHtpToggle.checked = !!state.filters.lowHtp;
        }

        syncHourFilterButtonState();
        syncCheckboxFilterState(ui.floorFilters, state.filters.floors);
        syncCheckboxFilterState(ui.packTypeFilters, state.filters.packTypes);
    }

    function saveFilterPreset() {
        const payload = {
            version: 1,
            savedAt: new Date().toISOString(),
            filters: {
                process: state.filters.process,
                search: state.filters.search,
                lowHtp: state.filters.lowHtp,
                hours: Array.from(state.filters.hours),
                floors: Array.from(state.filters.floors),
                packTypes: Array.from(state.filters.packTypes),
            },
            sort: {
                key: state.sort.key,
                direction: state.sort.direction,
            }
        };
        localStorage.setItem(FILTER_PRESET_STORAGE_KEY, JSON.stringify(payload));
        showModal('필터 프리셋 저장 완료', 1400);
    }

    function loadFilterPreset() {
        const raw = localStorage.getItem(FILTER_PRESET_STORAGE_KEY);
        if (!raw) {
            showModal('저장된 필터 프리셋이 없습니다.', 1600);
            return;
        }

        try {
            const parsed = JSON.parse(raw);
            const nextFilters = parsed && parsed.filters ? parsed.filters : {};
            const nextSort = parsed && parsed.sort ? parsed.sort : {};
            const allowedProcess = ['all', 'pick', 'pack'];

            state.filters.process = allowedProcess.includes(nextFilters.process) ? nextFilters.process : 'all';
            state.filters.search = typeof nextFilters.search === 'string' ? nextFilters.search.toLowerCase() : '';
            state.filters.lowHtp = !!nextFilters.lowHtp;
            state.filters.hours = new Set(
                Array.isArray(nextFilters.hours)
                    ? nextFilters.hours
                        .map(hour => Number(hour))
                        .filter(hour => Number.isInteger(hour) && hour >= 0 && hour <= 23)
                    : []
            );
            state.filters.floors = new Set(Array.isArray(nextFilters.floors) ? nextFilters.floors : []);
            state.filters.packTypes = new Set(Array.isArray(nextFilters.packTypes) ? nextFilters.packTypes : []);

            state.sort.key = typeof nextSort.key === 'string' ? nextSort.key : 'htp';
            state.sort.direction = nextSort.direction === 'desc' ? 'desc' : 'asc';

            syncFilterUiFromState();
            updateSortIndicators();
            applyFiltersAndRender();
            showModal('필터 프리셋 복원 완료', 1400);
        } catch (error) {
            console.error('필터 프리셋 파싱 오류:', error);
            localStorage.removeItem(FILTER_PRESET_STORAGE_KEY);
            showModal('필터 프리셋이 손상되어 초기화했습니다.', 1800);
        }
    }

    function syncBackgroundMotionState() {
        document.body.classList.toggle('motion-paused', document.hidden);
    }

    // --- Event Listeners ---
    function toggleMobileSidebar() {
        const isOpen = ui.sidebar.classList.toggle('open');
        ui.sidebarOverlay.classList.toggle('hidden', !isOpen);
    }
    function toggleDesktopSidebar() {
        ui.appContainer.classList.toggle('sidebar-collapsed');
    }

    ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
    ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
    ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

    const themeToggleBtn = document.getElementById('theme-toggle');
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', toggleTheme);
    }

    ui.fileUpload.addEventListener('change', handleFileUpload);
    // ⚡ DEBOUNCED: 검색 입력
    let searchDebounceTimer;
    ui.searchInput.addEventListener('input', (e) => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            state.filters.search = e.target.value.trim().toLowerCase();
            applyFiltersAndRender();
        }, 180); // 180ms 디바운스
    });
    // ⚡ DEBOUNCED: 필터 토글
    let filterDebounceTimer;
    ui.lowHtpToggle.addEventListener('change', (e) => {
        clearTimeout(filterDebounceTimer);
        filterDebounceTimer = setTimeout(() => {
            state.filters.lowHtp = e.target.checked;
            applyFiltersAndRender();
        }, 100); // 100ms 디바운스
    });
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            state.filters.process = e.currentTarget.id.replace('filter-', '');
            applyFiltersAndRender();
        });
    });
    ui.captureBtn.addEventListener('click', captureTable);
    ui.exportBtn.addEventListener('click', exportToExcel);
    if (ui.saveFilterPresetBtn) {
        ui.saveFilterPresetBtn.addEventListener('click', saveFilterPreset);
    }
    if (ui.loadFilterPresetBtn) {
        ui.loadFilterPresetBtn.addEventListener('click', loadFilterPreset);
    }
    document.addEventListener('visibilitychange', syncBackgroundMotionState);
    syncBackgroundMotionState();
    ui.tableHeader.addEventListener('click', (e) => {
        const headerCell = e.target.closest('.sortable');
        if (!headerCell) return;
        const sortKey = headerCell.dataset.sortKey;
        if (state.sort.key === sortKey) {
            if (state.sort.direction === 'asc') state.sort.direction = 'desc';
            else if (state.sort.direction === 'desc') { state.sort.key = 'htp'; state.sort.direction = 'asc'; }
        } else {
            state.sort.key = sortKey;
            state.sort.direction = 'asc';
        }
        applyFiltersAndRender();
    });

    function isDashboardVisible() {
        return !ui.dashboardView.classList.contains('hidden');
    }

    function flushDashboardUpdate() {
        if (!state.dashboardCache) return;
        if (state.dashboardRafId) cancelAnimationFrame(state.dashboardRafId);
        state.dashboardRafId = requestAnimationFrame(() => {
            state.dashboardRafId = null;
            updateDashboard(state.dashboardCache.filteredData, state.dashboardCache.rawData);
            state.dashboardDirty = false;
            
            // 🆕 데이터 갱신 시 애니메이션 자동 실행
            if (isDashboardVisible()) {
                animateDashboardEntrance();
            }
        });
    }

    function queueDashboardUpdate(filteredAggregatedData, timeFilteredRawData, force = false) {
        state.dashboardCache = { filteredData: filteredAggregatedData, rawData: timeFilteredRawData };
        state.dashboardDirty = true;
        if (force || isDashboardVisible()) {
            flushDashboardUpdate();
        }
    }

    // View Switcher
    ui.tableViewBtn.addEventListener('click', () => switchView('table'));
    ui.dashboardViewBtn.addEventListener('click', () => switchView('dashboard'));
    ui.historyViewBtn.addEventListener('click', () => switchView('history'));
    ui.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
    ui.rankingViewBtn.addEventListener('click', () => switchView('ranking'));

    function switchView(viewName) {
        ui.tableView.classList.add('hidden');
        ui.dashboardView.classList.add('hidden');
        ui.historyView.classList.add('hidden');
        ui.calendarView.classList.add('hidden');
        ui.rankingView.classList.add('hidden');
        ui.dashboardView.classList.remove('flex');
        ui.historyView.classList.remove('flex');
        ui.calendarView.classList.remove('flex');
        ui.rankingView.classList.remove('flex');
        
        ui.tableViewBtn.classList.remove('active');
        ui.dashboardViewBtn.classList.remove('active');
        ui.historyViewBtn.classList.remove('active');
        ui.calendarViewBtn.classList.remove('active');
        ui.rankingViewBtn.classList.remove('active');

        document.body.setAttribute('data-active-view', viewName);
        
        switch(viewName) {
            case 'table':
                ui.tableView.classList.remove('hidden');
                ui.tableViewBtn.classList.add('active');
                break;
            case 'dashboard':
                ui.dashboardView.classList.remove('hidden');
                ui.dashboardView.classList.add('flex');
                ui.dashboardViewBtn.classList.add('active');
                if (state.dashboardDirty) flushDashboardUpdate();
                
                // 🆕 Dashboard Wow Animations
                animateDashboardEntrance(true);
                break;
            case 'history':
                ui.historyView.classList.remove('hidden');
                ui.historyView.classList.add('flex');
                ui.historyViewBtn.classList.add('active');
                if (!isHistoryLoaded && !isLoadingHistory) {
                    loadHistoryData().then(() => {
                        ensureBadgesCalculated();
                        renderHistoryView();
                    });
                } else {
                    ensureBadgesCalculated();
                    renderHistoryView();
                }
                break;
            case 'calendar':
                ui.calendarView.classList.remove('hidden');
                ui.calendarView.classList.add('flex');
                ui.calendarViewBtn.classList.add('active');
                renderCalendarView();
                break;
            case 'ranking':
                ui.rankingView.classList.remove('hidden');
                ui.rankingView.classList.add('flex');
                ui.rankingViewBtn.classList.add('active');
                ensureBadgesCalculated();
                renderRankingView();
                break;
        }
    }

    // 🆕 Dashboard Visual Enhancements
    function animateDashboardEntrance(force = false) {
        if (document.body.classList.contains('motion-paused')) return;
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        const now = performance.now();
        if (!force && now - state.lastDashboardAnimationAt < 700) return;
        state.lastDashboardAnimationAt = now;

        const cards = ui.dashboardView.querySelectorAll('.dash-kpi-card, .dash-chart-card, .dash-process-summary, .dash-insight-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0) scale(1)';
            }, index * 60);
        });

        // KPI 숫자 애니메이션 실행
        animateValue(ui.kpi.totalWorkers);
        animateValue(ui.kpi.totalQty);
        animateValue(ui.kpi.avgHtp, 1);
        animateValue(ui.kpi.lowPerformers);
        animateValue(document.getElementById('kpi-target-achievement'), 1, '%');
    }

    function animateValue(obj, decimals = 0, suffix = '') {
        if (!obj) return;
        if (document.body.classList.contains('motion-paused')) return;
        const text = obj.textContent.replace(/,/g, '').replace('%', '');
        const end = parseFloat(text);
        if (isNaN(end)) return;
        
        const start = 0;
        const duration = 1200;
        let startTimestamp = null;
        
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            // Ease out cubic
            const easeProgress = 1 - Math.pow(1 - progress, 3);
            const current = (easeProgress * (end - start) + start);
            
            if (decimals > 0) {
                obj.textContent = current.toFixed(decimals) + suffix;
            } else {
                obj.textContent = Math.floor(current).toLocaleString() + suffix;
            }
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                if (decimals > 0) obj.textContent = end.toFixed(decimals) + suffix;
                else obj.textContent = end.toLocaleString() + suffix;
            }
        };
        window.requestAnimationFrame(step);
    }

    // History Period Selectors
    ui.periodWeekBtn.addEventListener('click', () => {
        setHistoryPeriod('week');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodMonthBtn.addEventListener('click', () => {
        setHistoryPeriod('month');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodAllBtn.addEventListener('click', () => {
        setHistoryPeriod('all');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodCustomBtn.addEventListener('click', () => {
        ui.customDateRange.classList.remove('hidden');
        document.querySelectorAll('.hist-period-btn, .period-btn').forEach(btn => btn.classList.remove('active'));
        ui.periodCustomBtn.classList.add('active');
    });
    ui.applyCustomRange.addEventListener('click', () => {
        const start = ui.startDate.value;
        const end = ui.endDate.value;
        if (start && end) {
            state.historyPeriod = 'custom';
            state.historyDateRange = { start, end };
            renderHistoryView();
        } else {
            showModal('시작일과 종료일을 모두 선택해주세요.');
        }
    });

    function setHistoryPeriod(period) {
        state.historyPeriod = period;
        document.querySelectorAll('.hist-period-btn, .period-btn').forEach(btn => btn.classList.remove('active'));
        if (period === 'week') ui.periodWeekBtn.classList.add('active');
        else if (period === 'month') ui.periodMonthBtn.classList.add('active');
        else if (period === 'all') ui.periodAllBtn.classList.add('active');
        renderHistoryView();
    }

    ui.exportHistoryExcel.addEventListener('click', exportHistoryToExcel);
    ui.exportHistoryPdf.addEventListener('click', exportHistoryToPDF);

    ui.calendarPrevMonth.addEventListener('click', () => {
        state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() - 1);
        renderCalendarView();
    });
    ui.calendarNextMonth.addEventListener('click', () => {
        state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() + 1);
        renderCalendarView();
    });

    ui.rankingDaily.addEventListener('click', () => setRankingPeriod('daily'));
    ui.rankingWeekly.addEventListener('click', () => setRankingPeriod('weekly'));
    ui.rankingMonthly.addEventListener('click', () => setRankingPeriod('monthly'));
    ui.rankingAllTime.addEventListener('click', () => setRankingPeriod('all-time'));

    function setRankingPeriod(period) {
        state.rankingPeriod = period;
        document.querySelectorAll('#ranking-daily, #ranking-weekly, #ranking-monthly, #ranking-all-time').forEach(btn => btn.classList.remove('active'));
        if (period === 'daily') ui.rankingDaily.classList.add('active');
        else if (period === 'weekly') ui.rankingWeekly.classList.add('active');
        else if (period === 'monthly') ui.rankingMonthly.classList.add('active');
        else if (period === 'all-time') ui.rankingAllTime.classList.add('active');
        renderRankingView();
    }

    ui.rankingPickType.addEventListener('click', () => setRankingProcessType('pick'));
    ui.rankingPackType.addEventListener('click', () => setRankingProcessType('pack'));

    function setRankingProcessType(type) {
        state.rankingProcessType = type;
        document.querySelectorAll('#ranking-pick-type, #ranking-pack-type').forEach(btn => btn.classList.remove('active'));
        if (type === 'pick') ui.rankingPickType.classList.add('active');
        else ui.rankingPackType.classList.add('active');
        renderRankingView();
    }

    function setHiddenEmployeesPanelOpen(isOpen) {
        ui.hiddenEmployeesList.classList.toggle('is-open', isOpen);
        ui.hiddenEmployeesList.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        ui.manageHiddenBtn.classList.toggle('active', isOpen);
        ui.manageHiddenBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) renderHiddenEmployeesList();
    }

    ui.manageHiddenBtn.addEventListener('click', () => {
        const shouldOpen = !ui.hiddenEmployeesList.classList.contains('is-open');
        setHiddenEmployeesPanelOpen(shouldOpen);
    });

    function renderHiddenEmployeesList() {
        ui.hiddenEmployeesList.innerHTML = '';
        
        if (hiddenEmployees.size === 0) {
            ui.hiddenEmployeesList.innerHTML = '<p class="text-sm text-gray-400 mb-2">숨긴 작업자가 없습니다.</p>';
            return;
        }

        hiddenEmployees.forEach(employeeName => {
            const item = document.createElement('div');
            item.className = 'hidden-employee-item';
            item.innerHTML = `
                <span class="font-semibold text-white text-sm">${employeeName.split('(')[0].trim()}</span>
                <button class="show-employee-btn-small" data-employee="${employeeName}">복구</button>
            `;
            ui.hiddenEmployeesList.appendChild(item);
        });

        ui.hiddenEmployeesList.querySelectorAll('.show-employee-btn-small').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const employeeName = e.target.dataset.employee;
                toggleHiddenEmployee(employeeName);
                renderHiddenEmployeesList();
            });
        });
    }

    ui.hiddenEmployeesModalClose.addEventListener('click', () => {
        ui.hiddenEmployeesModalBackdrop.classList.add('hidden');
        ui.hiddenEmployeesModalBackdrop.classList.remove('flex');
    });

    ui.employeeDetailClose.addEventListener('click', () => {
        ui.employeeDetailModalBackdrop.classList.add('hidden');
        ui.employeeDetailModalBackdrop.classList.remove('flex');
    });

    ui.calendarDetailClose.addEventListener('click', () => {
        ui.calendarDetailModalBackdrop.classList.add('hidden');
        ui.calendarDetailModalBackdrop.classList.remove('flex');
    });

    ui.tableBody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row || row.id === 'placeholder-row') return;
        
        if (e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn')) {
            const btn = e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn');
            const employeeName = btn.dataset.employee;
            toggleHiddenEmployee(employeeName);
            return;
        }

        const employeeCell = row.querySelector('td:nth-child(2)');
        const processCell = row.querySelector('td:nth-child(1)');
        if(employeeCell && processCell) {
            const employeeName = employeeCell.textContent.replace(/[👑🔥🐢🥇🥈🥉]\s*/g, '').trim();
            const processType = processCell.textContent;
            showIndividualTrend(employeeName, processType);
        }
    });
    
    ui.chartModalClose.addEventListener('click', () => {
        ui.chartModalBackdrop.classList.add('hidden');
        ui.chartModalBackdrop.classList.remove('flex');
    });
    ui.chartModalBackdrop.addEventListener('click', (e) => {
        if (e.target === ui.chartModalBackdrop || e.target.classList.contains('edm-backdrop-dots') || e.target.classList.contains('edm-dot')) {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
            ui.chartModalBackdrop.classList.remove('edm-backdrop-fx');
            const dots = ui.chartModalBackdrop.querySelector('.edm-backdrop-dots');
            if (dots) dots.remove();
        }
    });

    // --- Helper Functions ---
    function normalizeText(value) {
        return (typeof value === 'string' ? value : '').trim();
    }

    function isMissingLocation(value) {
        const text = normalizeText(value);
        if (!text) return true;
        return text === '-' || text.toUpperCase() === 'N/A';
    }

    function extractWorkstationToken(...values) {
        const workstationPattern = /\b(AB_M_[A-Z0-9._-]*|MA_M_[A-Z0-9._-]*|AB_OM_[A-Z0-9._-]*)\b/i;
        for (const value of values) {
            const text = normalizeText(value);
            if (!text) continue;
            const match = text.match(workstationPattern);
            if (match) return match[1];
        }
        return '';
    }

    function getResolvedLocation(location, processPathName) {
        const locationText = normalizeText(location);
        if (!isMissingLocation(locationText)) return locationText;
        const token = extractWorkstationToken(processPathName);
        return token || locationText;
    }

    function getPackType(location, processTask, processPathName) {
        const locationText = normalizeText(location);
        const processPathText = normalizeText(processPathName);
        const candidates = [locationText, processPathText].filter(Boolean).map(text => text.toUpperCase());
        if (candidates.length === 0) return DEFAULT_PACK_TYPE;

        for (const [name, prefixes] of Object.entries(PACK_TYPE_MAP)) {
            const normalizedPrefixes = Array.isArray(prefixes) ? prefixes : [prefixes];
            for (const prefix of normalizedPrefixes) {
                const normalizedPrefix = normalizeText(prefix).toUpperCase();
                if (!normalizedPrefix) continue;
                if (candidates.some(text => text.startsWith(normalizedPrefix) || text.includes(normalizedPrefix))) {
                    return name;
                }
            }
        }

        // 오토백 멀티: Pack at Rebin 작업대명 처리 + 신규 AB_M 접두어 fallback
        if (candidates.some(text => text.startsWith('PACK AT REBIN') || text.includes('AB_M_') || text.includes('AB_OM_'))) {
            return "오토백 멀티";
        }
        if (candidates.some(text => text.includes('MA_M_'))) {
            return "메뉴얼팩 멀티";
        }
        return DEFAULT_PACK_TYPE;
    }

    function getTargetHtp(item) {
        if (item.processType.includes('PICK')) return targetHtpValues['PICK'] || 0;
        if (item.processType.includes('PACK')) {
            const searchText = `${item.processPathName || ""} ${item.location || ""}`.toUpperCase();
            for (const name in TARGET_HTP_DEFAULTS) {
                if (name === "PICK") continue;
                const config = TARGET_HTP_DEFAULTS[name];
                if (config.keywords.some(keyword => searchText.includes((keyword || '').toUpperCase()))) {
                    return targetHtpValues[name] || 0;
                }
            }
            return targetHtpValues["Manual SINGULATION"] || 0;
        }
        return 0;
    }

    function parseExcelData(data) {
        if (data.length < 2) return [];
        const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
        const COLS_TO_LOAD = {
            workDate: 'work date', employee: 'employee', unitQty: 'unit qty', location: 'location', floor: 'floor',
            processPathName: 'process path name', htpStart: 'htp start', htpEnd: 'htp end', processTask: 'process(task)',
            contractType: 'contract type'
        };
        const colIndices = {};
        const missingCols = [];
        for (const key in COLS_TO_LOAD) {
            const index = headers.indexOf(COLS_TO_LOAD[key]);
            if (index === -1 && key !== 'contractType') missingCols.push(COLS_TO_LOAD[key]);
            colIndices[key] = index;
        }
        if (missingCols.length > 0) throw new Error(`엑셀 파일에 다음 필수 컬럼이 없습니다:\n[${missingCols.join(', ')}]`);

        const rawData = data.slice(1).map(row => {
            const combineDateTime = (dateValue, timeValue) => {
                if (!dateValue || !timeValue) return null;
                let datePart = (typeof dateValue === 'number') ? new Date(Date.UTC(1899, 11, 30) + dateValue * 24 * 60 * 60 * 1000) : new Date(dateValue);
                if (isNaN(datePart.getTime())) return null;
                let timePart;
                if (typeof timeValue === 'number') timePart = new Date(Date.UTC(1899, 11, 30) + timeValue * 24 * 60 * 60 * 1000);
                else if (typeof timeValue === 'string') {
                    const parts = timeValue.split(':');
                    timePart = new Date(0);
                    timePart.setUTCHours(parts[0] || 0, parts[1] || 0, parts[2] || 0, 0);
                } else timePart = timeValue;
                if (isNaN(timePart.getTime())) return null;
                return new Date(Date.UTC(datePart.getUTCFullYear(), datePart.getUTCMonth(), datePart.getUTCDate(), timePart.getUTCHours(), timePart.getUTCMinutes(), timePart.getUTCSeconds()));
            };
            const htpStart = combineDateTime(row[colIndices.workDate], row[colIndices.htpStart]);
            const htpEnd = combineDateTime(row[colIndices.workDate], row[colIndices.htpEnd]);
            if (!htpStart || !htpEnd) return null;
            const durationSeconds = (htpEnd - htpStart) / 1000;
            if (durationSeconds <= 0) return null;
            let processTask = row[colIndices.processTask] || '';
            const location = row[colIndices.location] || '';
            const processPathName = row[colIndices.processPathName] || '';
            if (processTask === 'REBIN(REBIN)' && location.startsWith('Pack at Rebin')) processTask = 'PACK(PACKING)';
            return {
                employee: row[colIndices.employee] || '', unitQty: parseInt(row[colIndices.unitQty] || 0),
                location: location, floor: row[colIndices.floor] || '',
                processPathName: processPathName, processTask: processTask,
                contractType: colIndices.contractType !== -1 ? (row[colIndices.contractType] || '').toUpperCase() : '',
                htpStart: htpStart, htpEnd: htpEnd
            };
        }).filter(item => {
            if (!item || !item.employee || item.unitQty <= 0) return false;
            if (item.employee === 'AGV_Agent') return false;
            return item.processTask === 'PICK(PICKING)' || item.processTask === 'PACK(PACKING)';
        });
        return rawData;
    }

    function aggregateData(rawData) {
        const aggregatedMap = new Map();
        rawData.forEach(item => {
            let key, packType = null;
            if (item.processTask === 'PICK(PICKING)') {
                key = `${item.employee}|${item.processPathName}|${item.floor}|PICK`;
                packType = '집품';
            } else {
                packType = getPackType(item.location, item.processTask, item.processPathName);
                key = `${item.employee}|${packType}|PACK`;
            }
            const resolvedLocation = getResolvedLocation(item.location, item.processPathName);
            const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
            if (durationSeconds <= 0) return;
            if (!aggregatedMap.has(key)) {
                const empIdMatch = item.employee.match(/\((.*?)\)/);
                const empId = empIdMatch ? empIdMatch[1] : '';
                aggregatedMap.set(key, {
                    processType: item.processTask.includes('PICK') ? 'PICK(집품)' : 'PACK(포장)',
                    employee: item.employee, floor: item.floor, unitQty: 0, totalSeconds: 0,
                    location: resolvedLocation, processPathName: item.processPathName, packType: packType,
                    isManager: MANAGERS_LIST.includes(empId), isPerm: item.contractType === 'PERM',
                    employeeKey: (item.employee || '').toLowerCase()
                });
            }
            const group = aggregatedMap.get(key);
            group.unitQty += item.unitQty;
            group.totalSeconds += durationSeconds;
            if (isMissingLocation(group.location) && !isMissingLocation(resolvedLocation)) {
                group.location = resolvedLocation;
            }
            group.processPathName = item.processPathName;
            group.floor = item.floor;
        });
        const finalData = [];
        for (const group of aggregatedMap.values()) {
            const mh = group.totalSeconds > 0 ? group.totalSeconds / 3600 : 0;
            if (mh >= 0.25 && group.unitQty >= 30) {
                const htpValue = mh > 0 ? group.unitQty / mh : 0;
                finalData.push({
                    ...group,
                    mh: mh.toFixed(4),
                    htp: htpValue.toFixed(1),
                    mhNum: mh,
                    htpNum: htpValue
                });
            }
        }

        return finalData;
    }

    function initializeFiltersFromData(rawData) {
        const allPackTypes = new Set();
        const floors = new Set();
        rawData.forEach(item => {
            if(item.processTask.includes('PICK')) {
                if(item.floor) floors.add(item.floor);
            } else if (item.processTask.includes('PACK')) {
                allPackTypes.add(getPackType(item.location, item.processTask, item.processPathName));
            }
        });
        createFilterCheckboxes(ui.packTypeFilters, Array.from(allPackTypes).sort(), 'packTypes', 'packtypes');
        createFilterCheckboxes(ui.floorFilters, Array.from(floors).sort(), 'floors', 'floors');
        createTimeFilters();
        createTargetHtpSettings();
    }

    function createTimeFilters() {
        const allHoursCheckbox = document.getElementById('all-hours-checkbox');
        ui.hourFilters.innerHTML = '';
        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            
            // 버튼 스타일 체크박스로 변경
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'hour-filter-btn text-xs font-bold py-2 px-1 rounded-lg transition-all duration-200 bg-gray-700 hover:bg-gray-600 text-gray-300 border-2 border-gray-600';
            button.dataset.hour = i;
            button.textContent = hour;
            
            button.addEventListener('click', (e) => {
                const hourVal = parseInt(e.currentTarget.dataset.hour);
                const isActive = state.filters.hours.has(hourVal);
                
                if (isActive) {
                    state.filters.hours.delete(hourVal);
                    e.currentTarget.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    e.currentTarget.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                } else {
                    state.filters.hours.add(hourVal);
                    e.currentTarget.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    e.currentTarget.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    allHoursCheckbox.checked = false;
                }
                
                if (state.filters.hours.size === 0) allHoursCheckbox.checked = true;
                applyFiltersAndRender();
            });
            
            ui.hourFilters.appendChild(button);
        }
        
        allHoursCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                });
                state.filters.hours.clear();
                applyFiltersAndRender();
            }
        });
        
        // DAY 조 선택 버튼 (09시-18시)
        document.getElementById('select-day-shift').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            state.filters.hours.clear();
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                if (hour >= 9 && hour <= 18) {
                    btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    state.filters.hours.add(hour);
                } else {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                }
            });
            applyFiltersAndRender();
        });
        
        // SWING 조 선택 버튼 (19시-08시)
        document.getElementById('select-swing-shift').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            state.filters.hours.clear();
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                if (hour >= 19 || hour <= 8) {
                    btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    state.filters.hours.add(hour);
                } else {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                }
            });
            applyFiltersAndRender();
        });
        
        document.getElementById('select-all-hours').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                state.filters.hours.add(hour);
            });
            applyFiltersAndRender();
        });
        
        document.getElementById('deselect-all-hours').addEventListener('click', () => {
            allHoursCheckbox.checked = true;
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
            });
            state.filters.hours.clear();
            applyFiltersAndRender();
        });
    }

    function createFilterCheckboxes(container, items, filterType, type) {
        // ⚡ OPTIMIZED: DocumentFragment로 리플로우 최소화
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        items.forEach(item => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-3 text-sm cursor-pointer bg-gray-800 bg-opacity-40 px-3 py-2.5 rounded-lg hover:bg-opacity-60 transition-all border border-transparent hover:border-gray-500';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.value = item;
            checkbox.className = `form-checkbox ${type}-checkbox w-5 h-5 rounded border-2 border-gray-500 text-blue-500 focus:ring-2 focus:ring-blue-400`;
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) state.filters[filterType].add(item);
                else state.filters[filterType].delete(item);
                applyFiltersAndRender();
            });
            label.appendChild(checkbox);
            const text = document.createElement('span');
            text.textContent = item;
            text.className = 'font-bold text-white';
            label.appendChild(text);
            fragment.appendChild(label); // ⚡ fragment에 추가
        });
        
        // ⚡ 한 번에 DOM에 추가 (리플로우 1회만)
        container.appendChild(fragment);
        
        const selectAllBtn = document.getElementById(`select-all-${type}`);
        const deselectAllBtn = document.getElementById(`deselect-all-${type}`);
        if (selectAllBtn && deselectAllBtn) {
            selectAllBtn.onclick = () => {
                container.querySelectorAll('input').forEach(cb => { cb.checked = true; state.filters[filterType].add(cb.value); });
                applyFiltersAndRender();
            };
            deselectAllBtn.onclick = () => {
                container.querySelectorAll('input').forEach(cb => { cb.checked = false; state.filters[filterType].delete(cb.value); });
                applyFiltersAndRender();
            };
        }
    }

    let targetHtpApplyDebounceTimer = null;

    function queueTargetHtpApplyRender(delay = 120) {
        clearTimeout(targetHtpApplyDebounceTimer);
        targetHtpApplyDebounceTimer = setTimeout(() => {
            applyFiltersAndRender();
        }, delay);
    }

    function getTargetHtpRangeMax(baseValue) {
        const safeBase = Number(baseValue) || 100;
        const scaled = Math.ceil((safeBase * 2.4) / 10) * 10;
        return Math.max(300, Math.min(1200, scaled));
    }

    function clampTargetHtpValue(value, min, max) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return min;
        return Math.max(min, Math.min(max, Math.round(numeric)));
    }

    function createTargetHtpSettings() {
        ui.targetHtpSettings.innerHTML = '';

        const panel = document.createElement('div');
        panel.className = 'target-htp-panel';

        const toolbar = document.createElement('div');
        toolbar.className = 'target-htp-toolbar';
        const toolbarTitle = document.createElement('span');
        toolbarTitle.className = 'target-htp-toolbar-title';
        toolbarTitle.textContent = 'Target HTP Controls';
        const resetAllBtn = document.createElement('button');
        resetAllBtn.type = 'button';
        resetAllBtn.className = 'target-htp-reset-all';
        resetAllBtn.textContent = '기본값 복원';
        resetAllBtn.addEventListener('click', () => {
            Object.keys(TARGET_HTP_DEFAULTS).forEach((key) => {
                targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
            });
            createTargetHtpSettings();
            applyFiltersAndRender();
            showModal('Target HTP를 기본값으로 복원했습니다.', 1300);
        });
        toolbar.appendChild(toolbarTitle);
        toolbar.appendChild(resetAllBtn);
        panel.appendChild(toolbar);

        const grid = document.createElement('div');
        grid.className = 'target-htp-grid';

        Object.entries(TARGET_HTP_DEFAULTS).forEach(([key, config]) => {
            const defaultValue = Number(config.value) || 0;
            const step = defaultValue >= 200 ? 5 : 1;
            const minValue = 0;
            const maxValue = getTargetHtpRangeMax(defaultValue);
            const initialValue = clampTargetHtpValue(
                targetHtpValues[key] ?? defaultValue,
                minValue,
                maxValue
            );
            targetHtpValues[key] = initialValue;

            const item = document.createElement('div');
            item.className = 'target-htp-item';

            const head = document.createElement('div');
            head.className = 'target-htp-head';
            const name = document.createElement('span');
            name.className = 'target-htp-name';
            name.textContent = key;
            const defaultBadge = document.createElement('span');
            defaultBadge.className = 'target-htp-default';
            defaultBadge.textContent = `기본 ${defaultValue}`;
            head.appendChild(name);
            head.appendChild(defaultBadge);

            const controls = document.createElement('div');
            controls.className = 'target-htp-controls';

            const minusBtn = document.createElement('button');
            minusBtn.type = 'button';
            minusBtn.className = 'target-htp-step';
            minusBtn.textContent = '−';

            const inputWrap = document.createElement('div');
            inputWrap.className = 'target-htp-input-wrap';
            const input = document.createElement('input');
            input.type = 'number';
            input.min = String(minValue);
            input.max = String(maxValue);
            input.step = String(step);
            input.value = String(initialValue);
            input.className = 'target-htp-input';
            const unit = document.createElement('span');
            unit.className = 'target-htp-unit';
            unit.textContent = 'HTP';
            inputWrap.appendChild(input);
            inputWrap.appendChild(unit);

            const plusBtn = document.createElement('button');
            plusBtn.type = 'button';
            plusBtn.className = 'target-htp-step';
            plusBtn.textContent = '+';

            const resetBtn = document.createElement('button');
            resetBtn.type = 'button';
            resetBtn.className = 'target-htp-reset';
            resetBtn.title = '기본값';
            resetBtn.textContent = '↺';

            controls.appendChild(minusBtn);
            controls.appendChild(inputWrap);
            controls.appendChild(plusBtn);
            controls.appendChild(resetBtn);

            const range = document.createElement('input');
            range.type = 'range';
            range.className = 'target-htp-range';
            range.min = String(minValue);
            range.max = String(maxValue);
            range.step = String(step);
            range.value = String(initialValue);

            const foot = document.createElement('div');
            foot.className = 'target-htp-foot';
            const rangeHint = document.createElement('span');
            rangeHint.textContent = `${minValue} - ${maxValue}`;
            const valueChip = document.createElement('span');
            valueChip.className = 'target-htp-value-chip';
            valueChip.textContent = `${initialValue} HTP`;
            foot.appendChild(rangeHint);
            foot.appendChild(valueChip);

            const syncValue = (nextValue, immediateRender = true) => {
                const normalized = clampTargetHtpValue(nextValue, minValue, maxValue);
                targetHtpValues[key] = normalized;
                input.value = String(normalized);
                range.value = String(normalized);
                valueChip.textContent = `${normalized} HTP`;
                if (immediateRender) queueTargetHtpApplyRender();
            };

            minusBtn.addEventListener('click', () => {
                syncValue((Number(input.value) || 0) - step, true);
            });
            plusBtn.addEventListener('click', () => {
                syncValue((Number(input.value) || 0) + step, true);
            });
            resetBtn.addEventListener('click', () => {
                syncValue(defaultValue, true);
            });
            input.addEventListener('input', (e) => {
                syncValue(e.target.value, false);
            });
            input.addEventListener('change', (e) => {
                syncValue(e.target.value, true);
            });
            range.addEventListener('input', (e) => {
                syncValue(e.target.value, true);
            });

            item.appendChild(head);
            item.appendChild(controls);
            item.appendChild(range);
            item.appendChild(foot);
            grid.appendChild(item);
        });

        panel.appendChild(grid);
        ui.targetHtpSettings.appendChild(panel);
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoader();
        showLoadingProgress('파일 업로드 중...');
        updateLoadingProgress(10, '파일 읽는 중...');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                updateLoadingProgress(30, '엑셀 파싱 중...');
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                updateLoadingProgress(50, '데이터 처리 중...');
                const parsedData = parseExcelData(jsonData);
                
                updateLoadingProgress(70, 'Firebase 업로드 중...');
                await saveDataToFirestore(parsedData);
                
            } catch (error) {
                console.error("파일 처리 오류:", error);
                showModal(error.message || "파일을 처리하는 중 오류가 발생했습니다.");
                hideLoader();
                hideLoadingProgress();
            }
        };
        reader.onerror = (error) => { 
            console.error("파일 읽기 오류:", error); 
            showModal("파일을 읽을 수 없습니다."); 
            hideLoader(); 
            hideLoadingProgress();
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveDataToFirestore(data) {
        try {
            updateLoadingProgress(80, '데이터 압축 중...');
            const serializableData = data.map(item => ({ ...item, htpStart: item.htpStart.toISOString(), htpEnd: item.htpEnd.toISOString() }));
            const jsonString = JSON.stringify(serializableData);
            const compressedData = pako.gzip(jsonString);
            const compressedBytes = Bytes.fromUint8Array(compressedData);
            const payload = { compressedData: compressedBytes, uploaderId: userId, timestamp: new Date().toISOString() };
            
            updateLoadingProgress(90, 'Firebase에 저장 중...');
            await setDoc(dataDocRef, payload);
            
            const today = new Date().toISOString().split('T')[0];
            const historyDocRef = doc(historyCollectionRef, today);
            const historyPayload = { 
                compressedData: compressedBytes, 
                uploaderId: userId, 
                timestamp: new Date().toISOString(),
                date: today
            };
            await setDoc(historyDocRef, historyPayload);
            
            updateLoadingProgress(100, '업로드 완료!');
            showModal('데이터가 성공적으로 업로드되었습니다!');
            
            await loadHistoryData();
            
            // 뱃지 계산 (히스토리 데이터가 로드되었으므로)
            console.log('🏅 엑셀 업로드 완료 - 뱃지 계산 확인');
            ensureBadgesCalculated();
            
        } catch (error) {
            console.error("Firestore 저장 오류:", error);
            showModal("데이터를 서버에 저장하는 데 실패했습니다.");
            hideLoader();
            hideLoadingProgress();
        } finally {
            setTimeout(() => hideLoadingProgress(), 1000);
        }
    }

    function applyFiltersAndRender() {
        if (pendingFilterIdleHandle !== null) {
            cancelIdle(pendingFilterIdleHandle);
            pendingFilterIdleHandle = null;
        }

        const renderToken = ++filterRenderToken;
        pendingFilterIdleHandle = runWhenIdle(() => {
            pendingFilterIdleHandle = null;
            if (renderToken !== filterRenderToken) return;

            if (globalRawData.length === 0) {
                state.lastDisplayData = [];
                renderTable([]);
                queueDashboardUpdate([], []);
                return;
            }
            
            const timeFilteredRawData = getTimeFilteredRawData();
            const aggregatedData = getAggregatedDataForCurrentHours(timeFilteredRawData);
            let displayFilteredData = aggregatedData.slice();
            const searchKeyword = state.filters.search;

            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(집품)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(포장)');

            if (searchKeyword) {
                displayFilteredData = displayFilteredData.filter(item => (item.employeeKey || '').includes(searchKeyword));
            }

            if (state.filters.lowHtp) {
                displayFilteredData = displayFilteredData.filter(item => (item.htpNum ?? parseFloat(item.htp)) < getTargetHtp(item));
            }

            let finalDisplayData = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }

            if (state.sort.key && state.sort.direction) {
                const numericSortMap = {
                    unitQty: 'unitQty',
                    mh: 'mhNum',
                    htp: 'htpNum',
                };
                finalDisplayData.sort((a, b) => {
                    const key = state.sort.key;
                    const valA = a[key], valB = b[key];
                    let compareResult;
                    if (numericSortMap[key]) {
                        compareResult = (a[numericSortMap[key]] ?? parseFloat(valA)) - (b[numericSortMap[key]] ?? parseFloat(valB));
                    } else {
                        compareResult = (valA || '').toString().localeCompare((valB || '').toString());
                    }
                    return state.sort.direction === 'asc' ? compareResult : -compareResult;
                });
            }

            state.lastDisplayData = finalDisplayData;
            renderTable(finalDisplayData);
            queueDashboardUpdate(finalDisplayData, timeFilteredRawData);
            updateColumnVisibility(finalDisplayData);
            updateStats(finalDisplayData);
            updateTicker(finalDisplayData);
            updateSortIndicators();
        });
    }
	
    function buildTableRowHtml(item, isDark, hideLocationCol) {
        const isHidden = hiddenEmployees.has(item.employee);
        const processTypeColor = item.processType.includes('PICK') ? 'text-blue-400' : 'text-yellow-400';
        const targetHtp = getTargetHtp(item);
        const htpValue = item.htpNum ?? parseFloat(item.htp);
        const htpColor = htpValue < targetHtp ? 'text-red-400' : 'text-green-400';
        const htpLevel = htpValue >= 300 ? 'top' : htpValue >= 200 ? 'high' : '';

        let employeeClass = 'text-gray-200';
        if (item.isManager) employeeClass = isDark ? 'text-yellow-300 font-bold' : 'text-yellow-600 font-bold';
        else if (item.isPerm) employeeClass = isDark ? 'text-emerald-400 font-bold' : 'text-emerald-600 font-bold';
        else employeeClass = isDark ? 'text-gray-300' : 'text-gray-700';

        const employeeName = escapeHtml(item.employee || '');
        const employeeDisplay = item.isManager ? `👑 ${employeeName}` : employeeName;
        const processType = escapeHtml(item.processType || '-');
        const location = escapeHtml(item.location || '-');
        const processPathName = escapeHtml(item.processPathName || '-');
        const packType = escapeHtml(item.packType || '-');
        const mh = escapeHtml(item.mh || '-');
        const htpText = `${htpValue < targetHtp && targetHtp > 0 ? '🚨 ' : ''}${escapeHtml(Number.isFinite(htpValue) ? htpValue.toFixed(1) : (item.htp || '0'))}`;

        const actionMenu = isHidden
            ? `<button class="action-menu-btn show-employee-btn" data-employee="${item.employee}" title="복구">🔓</button>`
            : `<button class="action-menu-btn hide-employee-btn" data-employee="${item.employee}" title="숨기기">🔒</button>`;

        return `
            <tr class="${isHidden ? 'cursor-pointer hover:bg-gray-700 hidden-employee' : 'cursor-pointer hover:bg-gray-700'}" data-process="${item.processType.includes('PICK') ? 'pick' : 'pack'}">
                <td class="px-4 py-3 font-medium ${processTypeColor}">${processType}</td>
                <td class="px-4 py-3 ${employeeClass} relative">
                    ${employeeDisplay}${isHidden ? '<span class="hidden-employee-indicator">숨김</span>' : ''}
                </td>
                <td class="px-4 py-3 text-gray-200">${item.unitQty}</td>
                <td class="px-4 py-3 text-gray-200${hideLocationCol ? ' hidden-col' : ''}">${location}</td>
                <td class="px-4 py-3 text-gray-200">${processPathName}</td>
                <td class="px-4 py-3 text-gray-200">${packType}</td>
                <td class="px-4 py-3 text-gray-200">${mh}</td>
                <td class="px-4 py-3 font-bold ${htpColor}" data-htp-level="${htpLevel}">${htpText}</td>
                <td class="px-4 py-3 relative"><div class="row-action-menu">${actionMenu}</div></td>
            </tr>
        `;
    }

	function renderTable(data) {
        const renderToken = ++state.tableRenderToken;
        if (state.tableChunkRaf) {
            cancelAnimationFrame(state.tableChunkRaf);
            state.tableChunkRaf = null;
        }

        ui.tableBody.innerHTML = '';
        if (data.length === 0) {
            ui.tableBody.appendChild(ui.placeholderRow);
            ui.placeholderRow.classList.remove('hidden');
            updateStats([]);
            updateTicker([]);
            return;
        }

        ui.placeholderRow.classList.add('hidden');
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const hideLocationCol = data.length > 0 && data.every(item => !item.location);
        const chunkSize = data.length > 2000 ? 120 : data.length > 900 ? 180 : 260;
        let index = 0;

        const appendChunk = () => {
            if (renderToken !== state.tableRenderToken) return;

            const end = Math.min(index + chunkSize, data.length);
            let rowsHtml = '';
            for (let i = index; i < end; i++) {
                rowsHtml += buildTableRowHtml(data[i], isDark, hideLocationCol);
            }
            ui.tableBody.insertAdjacentHTML('beforeend', rowsHtml);

            if (index === 0) {
                ui.tableBody.classList.remove('table-fade-in');
                requestAnimationFrame(() => {
                    if (renderToken === state.tableRenderToken) {
                        ui.tableBody.classList.add('table-fade-in');
                    }
                });
            }

            index = end;
            if (index < data.length) {
                state.tableChunkRaf = requestAnimationFrame(appendChunk);
            } else {
                state.tableChunkRaf = null;
            }
        };

        appendChunk();

        if (window.innerWidth <= 768) renderMobileCards(data);
    }
    
    function renderMobileCards(data) {
        const mobileContainer = document.getElementById('mobile-cards-container');
        if (!mobileContainer) return;
        
        mobileContainer.innerHTML = '';
        
        if (data.length === 0) {
            mobileContainer.innerHTML = '<div class="text-center py-10 text-gray-500">엑셀 파일을 업로드하여 데이터를 확인하세요.</div>';
            return;
        }

        const mobileCardLimit = 240;
        const cappedData = data.length > mobileCardLimit ? data.slice(0, mobileCardLimit) : data;
        let cardsHtml = '';
        
        cappedData.forEach(item => {
            const isHidden = hiddenEmployees.has(item.employee);
            const targetHtp = getTargetHtp(item);
            const htpValue = item.htpNum ?? parseFloat(item.htp);
            const isLowPerformer = htpValue < targetHtp;
            const processClass = item.processType.includes('PICK') ? 'pick' : 'pack';
            const htpClass = isLowPerformer ? 'low' : '';
            const employeeDisplay = item.isManager ? `👑 ${escapeHtml(item.employee)}` : escapeHtml(item.employee);
            
            cardsHtml += `
                <div class="employee-card ${isHidden ? 'hidden-employee' : ''}">
                    <div class="employee-card-header">
                        <div class="employee-card-name">${employeeDisplay}</div>
                        <div class="employee-card-process ${processClass}">${escapeHtml(item.processType)}</div>
                    </div>
                    <div class="employee-card-stats">
                        <div class="stat-item">
                            <div class="stat-label">작업량</div>
                            <div class="stat-value">${item.unitQty}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">HTP</div>
                            <div class="stat-value htp ${htpClass}">${isLowPerformer ? '🚨 ' : ''}${Number.isFinite(htpValue) ? htpValue.toFixed(1) : escapeHtml(item.htp)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">M/H</div>
                            <div class="stat-value">${escapeHtml(item.mh || '-')}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">팩 종류</div>
                            <div class="stat-value">${escapeHtml(item.packType || '-')}</div>
                        </div>
                    </div>
                    ${isHidden ? '<div class="hidden-employee-indicator">숨김</div>' : ''}
                </div>
            `;
        });

        if (data.length > mobileCardLimit) {
            cardsHtml += `<div class="text-center py-3 text-xs text-gray-500">모바일 성능 최적화를 위해 ${mobileCardLimit}건까지만 표시됩니다.</div>`;
        }

        mobileContainer.innerHTML = cardsHtml;
    }

    function updateColumnVisibility(data) {
        const locationColHeader = ui.tableHeader.querySelector('th[data-sort-key="location"]');
        if (!locationColHeader) return;
        const locationColIndex = Array.from(locationColHeader.parentNode.children).indexOf(locationColHeader);
        const isLocationEmpty = data.length > 0 && data.every(item => !item.location);
        if (state.lastLocationHiddenFlag === isLocationEmpty) return;
        state.lastLocationHiddenFlag = isLocationEmpty;
        document.querySelectorAll(`#data-table th:nth-child(${locationColIndex + 1}), #data-table td:nth-child(${locationColIndex + 1})`)
            .forEach(cell => cell.classList.toggle('hidden-col', isLocationEmpty));
    }

    function updateSortIndicators() {
        ui.tableHeader.querySelectorAll('.sortable').forEach(th => {
            const indicator = th.querySelector('.sort-indicator');
            const key = th.dataset.sortKey;
            indicator.classList.remove('asc', 'desc');
            indicator.textContent = '';
            if (key === state.sort.key && state.sort.direction) {
                indicator.classList.add(state.sort.direction);
                indicator.textContent = state.sort.direction === 'asc' ? '▲' : '▼';
            }
        });
    }

    function updateStats(data) {
        const visibleRows = data.length;
        const visibleWorkers = new Set(data.map(d => d.employee)).size;
        const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = data.reduce((sum, d) => sum + (d.mhNum ?? parseFloat(d.mh)), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh).toFixed(2) : '0.00';
        const highlightClass = document.documentElement.getAttribute('data-theme') === 'dark' ? 'text-white' : 'text-slate-900';
        ui.statsDisplay.innerHTML = `
            표시 그룹: <span class="font-bold ${highlightClass}">${visibleRows}</span> | 
            작업자 수: <span class="font-bold ${highlightClass}">${visibleWorkers}</span> | 
            총 작업량: <span class="font-bold ${highlightClass}">${totalQty.toLocaleString()}</span> | 
            평균 HTP: <span class="font-bold ${highlightClass}">${avgHtp}</span>`;
    }

    function updateTicker(data) {
        if (data.length === 0) {
            if (state.lastTickerSignature === 'empty') return;
            state.lastTickerSignature = 'empty';
            ui.tickerText.innerHTML = '<span class="ticker-loading">🎯 데이터를 업로드하면 PICK/PACK TOP3/LOW3가 표시됩니다.</span>';
            return;
        }
        
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const packData = data.filter(d => d.processType.includes('PACK'));

        const getHtpNum = (item) => item.htpNum ?? parseFloat(item.htp);
        const sortedPick = [...pickData].sort((a, b) => getHtpNum(b) - getHtpNum(a));
        const sortedPack = [...packData].sort((a, b) => getHtpNum(b) - getHtpNum(a));

        const pickTopItems = sortedPick.slice(0, 3);
        const pickLowItems = sortedPick.filter(d => getHtpNum(d) > 0).slice(-3).reverse();
        const packTopItems = sortedPack.slice(0, 3);
        const packLowItems = sortedPack.filter(d => getHtpNum(d) > 0).slice(-3).reverse();

        const toSig = (items) => items.map(item => `${item.employee}|${getHtpNum(item).toFixed(1)}`).join(',');
        const nextSig = [
            `pt:${toSig(pickTopItems)}`,
            `pl:${toSig(pickLowItems)}`,
            `kt:${toSig(packTopItems)}`,
            `kl:${toSig(packLowItems)}`,
        ].join('|');
        if (nextSig === state.lastTickerSignature) return;
        state.lastTickerSignature = nextSig;

        const createSection = (items, type, isTop) => {
            if (items.length === 0) return '';
            const processIcon = type === 'PICK' ? '📦' : '📮';
            const label = isTop ? `${processIcon} ${type} TOP 3` : `⚠️ ${type} LOW 3`;
            const sectionClass = isTop ? 'top' : 'low';
            const processClass = type.toLowerCase();

            return `
                <div class="ticker-section ${sectionClass} ${processClass}">
                    <span class="ticker-label">${label}</span>
                    ${items.map((item, idx) => `
                        <div class="ticker-item">
                            <span class="ticker-rank rank-${idx + 1}">${idx + 1}</span>
                            <span class="ticker-name">${escapeHtml(item.employee.split('(')[0].trim())}</span>
                            <span class="ticker-htp">${getHtpNum(item).toFixed(1)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        const allSections = 
            createSection(pickTopItems, 'PICK', true) +
            createSection(pickLowItems, 'PICK', false) +
            createSection(packTopItems, 'PACK', true) +
            createSection(packLowItems, 'PACK', false);
        ui.tickerText.innerHTML = allSections + allSections;
    }

    function captureTable() {
        const tableEl = document.getElementById('data-table');
        showModal('캡처 중...', 1500);
        html2canvas(tableEl).then(canvas => {
            canvas.toBlob(blob => {
                try {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                        .then(() => showModal('테이블이 클립보드에 복사되었습니다.'))
                        .catch(err => {
                            console.error('클립보드 복사 실패:', err);
                            showModal('클립보드 복사에 실패했습니다.');
                        });
                } catch (error) {
                     console.error('클립보드 API 오류:', error);
                     showModal('클립보드 API를 사용할 수 없는 환경입니다.');
                }
            });
        });
    }

    function exportToExcel() {
        if (globalRawData.length === 0) {
            showModal('내보낼 데이터가 없습니다.');
            return;
        }
        let timeFilteredRawData = [...globalRawData];
        if (state.filters.hours.size > 0) {
            timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
        }
        let aggregatedData = aggregateData(timeFilteredRawData);
        let displayFilteredData = aggregatedData;
        if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(집품)');
        else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(포장)');
        if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => (item.employeeKey || '').includes(state.filters.search));
        if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => (item.htpNum ?? parseFloat(item.htp)) < getTargetHtp(item));
        let dataToExport = displayFilteredData;
        if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
             dataToExport = displayFilteredData.filter(item => 
                (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
            );
        } else if (state.filters.floors.size > 0) {
            dataToExport = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
        } else if (state.filters.packTypes.size > 0) {
            dataToExport = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
        }
        if (dataToExport.length === 0) {
            showModal('내보낼 데이터가 없습니다.');
            return;
        }
        const pickData = [], packData = [];
        dataToExport.forEach(item => {
            const rowData = {
                '집품/포장': item.processType,
                '이름(쿠코드)': item.employee.replace(/[👑🔥🐢🥇🥈🥉]\s*/g, ''),
                '계약직 여부': item.isPerm ? 'PERM' : 'TEMP',
                '작업량': Number(item.unitQty),
                '로케이션 및 작업대': item.location || '-',
                'PP': item.processPathName || '-',
                '팩 종류': item.packType,
                'M/H': parseFloat(item.mh),
                'HTP': parseFloat(item.htp.replace('🚨 ', ''))
            };
            if (rowData['집품/포장'].includes('PICK')) pickData.push(rowData);
            else packData.push(rowData);
        });
        pickData.sort((a, b) => a.HTP - b.HTP);
        packData.sort((a, b) => a.HTP - b.HTP);
        const wb = XLSX.utils.book_new();
        const createStyledSheet = (data, sheetName) => {
            if (!data || data.length === 0) return;
            const headers = Object.keys(data[0]);
            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F81BD" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
            };
            const cellStyle = {
                alignment: { horizontal: "center", vertical: "center" },
                border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
            };
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const headerAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                if (ws[headerAddr]) ws[headerAddr].s = headerStyle;
                for (let R = 1; R <= range.e.r; ++R) {
                    const cellAddr = XLSX.utils.encode_cell({ c: C, r: R });
                    if (ws[cellAddr]) {
                        if (!ws[cellAddr].s) ws[cellAddr].s = {};
                        Object.assign(ws[cellAddr].s, cellStyle);
                        if (typeof ws[cellAddr].v === 'number') {
                            if (headers[C] === 'M/H') ws[cellAddr].z = '0.0000';
                            else if (headers[C] === 'HTP') ws[cellAddr].z = '0.0';
                            else if (headers[C] === '작업량') ws[cellAddr].z = '0';
                        }
                    }
                }
            }
            const colWidths = headers.map((header, i) => {
                const maxLength = Math.max(header.length, ...data.map(row => (row[header] ? row[header].toString().length : 0)));
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = colWidths;
            ws['!autofilter'] = { ref: ws['!ref'] };
            ws['!freeze'] = { ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        };
        createStyledSheet(pickData, "PICK(집품)");
        createStyledSheet(packData, "PACK(포장)");
        if (wb.SheetNames.length > 0) XLSX.writeFile(wb, "HTP_Data_Export_Styled.xlsx");
        else showModal('내보낼 데이터가 없습니다.');
    }
    
    function updateStatus(status, message) {
        const dot = ui.statusIndicator.querySelector('.status-dot');
        const statusValue = ui.statusIndicator.querySelector('.status-value');
        
        dot.className = 'status-dot';
        if (status === 'connected') dot.classList.add('status-connected');
        else if (status === 'disconnected') dot.classList.add('status-disconnected');
        else if (status === 'loading') dot.classList.add('status-loading');
        
        if (statusValue) {
            statusValue.textContent = message;
        }
    }

    function showLoader() { ui.loaderContainer.classList.remove('hidden'); ui.tableView.classList.add('hidden'); }
    function hideLoader() { ui.loaderContainer.classList.add('hidden'); ui.tableView.classList.remove('hidden'); }
    
    function showModal(message, duration = 3000) {
        const modal = document.createElement('div');
        modal.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out';
        modal.textContent = message;
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in-out {
                0% { opacity: 0; transform: translateY(-20px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-20px); }
            }
            .animate-fade-in-out { animation: fade-in-out ${duration / 1000}s ease-in-out forwards; }
        `;
        document.head.appendChild(style);
        document.body.appendChild(modal);
        setTimeout(() => { modal.remove(); style.remove(); }, duration);
    }

    function createBackdropDots(container) {
        const dotsWrap = document.createElement('div');
        dotsWrap.className = 'edm-backdrop-dots';
        const colors = ['rgba(59,130,246,0.4)','rgba(139,92,246,0.35)','rgba(236,72,153,0.3)','rgba(34,197,94,0.3)','rgba(251,191,36,0.35)'];
        for (let i = 0; i < 10; i++) {
            const dot = document.createElement('div');
            dot.className = 'edm-dot';
            const size = 3 + Math.random() * 5;
            dot.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;bottom:${-10-Math.random()*20}%;background:${colors[i%colors.length]};animation-duration:${6+Math.random()*8}s;animation-delay:${Math.random()*5}s;will-change:transform,opacity;`;
            dotsWrap.appendChild(dot);
        }
        container.appendChild(dotsWrap);
    }

    function showEmployeeModal(htmlContent) {
        // 기존 모달 제거
        const existingModal = document.getElementById('employee-detail-modal');
        if (existingModal) existingModal.remove();

        // 현재 테마 확인
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        // 모달 배경 + 이펙트
        const modalBg = document.createElement('div');
        modalBg.id = 'employee-detail-modal';
        modalBg.className = 'fixed inset-0 flex items-center justify-center z-50 edm-backdrop-fx';
        modalBg.style.cssText = `background-color:${isDark ? 'rgba(0,0,0,0.78)' : 'rgba(15,23,42,0.6)'};backdrop-filter:blur(8px);`;
        createBackdropDots(modalBg);

        // 모달 컨테이너
        const modalContainer = document.createElement('div');
        modalContainer.className = `${isDark ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto`;
        modalContainer.style.cssText = 'animation:edmFadeIn .25s ease;position:relative;z-index:1;';
        modalContainer.innerHTML = htmlContent;

        // 닫기 버튼을 헤더 안에 삽입
        const headerTop = modalContainer.querySelector('.edm-header-top');
        if (headerTop) {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'edm-close';
            closeBtn.innerHTML = '✕';
            closeBtn.onclick = () => modalBg.remove();
            headerTop.appendChild(closeBtn);
        } else {
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕';
            closeBtn.className = `absolute top-4 right-4 ${isDark ? 'text-white hover:text-red-400' : 'text-gray-700 hover:text-red-600'} text-2xl transition-colors font-bold`;
            closeBtn.onclick = () => modalBg.remove();
            modalContainer.style.position = 'relative';
            modalContainer.insertBefore(closeBtn, modalContainer.firstChild);
        }

        modalBg.appendChild(modalContainer);

        // 배경 클릭 시 닫기
        modalBg.onclick = (e) => {
            if (e.target === modalBg || e.target.classList.contains('edm-backdrop-dots')) modalBg.remove();
        };

        // ESC 키로 닫기
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modalBg.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);

        document.body.appendChild(modalBg);
    }

    initializeFiltersFromData([]);

    Chart.register(ChartDataLabels);

    function updateDashboard(filteredAggregatedData, timeFilteredRawData) {
        updateKpiCards(filteredAggregatedData);
        updateProcessSummary(filteredAggregatedData);
        updatePerformersLists(filteredAggregatedData);
        updateFloorHtpChart(filteredAggregatedData);
        updatePackTypeChart(filteredAggregatedData);
        updateProcessComparisonChart(filteredAggregatedData);
        updateHourlyTrendChart(timeFilteredRawData);
    }

    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    }

    function escapeHtml(value) {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function updateProcessSummary(data) {
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const packData = data.filter(d => d.processType.includes('PACK'));
        const pickQty = pickData.reduce((s, d) => s + d.unitQty, 0);
        const pickMh = pickData.reduce((s, d) => s + parseFloat(d.mh), 0);
        const pickHtp = pickMh > 0 ? (pickQty / pickMh) : 0;
        const pickWorkers = new Set(pickData.map(d => d.employee)).size;
        const packQty = packData.reduce((s, d) => s + d.unitQty, 0);
        const packMh = packData.reduce((s, d) => s + parseFloat(d.mh), 0);
        const packHtp = packMh > 0 ? (packQty / packMh) : 0;
        const packWorkers = new Set(packData.map(d => d.employee)).size;
        const totalQty = pickQty + packQty;
        const pickShare = totalQty > 0 ? (pickQty / totalQty) * 100 : 0;
        const packShare = totalQty > 0 ? (packQty / totalQty) * 100 : 0;

        setText('dash-pick-qty', pickQty.toLocaleString());
        setText('dash-pick-htp', pickHtp.toFixed(1));
        setText('dash-pick-workers', pickWorkers.toLocaleString());
        setText('dash-pack-qty', packQty.toLocaleString());
        setText('dash-pack-htp', packHtp.toFixed(1));
        setText('dash-pack-workers', packWorkers.toLocaleString());
        setText('dash-pick-share', `${pickShare.toFixed(1)}%`);
        setText('dash-pack-share', `${packShare.toFixed(1)}%`);
        setText('dash-insight-balance', `PICK ${pickShare.toFixed(1)}% · PACK ${packShare.toFixed(1)}%`);

        const pickFill = document.getElementById('dash-pick-share-fill');
        const packFill = document.getElementById('dash-pack-share-fill');
        if (pickFill) pickFill.style.width = `${pickShare.toFixed(1)}%`;
        if (packFill) packFill.style.width = `${packShare.toFixed(1)}%`;
    }

    function generateColors(numColors) {
        const colors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(99, 102, 241, 0.7)'];
        const result = [];
        for (let i = 0; i < numColors; i++) result.push(colors[i % colors.length]);
        return result;
    }

    function getChartTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
            isDark,
            tickColor:      isDark ? 'rgba(255, 255, 255, 0.5)' : '#64748b',
            gridColor:      isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(100, 116, 139, 0.08)',
            legendColor:    isDark ? '#f1f5f9' : '#475569',
            borderColor:    'transparent',
            tooltipBg:      'rgba(15, 23, 42, 0.9)',
            tooltipText:    '#fff',
            // 🆕 Neon Palette for the "Wow" factor
            colors: {
                blue: 'rgba(59, 130, 246, 0.85)',
                green: 'rgba(16, 185, 129, 0.85)',
                purple: 'rgba(139, 92, 246, 0.85)',
                amber: 'rgba(245, 158, 11, 0.85)',
                red: 'rgba(239, 68, 68, 0.85)',
                cyan: 'rgba(6, 182, 212, 0.85)',
                pink: 'rgba(236, 72, 153, 0.85)'
            }
        };
    }

    function upsertChart(chartKey, canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        const ctx = canvas.getContext('2d');
        if (!ctx) return null;

        const existing = state.charts[chartKey];
        if (existing && existing.config.type === config.type) {
            existing.data.labels = config.data.labels;
            existing.data.datasets = config.data.datasets;
            existing.options = config.options;
            existing.update('none');
            return existing;
        }

        if (existing) existing.destroy();
        state.charts[chartKey] = new Chart(ctx, config);
        return state.charts[chartKey];
    }

    function updateKpiCards(data) {
        const totalWorkers = new Set(data.map(d => d.employee)).size;
        const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const lowPerformers = data.filter(d => parseFloat(d.htp) < getTargetHtp(d)).length;

        const measurable = data.filter(d => getTargetHtp(d) > 0);
        const achieved = measurable.filter(d => parseFloat(d.htp) >= getTargetHtp(d)).length;
        const achievementRate = measurable.length > 0 ? (achieved / measurable.length) * 100 : 0;

        ui.kpi.totalWorkers.textContent = totalWorkers.toLocaleString();
        ui.kpi.totalQty.textContent = totalQty.toLocaleString();
        ui.kpi.avgHtp.textContent = avgHtp.toFixed(1);
        ui.kpi.lowPerformers.textContent = lowPerformers.toLocaleString();
        setText('kpi-target-achievement', `${achievementRate.toFixed(1)}%`);
        setText('dash-insight-status', totalWorkers > 0 ? `${totalWorkers}명 운영 중 · 평균 ${avgHtp.toFixed(1)} HTP` : '데이터 대기 중');
        if (lowPerformers > 0) {
            setText('dash-insight-alert', `저조자 ${lowPerformers}명 집중 관리 필요`);
        } else if (totalWorkers > 0) {
            setText('dash-insight-alert', '저조자 없음 · 운영 안정');
        } else {
            setText('dash-insight-alert', '분석 대기 중');
        }
    }

    function updatePerformersLists(data) {
        if (data.length === 0) {
            ui.topPickPerformersList.innerHTML = '<li class="dash-top-empty">데이터 없음</li>';
            ui.topPackPerformersList.innerHTML = '<li class="dash-top-empty">데이터 없음</li>';
            return;
        }
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const packData = data.filter(d => d.processType.includes('PACK'));
        pickData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        packData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        const top5Pick = pickData.slice(0, 5);
        const top5Pack = packData.slice(0, 5);
        const medals = ['🥇', '🥈', '🥉', '4', '5'];
        const createListItem = (item, idx) => {
            const medal = idx < 3 ? `<span class="dash-top-medal">${medals[idx]}</span>` : `<span class="dash-top-rank">${medals[idx]}</span>`;
            const safeName = escapeHtml(item.employee.split('(')[0].trim());
            return `<li class="dash-top-item ${idx < 3 ? 'top3' : ''}">${medal}<span class="dash-top-name">${safeName}</span><span class="dash-top-htp">${parseFloat(item.htp).toFixed(1)}</span></li>`;
        };
        ui.topPickPerformersList.innerHTML = top5Pick.length > 0
            ? top5Pick.map((item, i) => createListItem(item, i)).join('')
            : '<li class="dash-top-empty">데이터 없음</li>';
        ui.topPackPerformersList.innerHTML = top5Pack.length > 0
            ? top5Pack.map((item, i) => createListItem(item, i)).join('')
            : '<li class="dash-top-empty">데이터 없음</li>';
    }

    function updateFloorHtpChart(data) {
        const t = getChartTheme();
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const floorData = new Map();
        pickData.forEach(item => {
            if (!floorData.has(item.floor)) floorData.set(item.floor, { totalQty: 0, totalMh: 0 });
            const floor = floorData.get(item.floor);
            floor.totalQty += item.unitQty;
            floor.totalMh += parseFloat(item.mh);
        });
        const sortedFloors = Array.from(floorData.keys()).sort();
        const avgHtps = sortedFloors.map(floor => {
            const d = floorData.get(floor);
            return d.totalMh > 0 ? +(d.totalQty / d.totalMh).toFixed(1) : 0;
        });

        // Footer stats
        const bestIdx = avgHtps.length > 0 ? avgHtps.indexOf(Math.max(...avgHtps)) : -1;
        const worstIdx = avgHtps.length > 0 ? avgHtps.indexOf(Math.min(...avgHtps)) : -1;
        const gapVal = (bestIdx >= 0 && worstIdx >= 0) ? +(avgHtps[bestIdx] - avgHtps[worstIdx]).toFixed(1) : 0;
        setText('stat-floor-count', sortedFloors.length);
        setText('stat-floor-best', bestIdx >= 0 ? sortedFloors[bestIdx] : '-');
        setText('stat-floor-worst', worstIdx >= 0 ? sortedFloors[worstIdx] : '-');
        setText('stat-floor-best-val', bestIdx >= 0 ? avgHtps[bestIdx] : '-');
        setText('stat-floor-gap', bestIdx >= 0 ? gapVal : '-');
        setText('floor-chip-top', bestIdx >= 0 ? `${sortedFloors[bestIdx]}F · ${avgHtps[bestIdx].toFixed(1)}` : '-');
        setText('floor-chip-low', worstIdx >= 0 ? `${sortedFloors[worstIdx]}F · ${avgHtps[worstIdx].toFixed(1)}` : '-');
        const stabilityText = bestIdx < 0
            ? '-'
            : (gapVal <= 20 ? '매우 안정' : gapVal <= 40 ? '보통' : '편차 큼');
        setText('floor-chip-stability', stabilityText);

        const rankingEl = document.getElementById('floor-insight-ranking');
        if (rankingEl) {
            if (sortedFloors.length === 0) {
                rankingEl.innerHTML = '<div class="dash-floor-empty">PICK 데이터 없음</div>';
            } else {
                const rankingData = sortedFloors
                    .map((floor, idx) => ({ floor, htp: avgHtps[idx] }))
                    .sort((a, b) => b.htp - a.htp)
                    .slice(0, 5);
                rankingEl.innerHTML = rankingData.map((row, idx) => `
                    <div class="dash-floor-rank-item ${idx === 0 ? 'best' : ''}">
                        <span class="dash-floor-rank-pos">${idx + 1}위</span>
                        <span class="dash-floor-rank-name">${escapeHtml(row.floor)}F</span>
                        <span class="dash-floor-rank-val">${row.htp.toFixed(1)}</span>
                    </div>
                `).join('');
            }
        }

        // Purple intensity gradient with Neon
        const maxVal = Math.max(...avgHtps, 1);
        const barColors = avgHtps.map(v => {
            const intensity = 0.4 + 0.6 * (v / maxVal);
            return `rgba(139, 92, 246, ${intensity.toFixed(2)})`;
        });

        upsertChart('floorHtp', 'floor-htp-chart', {
            type: 'bar',
            data: {
                labels: sortedFloors,
                datasets: [{
                    label: '평균 HTP',
                    data: avgHtps,
                    backgroundColor: barColors,
                    borderColor: '#8b5cf6',
                    borderWidth: 2,
                    borderRadius: 12,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 1000, easing: 'easeOutQuart' },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: t.tickColor, font: { size: 11, weight: '600' } },
                        grid: { color: t.gridColor, drawBorder: false },
                    },
                    x: {
                        ticks: { color: t.tickColor, font: { size: 11, weight: '600' } },
                        grid: { display: false },
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: t.isDark ? '#a78bfa' : '#7c3aed',
                        font: { weight: '900', size: 12 },
                        formatter: value => value > 0 ? value : ''
                    },
                    tooltip: {
                        backgroundColor: t.tooltipBg,
                        titleColor: t.tooltipText,
                        bodyColor: t.tooltipText,
                        padding: 12,
                        cornerRadius: 12,
                        displayColors: false
                    }
                }
            }
        });
    }

    function updatePackTypeChart(data) {
        const t = getChartTheme();
        const packData = data.filter(d => d.processType.includes('PACK'));
        let packTypeData = new Map(), totalQuantity = 0;
        packData.forEach(item => {
            if (!packTypeData.has(item.packType)) packTypeData.set(item.packType, 0);
            packTypeData.set(item.packType, packTypeData.get(item.packType) + item.unitQty);
            totalQuantity += item.unitQty;
        });
        const otherThreshold = 0.02;
        let otherQuantity = 0;
        const finalPackData = new Map();
        packTypeData.forEach((qty, type) => {
            if (totalQuantity > 0 && (qty / totalQuantity) < otherThreshold) otherQuantity += qty;
            else finalPackData.set(type, qty);
        });
        if (otherQuantity > 0) finalPackData.set('기타', (finalPackData.get('기타') || 0) + otherQuantity);
        const labels = Array.from(finalPackData.keys());
        const quantities = Array.from(finalPackData.values());
        const sortedTypes = Array.from(finalPackData.entries())
            .map(([type, qty]) => ({
                type,
                qty,
                share: totalQuantity > 0 ? (qty / totalQuantity) * 100 : 0
            }))
            .sort((a, b) => b.qty - a.qty);
        const topType = sortedTypes[0] || null;
        const top3Share = sortedTypes.slice(0, 3).reduce((sum, row) => sum + row.share, 0);
        const balanceScore = sortedTypes.length === 0
            ? 0
            : Math.max(0, Math.min(100, 100 - top3Share + Math.min(sortedTypes.length * 4, 20)));

        // Footer stats
        setText('stat-pack-total-qty', totalQuantity.toLocaleString());
        setText('stat-pack-type-count', labels.length);
        setText('pack-balance-score', sortedTypes.length > 0 ? `${balanceScore.toFixed(0)}점` : '-');
        setText('pack-balance-state', sortedTypes.length > 0
            ? (balanceScore >= 75 ? '균형 우수' : balanceScore >= 55 ? '보통' : '편중 높음')
            : '데이터 없음');
        setText('pack-chip-top-type', topType ? topType.type : '-');
        setText('pack-chip-top-share', topType ? `${topType.share.toFixed(1)}%` : '-');
        setText('pack-chip-top3-share', sortedTypes.length > 0 ? `${top3Share.toFixed(1)}%` : '-');
        const packInsightList = document.getElementById('pack-insight-list');
        if (packInsightList) {
            if (sortedTypes.length === 0) {
                packInsightList.innerHTML = '<div class="dash-pack-empty">PACK 데이터 없음</div>';
            } else {
                packInsightList.innerHTML = sortedTypes.slice(0, 5).map((row, idx) => `
                    <div class="dash-pack-row ${idx === 0 ? 'top' : ''}">
                        <div class="dash-pack-row-head">
                            <span class="dash-pack-row-name">${escapeHtml(row.type)}</span>
                            <span class="dash-pack-row-meta">${row.qty.toLocaleString()} · ${row.share.toFixed(1)}%</span>
                        </div>
                        <div class="dash-pack-row-track">
                            <div class="dash-pack-row-fill" style="width:${row.share.toFixed(1)}%"></div>
                        </div>
                    </div>
                `).join('');
            }
        }

        upsertChart('packType', 'pack-type-chart', {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: '작업량',
                    data: quantities,
                    backgroundColor: [
                        t.colors.blue, t.colors.purple, t.colors.green, 
                        t.colors.amber, t.colors.pink, t.colors.cyan, t.colors.red
                    ],
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 2,
                    hoverOffset: 15,
                    borderRadius: 8,
                    spacing: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { animateRotate: true, animateScale: true, duration: 1500 },
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: t.legendColor,
                            padding: 20,
                            font: { size: 11, weight: '700' },
                            usePointStyle: true,
                            pointStyle: 'rectRounded',
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        textAlign: 'center',
                        font: { weight: '900', size: 12 },
                        textShadowBlur: 8,
                        textShadowColor: 'rgba(0,0,0,0.8)',
                        formatter: (value, context) => {
                            const pct = totalQuantity > 0 ? (value / totalQuantity * 100).toFixed(1) : 0;
                            if (parseFloat(pct) < 8) return '';
                            return `${pct}%`;
                        }
                    },
                    tooltip: {
                        backgroundColor: t.tooltipBg,
                        titleColor: t.tooltipText,
                        bodyColor: t.tooltipText,
                        padding: 12,
                        cornerRadius: 12,
                    }
                }
            }
        });
    }

    function updateProcessComparisonChart(data) {
        const t = getChartTheme();
        const processStats = { PICK: { totalQty: 0, totalMh: 0 }, PACK: { totalQty: 0, totalMh: 0 } };
        data.forEach(item => {
            const type = item.processType.includes('PICK') ? 'PICK' : 'PACK';
            processStats[type].totalQty += item.unitQty;
            processStats[type].totalMh += parseFloat(item.mh);
        });
        const pickHtp = processStats.PICK.totalMh > 0 ? (processStats.PICK.totalQty / processStats.PICK.totalMh).toFixed(1) : '0.0';
        const packHtp = processStats.PACK.totalMh > 0 ? (processStats.PACK.totalQty / processStats.PACK.totalMh).toFixed(1) : '0.0';

        // Footer stats
        setText('stat-process-pick-qty', processStats.PICK.totalQty.toLocaleString());
        setText('stat-process-pack-qty', processStats.PACK.totalQty.toLocaleString());
        setText('stat-process-pick-htp', pickHtp);
        setText('stat-process-pack-htp', packHtp);

        const pickQty = processStats.PICK.totalQty;
        const packQty = processStats.PACK.totalQty;
        const totalQty = pickQty + packQty;
        const pickShare = totalQty > 0 ? (pickQty / totalQty) * 100 : 0;
        const packShare = totalQty > 0 ? (packQty / totalQty) * 100 : 0;
        const pickHtpNum = parseFloat(pickHtp);
        const packHtpNum = parseFloat(packHtp);
        const shareGap = Math.abs(pickShare - packShare);
        const htpGap = Math.abs(pickHtpNum - packHtpNum);

        let dominant = '균형 운영';
        if (pickShare >= packShare + 2) dominant = 'PICK 우세';
        else if (packShare >= pickShare + 2) dominant = 'PACK 우세';
        setText('proc-chip-dominant', totalQty > 0 ? dominant : '-');
        setText('proc-chip-share-gap', totalQty > 0 ? `${shareGap.toFixed(1)}%p` : '-');
        setText('proc-chip-htp-gap', totalQty > 0 ? `${htpGap.toFixed(1)}` : '-');

        const pickFill = document.getElementById('proc-balance-pick');
        if (pickFill) pickFill.style.width = `${pickShare.toFixed(1)}%`;
        const packFill = document.getElementById('proc-balance-pack');
        if (packFill) packFill.style.width = `${packShare.toFixed(1)}%`;
        setText('proc-balance-pick-label', `PICK ${pickShare.toFixed(1)}%`);
        setText('proc-balance-pack-label', `PACK ${packShare.toFixed(1)}%`);

        let actionText = '작업 데이터가 없어 비교할 수 없습니다.';
        if (totalQty > 0) {
            if (shareGap <= 8 && htpGap <= 8) actionText = '두 공정이 균형적으로 운영되고 있습니다.';
            else if (pickShare > packShare && pickHtpNum >= packHtpNum) actionText = 'PICK 집중 구간입니다. PACK 지원 인력 투입을 검토하세요.';
            else if (packShare > pickShare && packHtpNum >= pickHtpNum) actionText = 'PACK 집중 구간입니다. PICK 물량 분산을 검토하세요.';
            else if (pickHtpNum > packHtpNum) actionText = 'PICK 효율 우세입니다. PACK 병목 원인을 점검하세요.';
            else if (packHtpNum > pickHtpNum) actionText = 'PACK 효율 우세입니다. PICK 동선 최적화를 권장합니다.';
            else actionText = '점유율과 HTP 격차를 함께 모니터링하세요.';
        }
        setText('proc-insight-action', actionText);

        upsertChart('processComparison', 'process-comparison-chart', {
            type: 'doughnut',
            data: {
                labels: ['PICK (집품)', 'PACK (포장)'],
                datasets: [{
                    label: '총 작업량',
                    data: [processStats.PICK.totalQty, processStats.PACK.totalQty],
                    backgroundColor: [t.colors.blue, t.colors.amber],
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 2,
                    hoverOffset: 20,
                    borderRadius: 10,
                    spacing: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { animateRotate: true, animateScale: true, duration: 1500 },
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: t.legendColor,
                            padding: 20,
                            font: { size: 12, weight: '800' },
                            usePointStyle: true,
                            pointStyle: 'circle',
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        textAlign: 'center',
                        font: { weight: '900', size: 14 },
                        textShadowBlur: 10,
                        textShadowColor: 'rgba(0,0,0,0.8)',
                        formatter: (value) => {
                            if (value === 0) return '';
                            const total = processStats.PICK.totalQty + processStats.PACK.totalQty;
                            const pct = Math.round((value / total) * 100);
                            return `${pct}%`;
                        }
                    },
                    tooltip: {
                        backgroundColor: t.tooltipBg,
                        titleColor: t.tooltipText,
                        bodyColor: t.tooltipText,
                        padding: 12,
                        cornerRadius: 12,
                        callbacks: {
                            label: (context) => {
                                const val = context.parsed;
                                return ` ${val.toLocaleString()} Units`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function updateHourlyTrendChart(rawData) {
        const t = getChartTheme();
        const hourlyData = new Map();
        for (let i = 0; i < 24; i++) hourlyData.set(i, { unitQty: 0, totalSeconds: 0 });

        rawData.forEach(item => {
            const hour = item.htpStart.getUTCHours();
            const stats = hourlyData.get(hour);
            if (stats) {
                stats.unitQty += item.unitQty;
                stats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            }
        });

        const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
        const labels = sortedHours.map(hour => `${hour.toString().padStart(2, '0')}:00`);
        const htpValues = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            if (!stats || stats.totalSeconds <= 0) return 0;
            const mh = stats.totalSeconds / 3600;
            return +((stats.unitQty / mh).toFixed(1));
        });

        let bestHour = -1;
        let bestHtp = 0;
        htpValues.forEach((value, idx) => {
            if (value > bestHtp) {
                bestHtp = value;
                bestHour = idx;
            }
        });
        if (bestHour >= 0 && bestHtp > 0) {
            setText('kpi-best-hour', labels[bestHour]);
        } else {
            setText('kpi-best-hour', '-');
        }

        upsertChart('hourlyHtp', 'hourly-htp-chart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '시간별 평균 HTP',
                    data: htpValues,
                    fill: true,
                    backgroundColor: t.isDark ? 'rgba(6, 182, 212, 0.15)' : 'rgba(14, 116, 144, 0.1)',
                    borderColor: '#22d3ee',
                    borderWidth: 4,
                    pointRadius: 4,
                    pointBackgroundColor: '#22d3ee',
                    pointBorderColor: t.isDark ? '#0f172a' : '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#22d3ee',
                    pointHoverBorderWidth: 3,
                    tension: 0.45
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 2000, easing: 'easeOutQuart' },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { color: t.tickColor, font: { weight: '600' } },
                        grid: { color: t.gridColor, drawBorder: false },
                    },
                    x: {
                        ticks: { color: t.tickColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 12, font: { weight: '600' } },
                        grid: { display: false },
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false },
                    tooltip: {
                        backgroundColor: t.tooltipBg,
                        titleColor: t.tooltipText,
                        bodyColor: t.tooltipText,
                        padding: 12,
                        cornerRadius: 12,
                        displayColors: false,
                        callbacks: {
                            label: (context) => ` ${context.parsed.y} HTP`
                        }
                    }
                }
            }
        });
    }

    function showIndividualTrend(employeeName, processType) {
        employeeName = employeeName.replace(/[👑🔥🐢🥇🥈🥉]\s*/g, '').trim();
        const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
        const employeeData = globalRawData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
        
        if (employeeData.length === 0) {
            showModal(`${employeeName.split('(')[0]} 님의 해당 공정 데이터가 없습니다.`);
            return;
        }

        const hourlyData = new Map();
        employeeData.forEach(item => {
            const hour = item.htpStart.getUTCHours();
            if (!hourlyData.has(hour)) hourlyData.set(hour, { unitQty: 0, totalSeconds: 0 });
            const hourStats = hourlyData.get(hour);
            hourStats.unitQty += item.unitQty;
            hourStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
        });

        const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
        const labels = sortedHours.map(hour => `${hour}시`);
        const htpValues = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            const mh = stats.totalSeconds / 3600;
            return mh > 0 ? (stats.unitQty / mh).toFixed(1) : 0;
        });

        const totalQty = employeeData.reduce((sum, item) => sum + item.unitQty, 0);
        const totalSeconds = employeeData.reduce((sum, item) => sum + (item.htpEnd - item.htpStart) / 1000, 0);
        const totalMh = totalSeconds / 3600;
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtp = Math.max(...htpValues.map(v => parseFloat(v)));
        const minHtp = Math.min(...htpValues.filter(v => v > 0).map(v => parseFloat(v)));
        const maxHour = sortedHours[htpValues.indexOf(maxHtp.toString())];
        
        const hourlyRanks = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            const mh = stats.totalSeconds / 3600;
            const employeeHtp = mh > 0 ? stats.unitQty / mh : 0;
            
            const sameHourData = globalRawData.filter(d => 
                d.processTask === targetProcessTask && 
                d.htpStart.getUTCHours() === hour
            );
            
            const employeeHtps = new Map();
            sameHourData.forEach(item => {
                if (!employeeHtps.has(item.employee)) {
                    employeeHtps.set(item.employee, { unitQty: 0, totalSeconds: 0 });
                }
                const empStats = employeeHtps.get(item.employee);
                empStats.unitQty += item.unitQty;
                empStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            });
            
            const htpList = Array.from(employeeHtps.values())
                .map(s => s.totalSeconds > 0 ? s.unitQty / (s.totalSeconds / 3600) : 0)
                .sort((a, b) => b - a);
            
            const rank = htpList.findIndex(h => h <= employeeHtp) + 1;
            const total = htpList.length;
            
            return { hour, rank, total };
        });

        const employeeBadge = employeeBadges[employeeName] || { badges: [], streaks: {}, records: {} };
        const badges = employeeBadge.badges || [];

        // 목표 HTP
        const targetHtp = getTargetHtp({processType: processType});
        const targetPct = Math.min(Math.round((avgHtp / targetHtp) * 100), 100);
        const targetDiffPct = ((avgHtp / targetHtp - 1) * 100).toFixed(1);
        const isAboveTarget = avgHtp >= targetHtp;

        // 링 색상
        let ringColor = '#3b82f6';
        if (targetPct >= 100) ringColor = '#22c55e';
        else if (targetPct >= 70) ringColor = '#3b82f6';
        else if (targetPct >= 40) ringColor = '#f59e0b';
        else ringColor = '#ef4444';

        // 뱃지 HTML
        const badgesHtml = badges.length > 0
            ? badges.map(b => `<span class="badge badge-${b.level || 'normal'} edm-badge-in-header" title="${b.desc || ''}">${b.name}</span>`).join('')
            : '<span class="edm-badge-chip" style="opacity:0.5">뱃지 없음</span>';

        const isPick = processType.includes('PICK');
        const processLabel = isPick ? 'PICK (집품)' : 'PACK (포장)';

        ui.chartModalTitle.textContent = '';
        const modalContent = document.getElementById('chart-modal-content');
        modalContent.className = 'rounded-2xl shadow-2xl w-full max-w-4xl relative flex flex-col overflow-y-auto';
        modalContent.style.cssText = 'max-height:90vh;background:var(--bg-secondary);animation:edmFadeIn .25s ease;padding:0;';
        modalContent.innerHTML = `
            <!-- Header -->
            <div class="edm-header">
                <div class="edm-header-top">
                    <div>
                        <span class="edm-name">${employeeName}</span>
                        <span class="edm-process-badge">${processLabel}</span>
                    </div>
                    <button class="edm-close" id="chart-modal-close">✕</button>
                </div>
                <div class="edm-badges-row">${badgesHtml}</div>
            </div>

            <!-- Dashboard Body -->
            <div style="padding: 24px 28px 28px;">
                <!-- Top Section: Ring + Stats -->
                <div style="display:grid;grid-template-columns:200px 1fr;gap:0;margin-bottom:20px;">
                    <!-- Left: Ring -->
                    <div class="edm-left">
                        <div class="edm-ring-wrap">
                            <div class="edm-ring" style="--pct:${targetPct};--ring-color:${ringColor}">
                                <div class="edm-ring-inner">
                                    <span class="edm-ring-label">평균 HTP</span>
                                    <span class="edm-ring-value">${avgHtp.toFixed(1)}</span>
                                    <span class="edm-ring-sub">목표 ${targetHtp}의 ${targetPct}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="edm-specialty" style="margin-top:12px;">
                            목표 대비 <strong style="color:${isAboveTarget ? '#4ade80' : '#f87171'}">${isAboveTarget ? '+' : ''}${targetDiffPct}%</strong>
                        </div>
                    </div>
                    <!-- Right: Stats Grid -->
                    <div class="edm-right">
                        <div class="edm-stats-grid">
                            <div class="edm-stat">
                                <div class="edm-stat-label">최고 HTP</div>
                                <div class="edm-stat-value green">${maxHtp.toFixed(1)}</div>
                                <div style="font-size:0.65rem;color:var(--text-tertiary);margin-top:4px;">${maxHour !== undefined ? maxHour + '시' : ''}</div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">최저 HTP</div>
                                <div class="edm-stat-value red">${minHtp > 0 ? minHtp.toFixed(1) : '-'}</div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">총 작업량</div>
                                <div class="edm-stat-value orange">${totalQty.toLocaleString()}</div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">총 작업시간</div>
                                <div class="edm-stat-value blue">${totalMh.toFixed(1)}<small style="font-size:0.5em;opacity:0.7">h</small></div>
                            </div>
                        </div>
                        <!-- Hourly Ranks -->
                        <div class="edm-progress-section" style="max-height:140px;overflow-y:auto;">
                            <div class="edm-progress-header" style="margin-bottom:8px;">
                                <span class="edm-progress-label">시간대별 순위</span>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                ${hourlyRanks.map(r => `
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 10px;background:var(--bg-primary);border-radius:6px;">
                                        <span style="color:var(--text-primary);font-weight:600;font-size:0.8rem;">${r.hour}시</span>
                                        <span style="color:${r.rank <= 3 ? '#fbbf24' : r.rank <= r.total / 2 ? '#4ade80' : '#94a3b8'};font-weight:700;font-size:0.8rem;">
                                            ${r.rank}위 / ${r.total}명 ${r.rank === 1 ? '👑' : r.rank <= 3 ? '⭐' : ''}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:12px;padding:16px;">
                    <div class="edm-progress-header" style="margin-bottom:12px;">
                        <span class="edm-progress-label">시간별 HTP 추이</span>
                    </div>
                    <div style="min-height:280px;position:relative;">
                        <canvas id="individual-htp-chart"></canvas>
                    </div>
                </div>
            </div>
        `;

        const ctx = document.getElementById('individual-htp-chart').getContext('2d');
        if (state.charts.individualHtp) state.charts.individualHtp.destroy();

        // 차트 텍스트 색상 (테마 대응)
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const tickColor = isDark ? '#d1d5db' : '#6b7280';
        const labelColor = isDark ? '#d1d5db' : '#374151';
        const dlColor = isDark ? '#FFFFFF' : '#1f2937';

        state.charts.individualHtp = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '시간별 HTP',
                    data: htpValues,
                    fill: true,
                    backgroundColor: isDark ? 'rgba(59,130,246,0.1)' : 'rgba(59,130,246,0.08)',
                    borderColor: '#3b82f6',
                    borderWidth: 2.5,
                    tension: 0.3,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: isDark ? '#1f2937' : '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)' } },
                    x: { ticks: { color: tickColor }, grid: { display: false } }
                },
                plugins: {
                    legend: { labels: { color: labelColor } },
                    datalabels: { align: 'top', color: dlColor, font: { weight: 600, size: 11 } }
                }
            }
        });

        document.getElementById('chart-modal-close').addEventListener('click', () => {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
            ui.chartModalBackdrop.classList.remove('edm-backdrop-fx');
            const dots = ui.chartModalBackdrop.querySelector('.edm-backdrop-dots');
            if (dots) dots.remove();
        });

        // 배경 이펙트 추가
        ui.chartModalBackdrop.classList.add('edm-backdrop-fx');
        const existingDots = ui.chartModalBackdrop.querySelector('.edm-backdrop-dots');
        if (existingDots) existingDots.remove();
        createBackdropDots(ui.chartModalBackdrop);

        ui.chartModalBackdrop.classList.remove('hidden');
        ui.chartModalBackdrop.classList.add('flex');
    }

    // --- 🆕 Calendar View Functions ---
    function renderCalendarView() {
        const year = state.calendarCurrentMonth.getFullYear();
        const month = state.calendarCurrentMonth.getMonth();
        
        ui.calendarMonthTitle.textContent = `${year}년 ${month + 1}월`;
        
        const existingDays = ui.calendarGrid.querySelectorAll('.calendar-day');
        existingDays.forEach(day => day.remove());
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day inactive';
            ui.calendarGrid.appendChild(emptyDay);
        }
        
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayData = historyData[dateStr];
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayEl.classList.add('today');
            }
            
            if (dayData && dayData.length > 0) {
                const aggregated = aggregateData(dayData);
                const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
                const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
                
                const targetHtp = 90;
                const performanceRatio = avgHtp / targetHtp;
                
                if (performanceRatio >= 1.2) dayEl.classList.add('excellent');
                else if (performanceRatio >= 1.0) dayEl.classList.add('good');
                else if (performanceRatio >= 0.8) dayEl.classList.add('average');
                else dayEl.classList.add('poor');
                
                dayEl.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-htp" style="color: var(--text-primary);">HTP ${avgHtp.toFixed(0)}</div>
                `;
                
                dayEl.addEventListener('click', () => showCalendarDayDetail(dateStr));
            } else {
                dayEl.classList.add('no-data');
                dayEl.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-htp" style="color: var(--text-tertiary); font-size: 0.65rem;">데이터 없음</div>
                `;
            }
            
            ui.calendarGrid.appendChild(dayEl);
        }
    }

    function showCalendarDayDetail(dateStr) {
        const dayData = historyData[dateStr];
        if (!dayData || dayData.length === 0) {
            showModal('해당 날짜의 데이터가 없습니다.');
            return;
        }
        
        const aggregated = aggregateData(dayData);
        const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const workerCount = new Set(aggregated.map(d => d.employee)).size;
        const targetHtp = 90;
        const targetRate = ((avgHtp / targetHtp) * 100).toFixed(0);
        
        document.getElementById('calendar-detail-title').textContent = `${dateStr} 상세 정보`;
        document.getElementById('calendar-detail-avg-htp').textContent = avgHtp.toFixed(1);
        document.getElementById('calendar-detail-total-qty').textContent = totalQty.toLocaleString();
        document.getElementById('calendar-detail-worker-count').textContent = workerCount;
        document.getElementById('calendar-detail-target-rate').textContent = targetRate + '%';
        
        const sorted = [...aggregated].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        const top5 = sorted.slice(0, 5);
        const topListHtml = top5.map((item, index) => `
            <div class="flex justify-between items-center bg-gray-600 p-2 rounded-md">
                <span class="font-semibold">${index + 1}. ${item.employee.split('(')[0].trim()}</span>
                <span class="font-bold text-green-400">${item.htp} HTP</span>
            </div>
        `).join('');
        document.getElementById('calendar-detail-top-list').innerHTML = topListHtml;
        
        const pickData = aggregated.filter(d => d.processType.includes('PICK'));
        const packData = aggregated.filter(d => d.processType.includes('PACK'));
        const pickQty = pickData.reduce((sum, d) => sum + d.unitQty, 0);
        const packQty = packData.reduce((sum, d) => sum + d.unitQty, 0);
        
        const ctx = document.getElementById('calendar-detail-chart').getContext('2d');
        if (state.charts.calendarDetailChart) state.charts.calendarDetailChart.destroy();
        state.charts.calendarDetailChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['PICK', 'PACK'],
                datasets: [{
                    data: [pickQty, packQty],
                    backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                    borderColor: '#374151',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#d1d5db' } },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value) => value.toLocaleString()
                    }
                }
            }
        });
        
        ui.calendarDetailModalBackdrop.classList.remove('hidden');
        ui.calendarDetailModalBackdrop.classList.add('flex');
    }

    // --- 🆕 Ranking View Functions ---
    function renderRankingView() {
        ensureBadgesCalculated(); // 뱃지 계산
        
        const filteredDates = getRankingFilteredDates();
        if (filteredDates.length === 0) {
            ui.rankingList.innerHTML = '<div class="rank-empty-state">데이터가 없습니다.</div>';
            return;
        }
        
        // 히스토리 데이터에서 직접 처리
        const processFilter = state.rankingProcessType === 'pick' ? 'PICK' : 'PACK';
        const employeeStats = new Map();
        
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (!Array.isArray(dayData)) return;
            
            dayData.forEach(item => {
                if (!item || !item.employee) return;
                
                const processTask = item.processTask || item.processType || '';
                if (!processTask.includes(processFilter)) return;
                
                // HTP 계산
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds <= 0) return;
                
                const htp = item.unitQty / (durationSeconds / 3600);
                const qty = item.unitQty || 0;
                const mh = durationSeconds / 3600;
                
                if (!employeeStats.has(item.employee)) {
                    employeeStats.set(item.employee, { totalQty: 0, totalMh: 0, htpList: [] });
                }
                const stats = employeeStats.get(item.employee);
                stats.totalQty += qty;
                stats.totalMh += mh;
                stats.htpList.push(htp);
            });
        });
        
        const rankings = [];
        employeeStats.forEach((stats, employee) => {
            const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
            rankings.push({ 
                employee, 
                avgHtp: avgHtp.toFixed(1), 
                totalQty: stats.totalQty,
                workDays: stats.htpList.length 
            });
        });
        
        rankings.sort((a, b) => parseFloat(b.avgHtp) - parseFloat(a.avgHtp));
        
        ui.rankingTotalCount.textContent = rankings.length;
        const avgHtp = rankings.length > 0 ? (rankings.reduce((sum, r) => sum + parseFloat(r.avgHtp), 0) / rankings.length) : 0;
        const maxHtp = rankings.length > 0 ? Math.max(...rankings.map(r => parseFloat(r.avgHtp))) : 0;
        const medianHtp = rankings.length > 0 ? parseFloat(rankings[Math.floor(rankings.length / 2)].avgHtp) : 0;
        
        ui.rankingAvgHtp.textContent = avgHtp.toFixed(1);
        ui.rankingMaxHtp.textContent = maxHtp.toFixed(1);
        ui.rankingMedianHtp.textContent = medianHtp.toFixed(1);
        
        if (rankings.length >= 1) {
            document.getElementById('podium-1-name').textContent = rankings[0].employee.split('(')[0].trim();
            document.getElementById('podium-1-score').textContent = rankings[0].avgHtp;
        } else {
            document.getElementById('podium-1-name').textContent = '-';
            document.getElementById('podium-1-score').textContent = '0';
        }
        
        if (rankings.length >= 2) {
            document.getElementById('podium-2-name').textContent = rankings[1].employee.split('(')[0].trim();
            document.getElementById('podium-2-score').textContent = rankings[1].avgHtp;
        } else {
            document.getElementById('podium-2-name').textContent = '-';
            document.getElementById('podium-2-score').textContent = '0';
        }
        
        if (rankings.length >= 3) {
            document.getElementById('podium-3-name').textContent = rankings[2].employee.split('(')[0].trim();
            document.getElementById('podium-3-score').textContent = rankings[2].avgHtp;
        } else {
            document.getElementById('podium-3-name').textContent = '-';
            document.getElementById('podium-3-score').textContent = '0';
        }
        
        ui.rankingList.innerHTML = '';
        rankings.forEach((rank, index) => {
            const position = index + 1;
            const previousRank = previousRankings[rank.employee] || position;
            const change = previousRank - position;

            let changeHtml = '';
            if (change > 0) {
                changeHtml = `<span class="ranking-change up">▲${change}</span>`;
            } else if (change < 0) {
                changeHtml = `<span class="ranking-change down">▼${Math.abs(change)}</span>`;
            } else {
                changeHtml = `<span class="ranking-change same">-</span>`;
            }

            const posClass = position <= 3 ? `rank-top-${position}` : '';
            const posIcon = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `#${position}`;

            const item = document.createElement('div');
            item.className = `rank-list-item ${posClass}`;
            item.innerHTML = `
                <div class="rank-item-pos">${posIcon}</div>
                <div class="rank-item-info">
                    <span class="rank-item-name">${rank.employee.split('(')[0].trim()}</span>
                    <span class="rank-item-qty">${rank.totalQty.toLocaleString()} Unit</span>
                </div>
                <div class="rank-item-htp-wrap">
                    <span class="rank-item-htp">${rank.avgHtp}</span>
                    ${changeHtml}
                </div>
            `;

            item.addEventListener('click', () => {
                const processType = state.rankingProcessType === 'pick' ? 'PICK(집품)' : 'PACK(포장)';
                showEmployeeDetailModal(rank.employee, processType);
            });

            ui.rankingList.appendChild(item);
        });
        
        previousRankings = {};
        rankings.forEach((rank, index) => {
            previousRankings[rank.employee] = index + 1;
        });
    }

    function getRankingFilteredDates() {
        const allDates = Object.keys(historyData).sort();
        if (allDates.length === 0) return [];
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        if (state.rankingPeriod === 'daily') {
            return allDates.filter(date => date === todayStr);
        } else if (state.rankingPeriod === 'weekly') {
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
        } else if (state.rankingPeriod === 'monthly') {
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
        } else if (state.rankingPeriod === 'all-time') {
            return allDates;
        }
        return allDates;
    }

    // --- 🆕 History View Functions ---
    let historyEmployeeData = [];
    let currentHistoryPage = 1;
    const EMPLOYEES_PER_PAGE = 20;

    function renderHistoryView() {
        ensureBadgesCalculated(); // 뱃지 계산
        
        if (Object.keys(historyData).length === 0) {
            showModal('히스토리 데이터가 없습니다.');
            return;
        }

        const filteredDates = getFilteredHistoryDates();
        if (filteredDates.length === 0) {
            ui.historyKpi.days.textContent = '0';
            ui.historyKpi.totalQty.textContent = '0';
            ui.historyKpi.avgHtp.textContent = '0.0';
            ui.historyKpi.maxHtp.textContent = '0.0';
            return;
        }

        let allAggregatedData = [];
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (dayData) {
                const aggregated = aggregateData(dayData);
                allAggregatedData = allAggregatedData.concat(aggregated.map(item => ({ ...item, date })));
            }
        });

        const totalDays = filteredDates.length;
        const totalQty = allAggregatedData.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = allAggregatedData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtp = Math.max(...allAggregatedData.map(d => parseFloat(d.htp)), 0);

        ui.historyKpi.days.textContent = totalDays.toLocaleString();
        ui.historyKpi.totalQty.textContent = totalQty.toLocaleString();
        ui.historyKpi.avgHtp.textContent = avgHtp.toFixed(1);
        ui.historyKpi.maxHtp.textContent = maxHtp.toFixed(1);

        calculateEmployeeHistoryData(allAggregatedData);
        updateHistoryTopPerformers(allAggregatedData);
    }

    function getFilteredHistoryDates() {
        const allDates = Object.keys(historyData).sort();
        if (allDates.length === 0) return [];

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        if (state.historyPeriod === 'week') {
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
        } else if (state.historyPeriod === 'month') {
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
        } else if (state.historyPeriod === 'all') {
            return allDates;
        } else if (state.historyPeriod === 'custom') {
            const { start, end } = state.historyDateRange;
            return allDates.filter(date => date >= start && date <= end);
        }
        return allDates;
    }

    function calculateEmployeeHistoryData(allData) {
        const employeeMap = new Map();

        allData.forEach(item => {
            if (!employeeMap.has(item.employee)) {
                employeeMap.set(item.employee, {
                    employee: item.employee,
                    totalDays: new Set(),
                    pickData: { totalQty: 0, totalMh: 0, ppPerformance: new Map() },
                    packData: { totalQty: 0, totalMh: 0, packTypePerformance: new Map() }
                });
            }

            const empData = employeeMap.get(item.employee);
            empData.totalDays.add(item.date);

            if (item.processType.includes('PICK')) {
                empData.pickData.totalQty += item.unitQty;
                empData.pickData.totalMh += parseFloat(item.mh);
                
                const pp = item.processPathName || '기타';
                if (!empData.pickData.ppPerformance.has(pp)) {
                    empData.pickData.ppPerformance.set(pp, { totalQty: 0, totalMh: 0 });
                }
                const ppStats = empData.pickData.ppPerformance.get(pp);
                ppStats.totalQty += item.unitQty;
                ppStats.totalMh += parseFloat(item.mh);
            } else {
                empData.packData.totalQty += item.unitQty;
                empData.packData.totalMh += parseFloat(item.mh);
                
                const packType = item.packType || '기타';
                if (!empData.packData.packTypePerformance.has(packType)) {
                    empData.packData.packTypePerformance.set(packType, { totalQty: 0, totalMh: 0 });
                }
                const packStats = empData.packData.packTypePerformance.get(packType);
                packStats.totalQty += item.unitQty;
                packStats.totalMh += parseFloat(item.mh);
            }
        });

        historyEmployeeData = Array.from(employeeMap.values()).map(emp => {
            const pickHtp = emp.pickData.totalMh > 0 ? (emp.pickData.totalQty / emp.pickData.totalMh) : 0;
            const packHtp = emp.packData.totalMh > 0 ? (emp.packData.totalQty / emp.packData.totalMh) : 0;
            const totalQty = emp.pickData.totalQty + emp.packData.totalQty;
            const totalMh = emp.pickData.totalMh + emp.packData.totalMh;
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;

            let bestPP = null, bestPPHtp = 0;
            emp.pickData.ppPerformance.forEach((stats, pp) => {
                const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                if (htp > bestPPHtp) {
                    bestPPHtp = htp;
                    bestPP = pp;
                }
            });

            let bestPackType = null, bestPackTypeHtp = 0;
            emp.packData.packTypePerformance.forEach((stats, packType) => {
                const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                if (htp > bestPackTypeHtp) {
                    bestPackTypeHtp = htp;
                    bestPackType = packType;
                }
            });

            return {
                employee: emp.employee,
                totalDays: emp.totalDays.size,
                totalQty: totalQty,
                avgHtp: avgHtp,
                pickHtp: pickHtp,
                packHtp: packHtp,
                bestProcess: pickHtp > packHtp ? 'PICK' : (packHtp > 0 ? 'PACK' : 'PICK'),
                bestProcessHtp: Math.max(pickHtp, packHtp),
                bestPP: bestPP,
                bestPPHtp: bestPPHtp,
                bestPackType: bestPackType,
                bestPackTypeHtp: bestPackTypeHtp
            };
        });

        historyEmployeeData.sort((a, b) => b.avgHtp - a.avgHtp);
    }

    function updateHistoryTopPerformers(allData) {
        const employeeStats = new Map();
        
        allData.forEach(item => {
            const key = `${item.employee}|${item.processType}`;
            if (!employeeStats.has(key)) {
                employeeStats.set(key, {
                    employee: item.employee,
                    processType: item.processType,
                    totalQty: 0,
                    totalMh: 0
                });
            }
            const stats = employeeStats.get(key);
            stats.totalQty += item.unitQty;
            stats.totalMh += parseFloat(item.mh);
        });

        const employeeList = [];
        employeeStats.forEach(stats => {
            const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
            employeeList.push({
                employee: stats.employee,
                processType: stats.processType,
                avgHtp: avgHtp,
                totalQty: stats.totalQty
            });
        });

        const pickList = employeeList
            .filter(e => e.processType.includes('PICK'))
            .sort((a, b) => b.avgHtp - a.avgHtp)
            .slice(0, 10);

        const packList = employeeList
            .filter(e => e.processType.includes('PACK'))
            .sort((a, b) => b.avgHtp - a.avgHtp)
            .slice(0, 10);

        ui.historyTopPickList.innerHTML = '';
        ui.historyTopPackList.innerHTML = '';

        if (pickList.length === 0) {
            ui.historyTopPickList.innerHTML = '<div class="text-gray-500 text-center py-4">데이터 없음</div>';
        } else {
            pickList.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                
                let medalOrNumber = '';
                if (rank === 1) {
                    medalOrNumber = '<span class="medal-icon">🥇</span>';
                } else if (rank === 2) {
                    medalOrNumber = '<span class="medal-icon">🥈</span>';
                } else if (rank === 3) {
                    medalOrNumber = '<span class="medal-icon">🥉</span>';
                } else {
                    medalOrNumber = `<span class="rank-number">${rank}</span>`;
                }
                
                const div = document.createElement('div');
                div.className = `top-performer-item ${rankClass}`;
                div.innerHTML = `
                    ${medalOrNumber}
                    <span class="performer-name">${item.employee.split('(')[0].trim()}</span>
                    <span class="performer-htp">${item.avgHtp.toFixed(1)} HTP</span>
                `;
                div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PICK(집품)'));
                ui.historyTopPickList.appendChild(div);
            });
        }

        if (packList.length === 0) {
            ui.historyTopPackList.innerHTML = '<div class="text-gray-500 text-center py-4">데이터 없음</div>';
        } else {
            packList.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                
                let medalOrNumber = '';
                if (rank === 1) {
                    medalOrNumber = '<span class="medal-icon">🥇</span>';
                } else if (rank === 2) {
                    medalOrNumber = '<span class="medal-icon">🥈</span>';
                } else if (rank === 3) {
                    medalOrNumber = '<span class="medal-icon">🥉</span>';
                } else {
                    medalOrNumber = `<span class="rank-number">${rank}</span>`;
                }
                
                const div = document.createElement('div');
                div.className = `top-performer-item ${rankClass}`;
                div.innerHTML = `
                    ${medalOrNumber}
                    <span class="performer-name">${item.employee.split('(')[0].trim()}</span>
                    <span class="performer-htp">${item.avgHtp.toFixed(1)} HTP</span>
                `;
                div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PACK(포장)'));
                ui.historyTopPackList.appendChild(div);
            });
        }
    }

    // Employee Search (간단 버전)
    const historyEmployeeSearch = document.getElementById('history-employee-search');
    const historyShowAllBtn = document.getElementById('history-show-all-btn');

    if (historyEmployeeSearch) {
        historyEmployeeSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                document.getElementById('history-employee-results').innerHTML =
                    '<div class="hist-empty-state"><div class="hist-empty-icon">🔍</div><p>사원을 검색하거나 "전체 보기"를 클릭하세요</p></div>';
                return;
            }
            const filtered = historyEmployeeData.filter(emp => 
                emp.employee.toLowerCase().includes(searchTerm)
            );
            renderEmployeeAnalysisCards(filtered);
        });
    }

    if (historyShowAllBtn) {
        historyShowAllBtn.addEventListener('click', () => {
            renderEmployeeAnalysisCards(historyEmployeeData.slice(0, 20));
        });
    }

    function renderEmployeeAnalysisCards(employees) {
        const resultsContainer = document.getElementById('history-employee-results');
        resultsContainer.innerHTML = '';

        if (employees.length === 0) {
            resultsContainer.innerHTML = '<div class="hist-empty-state"><div class="hist-empty-icon">😢</div><p>검색 결과가 없습니다</p></div>';
            return;
        }

        employees.forEach((emp) => {
            const card = document.createElement('div');
            card.className = 'employee-analysis-card';
            
            const rank = historyEmployeeData.findIndex(e => e.employee === emp.employee) + 1;
            const rankBadge = rank <= 3 ? (rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉') : `#${rank}`;

            card.innerHTML = `
                <div class="employee-name-header">
                    <span>${emp.employee.split('(')[0].trim()}</span>
                    <span style="font-size: 1.5rem;">${rankBadge}</span>
                </div>
                
                <div class="employee-stats-grid">
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">평균 HTP</div>
                        <div class="employee-stat-value" style="color: ${emp.avgHtp >= 90 ? '#4ade80' : '#f87171'};">
                            ${emp.avgHtp.toFixed(1)}
                        </div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">총 근무일수</div>
                        <div class="employee-stat-value">${emp.totalDays}일</div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">누적 작업량</div>
                        <div class="employee-stat-value">${emp.totalQty.toLocaleString()}</div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">최적 공정</div>
                        <div class="employee-stat-value">
                            <span class="performance-badge ${emp.bestProcess.toLowerCase()}">
                                ${emp.bestProcess} ${emp.bestProcessHtp.toFixed(1)}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="best-performance-section">
                    <div class="best-performance-title">⭐ 최고 효율 작업 위치</div>
                    <div class="best-performance-detail">
                        ${emp.bestProcess === 'PICK' && emp.bestPP ? 
                            `<strong>PICK (집품)</strong><br/>🔹 최고 효율 PP: <strong>${emp.bestPP}</strong><br/>🔹 HTP: <strong style="color: #4ade80;">${emp.bestPPHtp.toFixed(1)}</strong>` :
                            emp.bestProcess === 'PACK' && emp.bestPackType ?
                            `<strong>PACK (포장)</strong><br/>🔹 최고 효율 팩 종류: <strong>${emp.bestPackType}</strong><br/>🔹 HTP: <strong style="color: #fbbf24;">${emp.bestPackTypeHtp.toFixed(1)}</strong>` :
                            '데이터 수집 중...'}
                    </div>
                </div>
            `;

            card.addEventListener('click', () => {
                const processType = emp.bestProcess === 'PICK' ? 'PICK(집품)' : 'PACK(포장)';
                showEmployeeDetailModal(emp.employee, processType);
            });

            resultsContainer.appendChild(card);
        });
    }

    function showEmployeeDetailModal(employeeName, processType) {
        // 뱃지 먼저 계산
        ensureBadgesCalculated();

        // 사원 정보 가져오기
        const employeeBadge = employeeBadges[employeeName];

        if (!employeeBadge) {
            showModal(`${employeeName}의 정보를 찾을 수 없습니다.`);
            return;
        }

        const badges = employeeBadge.badges || [];
        const records = employeeBadge.records || {};

        // 목표 HTP 결정 (공정 타입 기준)
        const isPick = processType.includes('PICK');
        const defaultTarget = isPick ? (targetHtpValues['PICK'] || 90) : (targetHtpValues['Manual SINGULATION'] || 100);
        const avgHtp = records.avgHtp || 0;
        const targetPct = Math.min(Math.round((avgHtp / defaultTarget) * 100), 100);

        // 목표 달성률 (perfectDays / totalDays)
        const achieveRate = records.totalDays > 0 ? Math.round((records.perfectDays || 0) / records.totalDays * 100) : 0;

        // 링 색상 결정
        let ringColor = '#3b82f6'; // blue
        if (targetPct >= 100) ringColor = '#22c55e'; // green
        else if (targetPct >= 70) ringColor = '#3b82f6'; // blue
        else if (targetPct >= 40) ringColor = '#f59e0b'; // amber
        else ringColor = '#ef4444'; // red

        // 달성률 바 색상
        let barGradient = 'linear-gradient(90deg, #3b82f6, #8b5cf6)';
        if (achieveRate >= 80) barGradient = 'linear-gradient(90deg, #22c55e, #4ade80)';
        else if (achieveRate >= 50) barGradient = 'linear-gradient(90deg, #3b82f6, #8b5cf6)';
        else barGradient = 'linear-gradient(90deg, #f59e0b, #fb923c)';

        // 전문 공정 텍스트
        const specialtyText = records.specialtyProcess
            ? `<strong>${records.specialtyProcess}</strong> 전문`
            : (records.pickDays > 0 && records.packDays > 0 ? '멀티 플레이어' : '데이터 수집 중');

        // 뱃지 HTML
        let badgesHTML = '';
        if (badges.length > 0) {
            badgesHTML = badges.map(badge =>
                `<span class="badge badge-${badge.level || 'normal'} edm-badge-in-header" title="${badge.desc || ''}">${badge.name}</span>`
            ).join('');
        } else {
            badgesHTML = '<span class="edm-badge-chip" style="opacity:0.5">뱃지 없음</span>';
        }

        const processLabel = isPick ? 'PICK (집품)' : 'PACK (포장)';

        // 모달 내용 생성
        const modalContent = `
            <div class="edm-modal">
                <div class="edm-header">
                    <div class="edm-header-top">
                        <div>
                            <span class="edm-name">${employeeName}</span>
                            <span class="edm-process-badge">${processLabel}</span>
                        </div>
                    </div>
                    <div class="edm-badges-row">${badgesHTML}</div>
                </div>
                <div class="edm-body">
                    <div class="edm-left">
                        <div class="edm-ring-wrap">
                            <div class="edm-ring" style="--pct:${targetPct};--ring-color:${ringColor}">
                                <div class="edm-ring-inner">
                                    <span class="edm-ring-label">평균 HTP</span>
                                    <span class="edm-ring-value">${avgHtp.toFixed(1)}</span>
                                    <span class="edm-ring-sub">목표 ${defaultTarget}의 ${targetPct}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="edm-specialty">${specialtyText}</div>
                    </div>
                    <div class="edm-right">
                        <div class="edm-stats-grid">
                            <div class="edm-stat">
                                <div class="edm-stat-label">최고 HTP</div>
                                <div class="edm-stat-value green">${records.maxHtp || 0}</div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">총 근무일</div>
                                <div class="edm-stat-value purple">${records.totalDays || 0}<small style="font-size:0.6em;opacity:0.7">일</small></div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">총 작업량</div>
                                <div class="edm-stat-value orange">${(records.totalQty || 0).toLocaleString()}</div>
                            </div>
                            <div class="edm-stat">
                                <div class="edm-stat-label">연속 근무</div>
                                <div class="edm-stat-value red">${records.maxConsecutiveDays || 0}<small style="font-size:0.6em;opacity:0.7">일</small></div>
                            </div>
                        </div>
                        <div class="edm-progress-section">
                            <div class="edm-progress-header">
                                <span class="edm-progress-label">목표 달성률</span>
                                <span class="edm-progress-pct" style="color:${ringColor}">${achieveRate}%</span>
                            </div>
                            <div class="edm-progress-bar">
                                <div class="edm-progress-fill" style="width:${achieveRate}%;background:${barGradient}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        showEmployeeModal(modalContent);
    }

    function exportHistoryToExcel() {
        if (typeof XLSX === 'undefined') { showModal('Excel 라이브러리 로딩 실패. 페이지를 새로고침해주세요.'); return; }
        ensureBadgesCalculated();

        const filteredDates = getFilteredHistoryDates();
        if (filteredDates.length === 0) { showModal('다운로드할 히스토리 데이터가 없습니다.'); return; }

        showModal('엑셀 파일 생성 중...', 2000);
        const wb = XLSX.utils.book_new();

        // 헤더 스타일 생성 함수
        const makeHeaderStyle = (rgb) => ({
            font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 11 },
            fill: { fgColor: { rgb } },
            alignment: { horizontal: 'center', vertical: 'center' },
            border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }
        });
        const cellStyle = {
            alignment: { horizontal: 'center', vertical: 'center' },
            border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }
        };
        const applyStyles = (ws, headerRgb) => {
            const hStyle = makeHeaderStyle(headerRgb);
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const hAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                if (ws[hAddr]) ws[hAddr].s = hStyle;
                for (let R = 1; R <= range.e.r; ++R) {
                    const addr = XLSX.utils.encode_cell({ c: C, r: R });
                    if (ws[addr]) { if (!ws[addr].s) ws[addr].s = {}; Object.assign(ws[addr].s, cellStyle); }
                }
            }
            ws['!cols'] = Array.from({ length: range.e.c + 1 }, (_, i) => {
                const header = XLSX.utils.encode_cell({ c: i, r: 0 });
                let maxLen = ws[header] ? String(ws[header].v).length : 5;
                for (let R = 1; R <= range.e.r; ++R) {
                    const cell = ws[XLSX.utils.encode_cell({ c: i, r: R })];
                    if (cell) maxLen = Math.max(maxLen, String(cell.v).length);
                }
                return { wch: maxLen + 3 };
            });
            ws['!autofilter'] = { ref: ws['!ref'] };
            ws['!freeze'] = { ySplit: 1 };
        };

        // Sheet 1: 전체 요약
        const period = state.historyPeriod === 'week' ? '최근 7일' : state.historyPeriod === 'month' ? '최근 30일' : state.historyPeriod === 'all' ? '전체' : '사용자 지정';
        let allAggData = [];
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (dayData) allAggData = allAggData.concat(aggregateData(dayData).map(item => ({ ...item, date })));
        });
        const totalQty = allAggData.reduce((s, d) => s + d.unitQty, 0);
        const totalMh = allAggData.reduce((s, d) => s + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtpVal = Math.max(...allAggData.map(d => parseFloat(d.htp)), 0);

        const summaryData = [
            ['항목', '값'],
            ['조회 기간', period],
            ['시작일', filteredDates[0]],
            ['종료일', filteredDates[filteredDates.length - 1]],
            ['총 작업일수', filteredDates.length],
            ['누적 작업량', totalQty],
            ['평균 HTP', parseFloat(avgHtp.toFixed(1))],
            ['최고 HTP', maxHtpVal],
            ['생성 일시', new Date().toLocaleString('ko-KR')]
        ];
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        applyStyles(wsSummary, '4F46E5');
        XLSX.utils.book_append_sheet(wb, wsSummary, '전체 요약');

        // Sheet 2: 일별 데이터
        const dailyRows = filteredDates.map(date => {
            const dayData = historyData[date];
            if (!dayData) return null;
            const agg = aggregateData(dayData);
            const workers = new Set(agg.map(d => d.employee)).size;
            const dQty = agg.reduce((s, d) => s + d.unitQty, 0);
            const dMh = agg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const dHtp = dMh > 0 ? dQty / dMh : 0;
            const pickAgg = agg.filter(d => d.processType.includes('PICK'));
            const packAgg = agg.filter(d => d.processType.includes('PACK'));
            const pickMh = pickAgg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const pickQty = pickAgg.reduce((s, d) => s + d.unitQty, 0);
            const packMh = packAgg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const packQty = packAgg.reduce((s, d) => s + d.unitQty, 0);
            return {
                '날짜': date, '작업자수': workers, '총 작업량': dQty,
                '평균 HTP': parseFloat(dHtp.toFixed(1)),
                'PICK HTP': parseFloat((pickMh > 0 ? pickQty / pickMh : 0).toFixed(1)),
                'PACK HTP': parseFloat((packMh > 0 ? packQty / packMh : 0).toFixed(1))
            };
        }).filter(Boolean);
        if (dailyRows.length > 0) {
            const wsDaily = XLSX.utils.json_to_sheet(dailyRows);
            applyStyles(wsDaily, '2563EB');
            XLSX.utils.book_append_sheet(wb, wsDaily, '일별 데이터');
        }

        // Sheet 3: 사원별 성과
        const empRows = Object.entries(employeeBadges).map(([name, data]) => {
            const r = data.records || {};
            const badgeNames = (data.badges || []).map(b => b.name).join(', ');
            return {
                '이름': name, '총 근무일': r.totalDays || 0, '총 작업량': r.totalQty || 0,
                '평균 HTP': parseFloat((r.avgHtp || 0).toFixed ? (r.avgHtp || 0).toFixed(1) : r.avgHtp || 0),
                '최고 HTP': r.maxHtp || 0, '최고HTP 날짜': r.maxHtpDate || '-',
                'PICK 일수': r.pickDays || 0, 'PACK 일수': r.packDays || 0,
                '목표달성 일수': r.perfectDays || 0, '최대 연속근무': r.maxConsecutiveDays || 0,
                '전문 공정': r.specialtyProcess || '-', '획득 뱃지': badgeNames || '-'
            };
        }).sort((a, b) => parseFloat(b['평균 HTP']) - parseFloat(a['평균 HTP']));
        if (empRows.length > 0) {
            const wsEmp = XLSX.utils.json_to_sheet(empRows);
            applyStyles(wsEmp, '7C3AED');
            XLSX.utils.book_append_sheet(wb, wsEmp, '사원별 성과');
        }

        // Sheet 4 & 5: PICK/PACK 상세
        const pickRows = [], packRows = [];
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (!dayData) return;
            aggregateData(dayData).forEach(item => {
                const row = {
                    '날짜': date, '이름': item.employee.replace(/[👑🔥🐢🥇🥈🥉]\s*/g, ''),
                    '작업량': item.unitQty, '로케이션': item.location || '-',
                    'PP': item.processPathName || '-', '팩 종류': item.packType || '-',
                    'M/H': parseFloat(item.mh), 'HTP': parseFloat(item.htp)
                };
                if (item.processType.includes('PICK')) pickRows.push(row);
                else packRows.push(row);
            });
        });
        pickRows.sort((a, b) => a.HTP - b.HTP);
        packRows.sort((a, b) => a.HTP - b.HTP);
        if (pickRows.length > 0) {
            const wsPick = XLSX.utils.json_to_sheet(pickRows);
            applyStyles(wsPick, '2563EB');
            XLSX.utils.book_append_sheet(wb, wsPick, 'PICK 상세');
        }
        if (packRows.length > 0) {
            const wsPack = XLSX.utils.json_to_sheet(packRows);
            applyStyles(wsPack, 'D97706');
            XLSX.utils.book_append_sheet(wb, wsPack, 'PACK 상세');
        }

        const dateStr = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `HTP_히스토리_${period}_${dateStr}.xlsx`);
        showModal('엑셀 다운로드 완료!', 1500);
    }

    function exportHistoryToPDF() {
        if (!window.jspdf) { showModal('PDF 라이브러리 로딩 실패. 페이지를 새로고침해주세요.'); return; }
        ensureBadgesCalculated();

        const filteredDates = getFilteredHistoryDates();
        if (filteredDates.length === 0) { showModal('리포트를 생성할 히스토리 데이터가 없습니다.'); return; }

        showModal('PDF 리포트 생성 중...', 3000);

        // 데이터 준비
        let allAggData = [];
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (dayData) allAggData = allAggData.concat(aggregateData(dayData).map(item => ({ ...item, date })));
        });
        const totalQty = allAggData.reduce((s, d) => s + d.unitQty, 0);
        const totalMh = allAggData.reduce((s, d) => s + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtpVal = Math.max(...allAggData.map(d => parseFloat(d.htp)), 0);
        const period = state.historyPeriod === 'week' ? '최근 7일' : state.historyPeriod === 'month' ? '최근 30일' : state.historyPeriod === 'all' ? '전체' : '사용자 지정';

        // 일별 데이터
        const dailyData = filteredDates.map(date => {
            const dayData = historyData[date];
            if (!dayData) return null;
            const agg = aggregateData(dayData);
            const workers = new Set(agg.map(d => d.employee)).size;
            const dQty = agg.reduce((s, d) => s + d.unitQty, 0);
            const dMh = agg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const pickAgg = agg.filter(d => d.processType.includes('PICK'));
            const packAgg = agg.filter(d => d.processType.includes('PACK'));
            const pickMh = pickAgg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const pickQty = pickAgg.reduce((s, d) => s + d.unitQty, 0);
            const packMh = packAgg.reduce((s, d) => s + parseFloat(d.mh), 0);
            const packQty = packAgg.reduce((s, d) => s + d.unitQty, 0);
            return { date, workers, qty: dQty, htp: dMh > 0 ? (dQty / dMh).toFixed(1) : '0', pickHtp: (pickMh > 0 ? pickQty / pickMh : 0).toFixed(1), packHtp: (packMh > 0 ? packQty / packMh : 0).toFixed(1) };
        }).filter(Boolean);

        // Top 10
        const empStats = new Map();
        allAggData.forEach(item => {
            const key = `${item.employee}|${item.processType}`;
            if (!empStats.has(key)) empStats.set(key, { employee: item.employee, processType: item.processType, totalQty: 0, totalMh: 0 });
            const s = empStats.get(key);
            s.totalQty += item.unitQty;
            s.totalMh += parseFloat(item.mh);
        });
        const empList = [];
        empStats.forEach(s => { empList.push({ ...s, avgHtp: s.totalMh > 0 ? (s.totalQty / s.totalMh) : 0 }); });
        const pickTop = empList.filter(e => e.processType.includes('PICK')).sort((a, b) => b.avgHtp - a.avgHtp).slice(0, 10);
        const packTop = empList.filter(e => e.processType.includes('PACK')).sort((a, b) => b.avgHtp - a.avgHtp).slice(0, 10);

        // 뱃지 보유자
        const badgeHolders = Object.entries(employeeBadges)
            .filter(([, d]) => d.badges && d.badges.length > 0)
            .map(([name, d]) => ({ name, badges: d.badges.map(b => b.name).join(', '), days: d.records.totalDays || 0, avgHtp: (d.records.avgHtp || 0).toFixed ? parseFloat((d.records.avgHtp || 0).toFixed(1)) : 0 }))
            .sort((a, b) => b.avgHtp - a.avgHtp)
            .slice(0, 20);

        // HTML 리포트 생성
        const reportDiv = document.createElement('div');
        reportDiv.id = 'pdf-report-container';
        reportDiv.style.cssText = 'position:fixed;left:-9999px;top:0;width:800px;background:#F8FAFC;font-family:Pretendard,"Noto Sans KR",sans-serif;color:#0F172A;';

        const rankBg = (i) => i === 0 ? '#FEF3C7' : i === 1 ? '#F1F5F9' : i === 2 ? '#FFF7ED' : (i % 2 === 0 ? '#FFFFFF' : '#F8FAFC');
        const rankIcon = (i) => i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `${i + 1}`;

        const topTableHTML = (list, accentColor, label) => {
            if (list.length === 0) return `<div style="padding:16px;color:#94A3B8;text-align:center;">${label} 데이터 없음</div>`;
            return `<table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead><tr style="background:${accentColor};color:#fff;">
                    <th style="padding:10px 12px;text-align:center;border:1px solid ${accentColor};">순위</th>
                    <th style="padding:10px 12px;text-align:left;border:1px solid ${accentColor};">이름</th>
                    <th style="padding:10px 12px;text-align:right;border:1px solid ${accentColor};">평균 HTP</th>
                    <th style="padding:10px 12px;text-align:right;border:1px solid ${accentColor};">총 작업량</th>
                </tr></thead>
                <tbody>${list.map((e, i) => `<tr style="background:${rankBg(i)};">
                    <td style="padding:8px 12px;text-align:center;border:1px solid #E2E8F0;font-weight:700;">${rankIcon(i)}</td>
                    <td style="padding:8px 12px;border:1px solid #E2E8F0;">${e.employee.split('(')[0].trim()}</td>
                    <td style="padding:8px 12px;text-align:right;border:1px solid #E2E8F0;font-weight:700;color:${e.avgHtp >= 200 ? '#059669' : '#0F172A'};">${e.avgHtp.toFixed(1)}</td>
                    <td style="padding:8px 12px;text-align:right;border:1px solid #E2E8F0;">${e.totalQty.toLocaleString()}</td>
                </tr>`).join('')}</tbody></table>`;
        };

        reportDiv.innerHTML = `
            <!-- Title -->
            <div style="background:linear-gradient(135deg,#2563EB 0%,#7C3AED 100%);padding:48px 40px 40px;color:#fff;">
                <div style="font-size:28px;font-weight:800;letter-spacing:-0.02em;">HTP Performance Report</div>
                <div style="font-size:15px;opacity:0.85;margin-top:6px;">Pick / Pack 생산성 분석 리포트</div>
                <div style="margin-top:20px;display:flex;gap:16px;font-size:13px;opacity:0.75;">
                    <span>기간: ${filteredDates[0]} ~ ${filteredDates[filteredDates.length - 1]}</span>
                    <span>|</span>
                    <span>조회: ${period}</span>
                    <span>|</span>
                    <span>생성: ${new Date().toLocaleString('ko-KR')}</span>
                </div>
            </div>

            <!-- KPI Cards -->
            <div style="padding:32px 40px 24px;">
                <div style="font-size:18px;font-weight:700;margin-bottom:16px;color:#1E293B;">Key Performance Indicators</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                    <div style="background:#fff;border-radius:12px;padding:20px;border-left:4px solid #2563EB;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:12px;color:#64748B;font-weight:600;text-transform:uppercase;">총 작업일수</div>
                        <div style="font-size:28px;font-weight:800;color:#2563EB;margin-top:4px;">${filteredDates.length}<span style="font-size:14px;color:#94A3B8;"> 일</span></div>
                    </div>
                    <div style="background:#fff;border-radius:12px;padding:20px;border-left:4px solid #10B981;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:12px;color:#64748B;font-weight:600;text-transform:uppercase;">누적 작업량</div>
                        <div style="font-size:28px;font-weight:800;color:#10B981;margin-top:4px;">${totalQty.toLocaleString()}</div>
                    </div>
                    <div style="background:#fff;border-radius:12px;padding:20px;border-left:4px solid #F59E0B;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:12px;color:#64748B;font-weight:600;text-transform:uppercase;">평균 HTP</div>
                        <div style="font-size:28px;font-weight:800;color:#F59E0B;margin-top:4px;">${avgHtp.toFixed(1)}</div>
                    </div>
                    <div style="background:#fff;border-radius:12px;padding:20px;border-left:4px solid #7C3AED;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:12px;color:#64748B;font-weight:600;text-transform:uppercase;">최고 HTP</div>
                        <div style="font-size:28px;font-weight:800;color:#7C3AED;margin-top:4px;">${maxHtpVal.toFixed(1)}</div>
                    </div>
                </div>
            </div>

            <!-- Daily Table -->
            <div style="padding:8px 40px 24px;">
                <div style="font-size:18px;font-weight:700;margin-bottom:12px;color:#1E293B;">일별 추이</div>
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                    <thead><tr style="background:#2563EB;color:#fff;">
                        <th style="padding:10px;border:1px solid #2563EB;">날짜</th>
                        <th style="padding:10px;border:1px solid #2563EB;">작업자수</th>
                        <th style="padding:10px;border:1px solid #2563EB;">총 작업량</th>
                        <th style="padding:10px;border:1px solid #2563EB;">평균 HTP</th>
                        <th style="padding:10px;border:1px solid #2563EB;">PICK HTP</th>
                        <th style="padding:10px;border:1px solid #2563EB;">PACK HTP</th>
                    </tr></thead>
                    <tbody>${dailyData.map((d, i) => `<tr style="background:${i % 2 === 0 ? '#fff' : '#F1F5F9'};">
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:center;">${d.date}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:center;">${d.workers}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:right;">${d.qty.toLocaleString()}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:right;font-weight:700;">${d.htp}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:right;color:#2563EB;">${d.pickHtp}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:right;color:#D97706;">${d.packHtp}</td>
                    </tr>`).join('')}</tbody>
                </table>
            </div>

            <!-- PICK Top 10 -->
            <div style="padding:8px 40px 24px;">
                <div style="font-size:18px;font-weight:700;margin-bottom:12px;color:#1E293B;">PICK Top 10</div>
                ${topTableHTML(pickTop, '#2563EB', 'PICK')}
            </div>

            <!-- PACK Top 10 -->
            <div style="padding:8px 40px 24px;">
                <div style="font-size:18px;font-weight:700;margin-bottom:12px;color:#1E293B;">PACK Top 10</div>
                ${topTableHTML(packTop, '#D97706', 'PACK')}
            </div>

            <!-- Badge Holders -->
            <div style="padding:8px 40px 32px;">
                <div style="font-size:18px;font-weight:700;margin-bottom:12px;color:#1E293B;">뱃지 보유 현황</div>
                ${badgeHolders.length > 0 ? `<table style="width:100%;border-collapse:collapse;font-size:12px;">
                    <thead><tr style="background:#7C3AED;color:#fff;">
                        <th style="padding:10px;border:1px solid #7C3AED;">이름</th>
                        <th style="padding:10px;border:1px solid #7C3AED;">획득 뱃지</th>
                        <th style="padding:10px;border:1px solid #7C3AED;">총 근무일</th>
                        <th style="padding:10px;border:1px solid #7C3AED;">평균 HTP</th>
                    </tr></thead>
                    <tbody>${badgeHolders.map((h, i) => `<tr style="background:${i % 2 === 0 ? '#fff' : '#F1F5F9'};">
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;">${h.name.split('(')[0].trim()}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;font-size:11px;">${h.badges}</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:center;">${h.days}일</td>
                        <td style="padding:8px 10px;border:1px solid #E2E8F0;text-align:right;font-weight:700;">${h.avgHtp}</td>
                    </tr>`).join('')}</tbody>
                </table>` : '<div style="padding:16px;color:#94A3B8;text-align:center;">뱃지 보유자 없음</div>'}
            </div>

            <!-- Footer -->
            <div style="padding:16px 40px;background:#F1F5F9;border-top:1px solid #E2E8F0;text-align:center;font-size:11px;color:#94A3B8;">
                Generated by GWJ2 Pick&Pack HTP Dashboard &middot; ${new Date().toLocaleString('ko-KR')}
            </div>
        `;

        document.body.appendChild(reportDiv);

        setTimeout(() => {
            html2canvas(reportDiv, { scale: 2, useCORS: true, logging: false, backgroundColor: '#F8FAFC' }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const pageW = 210;
                const pageH = 297;
                const margin = 0;
                const imgW = pageW - margin * 2;
                const imgH = (canvas.height * imgW) / canvas.width;

                let yOffset = 0;
                let page = 0;
                while (yOffset < imgH) {
                    if (page > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', margin, -yOffset, imgW, imgH);
                    yOffset += pageH;
                    page++;
                }

                const dateStr = new Date().toISOString().split('T')[0];
                pdf.save(`HTP_리포트_${period}_${dateStr}.pdf`);
                reportDiv.remove();
                showModal('PDF 리포트 다운로드 완료!', 1500);
            }).catch(err => {
                console.error('PDF 생성 오류:', err);
                reportDiv.remove();
                showModal('PDF 생성 중 오류가 발생했습니다.');
            });
        }, 300);
    }

    // 🚀 페이지 로드 시 즉시 초기화
    // 🚀 페이지 완전히 로드된 후 초기화 (모든 함수 정의 후)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        // 이미 로드됨
        initializePage();
    }
    
    function initializePage() {
        console.log('🎯 페이지 초기화 시작');
        
        // 초기 로딩 후 transition 활성화
        setTimeout(() => {
            document.documentElement.style.setProperty('--transition-speed', '0.3s');
            console.log('✅ Transition 활성화');
        }, 100);
        
        // 티커 즉시 표시 (데이터 없어도 안내 메시지 표시)
        if (typeof updateTicker === 'function') {
            updateTicker([]);
            console.log('✅ 티커 초기화 완료');
        } else {
            console.warn('⚠️ updateTicker 함수 아직 정의 안됨');
        }
        
        // 테마 적용
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        console.log('✅ 테마 적용 완료:', savedTheme);
        
        // 🆕 자동으로 최근 7일 히스토리 로드
        console.log('📦 최근 7일 히스토리 자동 로드 시작...');
        setTimeout(() => {
            if (typeof loadHistoryData === 'function') {
                loadHistoryData(7).then(() => {
                    console.log('✅ 초기 히스토리 로드 완료');
                }).catch(err => {
                    console.log('⚠️ 초기 히스토리 로드 실패:', err.message);
                });
            }
        }, 500); // 0.5초 후 실행 (Firebase 초기화 대기)
    }
</script>
</body>
</html>

