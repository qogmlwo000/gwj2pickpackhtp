<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 PICK & PACK HTP TOOL_Bennett (v3.0)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="PICK & PACK HTP TOOL_Bennett">
    <meta property="og:description" content="ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ HTP ë°ì´í„°ë¥¼ ê³µìœ í•˜ê³  ë¶„ì„í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://github.com/qogmlwo000/gwj2pickpackhtp/blob/main/Bennett.png?raw=true">
    <meta property="og:url" content="https://qogmlwo000.github.io/gwj2pickpackhtp/">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --transition-speed: 0s;
        }
        
        /* Light Mode Colors */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* í•„ìš”í•œ ìš”ì†Œë§Œ transition ì ìš© */
        body,
        #sidebar,
        #main-content,
        .card,
        button,
        input,
        .filter-btn,
        .view-tab,
        .kpi-card,
        label {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }

        /* Forms - ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.1rem;
            height: 1.1rem;
            border: 2px solid #94a3b8;
            border-radius: 4px;
            background-color: #f1f5f9;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .form-checkbox {
            background-color: #0f172a;
            border: 2px solid #60a5fa;
        }
        
        .form-checkbox:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        .form-checkbox:checked {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: var(--accent-primary);
        }
        
        .form-checkbox:checked::after {
            content: 'âœ”';
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            scrollbar-width: thin;
        }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 5px; border: 2px solid var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; background-color: var(--bg-primary); }
        
        #sidebar {
            width: 300px;
            transition: margin-left var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            position: fixed; top: 0; left: 0; height: 100%; z-index: 40;
            transform: translateX(-100%);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        #sidebar.open { transform: translateX(0); }
        #main-content { transition: margin-left var(--transition-speed) ease-in-out; width: 100%; background-color: var(--bg-primary); }

        @media (min-width: 1024px) {
            #sidebar { position: static; transform: translateX(0); }
            #main-content { flex: 1; min-width: 0; }
            .app-container.sidebar-collapsed #sidebar { margin-left: -300px; }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative; width: 60px; height: 30px;
            background: var(--bg-tertiary); border-radius: 30px;
            cursor: pointer; display: flex; align-items: center; padding: 3px;
            border: 2px solid var(--border-color);
        }
        .theme-toggle-slider {
            width: 22px; height: 22px;
            background: var(--accent-primary); border-radius: 50%;
            transition: transform var(--transition-speed) ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-md);
        }
        [data-theme="dark"] .theme-toggle-slider { transform: translateX(30px); }

        /* Status & Loader */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px currentColor; }
        .status-connected { background-color: var(--success); animation: pulse-success 2s infinite; }
        .status-disconnected { background-color: var(--error); }
        .status-loading { background-color: var(--warning); animation: pulse-warning 1.5s infinite; }
        @keyframes pulse-success { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons & Filters */
        .filter-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: var(--bg-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .filter-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; }

        button { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }
        .bg-blue-600 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border-color: #3b82f6 !important; }
        .bg-blue-600:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important; }

        /* Cards & Views */
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .view-tab { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 2px solid var(--border-color); transition: all 0.2s ease; font-weight: 600; }
        .view-tab:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .view-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* Title & Ticker */
        #ticker-container { overflow: hidden; white-space: nowrap; position: relative; background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--bg-secondary) 100%); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        #ticker-text { position: absolute; animation: ticker-scroll 20s linear infinite; font-weight: 700; background: linear-gradient(90deg, #f59e0b, #eab308, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        @keyframes ticker-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Table */
        .table-container { flex-grow: 1; overflow: auto; -webkit-overflow-scrolling: touch; background-color: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        #data-table { background-color: var(--bg-secondary); }
        #data-table thead { background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-hover) 100%); backdrop-filter: blur(10px); }
        #data-table th { color: var(--text-primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--border-color); white-space: nowrap; padding: 16px; }
        #data-table td { border-right: 1px solid var(--border-color); white-space: nowrap; padding: 12px 16px; color: var(--text-secondary); }
        #data-table th:last-child, #data-table td:last-child { border-right: none; }
        #data-table tbody tr { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        #data-table tbody tr:hover { background-color: var(--bg-hover); box-shadow: var(--shadow-sm); }
        .sortable { cursor: pointer; position: relative; user-select: none; }
        .sort-indicator { display: inline-block; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
        .sortable:hover .sort-indicator { opacity: 0.8; }
        .sort-indicator.asc, .sort-indicator.desc { opacity: 1; color: var(--accent-primary); font-weight: bold; }
        .hidden-col { display: none; }
		
		/* ğŸ†• Enhanced Hidden Employee Styles */
        #data-table tbody tr.hidden-employee { 
            opacity: 0.2; 
            background: repeating-linear-gradient(
                45deg,
                var(--bg-secondary),
                var(--bg-secondary) 10px,
                var(--bg-tertiary) 10px,
                var(--bg-tertiary) 20px
            );
            filter: grayscale(0.8);
        }
        #data-table tbody tr.hidden-employee:hover {
            opacity: 0.4;
        }

        /* Forms */
        input[type="text"], input[type="number"], input[type="date"] { background-color: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary); transition: all 0.2s ease; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: var(--bg-secondary); }
        input[type="text"]::placeholder { color: var(--text-tertiary); }

        /* Dashboard */
        .kpi-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-left: 4px solid var(--accent-primary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .kpi-card h4 { color: var(--text-tertiary); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card p { color: var(--text-primary); font-size: 2rem; font-weight: 800; margin-top: 0.5rem; }

        /* Modals */
        #chart-modal-backdrop, #history-modal-backdrop, #employee-detail-modal-backdrop, #ranking-modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        #chart-modal-content, #history-modal-content, #employee-detail-modal-content, #ranking-modal-content { max-height: 85vh; background-color: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); overflow-y: auto; }
        #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		
		/* Text Colors */
        .text-gray-200, .text-white { color: var(--text-primary) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .text-gray-400, .text-gray-500 { color: var(--text-tertiary) !important; }
        .text-blue-400 { color: #60a5fa !important; }
        .text-yellow-400 { color: #fbbf24 !important; }
        .text-red-400 { color: #f87171 !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-yellow-300 { color: #fcd34d !important; }
        .text-lime-400 { color: #a3e635 !important; }
        
        [data-theme="light"] .text-lime-400 {
            color: #16a34a !important;
            font-weight: 600;
        }
        
        [data-theme="light"] .text-yellow-300 {
            color: #d97706 !important;
        }

        /* Utility */
        .bg-gray-800, .bg-gray-700 { background-color: var(--bg-secondary) !important; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        label { color: var(--text-secondary); transition: color 0.2s ease; }
        label:hover { color: var(--text-primary); }
        .rounded-lg { border-radius: 12px !important; }
        .rounded-md { border-radius: 8px !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { animation: fadeIn 0.3s ease-out; }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
            animation: badge-pulse 2s infinite;
        }
        .badge-gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .badge-silver { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); color: #374151; }
        .badge-bronze { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: #7c2d12; }
        .badge-streak { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .badge-record { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        @keyframes badge-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
		
		/* ğŸ†• Warning/Danger Badge Styles */
        .badge-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: #78350f; 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .badge-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .badge-info { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
        }
		
		/* ğŸ†• Row Action Menu (Hover) */
        .row-action-menu {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            border: 2px solid var(--border-color);
        }
        tr:hover .row-action-menu {
            opacity: 1;
        }
        .action-menu-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 12px;
            font-size: 1.3rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-menu-btn:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }

        /* History View Styles */
        .period-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .period-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.875rem; cursor: pointer; }
        .period-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; }
        
        .history-chart-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 20px; }
        
        .date-range-picker { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .date-range-picker input { padding: 8px 12px; border-radius: 8px; font-size: 0.875rem; }

        /* ğŸ†• Calendar View Styles */
        .calendar-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); cursor: pointer; }
        .calendar-nav-btn:hover { background-color: var(--bg-hover); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-header { text-align: center; font-weight: 700; color: var(--text-secondary); padding: 12px; font-size: 0.875rem; }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
            position: relative;
        }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .calendar-day.inactive { opacity: 0.3; cursor: default; }
        .calendar-day.inactive:hover { transform: none; box-shadow: none; }
        .calendar-day.today { border-color: var(--accent-primary); border-width: 3px; }
        .calendar-day-number { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .calendar-day-htp { font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
        .calendar-day.excellent { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); }
        .calendar-day.good { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%); }
        .calendar-day.average { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%); }
        .calendar-day.poor { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); }
        .calendar-day.no-data { background-color: var(--bg-tertiary); }
        .calendar-legend { display: flex; gap: 16px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .calendar-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; }
        .calendar-legend-color { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--border-color); }

        /* ğŸ†• Ranking/Leaderboard Styles */
        .ranking-card { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 16px; }
        .ranking-podium { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; align-items: end; }
        .podium-item { text-align: center; padding: 20px; border-radius: 12px; transition: all 0.3s ease; cursor: pointer; }
        .podium-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .podium-first { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); order: 2; padding-top: 40px; }
        .podium-second { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); order: 1; }
        .podium-third { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); order: 3; }
        .podium-rank { font-size: 3rem; margin-bottom: 8px; }
        .podium-name { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 4px; }
        .podium-score { font-weight: 600; font-size: 1.5rem; color: var(--text-primary); }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: var(--bg-tertiary); border-radius: 8px; border: 2px solid var(--border-color); transition: all 0.2s ease; cursor: pointer; }
        .ranking-item:hover { background-color: var(--bg-hover); transform: translateX(4px); }
        .ranking-item.highlight-user { border-color: var(--accent-primary); background-color: rgba(59, 130, 246, 0.1); }
        .ranking-position { font-weight: 700; font-size: 1.2rem; color: var(--text-secondary); min-width: 40px; }
        .ranking-employee { font-weight: 600; flex-grow: 1; color: var(--text-primary); }
        .ranking-htp { font-weight: 700; font-size: 1.1rem; color: var(--success); }
        .ranking-change { font-size: 0.875rem; font-weight: 600; margin-left: 8px; }
        .ranking-change.up { color: var(--success); }
        .ranking-change.down { color: var(--error); }
        .ranking-change.same { color: var(--text-tertiary); }
        .ranking-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .ranking-tab { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; text-align: center; cursor: pointer; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s ease; }
        .ranking-tab:hover { background-color: var(--bg-hover); }
        .ranking-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); }

        /* ğŸ†• Employee Detail Modal Styles */
        .employee-detail-header { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0; margin: -24px -24px 24px -24px; }
        .employee-detail-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .employee-stat-card { background-color: var(--bg-tertiary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); }
        .employee-stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; font-weight: 600; }
        .employee-stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); margin-top: 4px; }
        .employee-chart-container { background-color: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .trend-indicator { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; }
        .trend-indicator.positive { background-color: rgba(16, 185, 129, 0.2); color: var(--success); }
        .trend-indicator.negative { background-color: rgba(239, 68, 68, 0.2); color: var(--error); }
        .trend-indicator.neutral { background-color: var(--bg-tertiary); color: var(--text-tertiary); }

        /* ğŸ†• Hidden Employee Styles */
        .hidden-employee-indicator { 
            position: absolute; 
            right: 8px; 
            top: 50%; 
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            color: var(--error);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
            animation: pulse-hidden 2s infinite;
        }
        
        @keyframes pulse-hidden {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .hide-employee-btn {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hide-employee-btn:hover {
            background-color: var(--error);
            color: white;
        }
        .show-employee-btn {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .show-employee-btn:hover {
            background-color: var(--success);
            color: white;
        }
        .hidden-employees-panel {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-top: 12px;
        }
        .hidden-employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 8px;
        }
		
		/* ğŸ†• Enhanced Header Styles */
        .header-gradient {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.2) 0%, 
				rgba(139, 92, 246, 0.2) 50%, 
				rgba(236, 72, 153, 0.2) 100%
            );
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899) 1;
            position: relative;
            overflow: hidden;
        }
        
        .header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent
            );
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .header-toggle-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .header-toggle-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: rotate(90deg);
            color: white;
        }
        
        .logo-icon {
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header-title {
            font-size: 1.75rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            line-height: 1.2;
            margin: 0;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 5s ease infinite;
            background-size: 200% 200%;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 4px 16px rgba(16, 185, 129, 0.6); }
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-pulse {
            color: #10b981;
            animation: pulse-dot 1.5s ease-in-out infinite;
            font-size: 1.2rem;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .status-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        
        .status-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 700;
        }
		
		/* ğŸ†• Employee Analysis Card Styles */
        .employee-analysis-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .employee-analysis-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .employee-name-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .employee-stat-item {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .employee-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }
        .employee-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .best-performance-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .best-performance-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .best-performance-detail {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .performance-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .performance-badge.pick {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        .performance-badge.pack {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

<div id="app-container" class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gray-800 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto">
        <div class="flex items-center justify-between border-b pb-3" style="border-color: var(--border-color);">
            <h2 class="text-xl font-bold text-white">âš™ï¸ í•„í„° ë° ì„¤ì •</h2>
            <!-- Theme Toggle -->
            <div class="theme-toggle" id="theme-toggle">
                <div class="theme-toggle-slider">
                    <span id="theme-icon">ğŸŒ™</span>
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• Hidden Employees Management -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-semibold text-white">ğŸ‘» ìˆ¨ê¸´ ì‘ì—…ì</h3>
                <span id="hidden-count-badge" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">0</span>
            </div>
            <button id="manage-hidden-btn" class="w-full py-2 px-3 text-sm font-semibold rounded-md bg-gray-600 hover:bg-gray-500">
                ê´€ë¦¬í•˜ê¸°
            </button>
            <div id="hidden-employees-list" class="hidden-employees-panel hidden mt-3">
                <p class="text-sm text-gray-400 mb-2">ìˆ¨ê¸´ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- Time Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">â° ì‹œê°„ëŒ€ë³„ í•„í„°</h3>
            <div class="space-y-2">
                <label class="flex items-center space-x-2 text-sm cursor-pointer"><input type="checkbox" id="all-hours-checkbox" class="form-checkbox" checked><span>ì „ì²´ ì‹œê°„</span></label>
                <div id="hour-filters" class="filter-group-grid pt-2 border-t" style="border-color: var(--border-color);"></div>
                <div class="flex space-x-2 pt-2 border-t" style="border-color: var(--border-color);">
                    <button id="select-all-hours" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ ì„ íƒ</button>
                    <button id="deselect-all-hours" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ í•´ì œ</button>
                </div>
            </div>
        </div>

        <!-- Floor Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ“¶ ì¸µë³„ í•„í„° (ì§‘í’ˆ)</h3>
            <div id="floor-filters" class="space-y-2"></div>
            <div class="flex space-x-2 pt-2 mt-2 border-t" style="border-color: var(--border-color);">
                <button id="select-all-floors" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ ì„ íƒ</button>
                <button id="deselect-all-floors" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ í•´ì œ</button>
            </div>
        </div>

        <!-- Pack Type Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ“¦ íŒ© ì¢…ë¥˜ í•„í„° (í¬ì¥)</h3>
            <div id="pack-type-filters" class="space-y-2"></div>
             <div class="flex space-x-2 pt-2 mt-2 border-t" style="border-color: var(--border-color);">
                <button id="select-all-packtypes" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ ì„ íƒ</button>
                <button id="deselect-all-packtypes" class="text-xs py-1 px-2 rounded w-full">ëª¨ë‘ í•´ì œ</button>
            </div>
        </div>
        
        <!-- Target HTP Settings -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ¯ Target HTP ì„¤ì •</h3>
            <div id="target-htp-settings" class="space-y-2 text-sm"></div>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
	
	<!-- Main Content -->
<main id="main-content" class="flex-1 flex flex-col">
    <div class="header-gradient shadow-lg p-6 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-desktop" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="header-content">
                        <div class="flex items-center gap-3">
                            <div class="logo-icon">ğŸš€</div>
                            <div>
                                <h1 class="header-title">
                                    <span class="gradient-text">GWJ2 OB PICK & PACK</span>
                                    <span class="version-badge">v3.5</span>
                                </h1>
                                <p class="header-subtitle">
                                    <span class="status-pulse">â—</span>
                                    í•œ ëª…ì´ ì—‘ì…€ì„ ì˜¬ë¦¬ë©´ ëª¨ë‘ì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="status-indicator" class="status-card">
                    <div class="status-dot status-disconnected"></div>
                    <div>
                        <div class="status-label">ì—°ê²° ìƒíƒœ</div>
                        <div class="status-value">í™•ì¸ ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4 flex flex-col flex-shrink-0">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <button id="filter-all" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md active">ì „ì²´</button>
                    <button id="filter-pick" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">ğŸŸ¦ PICK</button>
                    <button id="filter-pack" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">ğŸŸ¨ PACK</button>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center">
                    <input type="text" id="search-input" placeholder="ğŸ” ì´ë¦„(ì›ë°”ì½”ë“œ) ê²€ìƒ‰..." class="w-full rounded-md py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="low-htp-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                        <span class="ml-3 text-sm font-medium">ğŸš¨ ì €ì¡°ìë§Œ ë³´ê¸°</span>
                    </label>
                    <button id="capture-btn" class="py-2 px-3 text-sm font-semibold rounded-md">ğŸ“·</button>
                    <button id="export-btn" class="py-2 px-3 text-sm font-semibold rounded-md">ğŸ“Š</button>
                </div>
            </div>
            
            <!-- Ticker -->
            <div id="ticker-container" class="p-2 rounded-lg text-sm">
                <div id="ticker-text-wrapper" class="relative w-full h-5 overflow-hidden">
                    <span id="ticker-text">Top/Low HTP ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                </div>
            </div>

            <!-- Stats & Upload -->
            <div class="bg-gray-800 p-3 rounded-lg flex flex-col md:flex-row justify-between items-center text-sm">
                 <div id="stats-display" class="text-gray-300 mb-2 md:mb-0 text-center md:text-left">
                    í‘œì‹œ ê·¸ë£¹: <span class="font-bold text-white">-</span> | 
                    ì‘ì—…ì ìˆ˜: <span class="font-bold text-white">-</span> | 
                    ì´ ì‘ì—…ëŸ‰: <span class="font-bold text-white">-</span> | 
                    í‰ê·  HTP: <span class="font-bold text-white">-</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-updated" class="font-semibold text-gray-200">ë°ì´í„° ì—†ìŒ</span></p>
                        <p>ì—…ë¡œë”: <span id="last-uploader" class="font-semibold text-gray-200">ë°ì´í„° ì—†ìŒ</span></p>
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                    <label for="file-upload" class="cursor-pointer py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">ì—‘ì…€ ì—…ë¡œë“œ</label>
                </div>
            </div>
        </div>

        <!-- View Switcher (5ê°œ ë©”ë‰´) -->
        <div class="px-4 pt-2">
            <div class="bg-gray-800 p-1 rounded-lg flex space-x-1 overflow-x-auto">
                <button id="table-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md active whitespace-nowrap">ğŸ“‹ ë°ì´í„°</button>
                <button id="dashboard-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button id="history-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">ğŸ“ˆ íˆìŠ¤í† ë¦¬</button>
                <button id="calendar-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">ğŸ“… ìº˜ë¦°ë”</button>
                <button id="ranking-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">ğŸ† ë­í‚¹</button>
            </div>
        </div>
        
        <!-- Table View -->
        <div id="table-view" class="flex flex-col flex-grow min-h-0">
            <div id="loader-container" class="flex-1 flex justify-center items-center hidden"><div class="loader"></div></div>
            <div class="table-container px-4 pb-4">
                <table id="data-table" class="min-w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processType">ì§‘í’ˆ/í¬ì¥<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="employee">ì´ë¦„(ì›ë°”ì½”ë“œ)<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="unitQty">ì‘ì—…ëŸ‰<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="location">ë¡œì¼€ì´ì…˜ ë° ì‘ì—…ëŒ€<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processPathName">PP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="packType">íŒ© ì¢…ë¥˜<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="mh">M/H<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="htp">HTP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 text-center">ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-gray-800">
                        <tr id="placeholder-row"><td colspan="9" class="text-center py-10 text-gray-500">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì´ ì‘ì—…ì ìˆ˜</h4>
                    <p id="kpi-total-workers" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì´ ì‘ì—…ëŸ‰ (Unit)</h4>
                    <p id="kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì „ì²´ í‰ê·  HTP</h4>
                    <p id="kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-red-500">
                    <h4 class="text-gray-400 text-sm font-medium">ì €ì¡°ì ìˆ˜</h4>
                    <p id="kpi-low-performers" class="text-3xl font-bold text-red-400">0</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-1">
                    <h3 class="text-lg font-semibold mb-2 text-white">í”„ë¡œì„¸ìŠ¤ë³„ ë¹„êµ</h3>
                    <div class="relative h-64 md:h-80"><canvas id="process-comparison-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-white">ì‹œê°„ëŒ€ë³„ HTP íŠ¸ë Œë“œ</h3>
                    <div class="relative h-64 md:h-80"><canvas id="hourly-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">ì¸µë³„ í‰ê·  HTP (ì§‘í’ˆ)</h3>
                    <div class="relative h-96"><canvas id="floor-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">íŒ© ì¢…ë¥˜ë³„ ì‘ì—…ëŸ‰ (í¬ì¥)</h3>
                    <div class="relative h-96"><canvas id="pack-type-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg lg:col-span-2 xl:col-span-1">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-full">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">ğŸ† Top 5 PICK</h3>
                            <ul id="top-pick-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">ğŸ† Top 5 PACK</h3>
                            <ul id="top-pack-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- Period Selector -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">ğŸ“… ê¸°ê°„ ì„ íƒ</h3>
                <div class="period-selector">
                    <button id="period-week" class="period-btn filter-btn active">ìµœê·¼ 7ì¼</button>
                    <button id="period-month" class="period-btn filter-btn">ìµœê·¼ 30ì¼</button>
                    <button id="period-all" class="period-btn filter-btn">ì „ì²´ ê¸°ê°„</button>
                    <button id="period-custom" class="period-btn filter-btn">ì‚¬ìš©ì ì§€ì •</button>
                </div>
                <div id="custom-date-range" class="date-range-picker hidden mt-3">
                    <input type="date" id="start-date" class="rounded-md py-2 px-3">
                    <span class="text-gray-400">~</span>
                    <input type="date" id="end-date" class="rounded-md py-2 px-3">
                    <button id="apply-custom-range" class="py-2 px-4 bg-blue-600 text-white rounded-md">ì ìš©</button>
                </div>
            </div>

            <!-- History KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì´ ì‘ì—… ì¼ìˆ˜</h4>
                    <p id="history-kpi-days" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ëˆ„ì  ì‘ì—…ëŸ‰</h4>
                    <p id="history-kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">í‰ê·  HTP</h4>
                    <p id="history-kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-purple-500">
                    <h4 class="text-gray-400 text-sm font-medium">ìµœê³  HTP</h4>
                    <p id="history-kpi-max-htp" class="text-3xl font-bold text-purple-400">0.0</p>
                </div>
            </div>

            <!-- ğŸ†• Employee Search & Analysis Section -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">ğŸ‘¤ ì‚¬ì›ë³„ ìƒì„¸ ë¶„ì„</h3>
                    <div class="flex items-center gap-2">
                        <input 
                            type="text" 
                            id="history-employee-search" 
                            placeholder="ğŸ” ì´ë¦„ ë˜ëŠ” ì›ë°”ì½”ë“œ ê²€ìƒ‰..." 
                            class="py-2 px-4 rounded-md text-sm w-80"
                            style="background: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary);"
                        >
                        <button id="history-show-all-btn" class="py-2 px-4 bg-blue-600 text-white rounded-md text-sm font-semibold hover:bg-blue-700">
                            ì „ì²´ ë³´ê¸°
                        </button>
                    </div>
                </div>

                <!-- Employee Analysis Results -->
                <div id="history-employee-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center py-10 text-gray-400">
                        ì‚¬ì›ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ "ì „ì²´ ë³´ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”
                    </div>
                </div>

                <!-- Pagination for All Employees -->
                <div id="history-pagination" class="hidden mt-4 flex justify-center items-center gap-2">
                    <button id="history-prev-page" class="py-2 px-4 bg-gray-700 text-white rounded-md hover:bg-gray-600 disabled:opacity-50">
                        â—€ ì´ì „
                    </button>
                    <span id="history-page-info" class="text-gray-300 mx-4">1 / 1</span>
                    <button id="history-next-page" class="py-2 px-4 bg-gray-700 text-white rounded-md hover:bg-gray-600 disabled:opacity-50">
                        ë‹¤ìŒ â–¶
                    </button>
                </div>
            </div>

            <!-- Top Performers History -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">ğŸ† ê¸°ê°„ë³„ Top 10 ì‘ì—…ì</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-blue-400">PICK (ì§‘í’ˆ)</h4>
                        <div id="history-top-pick-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-yellow-400">PACK (í¬ì¥)</h4>
                        <div id="history-top-pack-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Export History Button -->
            <div class="flex justify-end gap-3">
                <button id="export-history-excel" class="py-3 px-6 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
                    ğŸ“Š íˆìŠ¤í† ë¦¬ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
                <button id="export-history-pdf" class="py-3 px-6 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">
                    ğŸ“„ PDF ë¦¬í¬íŠ¸ ìƒì„±
                </button>
            </div>
        </div>

        <!-- ğŸ†• Calendar View -->
        <div id="calendar-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="calendar-prev-month" class="calendar-nav-btn">â—€ ì´ì „</button>
                    <h2 id="calendar-month-title" class="text-2xl font-bold text-white">2025ë…„ 1ì›”</h2>
                    <button id="calendar-next-month" class="calendar-nav-btn">ë‹¤ìŒ â–¶</button>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- ìš”ì¼ í—¤ë” -->
                    <div class="calendar-day-header">ì¼</div>
                    <div class="calendar-day-header">ì›”</div>
                    <div class="calendar-day-header">í™”</div>
                    <div class="calendar-day-header">ìˆ˜</div>
                    <div class="calendar-day-header">ëª©</div>
                    <div class="calendar-day-header">ê¸ˆ</div>
                    <div class="calendar-day-header">í† </div>
                    <!-- ë‚ ì§œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </div>

                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color excellent"></div>
                        <span>ìš°ìˆ˜ (ëª©í‘œ 120% ì´ìƒ)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color good"></div>
                        <span>ì–‘í˜¸ (ëª©í‘œ 100-120%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color average"></div>
                        <span>ë³´í†µ (ëª©í‘œ 80-100%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color poor"></div>
                        <span>ì €ì¡° (ëª©í‘œ 80% ë¯¸ë§Œ)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color no-data"></div>
                        <span>ë°ì´í„° ì—†ìŒ</span>
                    </div>
                </div>
            </div>
        </div>
		
		<!-- ğŸ†• Ranking View -->
        <div id="ranking-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- Ranking Period Selector -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="ranking-tabs">
                    <button id="ranking-daily" class="ranking-tab active">ğŸ“… ì¼ê°„</button>
                    <button id="ranking-weekly" class="ranking-tab">ğŸ“Š ì£¼ê°„</button>
                    <button id="ranking-monthly" class="ranking-tab">ğŸ“ˆ ì›”ê°„</button>
                    <button id="ranking-all-time" class="ranking-tab">ğŸ† ì „ì²´</button>
                </div>
            </div>

            <!-- Process Type Selector for Ranking -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="ranking-tabs">
                    <button id="ranking-pick-type" class="ranking-tab active">ğŸŸ¦ PICK ë­í‚¹</button>
                    <button id="ranking-pack-type" class="ranking-tab">ğŸŸ¨ PACK ë­í‚¹</button>
                </div>
            </div>

            <!-- Top 3 Podium -->
            <div class="ranking-card">
                <h3 class="text-2xl font-bold text-white mb-4 text-center">ğŸ† TOP 3</h3>
                <div class="ranking-podium" id="ranking-podium">
                    <!-- Podium items will be dynamically added -->
                    <div class="podium-item podium-second">
                        <div class="podium-rank">ğŸ¥ˆ</div>
                        <div class="podium-name" id="podium-2-name">-</div>
                        <div class="podium-score" id="podium-2-score">0</div>
                    </div>
                    <div class="podium-item podium-first">
                        <div class="podium-rank">ğŸ¥‡</div>
                        <div class="podium-name" id="podium-1-name">-</div>
                        <div class="podium-score" id="podium-1-score">0</div>
                    </div>
                    <div class="podium-item podium-third">
                        <div class="podium-rank">ğŸ¥‰</div>
                        <div class="podium-name" id="podium-3-name">-</div>
                        <div class="podium-score" id="podium-3-score">0</div>
                    </div>
                </div>
            </div>

            <!-- Full Ranking List -->
            <div class="ranking-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">ğŸ“‹ ì „ì²´ ìˆœìœ„</h3>
                    <div class="text-sm text-gray-400">
                        <span>ì´ <span id="ranking-total-count" class="font-bold text-white">0</span>ëª…</span>
                    </div>
                </div>
                <div class="ranking-list" id="ranking-list">
                    <!-- Ranking items will be dynamically added -->
                    <div class="text-center py-10 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- Ranking Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">í‰ê·  HTP</h4>
                    <p id="ranking-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-green-500">
                    <h4 class="text-gray-400 text-sm font-medium">ìµœê³  HTP</h4>
                    <p id="ranking-max-htp" class="text-3xl font-bold text-green-400">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-yellow-500">
                    <h4 class="text-gray-400 text-sm font-medium">ì¤‘ê°„ê°’ HTP</h4>
                    <p id="ranking-median-htp" class="text-3xl font-bold text-yellow-400">0.0</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chart Modal (Individual Trend) -->
<div id="chart-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="chart-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative flex flex-col overflow-y-auto">
        <h3 id="chart-modal-title" class="text-xl font-bold text-white mb-4">ê°œì¸ HTP ì¶”ì´</h3>
        <div class="flex-grow min-h-0"><canvas id="individual-htp-chart"></canvas></div>
        <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>

<!-- ğŸ†• Employee Detail Modal (ê°œì¸ë³„ íˆìŠ¤í† ë¦¬ ìƒì„¸ ë¶„ì„) -->
<div id="employee-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="employee-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl p-6 relative">
        <!-- Header -->
        <div class="employee-detail-header">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="employee-detail-name" class="text-3xl font-bold mb-2">ì‘ì—…ì ì´ë¦„</h2>
                    <p id="employee-detail-subtitle" class="text-lg opacity-90">PICK (ì§‘í’ˆ)</p>
                </div>
                <button id="employee-detail-close" class="text-white hover:text-gray-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="employee-detail-stats">
            <div class="employee-stat-card">
                <div class="employee-stat-label">ì´ ê·¼ë¬´ì¼ìˆ˜</div>
                <div class="employee-stat-value" id="employee-detail-total-days">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">í‰ê·  HTP</div>
                <div class="employee-stat-value" id="employee-detail-avg-htp">0.0</div>
                <div id="employee-detail-avg-trend" class="trend-indicator positive mt-2">
                    <span>â†‘</span>
                    <span>+0%</span>
                </div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ìµœê³  HTP</div>
                <div class="employee-stat-value text-green-400" id="employee-detail-max-htp">0.0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ì´ ì‘ì—…ëŸ‰</div>
                <div class="employee-stat-value" id="employee-detail-total-qty">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ëª©í‘œ ë‹¬ì„±ë¥ </div>
                <div class="employee-stat-value" id="employee-detail-target-rate">0%</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">í˜„ì¬ ìˆœìœ„</div>
                <div class="employee-stat-value" id="employee-detail-rank">-</div>
            </div>
        </div>

        <!-- ë±ƒì§€ ì„¹ì…˜ -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">ğŸ… íšë“ ë±ƒì§€</h4>
            <div id="employee-detail-badges" class="flex flex-wrap gap-2">
                <span class="text-gray-400">íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤</span>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">ğŸ“ˆ ì¼ë³„ HTP ì¶”ì´</h4>
                <div class="relative h-64"><canvas id="employee-detail-daily-chart"></canvas></div>
            </div>
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">ğŸ“Š ì¼ë³„ ì‘ì—…ëŸ‰</h4>
                <div class="relative h-64"><canvas id="employee-detail-qty-chart"></canvas></div>
            </div>
        </div>

        <!-- ì£¼ê°„/ì›”ê°„ ë¹„êµ -->
        <div class="employee-chart-container mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">ğŸ“… ì£¼ê°„ í‰ê·  ë¹„êµ</h4>
            <div class="relative h-64"><canvas id="employee-detail-weekly-chart"></canvas></div>
        </div>

        <!-- ìµœê·¼ ê¸°ë¡ í…Œì´ë¸” -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">ğŸ“‹ ìµœê·¼ 10ì¼ ê¸°ë¡</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-600">
                        <tr>
                            <th class="px-4 py-2 text-left text-white">ë‚ ì§œ</th>
                            <th class="px-4 py-2 text-left text-white">ì‘ì—…ëŸ‰</th>
                            <th class="px-4 py-2 text-left text-white">M/H</th>
                            <th class="px-4 py-2 text-left text-white">HTP</th>
                            <th class="px-4 py-2 text-left text-white">ìˆœìœ„</th>
                        </tr>
                    </thead>
                    <tbody id="employee-detail-recent-table" class="bg-gray-800">
                        <!-- Data will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ†• Calendar Day Detail Modal -->
<div id="calendar-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="calendar-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl p-6 relative max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="calendar-detail-title" class="text-2xl font-bold text-white">2025-01-17 ìƒì„¸ ì •ë³´</h3>
            <button id="calendar-detail-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Day Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">í‰ê·  HTP</div>
                <div id="calendar-detail-avg-htp" class="text-2xl font-bold text-white">0.0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">ì´ ì‘ì—…ëŸ‰</div>
                <div id="calendar-detail-total-qty" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">ì‘ì—…ì ìˆ˜</div>
                <div id="calendar-detail-worker-count" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">ëª©í‘œ ë‹¬ì„±ë¥ </div>
                <div id="calendar-detail-target-rate" class="text-2xl font-bold text-white">0%</div>
            </div>
        </div>

        <!-- Top Performers of the Day -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">ğŸ† ë‹¹ì¼ Top 5</h4>
            <div id="calendar-detail-top-list" class="space-y-2">
                <!-- List will be populated dynamically -->
            </div>
        </div>

        <!-- Process Distribution Chart -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">ğŸ“Š í”„ë¡œì„¸ìŠ¤ë³„ ë¶„í¬</h4>
            <div class="relative h-64"><canvas id="calendar-detail-chart"></canvas></div>
        </div>
    </div>
</div>

<!-- ğŸ†• Hidden Employees Management Modal -->
<div id="hidden-employees-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-white">ğŸ‘» ìˆ¨ê¸´ ì‘ì—…ì ê´€ë¦¬</h3>
            <button id="hidden-employees-modal-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="mb-4">
            <p class="text-gray-400 text-sm">ìˆ¨ê¸´ ì‘ì—…ìëŠ” ë°ì´í„° ë³´ê¸° íƒ­ì—ì„œ ë°˜íˆ¬ëª…í•˜ê²Œ í‘œì‹œë˜ë©°, í†µê³„ì—ì„œ ì œì™¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>

        <div id="hidden-employees-modal-list" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Hidden employees list will be populated -->
            <div class="text-center py-10 text-gray-500">ìˆ¨ê¸´ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>
</div>

</body>
</html>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, Bytes, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Theme Management ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }

        // Initialize theme immediately
        initTheme();

        // --- UI Elements ---
        const ui = {
            appContainer: document.getElementById('app-container'),
            fileUpload: document.getElementById('file-upload'),
            tableBody: document.getElementById('data-table-body'),
            tableHeader: document.querySelector('#data-table thead'),
            placeholderRow: document.getElementById('placeholder-row'),
            loaderContainer: document.getElementById('loader-container'),
            statusIndicator: document.getElementById('status-indicator'),
            lastUpdatedEl: document.getElementById('last-updated'),
            lastUploaderEl: document.getElementById('last-uploader'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
            sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            floorFilters: document.getElementById('floor-filters'),
            packTypeFilters: document.getElementById('pack-type-filters'),
            hourFilters: document.getElementById('hour-filters'),
            searchInput: document.getElementById('search-input'),
            lowHtpToggle: document.getElementById('low-htp-toggle'),
            statsDisplay: document.getElementById('stats-display'),
            captureBtn: document.getElementById('capture-btn'),
            exportBtn: document.getElementById('export-btn'),
            targetHtpSettings: document.getElementById('target-htp-settings'),
            tickerText: document.getElementById('ticker-text'),
            tableViewBtn: document.getElementById('table-view-btn'),
            dashboardViewBtn: document.getElementById('dashboard-view-btn'),
            historyViewBtn: document.getElementById('history-view-btn'),
            calendarViewBtn: document.getElementById('calendar-view-btn'),
            rankingViewBtn: document.getElementById('ranking-view-btn'),
            tableView: document.getElementById('table-view'),
            dashboardView: document.getElementById('dashboard-view'),
            historyView: document.getElementById('history-view'),
            calendarView: document.getElementById('calendar-view'),
            rankingView: document.getElementById('ranking-view'),
            chartModalBackdrop: document.getElementById('chart-modal-backdrop'),
            chartModalTitle: document.getElementById('chart-modal-title'),
            chartModalClose: document.getElementById('chart-modal-close'),
            kpi: {
                totalWorkers: document.getElementById('kpi-total-workers'),
                totalQty: document.getElementById('kpi-total-qty'),
                avgHtp: document.getElementById('kpi-avg-htp'),
                lowPerformers: document.getElementById('kpi-low-performers'),
            },
            topPickPerformersList: document.getElementById('top-pick-performers-list'),
            topPackPerformersList: document.getElementById('top-pack-performers-list'),
            // History View Elements
            periodWeekBtn: document.getElementById('period-week'),
            periodMonthBtn: document.getElementById('period-month'),
            periodAllBtn: document.getElementById('period-all'),
            periodCustomBtn: document.getElementById('period-custom'),
            customDateRange: document.getElementById('custom-date-range'),
            startDate: document.getElementById('start-date'),
            endDate: document.getElementById('end-date'),
            applyCustomRange: document.getElementById('apply-custom-range'),
            historyKpi: {
                days: document.getElementById('history-kpi-days'),
                totalQty: document.getElementById('history-kpi-total-qty'),
                avgHtp: document.getElementById('history-kpi-avg-htp'),
                maxHtp: document.getElementById('history-kpi-max-htp'),
            },
            historyTopPickList: document.getElementById('history-top-pick-list'),
            historyTopPackList: document.getElementById('history-top-pack-list'),
            exportHistoryExcel: document.getElementById('export-history-excel'),
            exportHistoryPdf: document.getElementById('export-history-pdf'),
            // ğŸ†• Calendar View Elements
            calendarPrevMonth: document.getElementById('calendar-prev-month'),
            calendarNextMonth: document.getElementById('calendar-next-month'),
            calendarMonthTitle: document.getElementById('calendar-month-title'),
            calendarGrid: document.getElementById('calendar-grid'),
            calendarDetailModalBackdrop: document.getElementById('calendar-detail-modal-backdrop'),
            calendarDetailClose: document.getElementById('calendar-detail-close'),
            // ğŸ†• Ranking View Elements
            rankingDaily: document.getElementById('ranking-daily'),
            rankingWeekly: document.getElementById('ranking-weekly'),
            rankingMonthly: document.getElementById('ranking-monthly'),
            rankingAllTime: document.getElementById('ranking-all-time'),
            rankingPickType: document.getElementById('ranking-pick-type'),
            rankingPackType: document.getElementById('ranking-pack-type'),
            rankingPodium: document.getElementById('ranking-podium'),
            rankingList: document.getElementById('ranking-list'),
            rankingTotalCount: document.getElementById('ranking-total-count'),
            rankingAvgHtp: document.getElementById('ranking-avg-htp'),
            rankingMaxHtp: document.getElementById('ranking-max-htp'),
            rankingMedianHtp: document.getElementById('ranking-median-htp'),
            // ğŸ†• Employee Detail Modal Elements
            employeeDetailModalBackdrop: document.getElementById('employee-detail-modal-backdrop'),
            employeeDetailClose: document.getElementById('employee-detail-close'),
            // ğŸ†• Hidden Employees Elements
            manageHiddenBtn: document.getElementById('manage-hidden-btn'),
            hiddenCountBadge: document.getElementById('hidden-count-badge'),
            hiddenEmployeesList: document.getElementById('hidden-employees-list'),
            hiddenEmployeesModalBackdrop: document.getElementById('hidden-employees-modal-backdrop'),
            hiddenEmployeesModalClose: document.getElementById('hidden-employees-modal-close'),
        };

        // --- Global State ---
        let globalRawData = []; 
        let historyData = {}; // { 'YYYY-MM-DD': rawDataArray }
        let hiddenEmployees = new Set(); // ìˆ¨ê¸´ ì‘ì—…ì ëª©ë¡
        let state = {
            filters: {
                process: 'all', search: '', lowHtp: false,
                hours: new Set(), floors: new Set(), packTypes: new Set()
            },
            sort: { key: 'htp', direction: 'asc' },
            charts: { 
                floorHtp: null, packType: null, individualHtp: null, 
                processComparison: null, hourlyHtp: null,
                historyDailyTrend: null, historyDailyQty: null,
                employeeDailyChart: null, employeeQtyChart: null, employeeWeeklyChart: null,
                calendarDetailChart: null
            },
            historyPeriod: 'week', // 'week', 'month', 'all', 'custom'
            historyDateRange: { start: null, end: null },
            calendarCurrentMonth: new Date(), // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì›”
            rankingPeriod: 'daily', // 'daily', 'weekly', 'monthly', 'all-time'
            rankingProcessType: 'pick', // 'pick', 'pack'
        };
        let targetHtpValues = {};
        let employeeBadges = {}; // { employeeId: { badges: [], streaks: {}, records: {} } }
        let previousRankings = {}; // ì´ì „ ìˆœìœ„ ì €ì¥ (ìˆœìœ„ ë³€ë™ ê³„ì‚°ìš©)

        // --- Constants ---
        const PACK_TYPE_MAP = {
            "ë©”ë‰´ì–¼íŒ©": "179_1.3F_MA_S_OG_", "ë©”ë‰´ì–¼íŒ© ë©€í‹°": "179_1.3F_MA_M_OG_", "ACE LINE": "179-1.2F-MA-ACE-OG-",
            "ì˜¤í† ë°± 1.2": "179_1.3F_AB_R1.2_OG_", "ì˜¤í† ë°± 2.5": "179_1.3F_AB_R2.5_OG_", "ì˜¤í† ë°± 4.0": "179_1.3F_AB_R4.0_OG_",
            "ì˜¤í† ë°± RTPB": "179_1.3F_AB_T1_OG_", "ì˜¤í† ë°± ë©€í‹°": "179_1.3F_AB_M_OG_", "CFC ë©”ë‰´ì–¼íŒ©": "190_6.2F_MA_S_OG_",
            "CFC ë©”ë‰´ì–¼íŒ© ë©€í‹°": "190_6.2F_MA_M_OG_", "CFC ì˜¤í† ë°± 2.5": "190_6.2F_AB_R2.5_OG_", "CFC ì˜¤í† ë°± 4.0": "190_6.2F_AB_R4.0_OG_",
            "CFC ì˜¤í† ë°± RTPB": "190_6.2G_AB_T1_OG_"
        };
        const DEFAULT_PACK_TYPE = "ê¸°íƒ€";
        const MANAGERS_LIST = ['26485305', '94354606', '66476877', '21284456', '24856615', '21019991', '87406548', '29801698', '27407697', '92816677', '65712250', '29787775', '37005613', '24304330', '27507426', '97224272', '92718820', '83689729', '36148186', '98659377', '97724155', '96792527', '24624169', '64118293', '50908038', '21220693', '41310393', '30997520', '66536830', '92733138', '77358628', '39359504', '25657753', '29229926', '46802436', '58548628', '93246435', '42103385', '26152514', '95383395', '55540763', '53909931', '28996527', '96358817', '56805916', '62613130', '47848283', '39678603', '58728654', '38876677', '68100618', '56334308'];
        
        const TARGET_HTP_DEFAULTS = {
            "Manual SINGULATION": { value: 100, keywords: ['ManualPack', '179_1.3F_MA_S_OG_'] },
            "Manual MULTI": { value: 120, keywords: ['7F_Multi_AGV', '179_1.3F_MA_M_OG_'] },
            "ACE LINE": { value: 150, keywords: ['ACE', '179-1.2F-MA-ACE-OG-'] },
            "Autobagger 1.2": { value: 380, keywords: ['Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'] },
            "Autobagger 2.5": { value: 350, keywords: ['Autobag2.5', '179_1.3F_AB_R2.5_OG_'] },
            "Autobagger 4.0": { value: 280, keywords: ['Autobag4.0', '179_1.3F_AB_R4.0_OG_'] },
            "Autobagger RTPB": { value: 150, keywords: ['Autobag_RTPB1', '179_1.3F_AB_T1_OG_'] },
            "Auto MULTI": { value: 250, keywords: ['AGV_Multi_Autobag4.0', '179_1.3F_AB_M_OG_'] },
            "CFC Manual S": { value: 100, keywords: ['190_6.2F_MA_S_OG_'] },
            "CFC Manual M": { value: 120, keywords: ['190_6.2F_MA_M_OG_'] },
            "CFC Autobag 2.5": { value: 350, keywords: ['190_6.2F_AB_R2.5_OG_'] },
            "CFC Autobag 4.0": { value: 280, keywords: ['190_6.2F_AB_R4.0_OG_'] },
            "CFC Autobag RTPB": { value: 150, keywords: ['190_6.2G_AB_T1_OG_'] },
            "PICK": { value: 90, keywords: [] }
        };
        for(const key in TARGET_HTP_DEFAULTS) {
            targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
        }

        // --- LocalStorage Management for Hidden Employees ---
        function loadHiddenEmployees() {
            const saved = localStorage.getItem('hiddenEmployees');
            if (saved) {
                hiddenEmployees = new Set(JSON.parse(saved));
            }
            updateHiddenCountBadge();
        }

        function saveHiddenEmployees() {
            localStorage.setItem('hiddenEmployees', JSON.stringify([...hiddenEmployees]));
            updateHiddenCountBadge();
        }

        function updateHiddenCountBadge() {
            ui.hiddenCountBadge.textContent = hiddenEmployees.size;
            if (hiddenEmployees.size > 0) {
                ui.hiddenCountBadge.classList.remove('bg-gray-500');
                ui.hiddenCountBadge.classList.add('bg-red-500');
            } else {
                ui.hiddenCountBadge.classList.remove('bg-red-500');
                ui.hiddenCountBadge.classList.add('bg-gray-500');
            }
        }

        function toggleHiddenEmployee(employeeName) {
            if (hiddenEmployees.has(employeeName)) {
                hiddenEmployees.delete(employeeName);
            } else {
                hiddenEmployees.add(employeeName);
            }
            saveHiddenEmployees();
            applyFiltersAndRender();
        }

        function showHiddenEmployeesModal() {
            const modalList = document.getElementById('hidden-employees-modal-list');
            modalList.innerHTML = '';

            if (hiddenEmployees.size === 0) {
                modalList.innerHTML = '<div class="text-center py-10 text-gray-500">ìˆ¨ê¸´ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                hiddenEmployees.forEach(employeeName => {
                    const item = document.createElement('div');
                    item.className = 'hidden-employee-item';
                    item.innerHTML = `
                        <span class="font-semibold text-white">${employeeName}</span>
                        <button class="show-employee-btn" data-employee="${employeeName}">ë³µêµ¬</button>
                    `;
                    modalList.appendChild(item);
                });

                // Attach event listeners
                modalList.querySelectorAll('.show-employee-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const employeeName = e.target.dataset.employee;
                        toggleHiddenEmployee(employeeName);
                        showHiddenEmployeesModal(); // Refresh modal
                    });
                });
            }

            ui.hiddenEmployeesModalBackdrop.classList.remove('hidden');
            ui.hiddenEmployeesModalBackdrop.classList.add('flex');
        }

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyBrPfjJWPPd8HzI1jCRoHFqwcuPuJ9u10E",
            authDomain: "gwj2-pickpack-htptool.firebaseapp.com",
            projectId: "gwj2-pickpack-htptool",
            storageBucket: "gwj2-pickpack-htptool.appspot.com",
            messagingSenderId: "913661158847",
            appId: "1:913661158847:web:ebaf60d2afbeadda452d0a",
            measurementId: "G-77DRPC5F58"
        };
        let db, auth, userId, dataDocRef, historyCollectionRef;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            dataDocRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpData', 'latestCompressed');
            historyCollectionRef = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpHistory');
        } catch(e) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            updateStatus('disconnected', 'Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                updateStatus('connected', 'ì‹¤ì‹œê°„ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                ui.fileUpload.disabled = false;
                setupRealtimeListener();
                loadHistoryData(); // Load history on auth
                loadHiddenEmployees(); // Load hidden employees
            } else {
                try { await signInAnonymously(auth); } catch (error) {
                    console.error("ìµëª… ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                    updateStatus('disconnected', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        });

        function setupRealtimeListener() {
            onSnapshot(dataDocRef, (docSnap) => {
                showLoader();
                if (docSnap.exists()) {
                    const dataPayload = docSnap.data();
                    try {
                        const compressedBytes = dataPayload.compressedData;
                        if (!compressedBytes) throw new Error("ì••ì¶•ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        const compressedUint8Array = compressedBytes.toUint8Array();
                        const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                        const parsedData = JSON.parse(decompressedString);
                        globalRawData = parsedData.map(item => ({
                            ...item,
                            htpStart: new Date(item.htpStart),
                            htpEnd: new Date(item.htpEnd),
                        }));
                        ui.lastUploaderEl.textContent = dataPayload.uploaderId.substring(0, 8) + '...';
                        ui.lastUpdatedEl.textContent = new Date(dataPayload.timestamp).toLocaleString('ko-KR');
                        initializeFiltersFromData(globalRawData);
                        applyFiltersAndRender();
                    } catch (error) {
                        console.error("ë°ì´í„° ì••ì¶• í•´ì œ ë˜ëŠ” íŒŒì‹± ì˜¤ë¥˜:", error);
                        showModal("ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        globalRawData = [];
                        applyFiltersAndRender();
                    }
                } else {
                    globalRawData = [];
                    initializeFiltersFromData([]);
                    applyFiltersAndRender();
                }
                hideLoader();
            }, (error) => {
                console.error("ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
                updateStatus('disconnected', 'ë°ì´í„° ìˆ˜ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                hideLoader();
            });
        }

        // --- History Data Management ---
        async function loadHistoryData() {
            try {
                // Load last 90 days of history
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                
                const q = query(
                    historyCollectionRef,
                    where('date', '>=', ninetyDaysAgo.toISOString().split('T')[0]),
                    orderBy('date', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                historyData = {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    try {
                        const compressedBytes = data.compressedData;
                        if (!compressedBytes) return;
                        const compressedUint8Array = compressedBytes.toUint8Array();
                        const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                        const parsedData = JSON.parse(decompressedString);
                        historyData[data.date] = parsedData.map(item => ({
                            ...item,
                            htpStart: new Date(item.htpStart),
                            htpEnd: new Date(item.htpEnd),
                        }));
                    } catch (error) {
                        console.error(`íˆìŠ¤í† ë¦¬ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜ (${data.date}):`, error);
                    }
                });
                
                console.log(`${Object.keys(historyData).length}ì¼ì˜ íˆìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                calculateEmployeeBadges();
                
            } catch (error) {
                console.error("íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
            }
        }
		
		// --- Gamification: Badge Calculation ---
        function calculateEmployeeBadges() {
    employeeBadges = {};
    
    const sortedDates = Object.keys(historyData).sort();
    const allEmployees = new Set();
    Object.values(historyData).forEach(dayData => {
        dayData.forEach(item => allEmployees.add(item.employee));
    });
    
    allEmployees.forEach(employeeName => {
        const badges = [];
        const streaks = { 
            targetMet: 0, 
            targetMissed: 0, // ğŸ†• ëª©í‘œ ë¯¸ë‹¬ ì—°ì†
            topPerformer: 0, 
            top5Performer: 0, // ğŸ†• Top5 ì—°ì†
            attendance: 0 // ğŸ†• ì—°ì† ì¶œê·¼
        };
        const records = { maxHtp: 0, maxQty: 0, totalDays: 0 };
        const dailyHtps = []; // ğŸ†• ì¼ë³„ HTP ê¸°ë¡ (í¸ì°¨ ê³„ì‚°ìš©)
        const recentPerformance = { last7: [], prev7: [], last10: [], overall: [] }; // ğŸ†•
        
        let consecutiveTargetDays = 0;
        let consecutiveTargetMissedDays = 0; // ğŸ†•
        let consecutiveTopDays = 0;
        let consecutiveTop5Days = 0; // ğŸ†•
        let consecutiveAttendance = 0; // ğŸ†•
        let lastDate = null;
        
        sortedDates.forEach((date, dateIndex) => {
            const dayData = historyData[date];
            const employeeData = dayData.filter(d => d.employee === employeeName);
            
            if (employeeData.length === 0) {
                consecutiveTargetDays = 0;
                consecutiveTargetMissedDays = 0;
                consecutiveTopDays = 0;
                consecutiveTop5Days = 0;
                consecutiveAttendance = 0;
                return;
            }
            
            records.totalDays++;
            
            // ğŸ†• ì—°ì† ì¶œê·¼ ì²´í¬
            if (lastDate) {
                const dayDiff = (new Date(date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
                if (dayDiff === 1) {
                    consecutiveAttendance++;
                } else {
                    consecutiveAttendance = 1;
                }
            } else {
                consecutiveAttendance = 1;
            }
            if (consecutiveAttendance > streaks.attendance) {
                streaks.attendance = consecutiveAttendance;
            }
            lastDate = date;
            
            const aggregated = aggregateData(employeeData);
            aggregated.forEach(item => {
                const htp = parseFloat(item.htp);
                const qty = item.unitQty;
                const targetHtp = getTargetHtp(item);
                
                // ğŸ†• ì¼ë³„ HTP ê¸°ë¡
                dailyHtps.push(htp);
                recentPerformance.overall.push(htp);
                
                // ğŸ†• ìµœê·¼ ì„±ê³¼ ê¸°ë¡
                if (dateIndex >= sortedDates.length - 10) {
                    recentPerformance.last10.push(htp);
                }
                if (dateIndex >= sortedDates.length - 7) {
                    recentPerformance.last7.push(htp);
                }
                if (dateIndex >= sortedDates.length - 14 && dateIndex < sortedDates.length - 7) {
                    recentPerformance.prev7.push(htp);
                }
                
                if (htp > records.maxHtp) records.maxHtp = htp;
                if (qty > records.maxQty) records.maxQty = qty;
                
                // ëª©í‘œ ë‹¬ì„±/ë¯¸ë‹¬ ì²´í¬
                if (htp >= targetHtp) {
                    consecutiveTargetDays++;
                    consecutiveTargetMissedDays = 0; // ë¦¬ì…‹
                } else {
                    consecutiveTargetDays = 0;
                    consecutiveTargetMissedDays++; // ğŸ†•
                }
                
                // ğŸ†• ìµœëŒ€ ëª©í‘œ ë¯¸ë‹¬ ì—°ì† ê¸°ë¡
                if (consecutiveTargetMissedDays > streaks.targetMissed) {
                    streaks.targetMissed = consecutiveTargetMissedDays;
                }
                
                if (consecutiveTargetDays > streaks.targetMet) {
                    streaks.targetMet = consecutiveTargetDays;
                }
                
                const allForProcess = aggregateData(dayData.filter(d => 
                    d.processTask === (item.processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)')
                ));
                const sortedByHtp = allForProcess.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
                
                const isTop3 = sortedByHtp.slice(0, 3).some(d => d.employee === employeeName);
                const isTop5 = sortedByHtp.slice(0, 5).some(d => d.employee === employeeName); // ğŸ†•
                
                if (isTop3) {
                    consecutiveTopDays++;
                } else {
                    consecutiveTopDays = 0;
                }
                
                // ğŸ†• Top5 ì—°ì† ì²´í¬
                if (isTop5) {
                    consecutiveTop5Days++;
                } else {
                    consecutiveTop5Days = 0;
                }
                
                if (consecutiveTopDays > streaks.topPerformer) {
                    streaks.topPerformer = consecutiveTopDays;
                }
                
                if (consecutiveTop5Days > streaks.top5Performer) {
                    streaks.top5Performer = consecutiveTop5Days;
                }
            });
        });
        
        // --- ğŸ†• í†µê³„ ê³„ì‚° ---
        const avgHtp = recentPerformance.overall.length > 0 
            ? recentPerformance.overall.reduce((a, b) => a + b, 0) / recentPerformance.overall.length 
            : 0;
        
        const last7Avg = recentPerformance.last7.length > 0 
            ? recentPerformance.last7.reduce((a, b) => a + b, 0) / recentPerformance.last7.length 
            : 0;
        
        const prev7Avg = recentPerformance.prev7.length > 0 
            ? recentPerformance.prev7.reduce((a, b) => a + b, 0) / recentPerformance.prev7.length 
            : 0;
        
        const last10Avg = recentPerformance.last10.length > 0 
            ? recentPerformance.last10.reduce((a, b) => a + b, 0) / recentPerformance.last10.length 
            : 0;
        
        // í‘œì¤€í¸ì°¨ ê³„ì‚°
        const mean = dailyHtps.reduce((a, b) => a + b, 0) / dailyHtps.length;
        const variance = dailyHtps.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / dailyHtps.length;
        const stdDev = Math.sqrt(variance);
        
        // --- ê¸ì • ë±ƒì§€ ---
        if (streaks.targetMet >= 7) badges.push({ type: 'streak', name: 'ğŸ”¥ 7ì¼ ì—°ì† ëª©í‘œ ë‹¬ì„±', level: 'gold' });
        else if (streaks.targetMet >= 5) badges.push({ type: 'streak', name: 'ğŸ”¥ 5ì¼ ì—°ì† ëª©í‘œ ë‹¬ì„±', level: 'silver' });
        else if (streaks.targetMet >= 3) badges.push({ type: 'streak', name: 'ğŸ”¥ 3ì¼ ì—°ì† ëª©í‘œ ë‹¬ì„±', level: 'bronze' });
        
        if (streaks.topPerformer >= 3) badges.push({ type: 'top', name: 'â­ 3ì¼ ì—°ì† Top3', level: 'gold' });
        if (streaks.top5Performer >= 5) badges.push({ type: 'top', name: 'ğŸ–ï¸ 5ì¼ ì—°ì† Top5', level: 'silver' });
        
        if (streaks.attendance >= 30) badges.push({ type: 'attendance', name: 'ğŸ”¥ 30ì¼ ì—°ì† ì¶œê·¼', level: 'gold' });
        else if (streaks.attendance >= 14) badges.push({ type: 'attendance', name: 'ğŸ”¥ 14ì¼ ì—°ì† ì¶œê·¼', level: 'silver' });
        else if (streaks.attendance >= 7) badges.push({ type: 'attendance', name: 'ğŸ”¥ 7ì¼ ì—°ì† ì¶œê·¼', level: 'bronze' });
        
        if (records.maxHtp >= 500) badges.push({ type: 'record', name: 'ğŸ’ HTP 500+', level: 'gold' });
        else if (records.maxHtp >= 400) badges.push({ type: 'record', name: 'ğŸ’ HTP 400+', level: 'silver' });
        else if (records.maxHtp >= 300) badges.push({ type: 'record', name: 'ğŸ’ HTP 300+', level: 'bronze' });
        
        if (records.totalDays >= 30) badges.push({ type: 'attendance', name: 'ğŸ“… 30ì¼ ê·¼ë¬´', level: 'gold' });
        else if (records.totalDays >= 14) badges.push({ type: 'attendance', name: 'ğŸ“… 14ì¼ ê·¼ë¬´', level: 'silver' });
        else if (records.totalDays >= 7) badges.push({ type: 'attendance', name: 'ğŸ“… 7ì¼ ê·¼ë¬´', level: 'bronze' });
        
        // ğŸ†• ìƒìŠ¹ì„¸
        if (prev7Avg > 0 && last7Avg > 0) {
            const improvement = ((last7Avg - prev7Avg) / prev7Avg) * 100;
            if (improvement >= 20) badges.push({ type: 'trend', name: 'ğŸ“ˆ ìƒìŠ¹ì„¸ (+20%)', level: 'gold' });
        }
        
        // ğŸ†• ì•ˆì •ì„±
        if (dailyHtps.length >= 5) {
            if (stdDev <= 15) badges.push({ type: 'stable', name: 'âš¡ ì•ˆì •ì ', level: 'silver' });
        }
        
        // --- ğŸ†• ê²½ê³  ë±ƒì§€ ---
        if (streaks.targetMissed >= 3) badges.push({ type: 'warning', name: 'ğŸ¢ 3ì¼ ì—°ì† ì €ì¡°', level: 'danger' });
        
        if (prev7Avg > 0 && last7Avg > 0) {
            const decline = ((prev7Avg - last7Avg) / prev7Avg) * 100;
            if (decline >= 20) badges.push({ type: 'warning', name: 'ğŸ“‰ í•˜ë½ì„¸ (-20%)', level: 'danger' });
        }
        
        if (dailyHtps.length >= 5 && stdDev >= 40) {
            badges.push({ type: 'warning', name: 'âš¡ ë¶ˆì•ˆì •', level: 'warning' });
        }
        
        if (avgHtp > 0 && last10Avg > 0) {
            const recentVsOverall = ((avgHtp - last10Avg) / avgHtp) * 100;
            if (recentVsOverall >= 30) badges.push({ type: 'warning', name: 'ğŸ’¤ ë¶€ì§„', level: 'danger' });
        }
        
        // ğŸ†• ìµœê·¼ 5ì¼ ì¤‘ 4ì¼ ì´ìƒ ëª©í‘œ ë¯¸ë‹¬
        if (recentPerformance.last7.length >= 5) {
            const last5 = recentPerformance.last7.slice(-5);
            const targetHtp = 90; // ê¸°ë³¸ ëª©í‘œ
            const missedDays = last5.filter(htp => htp < targetHtp).length;
            if (missedDays >= 4) badges.push({ type: 'warning', name: 'ğŸ¯ ê°œì„  í•„ìš”', level: 'warning' });
        }
        
        employeeBadges[employeeName] = { badges, streaks, records };
    });
}

        // --- Event Listeners ---
        function toggleMobileSidebar() {
            const isOpen = ui.sidebar.classList.toggle('open');
            ui.sidebarOverlay.classList.toggle('hidden', !isOpen);
        }
        function toggleDesktopSidebar() {
            ui.appContainer.classList.toggle('sidebar-collapsed');
        }

        ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
        ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
        ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }

        ui.fileUpload.addEventListener('change', handleFileUpload);
        ui.searchInput.addEventListener('input', (e) => {
            state.filters.search = e.target.value.toLowerCase();
            applyFiltersAndRender();
        });
        ui.lowHtpToggle.addEventListener('change', (e) => {
            state.filters.lowHtp = e.target.checked;
            applyFiltersAndRender();
        });
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.filters.process = e.currentTarget.id.replace('filter-', '');
                applyFiltersAndRender();
            });
        });
        ui.captureBtn.addEventListener('click', captureTable);
        ui.exportBtn.addEventListener('click', exportToExcel);
        ui.tableHeader.addEventListener('click', (e) => {
            const headerCell = e.target.closest('.sortable');
            if (!headerCell) return;
            const sortKey = headerCell.dataset.sortKey;
            if (state.sort.key === sortKey) {
                if (state.sort.direction === 'asc') state.sort.direction = 'desc';
                else if (state.sort.direction === 'desc') { state.sort.key = 'htp'; state.sort.direction = 'asc'; }
            } else {
                state.sort.key = sortKey;
                state.sort.direction = 'asc';
            }
            applyFiltersAndRender();
        });

        // View Switcher (5ê°œ ë©”ë‰´)
        ui.tableViewBtn.addEventListener('click', () => switchView('table'));
        ui.dashboardViewBtn.addEventListener('click', () => switchView('dashboard'));
        ui.historyViewBtn.addEventListener('click', () => switchView('history'));
        ui.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
        ui.rankingViewBtn.addEventListener('click', () => switchView('ranking'));

        function switchView(viewName) {
            // Hide all views
            ui.tableView.classList.add('hidden');
            ui.dashboardView.classList.add('hidden');
            ui.historyView.classList.add('hidden');
            ui.calendarView.classList.add('hidden');
            ui.rankingView.classList.add('hidden');
            
            // Remove active class from all tabs
            ui.tableViewBtn.classList.remove('active');
            ui.dashboardViewBtn.classList.remove('active');
            ui.historyViewBtn.classList.remove('active');
            ui.calendarViewBtn.classList.remove('active');
            ui.rankingViewBtn.classList.remove('active');
            
            // Show selected view and activate tab
            switch(viewName) {
                case 'table':
                    ui.tableView.classList.remove('hidden');
                    ui.tableViewBtn.classList.add('active');
                    break;
                case 'dashboard':
                    ui.dashboardView.classList.remove('hidden');
                    ui.dashboardView.classList.add('flex');
                    ui.dashboardViewBtn.classList.add('active');
                    break;
                case 'history':
                    ui.historyView.classList.remove('hidden');
                    ui.historyView.classList.add('flex');
                    ui.historyViewBtn.classList.add('active');
                    renderHistoryView();
                    break;
                case 'calendar':
                    ui.calendarView.classList.remove('hidden');
                    ui.calendarView.classList.add('flex');
                    ui.calendarViewBtn.classList.add('active');
                    renderCalendarView();
                    break;
                case 'ranking':
                    ui.rankingView.classList.remove('hidden');
                    ui.rankingView.classList.add('flex');
                    ui.rankingViewBtn.classList.add('active');
                    renderRankingView();
                    break;
            }
        }

        // History Period Selectors
        ui.periodWeekBtn.addEventListener('click', () => {
            setHistoryPeriod('week');
            ui.customDateRange.classList.add('hidden');
        });
        ui.periodMonthBtn.addEventListener('click', () => {
            setHistoryPeriod('month');
            ui.customDateRange.classList.add('hidden');
        });
        ui.periodAllBtn.addEventListener('click', () => {
            setHistoryPeriod('all');
            ui.customDateRange.classList.add('hidden');
        });
        ui.periodCustomBtn.addEventListener('click', () => {
            ui.customDateRange.classList.remove('hidden');
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            ui.periodCustomBtn.classList.add('active');
        });
        ui.applyCustomRange.addEventListener('click', () => {
            const start = ui.startDate.value;
            const end = ui.endDate.value;
            if (start && end) {
                state.historyPeriod = 'custom';
                state.historyDateRange = { start, end };
                renderHistoryView();
            } else {
                showModal('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        });

        function setHistoryPeriod(period) {
            state.historyPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            if (period === 'week') ui.periodWeekBtn.classList.add('active');
            else if (period === 'month') ui.periodMonthBtn.classList.add('active');
            else if (period === 'all') ui.periodAllBtn.classList.add('active');
            renderHistoryView();
        }

        // History Export Buttons
        ui.exportHistoryExcel.addEventListener('click', exportHistoryToExcel);
        ui.exportHistoryPdf.addEventListener('click', exportHistoryToPDF);

        // ğŸ†• Calendar Navigation
        ui.calendarPrevMonth.addEventListener('click', () => {
            state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() - 1);
            renderCalendarView();
        });
        ui.calendarNextMonth.addEventListener('click', () => {
            state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() + 1);
            renderCalendarView();
        });

        // ğŸ†• Ranking Period Selectors
        ui.rankingDaily.addEventListener('click', () => setRankingPeriod('daily'));
        ui.rankingWeekly.addEventListener('click', () => setRankingPeriod('weekly'));
        ui.rankingMonthly.addEventListener('click', () => setRankingPeriod('monthly'));
        ui.rankingAllTime.addEventListener('click', () => setRankingPeriod('all-time'));

        function setRankingPeriod(period) {
            state.rankingPeriod = period;
            document.querySelectorAll('#ranking-daily, #ranking-weekly, #ranking-monthly, #ranking-all-time').forEach(btn => btn.classList.remove('active'));
            if (period === 'daily') ui.rankingDaily.classList.add('active');
            else if (period === 'weekly') ui.rankingWeekly.classList.add('active');
            else if (period === 'monthly') ui.rankingMonthly.classList.add('active');
            else if (period === 'all-time') ui.rankingAllTime.classList.add('active');
            renderRankingView();
        }

        // ğŸ†• Ranking Process Type Selectors
        ui.rankingPickType.addEventListener('click', () => setRankingProcessType('pick'));
        ui.rankingPackType.addEventListener('click', () => setRankingProcessType('pack'));

        function setRankingProcessType(type) {
            state.rankingProcessType = type;
            document.querySelectorAll('#ranking-pick-type, #ranking-pack-type').forEach(btn => btn.classList.remove('active'));
            if (type === 'pick') ui.rankingPickType.classList.add('active');
            else ui.rankingPackType.classList.add('active');
            renderRankingView();
        }

        // ğŸ†• Hidden Employees Management
        ui.manageHiddenBtn.addEventListener('click', () => {
            if (ui.hiddenEmployeesList.classList.contains('hidden')) {
                ui.hiddenEmployeesList.classList.remove('hidden');
                renderHiddenEmployeesList();
            } else {
                ui.hiddenEmployeesList.classList.add('hidden');
            }
        });

        function renderHiddenEmployeesList() {
            ui.hiddenEmployeesList.innerHTML = '';
            
            if (hiddenEmployees.size === 0) {
                ui.hiddenEmployeesList.innerHTML = '<p class="text-sm text-gray-400 mb-2">ìˆ¨ê¸´ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            hiddenEmployees.forEach(employeeName => {
                const item = document.createElement('div');
                item.className = 'hidden-employee-item';
                item.innerHTML = `
                    <span class="font-semibold text-white text-sm">${employeeName.split('(')[0].trim()}</span>
                    <button class="show-employee-btn-small" data-employee="${employeeName}">ë³µêµ¬</button>
                `;
                ui.hiddenEmployeesList.appendChild(item);
            });

            // Attach event listeners
            ui.hiddenEmployeesList.querySelectorAll('.show-employee-btn-small').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const employeeName = e.target.dataset.employee;
                    toggleHiddenEmployee(employeeName);
                    renderHiddenEmployeesList();
                });
            });
        }

        ui.hiddenEmployeesModalClose.addEventListener('click', () => {
            ui.hiddenEmployeesModalBackdrop.classList.add('hidden');
            ui.hiddenEmployeesModalBackdrop.classList.remove('flex');
        });

        // ğŸ†• Modal Close Events
        ui.employeeDetailClose.addEventListener('click', () => {
            ui.employeeDetailModalBackdrop.classList.add('hidden');
            ui.employeeDetailModalBackdrop.classList.remove('flex');
        });

        ui.calendarDetailClose.addEventListener('click', () => {
            ui.calendarDetailModalBackdrop.classList.add('hidden');
            ui.calendarDetailModalBackdrop.classList.remove('flex');
        });

        ui.tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || row.id === 'placeholder-row') return;
            
            // Check if clicked on action button
            if (e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn')) {
                const btn = e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn');
                const employeeName = btn.dataset.employee;
                toggleHiddenEmployee(employeeName);
                return;
            }

            const employeeCell = row.querySelector('td:nth-child(2)');
            const processCell = row.querySelector('td:nth-child(1)');
            if(employeeCell && processCell) {
                const employeeName = employeeCell.textContent.replace(/[ğŸ‘‘ğŸ”¥ğŸ¢ğŸ¥‡ğŸ¥ˆğŸ¥‰]\s*/g, '').trim();
                const processType = processCell.textContent;
                showIndividualTrend(employeeName, processType);
            }
        });
        
        ui.chartModalClose.addEventListener('click', () => {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
        });
        ui.chartModalBackdrop.addEventListener('click', (e) => {
            if (e.target === ui.chartModalBackdrop) {
                ui.chartModalBackdrop.classList.add('hidden');
                ui.chartModalBackdrop.classList.remove('flex');
            }
        });

        // --- Helper Functions ---
        function getPackType(location, processTask, processPathName) {
            if (processTask === 'PACK(PACKING)' && processPathName.includes('AGV_Multi_Autobag4.0') && location.startsWith('Pack at Rebin (Test')) return "ì˜¤í† ë°± ë©€í‹°";
            if (typeof location !== 'string') return DEFAULT_PACK_TYPE;
            for (const [name, prefix] of Object.entries(PACK_TYPE_MAP)) {
                if (location.startsWith(prefix)) return name;
            }
            return DEFAULT_PACK_TYPE;
        }

        function getTargetHtp(item) {
            if (item.processType.includes('PICK')) return targetHtpValues['PICK'] || 0;
            if (item.processType.includes('PACK')) {
                const processPathName = item.processPathName || "";
                for (const name in TARGET_HTP_DEFAULTS) {
                    if (name === "PICK") continue;
                    const config = TARGET_HTP_DEFAULTS[name];
                    if (config.keywords.some(keyword => processPathName.includes(keyword))) return targetHtpValues[name] || 0;
                }
                return targetHtpValues["Manual SINGULATION"] || 0;
            }
            return 0;
        }

        function parseExcelData(data) {
            if (data.length < 2) return [];
            const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            const COLS_TO_LOAD = {
                workDate: 'work date', employee: 'employee', unitQty: 'unit qty', location: 'location', floor: 'floor',
                processPathName: 'process path name', htpStart: 'htp start', htpEnd: 'htp end', processTask: 'process(task)',
                contractType: 'contract type'
            };
            const colIndices = {};
            const missingCols = [];
            for (const key in COLS_TO_LOAD) {
                const index = headers.indexOf(COLS_TO_LOAD[key]);
                if (index === -1 && key !== 'contractType') missingCols.push(COLS_TO_LOAD[key]);
                colIndices[key] = index;
            }
            if (missingCols.length > 0) throw new Error(`ì—‘ì…€ íŒŒì¼ì— ë‹¤ìŒ í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤:\n[${missingCols.join(', ')}]`);

            const rawData = data.slice(1).map(row => {
                const combineDateTime = (dateValue, timeValue) => {
                    if (!dateValue || !timeValue) return null;
                    let datePart = (typeof dateValue === 'number') ? new Date(Date.UTC(1899, 11, 30) + dateValue * 24 * 60 * 60 * 1000) : new Date(dateValue);
                    if (isNaN(datePart.getTime())) return null;
                    let timePart;
                    if (typeof timeValue === 'number') timePart = new Date(Date.UTC(1899, 11, 30) + timeValue * 24 * 60 * 60 * 1000);
                    else if (typeof timeValue === 'string') {
                        const parts = timeValue.split(':');
                        timePart = new Date(0);
                        timePart.setUTCHours(parts[0] || 0, parts[1] || 0, parts[2] || 0, 0);
                    } else timePart = timeValue;
                    if (isNaN(timePart.getTime())) return null;
                    return new Date(Date.UTC(datePart.getUTCFullYear(), datePart.getUTCMonth(), datePart.getUTCDate(), timePart.getUTCHours(), timePart.getUTCMinutes(), timePart.getUTCSeconds()));
                };
                const htpStart = combineDateTime(row[colIndices.workDate], row[colIndices.htpStart]);
                const htpEnd = combineDateTime(row[colIndices.workDate], row[colIndices.htpEnd]);
                if (!htpStart || !htpEnd) return null;
                const durationSeconds = (htpEnd - htpStart) / 1000;
                if (durationSeconds <= 0) return null;
                let processTask = row[colIndices.processTask] || '';
                const location = row[colIndices.location] || '';
                const processPathName = row[colIndices.processPathName] || '';
                if (processTask === 'REBIN(REBIN)' && location.startsWith('Pack at Rebin (Test') && processPathName === '0. AGV_Multi_Autobag4.0 + ì¼ë°˜ì¡´ í†µí•©') processTask = 'PACK(PACKING)';
                return {
                    employee: row[colIndices.employee] || '', unitQty: parseInt(row[colIndices.unitQty] || 0),
                    location: location, floor: row[colIndices.floor] || '',
                    processPathName: processPathName, processTask: processTask,
                    contractType: colIndices.contractType !== -1 ? (row[colIndices.contractType] || '').toUpperCase() : '',
                    htpStart: htpStart, htpEnd: htpEnd
                };
            }).filter(item => {
                if (!item || !item.employee || item.unitQty <= 0) return false;
                if (item.employee === 'AGV_Agent') return false;
                return item.processTask === 'PICK(PICKING)' || item.processTask === 'PACK(PACKING)';
            });
            return rawData;
        }

        function aggregateData(rawData) {
            const aggregatedMap = new Map();
            rawData.forEach(item => {
                let key, packType = null;
                if (item.processTask === 'PICK(PICKING)') {
                    key = `${item.employee}|${item.processPathName}|${item.floor}|PICK`;
                    packType = 'ì§‘í’ˆ';
                } else {
                    packType = getPackType(item.location, item.processTask, item.processPathName);
                    key = `${item.employee}|${packType}|PACK`;
                }
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds <= 0) return;
                if (!aggregatedMap.has(key)) {
                    const empIdMatch = item.employee.match(/\((.*?)\)/);
                    const empId = empIdMatch ? empIdMatch[1] : '';
                    aggregatedMap.set(key, {
                        processType: item.processTask.includes('PICK') ? 'PICK(ì§‘í’ˆ)' : 'PACK(í¬ì¥)',
                        employee: item.employee, floor: item.floor, unitQty: 0, totalSeconds: 0,
                        location: item.location, processPathName: item.processPathName, packType: packType,
                        isManager: MANAGERS_LIST.includes(empId), isPerm: item.contractType === 'PERM'
                    });
                }
                const group = aggregatedMap.get(key);
                group.unitQty += item.unitQty;
                group.totalSeconds += durationSeconds;
                group.location = item.location;
                group.processPathName = item.processPathName;
                group.floor = item.floor;
            });
            const finalData = [];
            for (const group of aggregatedMap.values()) {
                const mh = group.totalSeconds > 0 ? group.totalSeconds / 3600 : 0;
                if (mh >= 0.25 && group.unitQty >= 30) {
                    finalData.push({ ...group, mh: mh.toFixed(4), htp: (mh > 0 ? group.unitQty / mh : 0).toFixed(1) });
                }
            }
            return finalData;
        }
		
		function initializeFiltersFromData(rawData) {
            const allPackTypes = new Set();
            const floors = new Set();
            rawData.forEach(item => {
                if(item.processTask.includes('PICK')) {
                    if(item.floor) floors.add(item.floor);
                } else if (item.processTask.includes('PACK')) {
                    allPackTypes.add(getPackType(item.location, item.processTask, item.processPathName));
                }
            });
            createFilterCheckboxes(ui.packTypeFilters, Array.from(allPackTypes).sort(), 'packTypes', 'packtypes');
            createFilterCheckboxes(ui.floorFilters, Array.from(floors).sort(), 'floors', 'floors');
            createTimeFilters();
            createTargetHtpSettings();
        }

        function createTimeFilters() {
            const allHoursCheckbox = document.getElementById('all-hours-checkbox');
            ui.hourFilters.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = i;
                checkbox.className = 'form-checkbox hour-checkbox';
                checkbox.addEventListener('change', (e) => {
                    const hourVal = parseInt(e.target.value);
                    if (e.target.checked) {
                        state.filters.hours.add(hourVal);
                        allHoursCheckbox.checked = false;
                    } else {
                        state.filters.hours.delete(hourVal);
                    }
                    if (state.filters.hours.size === 0) allHoursCheckbox.checked = true;
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                const text = document.createElement('span');
                text.textContent = hour;
                label.appendChild(text);
                ui.hourFilters.appendChild(label);
            }
            allHoursCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                    state.filters.hours.clear();
                    applyFiltersAndRender();
                }
            });
            document.getElementById('select-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = false;
                document.querySelectorAll('.hour-checkbox').forEach(cb => {
                    cb.checked = true;
                    state.filters.hours.add(parseInt(cb.value));
                });
                applyFiltersAndRender();
            });
            document.getElementById('deselect-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = true;
                document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                state.filters.hours.clear();
                applyFiltersAndRender();
            });
        }

        function createFilterCheckboxes(container, items, filterType, type) {
            container.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = item;
                checkbox.className = `form-checkbox ${type}-checkbox`;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) state.filters[filterType].add(item);
                    else state.filters[filterType].delete(item);
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${item}`));
                container.appendChild(label);
            });
            const selectAllBtn = document.getElementById(`select-all-${type}`);
            const deselectAllBtn = document.getElementById(`deselect-all-${type}`);
            if (selectAllBtn && deselectAllBtn) {
                selectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = true; state.filters[filterType].add(cb.value); });
                    applyFiltersAndRender();
                };
                deselectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = false; state.filters[filterType].delete(cb.value); });
                    applyFiltersAndRender();
                };
            }
        }

        function createTargetHtpSettings() {
            ui.targetHtpSettings.innerHTML = '';
            for (const key in TARGET_HTP_DEFAULTS) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between';
                const label = document.createElement('label');
                label.textContent = key + ':';
                const input = document.createElement('input');
                input.type = 'number';
                input.value = targetHtpValues[key];
                input.className = 'w-20 rounded-md py-1 px-2 text-sm text-right';
                input.addEventListener('change', (e) => {
                    targetHtpValues[key] = parseFloat(e.target.value) || 0;
                    applyFiltersAndRender();
                });
                div.appendChild(label);
                div.appendChild(input);
                ui.targetHtpSettings.appendChild(div);
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoader();
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const parsedData = parseExcelData(jsonData);
                    await saveDataToFirestore(parsedData);
                } catch (error) {
                    console.error("íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                    showModal(error.message || "íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    hideLoader();
                }
            };
            reader.onerror = (error) => { console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", error); showModal("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); hideLoader(); };
            reader.readAsArrayBuffer(file);
        }

        async function saveDataToFirestore(data) {
            try {
                const serializableData = data.map(item => ({ ...item, htpStart: item.htpStart.toISOString(), htpEnd: item.htpEnd.toISOString() }));
                const jsonString = JSON.stringify(serializableData);
                const compressedData = pako.gzip(jsonString);
                const compressedBytes = Bytes.fromUint8Array(compressedData);
                const payload = { compressedData: compressedBytes, uploaderId: userId, timestamp: new Date().toISOString() };
                await setDoc(dataDocRef, payload);
                
                // Also save to history collection with date key
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const historyDocRef = doc(historyCollectionRef, today);
                const historyPayload = { 
                    compressedData: compressedBytes, 
                    uploaderId: userId, 
                    timestamp: new Date().toISOString(),
                    date: today
                };
                await setDoc(historyDocRef, historyPayload);
                
                showModal('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // Reload history data
                await loadHistoryData();
                
            } catch (error) {
                console.error("Firestore ì €ì¥ ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                hideLoader();
            }
        }

        function applyFiltersAndRender() {
            if (globalRawData.length === 0) {
                renderTable([]);
                updateDashboard([], []);
                return;
            }
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
            }
            let aggregatedData = aggregateData(timeFilteredRawData);
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(ì§‘í’ˆ)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(í¬ì¥)');
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            let finalDisplayData = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            if (state.sort.key && state.sort.direction) {
                const numericKeys = ['unitQty', 'mh', 'htp'];
                finalDisplayData.sort((a, b) => {
                    const key = state.sort.key;
                    const valA = a[key], valB = b[key];
                    let compareResult;
                    if (numericKeys.includes(key)) compareResult = parseFloat(valA) - parseFloat(valB);
                    else compareResult = (valA || '').toString().localeCompare((valB || '').toString());
                    return state.sort.direction === 'asc' ? compareResult : -compareResult;
                });
            }
            renderTable(finalDisplayData);
            updateDashboard(finalDisplayData, timeFilteredRawData);
            updateColumnVisibility(finalDisplayData);
            updateStats(finalDisplayData);
            updateTicker(finalDisplayData);
            updateSortIndicators();
        }
        
        function renderTable(data) {
            ui.tableBody.innerHTML = '';
            if (data.length === 0) {
                ui.tableBody.appendChild(ui.placeholderRow);
                ui.placeholderRow.classList.remove('hidden');
                updateStats([]);
                updateTicker([]);
                return;
            }
            ui.placeholderRow.classList.add('hidden');

            data.forEach(item => {
                const row = document.createElement('tr');
                const isHidden = hiddenEmployees.has(item.employee);
                row.className = isHidden ? 'cursor-pointer hover:bg-gray-700 hidden-employee' : 'cursor-pointer hover:bg-gray-700';
                
                let processTypeColor = item.processType.includes('PICK') ? 'text-blue-400' : 'text-yellow-400';
                const targetHtp = getTargetHtp(item);
                let htpColor = parseFloat(item.htp) < targetHtp ? 'text-red-400' : 'text-green-400';
                
                let empDisplay = item.employee;
                let empColor = 'text-gray-200';

                if (item.isManager) {
                    empDisplay = `ğŸ‘‘ ${item.employee}`;
                    empColor = 'text-yellow-300 font-bold';
                } else if (item.isPerm) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    empColor = isDark ? 'text-lime-400' : 'text-green-600 font-semibold';
                }

                let badge = '';
                
                // Add gamification badges (íšë“ ë±ƒì§€ë§Œ í‘œì‹œ)
                const employeeBadge = employeeBadges[item.employee];
                if (employeeBadge && employeeBadge.badges.length > 0) {
                    const topBadge = employeeBadge.badges[0];
                    if (topBadge.level === 'gold') badge += ' ğŸ¥‡';
                    else if (topBadge.level === 'silver') badge += ' ğŸ¥ˆ';
                    else if (topBadge.level === 'bronze') badge += ' ğŸ¥‰';
                }
                
                empDisplay += badge;

                // ğŸ†• Hidden indicator and action button
                const actionMenu = `
            <div class="row-action-menu">
                ${isHidden 
                    ? `<button class="action-menu-btn show-employee-btn" data-employee="${item.employee}" title="ë³µêµ¬">ğŸ”“</button>`
                    : `<button class="action-menu-btn hide-employee-btn" data-employee="${item.employee}" title="ìˆ¨ê¸°ê¸°">ğŸ”’</button>`
                }
            </div>
        `;

                row.innerHTML = `
            <td class="px-4 py-3 font-medium ${processTypeColor}">${item.processType}</td>
            <td class="px-4 py-3 ${empColor} relative">
                ${empDisplay}${isHidden ? '<span class="hidden-employee-indicator">ìˆ¨ê¹€</span>' : ''}
            </td>
            <td class="px-4 py-3 text-gray-200">${item.unitQty}</td>
            <td class="px-4 py-3 text-gray-200">${item.location || '-'}</td>
            <td class="px-4 py-3 text-gray-200">${item.processPathName || '-'}</td>
            <td class="px-4 py-3 text-gray-200">${item.packType}</td>
            <td class="px-4 py-3 text-gray-200">${item.mh}</td>
            <td class="px-4 py-3 font-bold ${htpColor}">${parseFloat(item.htp) < targetHtp && targetHtp > 0 ? 'ğŸš¨ ' : ''}${item.htp}</td>
            <td class="px-4 py-3 relative">${actionMenu}</td>
        `;
                ui.tableBody.appendChild(row);
            });
        }

        function updateColumnVisibility(data) {
            const locationColHeader = ui.tableHeader.querySelector('th[data-sort-key="location"]');
            if (!locationColHeader) return;
            const locationColIndex = Array.from(locationColHeader.parentNode.children).indexOf(locationColHeader);
            const isLocationEmpty = data.length > 0 && data.every(item => !item.location);
            document.querySelectorAll(`#data-table th:nth-child(${locationColIndex + 1}), #data-table td:nth-child(${locationColIndex + 1})`)
                .forEach(cell => cell.classList.toggle('hidden-col', isLocationEmpty));
        }

        function updateSortIndicators() {
            ui.tableHeader.querySelectorAll('.sortable').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                const key = th.dataset.sortKey;
                indicator.classList.remove('asc', 'desc');
                indicator.textContent = '';
                if (key === state.sort.key && state.sort.direction) {
                    indicator.classList.add(state.sort.direction);
                    indicator.textContent = state.sort.direction === 'asc' ? 'â–²' : 'â–¼';
                }
            });
        }

        function updateStats(data) {
            const visibleRows = data.length;
            const visibleWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh).toFixed(2) : '0.00';
            ui.statsDisplay.innerHTML = `
                í‘œì‹œ ê·¸ë£¹: <span class="font-bold text-white">${visibleRows}</span> | 
                ì‘ì—…ì ìˆ˜: <span class="font-bold text-white">${visibleWorkers}</span> | 
                ì´ ì‘ì—…ëŸ‰: <span class="font-bold text-white">${totalQty.toLocaleString()}</span> | 
                í‰ê·  HTP: <span class="font-bold text-white">${avgHtp}</span>`;
        }

        function updateTicker(data) {
            if (data.length === 0) {
                ui.tickerText.textContent = "Top/Low HTP ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
                return;
            }
            const sortedByHtp = [...data].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top3 = sortedByHtp.slice(0, 3);
            const low3 = sortedByHtp.filter(d => d.htp > 0).slice(-3).reverse();
            const formatTickerItem = (item) => `${item.employee.split('(')[0].trim()} (${item.htp})`;
            const topStr = "ğŸ†Top3: " + (top3.length > 0 ? top3.map(formatTickerItem).join(', ') : '-');
            const lowStr = "ğŸš¨Low3: " + (low3.length > 0 ? low3.map(formatTickerItem).join(', ') : '-');
            ui.tickerText.textContent = `${topStr}        ${lowStr}`;
        }

        function captureTable() {
            const tableEl = document.getElementById('data-table');
            showModal('ìº¡ì²˜ ì¤‘...', 1500);
            html2canvas(tableEl).then(canvas => {
                canvas.toBlob(blob => {
                    try {
                        navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                            .then(() => showModal('í…Œì´ë¸”ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'))
                            .catch(err => {
                                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                showModal('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            });
                    } catch (error) {
                         console.error('í´ë¦½ë³´ë“œ API ì˜¤ë¥˜:', error);
                         showModal('í´ë¦½ë³´ë“œ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
                    }
                });
            });
        }

        function exportToExcel() {
            if (globalRawData.length === 0) {
                showModal('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
            }
            let aggregatedData = aggregateData(timeFilteredRawData);
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(ì§‘í’ˆ)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(í¬ì¥)');
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            let dataToExport = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                 dataToExport = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                dataToExport = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                dataToExport = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            if (dataToExport.length === 0) {
                showModal('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const pickData = [], packData = [];
            dataToExport.forEach(item => {
                const rowData = {
                    'ì§‘í’ˆ/í¬ì¥': item.processType,
                    'ì´ë¦„(ì›ë°”ì½”ë“œ)': item.employee.replace(/[ğŸ‘‘ğŸ”¥ğŸ¢ğŸ¥‡ğŸ¥ˆğŸ¥‰]\s*/g, ''),
                    'ê³„ì•½ì§ ì—¬ë¶€': item.isPerm ? 'PERM' : 'TEMP',
                    'ì‘ì—…ëŸ‰': Number(item.unitQty),
                    'ë¡œì¼€ì´ì…˜ ë° ì‘ì—…ëŒ€': item.location || '-',
                    'PP': item.processPathName || '-',
                    'íŒ© ì¢…ë¥˜': item.packType,
                    'M/H': parseFloat(item.mh),
                    'HTP': parseFloat(item.htp.replace('ğŸš¨ ', ''))
                };
                if (rowData['ì§‘í’ˆ/í¬ì¥'].includes('PICK')) pickData.push(rowData);
                else packData.push(rowData);
            });
            pickData.sort((a, b) => a.HTP - b.HTP);
            packData.sort((a, b) => a.HTP - b.HTP);
            const wb = XLSX.utils.book_new();
            const createStyledSheet = (data, sheetName) => {
                if (!data || data.length === 0) return;
                const headers = Object.keys(data[0]);
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4F81BD" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };
                const cellStyle = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const headerAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                    if (ws[headerAddr]) ws[headerAddr].s = headerStyle;
                    for (let R = 1; R <= range.e.r; ++R) {
                        const cellAddr = XLSX.utils.encode_cell({ c: C, r: R });
                        if (ws[cellAddr]) {
                            if (!ws[cellAddr].s) ws[cellAddr].s = {};
                            Object.assign(ws[cellAddr].s, cellStyle);
                            if (typeof ws[cellAddr].v === 'number') {
                                if (headers[C] === 'M/H') ws[cellAddr].z = '0.0000';
                                else if (headers[C] === 'HTP') ws[cellAddr].z = '0.0';
                                else if (headers[C] === 'ì‘ì—…ëŸ‰') ws[cellAddr].z = '0';
                            }
                        }
                    }
                }
                const colWidths = headers.map((header, i) => {
                    const maxLength = Math.max(header.length, ...data.map(row => (row[header] ? row[header].toString().length : 0)));
                    return { wch: maxLength + 2 };
                });
                ws['!cols'] = colWidths;
                ws['!autofilter'] = { ref: ws['!ref'] };
                ws['!freeze'] = { ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            };
            createStyledSheet(pickData, "PICK(ì§‘í’ˆ)");
            createStyledSheet(packData, "PACK(í¬ì¥)");
            if (wb.SheetNames.length > 0) XLSX.writeFile(wb, "HTP_Data_Export_Styled.xlsx");
            else showModal('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        function updateStatus(status, message) {
    const dot = ui.statusIndicator.querySelector('.status-dot');
    const statusValue = ui.statusIndicator.querySelector('.status-value');
    
    dot.className = 'status-dot';
    if (status === 'connected') dot.classList.add('status-connected');
    else if (status === 'disconnected') dot.classList.add('status-disconnected');
    else if (status === 'loading') dot.classList.add('status-loading');
    
    if (statusValue) {
        statusValue.textContent = message;
    }
}

        function showLoader() { ui.loaderContainer.classList.remove('hidden'); ui.tableView.classList.add('hidden'); }
        function hideLoader() { ui.loaderContainer.classList.add('hidden'); ui.tableView.classList.remove('hidden'); }
        
        function showModal(message, duration = 3000) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out';
            modal.textContent = message;
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fade-in-out {
                    0% { opacity: 0; transform: translateY(-20px); }
                    10% { opacity: 1; transform: translateY(0); }
                    90% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
                .animate-fade-in-out { animation: fade-in-out ${duration / 1000}s ease-in-out forwards; }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
            setTimeout(() => { modal.remove(); style.remove(); }, duration);
        }

        // Initialize on page load
        initializeFiltersFromData([]);
	
	// --- Chart Functions ---
        Chart.register(ChartDataLabels);

        function updateDashboard(filteredAggregatedData, timeFilteredRawData) {
            updateKpiCards(filteredAggregatedData);
            updatePerformersLists(filteredAggregatedData);
            updateFloorHtpChart(filteredAggregatedData);
            updatePackTypeChart(filteredAggregatedData);
            updateProcessComparisonChart(filteredAggregatedData);
            updateHourlyTrendChart(timeFilteredRawData);
        }

        function generateColors(numColors) {
            const colors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(99, 102, 241, 0.7)'];
            const result = [];
            for (let i = 0; i < numColors; i++) result.push(colors[i % colors.length]);
            return result;
        }

        function updateKpiCards(data) {
            const totalWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const lowPerformers = data.filter(d => parseFloat(d.htp) < getTargetHtp(d)).length;
            ui.kpi.totalWorkers.textContent = totalWorkers.toLocaleString();
            ui.kpi.totalQty.textContent = totalQty.toLocaleString();
            ui.kpi.avgHtp.textContent = avgHtp.toFixed(1);
            ui.kpi.lowPerformers.textContent = lowPerformers.toLocaleString();
        }

        function updatePerformersLists(data) {
            ui.topPickPerformersList.innerHTML = '';
            ui.topPackPerformersList.innerHTML = '';
            if (data.length === 0) {
                ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
                ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
                return;
            }
            const pickData = data.filter(d => d.processType.includes('PICK'));
            const packData = data.filter(d => d.processType.includes('PACK'));
            pickData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            packData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top5Pick = pickData.slice(0, 5);
            const top5Pack = packData.slice(0, 5);
            const createListItem = (item) => `<li class="flex justify-between items-center bg-gray-700 p-2 rounded-md"><span>${item.employee.split('(')[0].trim()}</span><span class="font-bold text-green-400">${item.htp}</span></li>`;
            if (top5Pick.length > 0) top5Pick.forEach(item => ui.topPickPerformersList.innerHTML += createListItem(item));
            else ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
            if (top5Pack.length > 0) top5Pack.forEach(item => ui.topPackPerformersList.innerHTML += createListItem(item));
            else ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
        }

        function updateFloorHtpChart(data) {
            const pickData = data.filter(d => d.processType.includes('PICK'));
            const floorData = new Map();
            pickData.forEach(item => {
                if (!floorData.has(item.floor)) floorData.set(item.floor, { totalQty: 0, totalMh: 0 });
                const floor = floorData.get(item.floor);
                floor.totalQty += item.unitQty;
                floor.totalMh += parseFloat(item.mh);
            });
            const sortedFloors = Array.from(floorData.keys()).sort();
            const labels = sortedFloors;
            const avgHtps = sortedFloors.map(floor => {
                 const d = floorData.get(floor);
                 const weightedAvgHtp = d.totalMh > 0 ? (d.totalQty / d.totalMh) : 0;
                 return weightedAvgHtp.toFixed(1);
            });
            const ctx = document.getElementById('floor-htp-chart').getContext('2d');
            if (state.charts.floorHtp) state.charts.floorHtp.destroy();
            state.charts.floorHtp = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'í‰ê·  HTP', data: avgHtps, backgroundColor: generateColors(labels.length), borderColor: '#4b5563', borderWidth: 1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#FFFFFF', font: { weight: 'bold' }, formatter: (value) => value > 0 ? value : '' } }
                }
            });
        }

        function updatePackTypeChart(data) {
            const packData = data.filter(d => d.processType.includes('PACK'));
            let packTypeData = new Map(), totalQuantity = 0;
            packData.forEach(item => {
                if (!packTypeData.has(item.packType)) packTypeData.set(item.packType, 0);
                const currentQty = packTypeData.get(item.packType);
                packTypeData.set(item.packType, currentQty + item.unitQty);
                totalQuantity += item.unitQty;
            });
            const otherThreshold = 0.02;
            let otherQuantity = 0;
            const finalPackData = new Map();
            packTypeData.forEach((qty, type) => {
                if (totalQuantity > 0 && (qty / totalQuantity) < otherThreshold) otherQuantity += qty;
                else finalPackData.set(type, qty);
            });
            if (otherQuantity > 0) finalPackData.set('ê¸°íƒ€', (finalPackData.get('ê¸°íƒ€') || 0) + otherQuantity);
            const labels = Array.from(finalPackData.keys());
            const quantities = Array.from(finalPackData.values());
            const ctx = document.getElementById('pack-type-chart').getContext('2d');
            if (state.charts.packType) state.charts.packType.destroy();
            state.charts.packType = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ label: 'ì‘ì—…ëŸ‰', data: quantities, backgroundColor: generateColors(labels.length), borderColor: '#374151', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#d1d5db' } },
                        datalabels: { color: '#FFFFFF', textAlign: 'center', font: { weight: 'bold' }, formatter: (value, context) => {
                            const percentage = totalQuantity > 0 ? (value / totalQuantity * 100).toFixed(1) : 0;
                            const label = context.chart.data.labels[context.dataIndex];
                            if (parseFloat(percentage) < 5) return '';
                            return `${label}\n${percentage}%`;
                        }}
                    }
                }
            });
        }

        function updateProcessComparisonChart(data) {
            const processStats = { PICK: { totalQty: 0, totalMh: 0 }, PACK: { totalQty: 0, totalMh: 0 } };
            data.forEach(item => {
                const type = item.processType.includes('PICK') ? 'PICK' : 'PACK';
                processStats[type].totalQty += item.unitQty;
                processStats[type].totalMh += parseFloat(item.mh);
            });
            const pickHtp = processStats.PICK.totalMh > 0 ? (processStats.PICK.totalQty / processStats.PICK.totalMh) : 0;
            const packHtp = processStats.PACK.totalMh > 0 ? (processStats.PACK.totalQty / processStats.PACK.totalMh) : 0;
            const ctx = document.getElementById('process-comparison-chart').getContext('2d');
            if (state.charts.processComparison) state.charts.processComparison.destroy();
            state.charts.processComparison = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['PICK(ì§‘í’ˆ)', 'PACK(í¬ì¥)'], datasets: [{ label: 'ì´ ì‘ì—…ëŸ‰', data: [processStats.PICK.totalQty, processStats.PACK.totalQty], backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: '#374151', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#d1d5db' } },
                        datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (value, context) => {
                            const label = context.chart.data.labels[context.dataIndex];
                            const htp = label.includes('PICK') ? pickHtp : packHtp;
                            return `${value.toLocaleString()}\n(Avg ${htp.toFixed(0)} HTP)`;
                        }}
                    }
                }
            });
        }
        
        function updateHourlyTrendChart(rawData) {
             const hourlyData = new Map();
             for(let i=0; i<24; i++) hourlyData.set(i, { unitQty: 0, totalSeconds: 0 });
             rawData.forEach(item => {
                const hour = item.htpStart.getUTCHours();
                const stats = hourlyData.get(hour);
                if(stats){
                    stats.unitQty += item.unitQty;
                    stats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
                }
             });
            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour.toString().padStart(2, '0')}:00`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                if (!stats || stats.totalSeconds <= 0) return 0;
                const mh = stats.totalSeconds / 3600;
                return (stats.unitQty / mh).toFixed(1);
            });
            const ctx = document.getElementById('hourly-htp-chart').getContext('2d');
            if (state.charts.hourlyHtp) state.charts.hourlyHtp.destroy();
            state.charts.hourlyHtp = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'ì‹œê°„ë³„ í‰ê·  HTP', data: htpValues, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.3 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } } },
                    plugins: { legend: { display: false }, datalabels: { display: false } }
                }
            });
        }

        function showIndividualTrend(employeeName, processType) {
            employeeName = employeeName.replace(/[ğŸ‘‘ğŸ”¥ğŸ¢ğŸ¥‡ğŸ¥ˆğŸ¥‰]\s*/g, '').trim();
            const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
            const employeeData = globalRawData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
            
            if (employeeData.length === 0) {
                showModal(`${employeeName.split('(')[0]} ë‹˜ì˜ í•´ë‹¹ ê³µì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const hourlyData = new Map();
            employeeData.forEach(item => {
                const hour = item.htpStart.getUTCHours();
                if (!hourlyData.has(hour)) hourlyData.set(hour, { unitQty: 0, totalSeconds: 0 });
                const hourStats = hourlyData.get(hour);
                hourStats.unitQty += item.unitQty;
                hourStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            });

            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour}ì‹œ`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                const mh = stats.totalSeconds / 3600;
                return mh > 0 ? (stats.unitQty / mh).toFixed(1) : 0;
            });

            const totalQty = employeeData.reduce((sum, item) => sum + item.unitQty, 0);
            const totalSeconds = employeeData.reduce((sum, item) => sum + (item.htpEnd - item.htpStart) / 1000, 0);
            const totalMh = totalSeconds / 3600;
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const maxHtp = Math.max(...htpValues.map(v => parseFloat(v)));
            const minHtp = Math.min(...htpValues.filter(v => v > 0).map(v => parseFloat(v)));
            const maxHour = sortedHours[htpValues.indexOf(maxHtp.toString())];
            
            const hourlyRanks = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                const mh = stats.totalSeconds / 3600;
                const employeeHtp = mh > 0 ? stats.unitQty / mh : 0;
                
                const sameHourData = globalRawData.filter(d => 
                    d.processTask === targetProcessTask && 
                    d.htpStart.getUTCHours() === hour
                );
                
                const employeeHtps = new Map();
                sameHourData.forEach(item => {
                    if (!employeeHtps.has(item.employee)) {
                        employeeHtps.set(item.employee, { unitQty: 0, totalSeconds: 0 });
                    }
                    const empStats = employeeHtps.get(item.employee);
                    empStats.unitQty += item.unitQty;
                    empStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
                });
                
                const htpList = Array.from(employeeHtps.values())
                    .map(s => s.totalSeconds > 0 ? s.unitQty / (s.totalSeconds / 3600) : 0)
                    .sort((a, b) => b - a);
                
                const rank = htpList.findIndex(h => h <= employeeHtp) + 1;
                const total = htpList.length;
                
                return { hour, rank, total };
            });

            const employeeBadge = employeeBadges[employeeName] || { badges: [], streaks: {}, records: {} };
            const badgesHtml = employeeBadge.badges.length > 0 
                ? employeeBadge.badges.map(b => `<span class="badge badge-${b.level}">${b.name}</span>`).join(' ')
                : '<span class="text-gray-500">íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤</span>';

            ui.chartModalTitle.textContent = `${employeeName} ë‹˜ì˜ ìƒì„¸ ë¶„ì„ (${processType.split('(')[0]})`;
            const modalContent = document.getElementById('chart-modal-content');
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">${employeeName} ë‹˜ì˜ ìƒì„¸ ë¶„ì„ (${processType.split('(')[0]})</h3>
                
                <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ… íšë“ ë±ƒì§€</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${badgesHtml}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ“Š ì˜¤ëŠ˜ì˜ ì„±ê³¼ ìš”ì•½</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">í‰ê·  HTP</div>
                                <div style="color: var(--text-primary); font-size: 20px; font-weight: 700;">${avgHtp.toFixed(1)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">ìµœê³  HTP</div>
                                <div style="color: #4ade80; font-size: 20px; font-weight: 700;">${maxHtp.toFixed(1)}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">${maxHour}ì‹œ</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">ìµœì € HTP</div>
                                <div style="color: #f87171; font-size: 20px; font-weight: 700;">${minHtp > 0 ? minHtp.toFixed(1) : '-'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">ì´ ì‘ì—…ëŸ‰</div>
                                <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalQty.toLocaleString()}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">Unit</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">ì´ ì‘ì—…ì‹œê°„</div>
                                <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalMh.toFixed(1)}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">ì‹œê°„</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">ëª©í‘œ ëŒ€ë¹„</div>
                                <div style="color: ${avgHtp >= getTargetHtp({processType: processType}) ? '#4ade80' : '#f87171'}; font-size: 18px; font-weight: 700;">
                                    ${((avgHtp / getTargetHtp({processType: processType}) - 1) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; max-height: 180px; overflow-y: auto;">
                        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ† ì‹œê°„ëŒ€ë³„ ìˆœìœ„</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${hourlyRanks.map(r => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-secondary); border-radius: 6px;">
                                    <span style="color: var(--text-primary); font-weight: 600; font-size: 13px;">${r.hour}ì‹œ</span>
                                    <span style="color: ${r.rank <= 3 ? '#fbbf24' : r.rank <= r.total / 2 ? '#4ade80' : '#94a3b8'}; font-weight: 700; font-size: 13px;">
                                        ${r.rank}ìœ„ / ${r.total}ëª… ${r.rank === 1 ? 'ğŸ‘‘' : r.rank <= 3 ? 'â­' : ''}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="flex-grow" style="min-height: 300px;">
                    <canvas id="individual-htp-chart"></canvas>
                </div>
                <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            const ctx = document.getElementById('individual-htp-chart').getContext('2d');
            if (state.charts.individualHtp) state.charts.individualHtp.destroy();
            state.charts.individualHtp = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'ì‹œê°„ë³„ HTP', data: htpValues, fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                    plugins: { legend: { labels: { color: '#d1d5db' } }, datalabels: { align: 'top', color: '#FFFFFF' } }
                }
            });
            
            document.getElementById('chart-modal-close').addEventListener('click', () => {
                ui.chartModalBackdrop.classList.add('hidden');
                ui.chartModalBackdrop.classList.remove('flex');
            });

            ui.chartModalBackdrop.classList.remove('hidden');
            ui.chartModalBackdrop.classList.add('flex');
        }

        // ğŸ†• ì´ ë¶€ë¶„ì€ ë„ˆë¬´ ê¸¸ì–´ì„œ ë‹¤ìŒ ë©”ì‹œì§€ì—ì„œ ê³„ì†ë©ë‹ˆë‹¤
		// --- ğŸ†• Calendar View Functions ---
        function renderCalendarView() {
            const year = state.calendarCurrentMonth.getFullYear();
            const month = state.calendarCurrentMonth.getMonth();
            
            // Update title
            ui.calendarMonthTitle.textContent = `${year}ë…„ ${month + 1}ì›”`;
            
            // Clear existing calendar days (keep headers)
            const existingDays = ui.calendarGrid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day inactive';
                ui.calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = historyData[dateStr];
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                // Check if today
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayEl.classList.add('today');
                }
                
                if (dayData && dayData.length > 0) {
                    // Calculate average HTP for the day
                    const aggregated = aggregateData(dayData);
                    const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
                    const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                    const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
                    
                    // Determine performance level
                    const targetHtp = 90; // Base target
                    const performanceRatio = avgHtp / targetHtp;
                    
                    if (performanceRatio >= 1.2) dayEl.classList.add('excellent');
                    else if (performanceRatio >= 1.0) dayEl.classList.add('good');
                    else if (performanceRatio >= 0.8) dayEl.classList.add('average');
                    else dayEl.classList.add('poor');
                    
                    dayEl.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-day-htp" style="color: var(--text-primary);">HTP ${avgHtp.toFixed(0)}</div>
                    `;
                    
                    dayEl.addEventListener('click', () => showCalendarDayDetail(dateStr));
                } else {
                    dayEl.classList.add('no-data');
                    dayEl.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-day-htp" style="color: var(--text-tertiary); font-size: 0.65rem;">ë°ì´í„° ì—†ìŒ</div>
                    `;
                }
                
                ui.calendarGrid.appendChild(dayEl);
            }
        }

        function showCalendarDayDetail(dateStr) {
            const dayData = historyData[dateStr];
            if (!dayData || dayData.length === 0) {
                showModal('í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const aggregated = aggregateData(dayData);
            const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const workerCount = new Set(aggregated.map(d => d.employee)).size;
            const targetHtp = 90;
            const targetRate = ((avgHtp / targetHtp) * 100).toFixed(0);
            
            // Update modal content
            document.getElementById('calendar-detail-title').textContent = `${dateStr} ìƒì„¸ ì •ë³´`;
            document.getElementById('calendar-detail-avg-htp').textContent = avgHtp.toFixed(1);
            document.getElementById('calendar-detail-total-qty').textContent = totalQty.toLocaleString();
            document.getElementById('calendar-detail-worker-count').textContent = workerCount;
            document.getElementById('calendar-detail-target-rate').textContent = targetRate + '%';
            
            // Top 5 performers
            const sorted = [...aggregated].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top5 = sorted.slice(0, 5);
            const topListHtml = top5.map((item, index) => `
                <div class="flex justify-between items-center bg-gray-600 p-2 rounded-md">
                    <span class="font-semibold">${index + 1}. ${item.employee.split('(')[0].trim()}</span>
                    <span class="font-bold text-green-400">${item.htp} HTP</span>
                </div>
            `).join('');
            document.getElementById('calendar-detail-top-list').innerHTML = topListHtml;
            
            // Process distribution chart
            const pickData = aggregated.filter(d => d.processType.includes('PICK'));
            const packData = aggregated.filter(d => d.processType.includes('PACK'));
            const pickQty = pickData.reduce((sum, d) => sum + d.unitQty, 0);
            const packQty = packData.reduce((sum, d) => sum + d.unitQty, 0);
            
            const ctx = document.getElementById('calendar-detail-chart').getContext('2d');
            if (state.charts.calendarDetailChart) state.charts.calendarDetailChart.destroy();
            state.charts.calendarDetailChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['PICK', 'PACK'],
                    datasets: [{
                        data: [pickQty, packQty],
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                        borderColor: '#374151',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#d1d5db' } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: (value) => value.toLocaleString()
                        }
                    }
                }
            });
            
            ui.calendarDetailModalBackdrop.classList.remove('hidden');
            ui.calendarDetailModalBackdrop.classList.add('flex');
        }

        // --- ğŸ†• Ranking View Functions ---
        function renderRankingView() {
            const filteredDates = getRankingFilteredDates();
            if (filteredDates.length === 0) {
                ui.rankingList.innerHTML = '<div class="text-center py-10 text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // Aggregate data for the period
            let allAggregatedData = [];
            filteredDates.forEach(date => {
                const dayData = historyData[date];
                if (dayData) {
                    const aggregated = aggregateData(dayData);
                    allAggregatedData = allAggregatedData.concat(aggregated.map(item => ({ ...item, date })));
                }
            });
            
            // Filter by process type
            const processFilter = state.rankingProcessType === 'pick' ? 'PICK(ì§‘í’ˆ)' : 'PACK(í¬ì¥)';
            const filteredData = allAggregatedData.filter(d => d.processType === processFilter);
            
            // Calculate average HTP per employee
            const employeeStats = new Map();
            filteredData.forEach(item => {
                if (!employeeStats.has(item.employee)) {
                    employeeStats.set(item.employee, { totalQty: 0, totalMh: 0 });
                }
                const stats = employeeStats.get(item.employee);
                stats.totalQty += item.unitQty;
                stats.totalMh += parseFloat(item.mh);
            });
            
            const rankings = [];
            employeeStats.forEach((stats, employee) => {
                const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                rankings.push({ employee, avgHtp: avgHtp.toFixed(1), totalQty: stats.totalQty });
            });
            
            // Sort by HTP
            rankings.sort((a, b) => parseFloat(b.avgHtp) - parseFloat(a.avgHtp));
            
            // Update statistics
            ui.rankingTotalCount.textContent = rankings.length;
            const avgHtp = rankings.length > 0 ? (rankings.reduce((sum, r) => sum + parseFloat(r.avgHtp), 0) / rankings.length) : 0;
            const maxHtp = rankings.length > 0 ? Math.max(...rankings.map(r => parseFloat(r.avgHtp))) : 0;
            const medianHtp = rankings.length > 0 ? parseFloat(rankings[Math.floor(rankings.length / 2)].avgHtp) : 0;
            
            ui.rankingAvgHtp.textContent = avgHtp.toFixed(1);
            ui.rankingMaxHtp.textContent = maxHtp.toFixed(1);
            ui.rankingMedianHtp.textContent = medianHtp.toFixed(1);
            
            // Update podium (Top 3)
            if (rankings.length >= 1) {
                document.getElementById('podium-1-name').textContent = rankings[0].employee.split('(')[0].trim();
                document.getElementById('podium-1-score').textContent = rankings[0].avgHtp;
            } else {
                document.getElementById('podium-1-name').textContent = '-';
                document.getElementById('podium-1-score').textContent = '0';
            }
            
            if (rankings.length >= 2) {
                document.getElementById('podium-2-name').textContent = rankings[1].employee.split('(')[0].trim();
                document.getElementById('podium-2-score').textContent = rankings[1].avgHtp;
            } else {
                document.getElementById('podium-2-name').textContent = '-';
                document.getElementById('podium-2-score').textContent = '0';
            }
            
            if (rankings.length >= 3) {
                document.getElementById('podium-3-name').textContent = rankings[2].employee.split('(')[0].trim();
                document.getElementById('podium-3-score').textContent = rankings[2].avgHtp;
            } else {
                document.getElementById('podium-3-name').textContent = '-';
                document.getElementById('podium-3-score').textContent = '0';
            }
            
            // Update ranking list
            ui.rankingList.innerHTML = '';
            rankings.forEach((rank, index) => {
                const position = index + 1;
                const previousRank = previousRankings[rank.employee] || position;
                const change = previousRank - position;
                
                let changeHtml = '';
                if (change > 0) {
                    changeHtml = `<span class="ranking-change up">â–²${change}</span>`;
                } else if (change < 0) {
                    changeHtml = `<span class="ranking-change down">â–¼${Math.abs(change)}</span>`;
                } else {
                    changeHtml = `<span class="ranking-change same">-</span>`;
                }
                
                const item = document.createElement('div');
                item.className = 'ranking-item';
                item.innerHTML = `
                    <div class="ranking-position">#${position}</div>
                    <div class="ranking-employee">${rank.employee.split('(')[0].trim()}</div>
                    <div class="ranking-htp">${rank.avgHtp}${changeHtml}</div>
                `;
                
                // Click to show employee detail
                item.addEventListener('click', () => {
                    const processType = state.rankingProcessType === 'pick' ? 'PICK(ì§‘í’ˆ)' : 'PACK(í¬ì¥)';
                    showEmployeeDetailModal(rank.employee, processType);
                });
                
                ui.rankingList.appendChild(item);
            });
            
            // Save current rankings for next comparison
            previousRankings = {};
            rankings.forEach((rank, index) => {
                previousRankings[rank.employee] = index + 1;
            });
        }

        function getRankingFilteredDates() {
            const allDates = Object.keys(historyData).sort();
            if (allDates.length === 0) return [];
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            if (state.rankingPeriod === 'daily') {
                return allDates.filter(date => date === todayStr);
            } else if (state.rankingPeriod === 'weekly') {
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
                return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
            } else if (state.rankingPeriod === 'monthly') {
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
            } else if (state.rankingPeriod === 'all-time') {
                return allDates;
            }
            return allDates;
        }

        // --- ğŸ†• Employee Detail Modal Functions ---
        function showEmployeeDetailModal(employeeName, processType) {
            employeeName = employeeName.replace(/[ğŸ‘‘ğŸ”¥ğŸ¢ğŸ¥‡ğŸ¥ˆğŸ¥‰]\s*/g, '').trim();
            const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
            
            // Gather all historical data for this employee
            const employeeHistoryData = [];
            Object.keys(historyData).sort().forEach(date => {
                const dayData = historyData[date];
                const employeeData = dayData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
                if (employeeData.length > 0) {
                    const aggregated = aggregateData(employeeData);
                    aggregated.forEach(item => {
                        employeeHistoryData.push({ ...item, date });
                    });
                }
            });
            
            if (employeeHistoryData.length === 0) {
                showModal(`${employeeName.split('(')[0]} ë‹˜ì˜ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            // Calculate statistics
            const totalDays = new Set(employeeHistoryData.map(d => d.date)).size;
            const totalQty = employeeHistoryData.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = employeeHistoryData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const maxHtp = Math.max(...employeeHistoryData.map(d => parseFloat(d.htp)));
            const targetHtp = getTargetHtp({ processType });
            const targetRate = ((avgHtp / targetHtp) * 100).toFixed(0);
            
            // Calculate trend (last 7 days vs previous 7 days)
            const sortedDates = [...new Set(employeeHistoryData.map(d => d.date))].sort();
            const last7Days = sortedDates.slice(-7);
            const prev7Days = sortedDates.slice(-14, -7);
            
            const last7Data = employeeHistoryData.filter(d => last7Days.includes(d.date));
            const prev7Data = employeeHistoryData.filter(d => prev7Days.includes(d.date));
            
            const last7Mh = last7Data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const last7Qty = last7Data.reduce((sum, d) => sum + d.unitQty, 0);
            const last7Htp = last7Mh > 0 ? last7Qty / last7Mh : 0;
            
            const prev7Mh = prev7Data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const prev7Qty = prev7Data.reduce((sum, d) => sum + d.unitQty, 0);
            const prev7Htp = prev7Mh > 0 ? prev7Qty / prev7Mh : 0;
            
            const trendPercent = prev7Htp > 0 ? (((last7Htp - prev7Htp) / prev7Htp) * 100).toFixed(1) : 0;
            const trendPositive = parseFloat(trendPercent) >= 0;
            
            // Calculate rank (based on current ranking view)
            const currentRankings = ui.rankingList.querySelectorAll('.ranking-item');
            let rank = '-';
            currentRankings.forEach((item, index) => {
                const empName = item.querySelector('.ranking-employee').textContent;
                if (empName === employeeName.split('(')[0].trim()) {
                    rank = `#${index + 1}`;
                }
            });
            
            // Update modal
            document.getElementById('employee-detail-name').textContent = employeeName.split('(')[0].trim();
            document.getElementById('employee-detail-subtitle').textContent = processType;
            document.getElementById('employee-detail-total-days').textContent = totalDays;
            document.getElementById('employee-detail-avg-htp').textContent = avgHtp.toFixed(1);
            document.getElementById('employee-detail-max-htp').textContent = maxHtp.toFixed(1);
            document.getElementById('employee-detail-total-qty').textContent = totalQty.toLocaleString();
            document.getElementById('employee-detail-target-rate').textContent = targetRate + '%';
            document.getElementById('employee-detail-rank').textContent = rank;
            
            // Update trend indicator
            const trendEl = document.getElementById('employee-detail-avg-trend');
            trendEl.className = trendPositive ? 'trend-indicator positive mt-2' : 'trend-indicator negative mt-2';
            trendEl.innerHTML = `<span>${trendPositive ? 'â†‘' : 'â†“'}</span><span>${trendPositive ? '+' : ''}${trendPercent}%</span>`;
            
            // Update badges
            const employeeBadge = employeeBadges[employeeName] || { badges: [] };
            const badgesHtml = employeeBadge.badges.length > 0
                ? employeeBadge.badges.map(b => `<span class="badge badge-${b.level}">${b.name}</span>`).join(' ')
                : '<span class="text-gray-400">íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤</span>';
            document.getElementById('employee-detail-badges').innerHTML = badgesHtml;
            
            // Daily HTP Chart
            const dailyData = new Map();
            employeeHistoryData.forEach(item => {
                if (!dailyData.has(item.date)) {
                    dailyData.set(item.date, { totalQty: 0, totalMh: 0 });
                }
                const stats = dailyData.get(item.date);
                stats.totalQty += item.unitQty;
                stats.totalMh += parseFloat(item.mh);
            });
            
            const sortedDailyDates = [...dailyData.keys()].sort().slice(-30); // Last 30 days
            const dailyLabels = sortedDailyDates.map(d => d.substring(5)); // MM-DD
            const dailyHtps = sortedDailyDates.map(date => {
                const stats = dailyData.get(date);
                return stats.totalMh > 0 ? (stats.totalQty / stats.totalMh).toFixed(1) : 0;
            });
            
            const dailyCtx = document.getElementById('employee-detail-daily-chart').getContext('2d');
            if (state.charts.employeeDailyChart) state.charts.employeeDailyChart.destroy();
            state.charts.employeeDailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'ì¼ë³„ HTP',
                        data: dailyHtps,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });
            
            // Daily Qty Chart
            const dailyQtys = sortedDailyDates.map(date => dailyData.get(date).totalQty);
            const qtyCtx = document.getElementById('employee-detail-qty-chart').getContext('2d');
            if (state.charts.employeeQtyChart) state.charts.employeeQtyChart.destroy();
            state.charts.employeeQtyChart = new Chart(qtyCtx, {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'ì¼ë³„ ì‘ì—…ëŸ‰',
                        data: dailyQtys,
                        backgroundColor: 'rgba(245, 158, 11, 0.7)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });
            
            // Weekly comparison chart
            const weeklyData = [];
            for (let i = 0; i < sortedDailyDates.length; i += 7) {
                const weekDates = sortedDailyDates.slice(i, i + 7);
                const weekData = employeeHistoryData.filter(d => weekDates.includes(d.date));
                const weekMh = weekData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                const weekQty = weekData.reduce((sum, d) => sum + d.unitQty, 0);
                const weekHtp = weekMh > 0 ? weekQty / weekMh : 0;
                weeklyData.push({
                    label: `${weekDates[0].substring(5)}~${weekDates[weekDates.length - 1].substring(5)}`,
                    htp: weekHtp.toFixed(1)
                });
            }
            
            const weeklyCtx = document.getElementById('employee-detail-weekly-chart').getContext('2d');
            if (state.charts.employeeWeeklyChart) state.charts.employeeWeeklyChart.destroy();
            state.charts.employeeWeeklyChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map(w => w.label),
                    datasets: [{
                        label: 'ì£¼ê°„ í‰ê·  HTP',
                        data: weeklyData.map(w => w.htp),
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#FFFFFF',
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
            
            // Recent 10 days table
            const recent10 = sortedDailyDates.slice(-10).reverse();
            const tableHtml = recent10.map(date => {
                const stats = dailyData.get(date);
                const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh).toFixed(1) : 0;
                
                // Calculate rank for that day
                const dayFullData = historyData[date];
                if (dayFullData) {
                    const allAggregated = aggregateData(dayFullData);
                    const sameProcess = allAggregated.filter(d => d.processType === processType);
                    sameProcess.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
                    const rankIndex = sameProcess.findIndex(d => d.employee === employeeName);
                    const dayRank = rankIndex >= 0 ? `#${rankIndex + 1}` : '-';
                    
                    return `
                        <tr class="border-b border-gray-700">
                            <td class="px-4 py-2">${date}</td>
                            <td class="px-4 py-2">${stats.totalQty.toLocaleString()}</td>
                            <td class="px-4 py-2">${stats.totalMh.toFixed(2)}</td>
                            <td class="px-4 py-2 font-bold ${parseFloat(htp) >= targetHtp ? 'text-green-400' : 'text-red-400'}">${htp}</td>
                            <td class="px-4 py-2">${dayRank}</td>
                        </tr>
                    `;
                }
                return '';
            }).join('');
            
            document.getElementById('employee-detail-recent-table').innerHTML = tableHtml;
            
            // Show modal
            ui.employeeDetailModalBackdrop.classList.remove('hidden');
            ui.employeeDetailModalBackdrop.classList.add('flex');
        }

        function getFilteredHistoryDates() {
            const allDates = Object.keys(historyData).sort();
            if (allDates.length === 0) return [];

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            if (state.historyPeriod === 'week') {
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
                return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
            } else if (state.historyPeriod === 'month') {
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
            } else if (state.historyPeriod === 'all') {
                return allDates;
            } else if (state.historyPeriod === 'custom') {
                const { start, end } = state.historyDateRange;
                return allDates.filter(date => date >= start && date <= end);
            }
            return allDates;
        }

        function updateHistoryDailyTrendChart(dates) {
            const labels = dates.map(d => d.substring(5));
            const avgHtps = dates.map(date => {
                const dayData = historyData[date];
                if (!dayData) return 0;
                const aggregated = aggregateData(dayData);
                const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
                const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                return totalMh > 0 ? (totalQty / totalMh) : 0;
            });

            const ctx = document.getElementById('history-daily-trend-chart').getContext('2d');
            if (state.charts.historyDailyTrend) state.charts.historyDailyTrend.destroy();
            state.charts.historyDailyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ë³„ í‰ê·  HTP',
                        data: avgHtps,
                        fill: true,
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        legend: { labels: { color: '#d1d5db' } },
                        datalabels: { display: false }
                    }
                }
            });
        }

        function updateHistoryDailyQtyChart(dates) {
            const labels = dates.map(d => d.substring(5));
            const dailyQtys = dates.map(date => {
                const dayData = historyData[date];
                if (!dayData) return 0;
                const aggregated = aggregateData(dayData);
                return aggregated.reduce((sum, d) => sum + d.unitQty, 0);
            });

            const ctx = document.getElementById('history-daily-qty-chart').getContext('2d');
            if (state.charts.historyDailyQty) state.charts.historyDailyQty.destroy();
            state.charts.historyDailyQty = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ë³„ ì´ ì‘ì—…ëŸ‰',
                        data: dailyQtys,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });
        }

        function updateHistoryTopPerformers(allData) {
            const employeeStats = new Map();
            
            allData.forEach(item => {
                const key = `${item.employee}|${item.processType}`;
                if (!employeeStats.has(key)) {
                    employeeStats.set(key, {
                        employee: item.employee,
                        processType: item.processType,
                        totalQty: 0,
                        totalMh: 0
                    });
                }
                const stats = employeeStats.get(key);
                stats.totalQty += item.unitQty;
                stats.totalMh += parseFloat(item.mh);
            });

            const employeeList = [];
            employeeStats.forEach(stats => {
                const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                employeeList.push({
                    employee: stats.employee,
                    processType: stats.processType,
                    avgHtp: avgHtp,
                    totalQty: stats.totalQty
                });
            });

            const pickList = employeeList
                .filter(e => e.processType.includes('PICK'))
                .sort((a, b) => b.avgHtp - a.avgHtp)
                .slice(0, 10);

            const packList = employeeList
                .filter(e => e.processType.includes('PACK'))
                .sort((a, b) => b.avgHtp - a.avgHtp)
                .slice(0, 10);

            ui.historyTopPickList.innerHTML = '';
            ui.historyTopPackList.innerHTML = '';

            if (pickList.length === 0) {
                ui.historyTopPickList.innerHTML = '<div class="text-gray-500 text-center py-4">ë°ì´í„° ì—†ìŒ</div>';
            } else {
                pickList.forEach((item, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-md cursor-pointer hover:bg-gray-600';
                    div.innerHTML = `
                        <span class="font-semibold">${medal} ${item.employee.split('(')[0].trim()}</span>
                        <span class="text-green-400 font-bold">${item.avgHtp.toFixed(1)} HTP</span>
                    `;
                    div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PICK(ì§‘í’ˆ)'));
                    ui.historyTopPickList.appendChild(div);
                });
            }

            if (packList.length === 0) {
                ui.historyTopPackList.innerHTML = '<div class="text-gray-500 text-center py-4">ë°ì´í„° ì—†ìŒ</div>';
            } else {
                packList.forEach((item, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-md cursor-pointer hover:bg-gray-600';
                    div.innerHTML = `
                        <span class="font-semibold">${medal} ${item.employee.split('(')[0].trim()}</span>
                        <span class="text-green-400 font-bold">${item.avgHtp.toFixed(1)} HTP</span>
                    `;
                    div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PACK(í¬ì¥)'));
                    ui.historyTopPackList.appendChild(div);
                });
            }
        }

        function exportHistoryToExcel() {
            const filteredDates = getFilteredHistoryDates();
            if (filteredDates.length === 0) {
                showModal('ë‚´ë³´ë‚¼ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const wb = XLSX.utils.book_new();

            const summaryData = [];
            filteredDates.forEach(date => {
                const dayData = historyData[date];
                if (!dayData) return;
                const aggregated = aggregateData(dayData);
                const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
                const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
                const workers = new Set(aggregated.map(d => d.employee)).size;

                summaryData.push({
                    'ë‚ ì§œ': date,
                    'ì‘ì—…ì ìˆ˜': workers,
                    'ì´ ì‘ì—…ëŸ‰': totalQty,
                    'ì´ M/H': parseFloat(totalMh.toFixed(2)),
                    'í‰ê·  HTP': parseFloat(avgHtp.toFixed(1))
                });
            });

            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'ì¼ë³„ ìš”ì•½');

            const detailedData = [];
            filteredDates.forEach(date => {
                const dayData = historyData[date];
                if (!dayData) return;
                const aggregated = aggregateData(dayData);
                aggregated.forEach(item => {
                    detailedData.push({
                        'ë‚ ì§œ': date,
                        'ì§‘í’ˆ/í¬ì¥': item.processType,
                        'ì´ë¦„(ì›ë°”ì½”ë“œ)': item.employee.replace(/[ğŸ‘‘ğŸ”¥ğŸ¢ğŸ¥‡ğŸ¥ˆğŸ¥‰]\s*/g, ''),
                        'ê³„ì•½ì§ ì—¬ë¶€': item.isPerm ? 'PERM' : 'TEMP',
                        'ì‘ì—…ëŸ‰': item.unitQty,
                        'ë¡œì¼€ì´ì…˜': item.location || '-',
                        'PP': item.processPathName || '-',
                        'íŒ© ì¢…ë¥˜': item.packType,
                        'M/H': parseFloat(item.mh),
                        'HTP': parseFloat(item.htp)
                    });
                });
            });

            const detailedWs = XLSX.utils.json_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(wb, detailedWs, 'ìƒì„¸ ë°ì´í„°');

            const filename = `HTP_History_${filteredDates[0]}_to_${filteredDates[filteredDates.length - 1]}.xlsx`;
            XLSX.writeFile(wb, filename);
            showModal('íˆìŠ¤í† ë¦¬ ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function exportHistoryToPDF() {
            showModal('PDF ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 2000);
            
            const filteredDates = getFilteredHistoryDates();
            if (filteredDates.length === 0) {
                showModal('ë‚´ë³´ë‚¼ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let allAggregatedData = [];
            filteredDates.forEach(date => {
                const dayData = historyData[date];
                if (dayData) {
                    const aggregated = aggregateData(dayData);
                    allAggregatedData = allAggregatedData.concat(aggregated);
                }
            });

            const totalDays = filteredDates.length;
            const totalQty = allAggregatedData.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = allAggregatedData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const maxHtp = Math.max(...allAggregatedData.map(d => parseFloat(d.htp)), 0);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('GWJ2 OB HTP íˆìŠ¤í† ë¦¬ ë¦¬í¬íŠ¸', 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.text(`ê¸°ê°„: ${filteredDates[0]} ~ ${filteredDates[filteredDates.length - 1]}`, 105, 30, { align: 'center' });

            doc.setFontSize(14);
            doc.text('ìš”ì•½ í†µê³„', 20, 45);
            doc.setFontSize(11);
            doc.text(`ì´ ì‘ì—… ì¼ìˆ˜: ${totalDays}ì¼`, 20, 55);
            doc.text(`ëˆ„ì  ì‘ì—…ëŸ‰: ${totalQty.toLocaleString()} Unit`, 20, 65);
            doc.text(`í‰ê·  HTP: ${avgHtp.toFixed(1)}`, 20, 75);
            doc.text(`ìµœê³  HTP: ${maxHtp.toFixed(1)}`, 20, 85);

            doc.setFontSize(14);
            doc.text('ê¸°ê°„ ë‚´ Top 5 ì‘ì—…ì', 20, 100);

            const employeeStats = new Map();
            allAggregatedData.forEach(item => {
                const key = `${item.employee}|${item.processType}`;
                if (!employeeStats.has(key)) {
                    employeeStats.set(key, { employee: item.employee, processType: item.processType, totalQty: 0, totalMh: 0 });
                }
                const stats = employeeStats.get(key);
                stats.totalQty += item.unitQty;
                stats.totalMh += parseFloat(item.mh);
            });

            const employeeList = [];
            employeeStats.forEach(stats => {
                const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                employeeList.push({ employee: stats.employee, processType: stats.processType, avgHtp: avgHtp });
            });

            const topPick = employeeList.filter(e => e.processType.includes('PICK')).sort((a, b) => b.avgHtp - a.avgHtp).slice(0, 5);
            const topPack = employeeList.filter(e => e.processType.includes('PACK')).sort((a, b) => b.avgHtp - a.avgHtp).slice(0, 5);

            doc.setFontSize(12);
            doc.text('PICK (ì§‘í’ˆ)', 20, 110);
            doc.setFontSize(10);
            let yPos = 120;
            topPick.forEach((item, i) => {
                doc.text(`${i + 1}. ${item.employee.split('(')[0].trim()} - ${item.avgHtp.toFixed(1)} HTP`, 25, yPos);
                yPos += 8;
            });

            doc.setFontSize(12);
            doc.text('PACK (í¬ì¥)', 110, 110);
            doc.setFontSize(10);
            yPos = 120;
            topPack.forEach((item, i) => {
                doc.text(`${i + 1}. ${item.employee.split('(')[0].trim()} - ${item.avgHtp.toFixed(1)} HTP`, 115, yPos);
                yPos += 8;
            });

            doc.setFontSize(9);
            doc.text(`ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}`, 105, 280, { align: 'center' });
            doc.text('GWJ2 OB PICK & PACK HTP TOOL v3.5', 105, 287, { align: 'center' });

            const filename = `HTP_Report_${filteredDates[0]}_to_${filteredDates[filteredDates.length - 1]}.pdf`;
            doc.save(filename);
            
            setTimeout(() => {
                showModal('PDF ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }, 2000);
        }
		
		// --- ğŸ†• Enhanced History View with Employee Search ---
        
        let historyEmployeeData = []; // ì „ì²´ ì‚¬ì› ë°ì´í„°
        let currentHistoryPage = 1;
        const EMPLOYEES_PER_PAGE = 20;

        function renderHistoryView() {
            if (Object.keys(historyData).length === 0) {
                showModal('íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const filteredDates = getFilteredHistoryDates();
            if (filteredDates.length === 0) {
                ui.historyKpi.days.textContent = '0';
                ui.historyKpi.totalQty.textContent = '0';
                ui.historyKpi.avgHtp.textContent = '0.0';
                ui.historyKpi.maxHtp.textContent = '0.0';
                return;
            }

            let allAggregatedData = [];
            filteredDates.forEach(date => {
                const dayData = historyData[date];
                if (dayData) {
                    const aggregated = aggregateData(dayData);
                    allAggregatedData = allAggregatedData.concat(aggregated.map(item => ({ ...item, date })));
                }
            });

            const totalDays = filteredDates.length;
            const totalQty = allAggregatedData.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = allAggregatedData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const maxHtp = Math.max(...allAggregatedData.map(d => parseFloat(d.htp)), 0);

            ui.historyKpi.days.textContent = totalDays.toLocaleString();
            ui.historyKpi.totalQty.textContent = totalQty.toLocaleString();
            ui.historyKpi.avgHtp.textContent = avgHtp.toFixed(1);
            ui.historyKpi.maxHtp.textContent = maxHtp.toFixed(1);

            // ğŸ†• Calculate employee analysis data
            calculateEmployeeHistoryData(allAggregatedData);
            
            updateHistoryTopPerformers(allAggregatedData);
        }

        function calculateEmployeeHistoryData(allData) {
            const employeeMap = new Map();

            allData.forEach(item => {
                if (!employeeMap.has(item.employee)) {
                    employeeMap.set(item.employee, {
                        employee: item.employee,
                        totalDays: new Set(),
                        pickData: { totalQty: 0, totalMh: 0, ppPerformance: new Map() },
                        packData: { totalQty: 0, totalMh: 0, packTypePerformance: new Map() }
                    });
                }

                const empData = employeeMap.get(item.employee);
                empData.totalDays.add(item.date);

                if (item.processType.includes('PICK')) {
                    empData.pickData.totalQty += item.unitQty;
                    empData.pickData.totalMh += parseFloat(item.mh);
                    
                    const pp = item.processPathName || 'ê¸°íƒ€';
                    if (!empData.pickData.ppPerformance.has(pp)) {
                        empData.pickData.ppPerformance.set(pp, { totalQty: 0, totalMh: 0 });
                    }
                    const ppStats = empData.pickData.ppPerformance.get(pp);
                    ppStats.totalQty += item.unitQty;
                    ppStats.totalMh += parseFloat(item.mh);
                } else {
                    empData.packData.totalQty += item.unitQty;
                    empData.packData.totalMh += parseFloat(item.mh);
                    
                    const packType = item.packType || 'ê¸°íƒ€';
                    if (!empData.packData.packTypePerformance.has(packType)) {
                        empData.packData.packTypePerformance.set(packType, { totalQty: 0, totalMh: 0 });
                    }
                    const packStats = empData.packData.packTypePerformance.get(packType);
                    packStats.totalQty += item.unitQty;
                    packStats.totalMh += parseFloat(item.mh);
                }
            });

            // Convert to array and calculate final stats
            historyEmployeeData = Array.from(employeeMap.values()).map(emp => {
                const pickHtp = emp.pickData.totalMh > 0 ? (emp.pickData.totalQty / emp.pickData.totalMh) : 0;
                const packHtp = emp.packData.totalMh > 0 ? (emp.packData.totalQty / emp.packData.totalMh) : 0;
                const totalQty = emp.pickData.totalQty + emp.packData.totalQty;
                const totalMh = emp.pickData.totalMh + emp.packData.totalMh;
                const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;

                // Find best PP for PICK
                let bestPP = null, bestPPHtp = 0;
                emp.pickData.ppPerformance.forEach((stats, pp) => {
                    const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                    if (htp > bestPPHtp) {
                        bestPPHtp = htp;
                        bestPP = pp;
                    }
                });

                // Find best Pack Type for PACK
                let bestPackType = null, bestPackTypeHtp = 0;
                emp.packData.packTypePerformance.forEach((stats, packType) => {
                    const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                    if (htp > bestPackTypeHtp) {
                        bestPackTypeHtp = htp;
                        bestPackType = packType;
                    }
                });

                return {
                    employee: emp.employee,
                    totalDays: emp.totalDays.size,
                    totalQty: totalQty,
                    avgHtp: avgHtp,
                    pickHtp: pickHtp,
                    packHtp: packHtp,
                    bestProcess: pickHtp > packHtp ? 'PICK' : (packHtp > 0 ? 'PACK' : 'PICK'),
                    bestProcessHtp: Math.max(pickHtp, packHtp),
                    bestPP: bestPP,
                    bestPPHtp: bestPPHtp,
                    bestPackType: bestPackType,
                    bestPackTypeHtp: bestPackTypeHtp
                };
            });

            // Sort by avgHtp
            historyEmployeeData.sort((a, b) => b.avgHtp - a.avgHtp);
        }

        function renderEmployeeAnalysisCards(employees) {
            const resultsContainer = document.getElementById('history-employee-results');
            resultsContainer.innerHTML = '';

            if (employees.length === 0) {
                resultsContainer.innerHTML = '<div class="text-center py-10 text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            employees.forEach((emp, index) => {
                const card = document.createElement('div');
                card.className = 'employee-analysis-card';
                
                const rank = historyEmployeeData.findIndex(e => e.employee === emp.employee) + 1;
                const rankBadge = rank <= 3 ? (rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰') : `#${rank}`;

                card.innerHTML = `
                    <div class="employee-name-header">
                        <span>${emp.employee.split('(')[0].trim()}</span>
                        <span style="font-size: 1.5rem;">${rankBadge}</span>
                    </div>
                    
                    <div class="employee-stats-grid">
                        <div class="employee-stat-item">
                            <div class="employee-stat-label">í‰ê·  HTP</div>
                            <div class="employee-stat-value" style="color: ${emp.avgHtp >= 90 ? '#4ade80' : '#f87171'};">
                                ${emp.avgHtp.toFixed(1)}
                            </div>
                        </div>
                        <div class="employee-stat-item">
                            <div class="employee-stat-label">ì´ ê·¼ë¬´ì¼ìˆ˜</div>
                            <div class="employee-stat-value">${emp.totalDays}ì¼</div>
                        </div>
                        <div class="employee-stat-item">
                            <div class="employee-stat-label">ëˆ„ì  ì‘ì—…ëŸ‰</div>
                            <div class="employee-stat-value">${emp.totalQty.toLocaleString()}</div>
                        </div>
                        <div class="employee-stat-item">
                            <div class="employee-stat-label">ìµœì  ê³µì •</div>
                            <div class="employee-stat-value">
                                <span class="performance-badge ${emp.bestProcess.toLowerCase()}">
                                    ${emp.bestProcess} ${emp.bestProcessHtp.toFixed(1)}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="best-performance-section">
                        <div class="best-performance-title">
                            â­ ìµœê³  íš¨ìœ¨ ì‘ì—… ìœ„ì¹˜
                        </div>
                        <div class="best-performance-detail">
                            ${emp.bestProcess === 'PICK' && emp.bestPP ? 
                                `<strong>PICK (ì§‘í’ˆ)</strong><br/>
                                 ğŸ”¹ ìµœê³  íš¨ìœ¨ PP: <strong>${emp.bestPP}</strong><br/>
                                 ğŸ”¹ HTP: <strong style="color: #4ade80;">${emp.bestPPHtp.toFixed(1)}</strong>` :
                                emp.bestProcess === 'PACK' && emp.bestPackType ?
                                `<strong>PACK (í¬ì¥)</strong><br/>
                                 ğŸ”¹ ìµœê³  íš¨ìœ¨ íŒ© ì¢…ë¥˜: <strong>${emp.bestPackType}</strong><br/>
                                 ğŸ”¹ HTP: <strong style="color: #fbbf24;">${emp.bestPackTypeHtp.toFixed(1)}</strong>` :
                                'ë°ì´í„° ìˆ˜ì§‘ ì¤‘...'}
                        </div>
                        ${emp.pickHtp > 0 && emp.packHtp > 0 ? `
                            <div class="mt-2 pt-2 border-t border-gray-600">
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                    PICK HTP: <strong>${emp.pickHtp.toFixed(1)}</strong> | 
                                    PACK HTP: <strong>${emp.packHtp.toFixed(1)}</strong>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Click to show detailed modal
                card.addEventListener('click', () => {
                    const processType = emp.bestProcess === 'PICK' ? 'PICK(ì§‘í’ˆ)' : 'PACK(í¬ì¥)';
                    showEmployeeDetailModal(emp.employee, processType);
                });

                resultsContainer.appendChild(card);
            });
        }

        // Employee Search Functionality
        const historyEmployeeSearch = document.getElementById('history-employee-search');
        const historyShowAllBtn = document.getElementById('history-show-all-btn');
        const historyPrevPageBtn = document.getElementById('history-prev-page');
        const historyNextPageBtn = document.getElementById('history-next-page');
        const historyPagination = document.getElementById('history-pagination');

        historyEmployeeSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('history-employee-results').innerHTML = 
                    '<div class="text-center py-10 text-gray-400">ì‚¬ì›ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ "ì „ì²´ ë³´ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</div>';
                historyPagination.classList.add('hidden');
                return;
            }

            const filtered = historyEmployeeData.filter(emp => 
                emp.employee.toLowerCase().includes(searchTerm)
            );

            renderEmployeeAnalysisCards(filtered);
            historyPagination.classList.add('hidden');
        });

        historyShowAllBtn.addEventListener('click', () => {
            currentHistoryPage = 1;
            renderEmployeeListPage();
        });

        historyPrevPageBtn.addEventListener('click', () => {
            if (currentHistoryPage > 1) {
                currentHistoryPage--;
                renderEmployeeListPage();
            }
        });

        historyNextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(historyEmployeeData.length / EMPLOYEES_PER_PAGE);
            if (currentHistoryPage < totalPages) {
                currentHistoryPage++;
                renderEmployeeListPage();
            }
        });

        function renderEmployeeListPage() {
            const totalPages = Math.ceil(historyEmployeeData.length / EMPLOYEES_PER_PAGE);
            const startIndex = (currentHistoryPage - 1) * EMPLOYEES_PER_PAGE;
            const endIndex = startIndex + EMPLOYEES_PER_PAGE;
            const pageEmployees = historyEmployeeData.slice(startIndex, endIndex);

            renderEmployeeAnalysisCards(pageEmployees);

            document.getElementById('history-page-info').textContent = `${currentHistoryPage} / ${totalPages}`;
            historyPrevPageBtn.disabled = currentHistoryPage === 1;
            historyNextPageBtn.disabled = currentHistoryPage === totalPages;
            historyPagination.classList.remove('hidden');

            // Clear search
            historyEmployeeSearch.value = '';
        }

        // ğŸ‰ Complete - Initialize
        console.log("ğŸš€ GWJ2 HTP TOOL v3.0 ì´ˆê¸°í™” ì™„ë£Œ - ëª¨ë“  ê¸°ëŠ¥ ë¡œë“œë¨");
    </script>
</body>
</html>